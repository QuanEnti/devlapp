


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ProjectServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.devcollab.service.impl.core</a>
</div>

<h1>Coverage Summary for Class: ProjectServiceImpl (com.devcollab.service.impl.core)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ProjectServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/31)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/88)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/271)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.devcollab.service.impl.core;
&nbsp;
&nbsp;import com.devcollab.domain.*;
&nbsp;import com.devcollab.dto.MemberDTO;
&nbsp;import com.devcollab.dto.ProjectDTO;
&nbsp;import com.devcollab.dto.ProjectSummaryDTO;
&nbsp;import com.devcollab.dto.response.ProjectDashboardDTO;
&nbsp;import com.devcollab.dto.response.ProjectPerformanceDTO;
&nbsp;import com.devcollab.dto.response.ProjectSearchResponseDTO;
&nbsp;import com.devcollab.dto.userTaskDto.ProjectFilterDTO;
&nbsp;import com.devcollab.exception.BadRequestException;
&nbsp;import com.devcollab.exception.NotFoundException;
&nbsp;import com.devcollab.repository.*;
&nbsp;import com.devcollab.service.core.ProjectService;
&nbsp;import com.devcollab.service.event.AppEventService;
&nbsp;import com.devcollab.service.system.ActivityService;
&nbsp;import com.devcollab.service.system.NotificationService;
&nbsp;import com.devcollab.service.system.ProjectAuthorizationService;
&nbsp;
&nbsp;import org.springframework.data.domain.Sort;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;
&nbsp;import org.springframework.data.domain.Page;
&nbsp;import org.springframework.data.domain.PageRequest;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import java.math.BigDecimal;
&nbsp;import java.math.RoundingMode;
&nbsp;import java.time.DayOfWeek;
&nbsp;import java.time.LocalDate;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.*;
&nbsp;import org.springframework.data.domain.Pageable;
&nbsp;
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@Service
&nbsp;@RequiredArgsConstructor
&nbsp;@Transactional
&nbsp;public class ProjectServiceImpl implements ProjectService {
&nbsp;
&nbsp;    private final ProjectRepository projectRepository;
&nbsp;    private final ProjectMemberRepository projectMemberRepository;
&nbsp;    private final BoardColumnRepository boardColumnRepository;
&nbsp;    private final UserRepository userRepository;
&nbsp;    private final TaskRepository taskRepository;
&nbsp;    private final ProjectAuthorizationService authz;
&nbsp;
&nbsp;    private final AppEventService appEventService;
&nbsp;    private final ActivityService activityService;
&nbsp;    private final NotificationService notificationService;
&nbsp;
&nbsp;    @Override
&nbsp;    public Project createProject(Project project, Long creatorId) {
<b class="nc">&nbsp;        if (project == null || project.getName() == null || project.getName().isBlank()) {</b>
<b class="nc">&nbsp;            throw new BadRequestException(&quot;T√™n d·ª± √°n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        String projectName = project.getName().trim();</b>
&nbsp;
&nbsp;        // ‚úÖ Check for duplicate (case-insensitive)
<b class="nc">&nbsp;        boolean exists = projectRepository.existsByNameIgnoreCaseAndCreatedBy_UserId(projectName,creatorId);</b>
<b class="nc">&nbsp;        if (exists) {</b>
<b class="nc">&nbsp;            throw new BadRequestException(&quot;T√™n d·ª± √°n b·ªã tr√πng&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (project.getStartDate() != null &amp;&amp; project.getDueDate() != null</b>
<b class="nc">&nbsp;                &amp;&amp; project.getDueDate().isBefore(project.getStartDate())) {</b>
<b class="nc">&nbsp;            throw new BadRequestException(&quot;Ng√†y k·∫øt th√∫c ph·∫£i sau ng√†y b·∫Øt ƒë·∫ßu&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        User creator = userRepository.findById(creatorId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new NotFoundException(&quot;User kh√¥ng t·ªìn t·∫°i&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        project.setCreatedBy(creator);</b>
<b class="nc">&nbsp;        project.setCreatedAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;        project.setUpdatedAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;        if (project.getStatus() == null)</b>
<b class="nc">&nbsp;            project.setStatus(&quot;Active&quot;);</b>
<b class="nc">&nbsp;        if (project.getPriority() == null)</b>
<b class="nc">&nbsp;            project.setPriority(&quot;Normal&quot;);</b>
<b class="nc">&nbsp;        if (project.getVisibility() == null)</b>
<b class="nc">&nbsp;            project.setVisibility(&quot;private&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        Project saved = projectRepository.save(project);</b>
&nbsp;
<b class="nc">&nbsp;        ProjectMember pm = new ProjectMember();</b>
<b class="nc">&nbsp;        pm.setProject(saved);</b>
<b class="nc">&nbsp;        pm.setUser(creator);</b>
<b class="nc">&nbsp;        pm.setRoleInProject(&quot;PM&quot;);</b>
<b class="nc">&nbsp;        pm.setJoinedAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;        projectMemberRepository.save(pm);</b>
&nbsp;
<b class="nc">&nbsp;        String[] defaultCols = {&quot;To-do&quot;, &quot;In Progress&quot;, &quot;Review&quot;, &quot;Done&quot;};</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; defaultCols.length; i++) {</b>
<b class="nc">&nbsp;            BoardColumn col = new BoardColumn();</b>
<b class="nc">&nbsp;            col.setProject(saved);</b>
<b class="nc">&nbsp;            col.setName(defaultCols[i]);</b>
<b class="nc">&nbsp;            col.setOrderIndex(i + 1);</b>
<b class="nc">&nbsp;            col.setIsDefault(true);</b>
<b class="nc">&nbsp;            boardColumnRepository.save(col);</b>
&nbsp;        }
&nbsp;
&nbsp;        // activityService.log(&quot;PROJECT&quot;, saved.getProjectId(), &quot;CREATE&quot;,
&nbsp;        // saved.getName());
<b class="nc">&nbsp;        appEventService.publishProjectCreated(saved);</b>
&nbsp;        // notificationService.notifyProjectCreated(saved);
&nbsp;
<b class="nc">&nbsp;        return saved;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Project updateProject(Long id, Project patch) {
<b class="nc">&nbsp;        Project existing = projectRepository.findById(id)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new NotFoundException(&quot;Kh√¥ng t√¨m th·∫•y d·ª± √°n&quot;));</b>
&nbsp;        // ‚úÖ Ki·ªÉm tra t√™n tr√πng (n·∫øu c√≥ c·∫≠p nh·∫≠t)
<b class="nc">&nbsp;        if (patch.getName() != null &amp;&amp; !patch.getName().isBlank()) {</b>
<b class="nc">&nbsp;            String projectName = patch.getName().trim();</b>
<b class="nc">&nbsp;            boolean exists = projectRepository.existsByNameIgnoreCaseAndCreatedBy_UserIdAndProjectIdNot(</b>
<b class="nc">&nbsp;                    projectName, existing.getCreatedBy().getUserId(), id</b>
&nbsp;            );
<b class="nc">&nbsp;            if (exists) {</b>
<b class="nc">&nbsp;                throw new BadRequestException(&quot;T√™n d·ª± √°n b·ªã tr√πng&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            existing.setName(projectName);</b>
&nbsp;        }
&nbsp;        // ‚úÖ C·∫≠p nh·∫≠t m√¥ t·∫£
<b class="nc">&nbsp;        if (patch.getDescription() != null)</b>
<b class="nc">&nbsp;            existing.setDescription(patch.getDescription());</b>
&nbsp;        // ‚úÖ C·∫≠p nh·∫≠t Business Rule
<b class="nc">&nbsp;        if (patch.getBusinessRule() != null)</b>
<b class="nc">&nbsp;            existing.setBusinessRule(patch.getBusinessRule());</b>
&nbsp;        // ‚úÖ C·∫≠p nh·∫≠t ƒë·ªô ∆∞u ti√™n
<b class="nc">&nbsp;        if (patch.getPriority() != null)</b>
<b class="nc">&nbsp;            existing.setPriority(patch.getPriority());</b>
&nbsp;        // ‚úÖ C·∫≠p nh·∫≠t visibility (n·∫øu c√≥)
<b class="nc">&nbsp;        if (patch.getVisibility() != null)</b>
<b class="nc">&nbsp;            existing.setVisibility(patch.getVisibility());</b>
&nbsp;        // ‚úÖ C·∫≠p nh·∫≠t ng√†y b·∫Øt ƒë·∫ßu
<b class="nc">&nbsp;        if (patch.getStartDate() != null)</b>
<b class="nc">&nbsp;            existing.setStartDate(patch.getStartDate());</b>
&nbsp;        // ‚úÖ C·∫≠p nh·∫≠t ng√†y k·∫øt th√∫c (v√† ki·ªÉm tra h·ª£p l·ªá)
<b class="nc">&nbsp;        if (patch.getDueDate() != null) {</b>
<b class="nc">&nbsp;            if (existing.getStartDate() != null &amp;&amp; patch.getDueDate().isBefore(existing.getStartDate())) {</b>
<b class="nc">&nbsp;                throw new BadRequestException(&quot;Ng√†y k·∫øt th√∫c kh√¥ng h·ª£p l·ªá&quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            existing.setDueDate(patch.getDueDate());</b>
&nbsp;        }
<b class="nc">&nbsp;        existing.setUpdatedAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;        Project saved = projectRepository.save(existing);</b>
&nbsp;        // üß© Ghi log ho·∫°t ƒë·ªông
<b class="nc">&nbsp;        activityService.log(&quot;PROJECT&quot;, saved.getProjectId(), &quot;UPDATE&quot;, saved.getName());</b>
<b class="nc">&nbsp;        return saved;</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public List&lt;Project&gt; getProjectsByUser(Long userId) {
<b class="nc">&nbsp;        List&lt;Project&gt; created = projectRepository.findByCreatedBy_UserId(userId);</b>
<b class="nc">&nbsp;        List&lt;ProjectMember&gt; joined = projectMemberRepository.findByUser_UserId(userId);</b>
&nbsp;
<b class="nc">&nbsp;        Map&lt;Long, Project&gt; all = new LinkedHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        for (Project p : created) all.put(p.getProjectId(), p);</b>
<b class="nc">&nbsp;        for (ProjectMember m : joined) all.put(m.getProject().getProjectId(), m.getProject());</b>
<b class="nc">&nbsp;        return new ArrayList&lt;&gt;(all.values());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ProjectMember addMember(Long projectId, Long userId, String role) {
<b class="nc">&nbsp;        Project project = projectRepository.findById(projectId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new NotFoundException(&quot;D·ª± √°n kh√¥ng t·ªìn t·∫°i&quot;));</b>
<b class="nc">&nbsp;        User user = userRepository.findById(userId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new NotFoundException(&quot;User kh√¥ng t·ªìn t·∫°i&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        boolean exists = projectMemberRepository.findByProject_ProjectId(projectId)</b>
<b class="nc">&nbsp;                .stream()</b>
<b class="nc">&nbsp;                .anyMatch(m -&gt; m.getUser().getUserId().equals(userId));</b>
<b class="nc">&nbsp;        if (exists) {</b>
<b class="nc">&nbsp;            return projectMemberRepository.findByProject_ProjectId(projectId)</b>
<b class="nc">&nbsp;                    .stream()</b>
<b class="nc">&nbsp;                    .filter(m -&gt; m.getUser().getUserId().equals(userId))</b>
<b class="nc">&nbsp;                    .findFirst().get();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        ProjectMember pm = new ProjectMember();</b>
<b class="nc">&nbsp;        pm.setProject(project);</b>
<b class="nc">&nbsp;        pm.setUser(user);</b>
<b class="nc">&nbsp;        pm.setRoleInProject(role != null ? role : &quot;Member&quot;);</b>
<b class="nc">&nbsp;        pm.setJoinedAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;        ProjectMember saved = projectMemberRepository.save(pm);</b>
&nbsp;
<b class="nc">&nbsp;        activityService.log(&quot;PROJECT&quot;, projectId, &quot;ADD_MEMBER&quot;, user.getEmail());</b>
<b class="nc">&nbsp;        appEventService.publishMemberAdded(project, user);</b>
<b class="nc">&nbsp;        notificationService.notifyMemberAdded(project, user);</b>
<b class="nc">&nbsp;        return saved;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void removeMember(Long projectId, Long userId) {
<b class="nc">&nbsp;        List&lt;ProjectMember&gt; members = projectMemberRepository.findByProject_ProjectId(projectId);</b>
<b class="nc">&nbsp;        ProjectMember target = members.stream()</b>
<b class="nc">&nbsp;                .filter(m -&gt; m.getUser().getUserId().equals(userId))</b>
<b class="nc">&nbsp;                .findFirst()</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new NotFoundException(&quot;Th√†nh vi√™n kh√¥ng t·ªìn t·∫°i&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        long pmCount = members.stream()</b>
<b class="nc">&nbsp;                .filter(m -&gt; &quot;PM&quot;.equalsIgnoreCase(m.getRoleInProject()))</b>
<b class="nc">&nbsp;                .count();</b>
<b class="nc">&nbsp;        if (&quot;PM&quot;.equalsIgnoreCase(target.getRoleInProject()) &amp;&amp; pmCount &lt;= 1) {</b>
<b class="nc">&nbsp;            throw new BadRequestException(&quot;Kh√¥ng th·ªÉ x√≥a PM cu·ªëi c√πng c·ªßa d·ª± √°n&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        projectMemberRepository.delete(target);</b>
<b class="nc">&nbsp;        activityService.log(&quot;PROJECT&quot;, projectId, &quot;REMOVE_MEMBER&quot;, target.getUser().getEmail());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Project archiveProject(Long projectId) {
<b class="nc">&nbsp;        Project project = projectRepository.findById(projectId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new NotFoundException(&quot;Kh√¥ng t√¨m th·∫•y d·ª± √°n&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        if (!&quot;Archived&quot;.equalsIgnoreCase(project.getStatus())) {</b>
<b class="nc">&nbsp;            project.setStatus(&quot;Archived&quot;);</b>
<b class="nc">&nbsp;            project.setArchivedAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;            project.setUpdatedAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;            project = projectRepository.save(project);</b>
&nbsp;
<b class="nc">&nbsp;            activityService.log(&quot;PROJECT&quot;, projectId, &quot;ARCHIVE&quot;, project.getName());</b>
<b class="nc">&nbsp;            notificationService.notifyProjectArchived(project);</b>
&nbsp;        }
<b class="nc">&nbsp;        return project;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteProject(Long projectId) {
<b class="nc">&nbsp;        if (!projectRepository.existsById(projectId)) {</b>
<b class="nc">&nbsp;            throw new NotFoundException(&quot;D·ª± √°n kh√¥ng t·ªìn t·∫°i&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        projectRepository.deleteById(projectId);</b>
<b class="nc">&nbsp;        activityService.log(&quot;PROJECT&quot;, projectId, &quot;DELETE&quot;, &quot;Hard delete&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Project getById(Long projectId) {
<b class="nc">&nbsp;        return projectRepository.findById(projectId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new NotFoundException(&quot;Kh√¥ng t√¨m th·∫•y d·ª± √°n&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ProjectDashboardDTO getDashboardForPm(Long projectId, String pmEmail) {
<b class="nc">&nbsp;        Project project = projectRepository.findById(projectId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new NotFoundException(&quot;Kh√¥ng t√¨m th·∫•y d·ª± √°n&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        authz.ensurePmOfProject(pmEmail, projectId);</b>
&nbsp;
<b class="nc">&nbsp;        long total = taskRepository.countByProject_ProjectId(projectId);</b>
<b class="nc">&nbsp;        long open = taskRepository.countByProject_ProjectIdAndStatus(projectId, &quot;OPEN&quot;);</b>
<b class="nc">&nbsp;        long inProgress = taskRepository.countByProject_ProjectIdAndStatus(projectId, &quot;IN_PROGRESS&quot;);</b>
<b class="nc">&nbsp;        long review = taskRepository.countByProject_ProjectIdAndStatus(projectId, &quot;REVIEW&quot;);</b>
<b class="nc">&nbsp;        long done = taskRepository.countByProject_ProjectIdAndStatus(projectId, &quot;DONE&quot;);</b>
<b class="nc">&nbsp;        long overdue = taskRepository.countOverdue(projectId, LocalDateTime.now());</b>
&nbsp;
<b class="nc">&nbsp;        BigDecimal percentDone = total == 0</b>
<b class="nc">&nbsp;                ? BigDecimal.ZERO</b>
<b class="nc">&nbsp;                : BigDecimal.valueOf(done)</b>
<b class="nc">&nbsp;                        .multiply(BigDecimal.valueOf(100))</b>
<b class="nc">&nbsp;                        .divide(BigDecimal.valueOf(total), 2, RoundingMode.HALF_UP);</b>
&nbsp;
<b class="nc">&nbsp;        return ProjectDashboardDTO.builder()</b>
<b class="nc">&nbsp;                .projectId(projectId)</b>
<b class="nc">&nbsp;                .totalTasks(total)</b>
<b class="nc">&nbsp;                .openTasks(open)</b>
<b class="nc">&nbsp;                .inProgressTasks(inProgress)</b>
<b class="nc">&nbsp;                .reviewTasks(review)</b>
<b class="nc">&nbsp;                .doneTasks(done)</b>
<b class="nc">&nbsp;                .overdueTasks(overdue)</b>
<b class="nc">&nbsp;                .percentDone(percentDone)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Project getByIdWithMembers(Long projectId) {
<b class="nc">&nbsp;        return projectRepository.findByIdWithMembers(projectId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new NotFoundException(&quot;Kh√¥ng t√¨m th·∫•y d·ª± √°n&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ProjectPerformanceDTO getPerformanceData(Long projectId, String pmEmail) {
<b class="nc">&nbsp;    authz.ensurePmOfProject(pmEmail, projectId);</b>
&nbsp;
<b class="nc">&nbsp;    LocalDate today = LocalDate.now();</b>
<b class="nc">&nbsp;    LocalDate startOfWeek = today.with(DayOfWeek.MONDAY);</b>
<b class="nc">&nbsp;    LocalDate endOfWeek = today.with(DayOfWeek.SUNDAY);</b>
&nbsp;
<b class="nc">&nbsp;    List&lt;Object[]&gt; results = taskRepository.countCompletedTasksPerDay(</b>
&nbsp;        projectId,
<b class="nc">&nbsp;        startOfWeek.atStartOfDay(),</b>
<b class="nc">&nbsp;        endOfWeek.atTime(23, 59, 59)</b>
&nbsp;    );
&nbsp;
<b class="nc">&nbsp;    Map&lt;String, Long&gt; dayMap = new LinkedHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;    results.forEach(r -&gt; dayMap.put((String) r[0], (Long) r[1]));</b>
&nbsp;
<b class="nc">&nbsp;    List&lt;String&gt; labels = List.of(&quot;Mon&quot;, &quot;Tue&quot;, &quot;Wed&quot;, &quot;Thu&quot;, &quot;Fri&quot;, &quot;Sat&quot;, &quot;Sun&quot;);</b>
<b class="nc">&nbsp;    List&lt;Long&gt; achieved = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    for (String d : labels) {</b>
<b class="nc">&nbsp;        achieved.add(dayMap.getOrDefault(d, 0L));</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    long total = taskRepository.countByProject_ProjectId(projectId);</b>
<b class="nc">&nbsp;    long targetPerDay = Math.max(1, total / 7);</b>
<b class="nc">&nbsp;    List&lt;Long&gt; target = labels.stream().map(d -&gt; targetPerDay).toList();</b>
&nbsp;
<b class="nc">&nbsp;    return new ProjectPerformanceDTO(labels, achieved, target);</b>
&nbsp;
&nbsp;}
&nbsp;
&nbsp;@Override
&nbsp;public List&lt;ProjectDTO&gt; getTopProjectsByPm(String email, int limit) {
<b class="nc">&nbsp;    Pageable pageable = PageRequest.of(0, limit);</b>
<b class="nc">&nbsp;    return projectRepository.findTopProjectsByPm(email, pageable);</b>
&nbsp;}
&nbsp;
&nbsp;@Override
&nbsp;public Page&lt;ProjectDTO&gt; getAllProjectsByPm(String email, int page, int size, String keyword) {
<b class="nc">&nbsp;    if (keyword == null || keyword.isBlank())</b>
<b class="nc">&nbsp;        keyword = &quot;&quot;;</b>
&nbsp;
<b class="nc">&nbsp;    Pageable pageable = PageRequest.of(page, size, Sort.by(&quot;updatedAt&quot;).descending());</b>
<b class="nc">&nbsp;    Page&lt;ProjectDTO&gt; projects = projectRepository.findAllProjectsByPm(email, keyword, pageable);</b>
<b class="nc">&nbsp;    System.out.println(projects);</b>
<b class="nc">&nbsp;    if (projects == null)</b>
<b class="nc">&nbsp;        return Page.empty(pageable);</b>
&nbsp;
<b class="nc">&nbsp;    return projects.map(dto -&gt; {</b>
<b class="nc">&nbsp;        Long projectId = dto.getProjectId();</b>
<b class="nc">&nbsp;        if (projectId == null) {</b>
<b class="nc">&nbsp;            log.warn(&quot;‚ö†Ô∏è ProjectDTO missing projectId for {}&quot;, dto.getName());</b>
<b class="nc">&nbsp;            return dto;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        List&lt;MemberDTO&gt; allMembers = Optional.ofNullable(</b>
<b class="nc">&nbsp;                projectMemberRepository.findMembersByProject(projectId)).orElse(Collections.emptyList());</b>
&nbsp;
<b class="nc">&nbsp;        int totalMembers = allMembers.size();</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;MemberDTO&gt; topMembers = allMembers.stream()</b>
<b class="nc">&nbsp;                .filter(m -&gt; m.getAvatarUrl() != null)</b>
<b class="nc">&nbsp;                .limit(4)</b>
<b class="nc">&nbsp;                .toList();</b>
&nbsp;
<b class="nc">&nbsp;        dto.setMemberCount(totalMembers);</b>
<b class="nc">&nbsp;        dto.setMemberAvatars(topMembers.stream().map(MemberDTO::getAvatarUrl).toList());</b>
<b class="nc">&nbsp;        dto.setMemberNames(topMembers.stream().map(MemberDTO::getName).toList());</b>
&nbsp;
<b class="nc">&nbsp;        return dto;</b>
&nbsp;    });
&nbsp;}
&nbsp;
&nbsp;    @Override
&nbsp;    public Project enableShareLink(Long projectId, String pmEmail) {
<b class="nc">&nbsp;        Project project = projectRepository.findById(projectId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new NotFoundException(&quot;Kh√¥ng t√¨m th·∫•y d·ª± √°n&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        authz.ensurePmOfProject(pmEmail, projectId);</b>
&nbsp;
&nbsp;
<b class="nc">&nbsp;        if (!project.isAllowLinkJoin()) {</b>
<b class="nc">&nbsp;            String inviteLink = UUID.randomUUID().toString();</b>
<b class="nc">&nbsp;            project.setInviteLink(inviteLink);</b>
<b class="nc">&nbsp;            project.setAllowLinkJoin(true);</b>
<b class="nc">&nbsp;            project.setUpdatedAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;            projectRepository.save(project);</b>
&nbsp;
&nbsp;            // activityService.log(&quot;PROJECT&quot;, projectId, &quot;ENABLE_SHARE&quot;, &quot;Link: &quot; + inviteLink);
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return project;</b>
&nbsp;    }
&nbsp;    @Override
&nbsp;    public Project disableShareLink(Long projectId, String pmEmail) {
<b class="nc">&nbsp;        Project project = projectRepository.findById(projectId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new NotFoundException(&quot;Kh√¥ng t√¨m th·∫•y d·ª± √°n&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        authz.ensurePmOfProject(pmEmail, projectId);</b>
&nbsp;
<b class="nc">&nbsp;        if (project.isAllowLinkJoin()) {</b>
<b class="nc">&nbsp;            project.setAllowLinkJoin(false);</b>
<b class="nc">&nbsp;            project.setInviteLink(null);</b>
<b class="nc">&nbsp;            project.setUpdatedAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;            projectRepository.save(project);</b>
&nbsp;
<b class="nc">&nbsp;            activityService.log(&quot;PROJECT&quot;, projectId, &quot;DISABLE_SHARE&quot;, &quot;Share link disabled&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return project;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ProjectMember joinProjectByLink(String inviteLink, Long userId) {
<b class="nc">&nbsp;        Project project = projectRepository.findActiveSharedProject(inviteLink)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new BadRequestException(&quot;Link m·ªùi kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ b·ªã t·∫Øt&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        User user = userRepository.findById(userId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new NotFoundException(&quot;User kh√¥ng t·ªìn t·∫°i&quot;));</b>
&nbsp;
<b class="nc">&nbsp;        boolean exists = projectMemberRepository.existsByProject_ProjectIdAndUser_UserId(project.getProjectId(),</b>
&nbsp;                userId);
<b class="nc">&nbsp;        if (exists) {</b>
<b class="nc">&nbsp;            throw new BadRequestException(&quot;B·∫°n ƒë√£ l√† th√†nh vi√™n c·ªßa d·ª± √°n n√†y&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        ProjectMember newMember = new ProjectMember();</b>
<b class="nc">&nbsp;        newMember.setProject(project);</b>
<b class="nc">&nbsp;        newMember.setUser(user);</b>
<b class="nc">&nbsp;        newMember.setRoleInProject(&quot;Member&quot;);</b>
<b class="nc">&nbsp;        newMember.setJoinedAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;        projectMemberRepository.save(newMember);</b>
&nbsp;
<b class="nc">&nbsp;        activityService.log(&quot;PROJECT&quot;, project.getProjectId(), &quot;JOIN_BY_LINK&quot;, user.getEmail());</b>
<b class="nc">&nbsp;        notificationService.notifyMemberAdded(project, user);</b>
&nbsp;
<b class="nc">&nbsp;        return newMember;</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;Project&gt; getProjectsByUsername(String username) {
&nbsp;        // 1. T√¨m User b·∫±ng username (email)
<b class="nc">&nbsp;        User user = userRepository.findByEmail(username)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new NotFoundException(&quot;User kh√¥ng t·ªìn t·∫°i&quot;));</b>
&nbsp;
&nbsp;        // 2. G·ªçi l·∫°i ph∆∞∆°ng th·ª©c c≈© b·∫±ng userId
<b class="nc">&nbsp;        return this.getProjectsByUser(user.getUserId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional(readOnly = true)
&nbsp;    public List&lt;ProjectSearchResponseDTO&gt; searchProjectsByKeyword(String keyword) {
<b class="nc">&nbsp;        List&lt;Project&gt; projects = projectRepository</b>
<b class="nc">&nbsp;                .findByNameContainingIgnoreCaseOrDescriptionContainingIgnoreCase(keyword, keyword);</b>
<b class="nc">&nbsp;        return projects.stream()</b>
<b class="nc">&nbsp;                .map(ProjectSearchResponseDTO::new)</b>
<b class="nc">&nbsp;                .toList();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional(readOnly = true)
&nbsp;    public String getUserRoleInProject(Long projectId, Long userId) {
<b class="nc">&nbsp;        return projectMemberRepository.findRoleInProject(projectId, userId)</b>
<b class="nc">&nbsp;                .orElse(&quot;Member&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Transactional(readOnly = true)
&nbsp;    public String getUserRoleInProjectByEmail(Long projectId, String email) {
<b class="nc">&nbsp;        User user = userRepository.findByEmail(email)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new NotFoundException(&quot;User kh√¥ng t·ªìn t·∫°i&quot;));</b>
<b class="nc">&nbsp;        return getUserRoleInProject(projectId, user.getUserId());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional(readOnly = true)
&nbsp;    public List&lt;ProjectFilterDTO&gt; getActiveProjectsForUser(Long userId) {
<b class="nc">&nbsp;        return projectRepository.findActiveProjectsByUser(userId);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Map&lt;String, Object&gt; getProgress(Long projectId) {
&nbsp;        try {
<b class="nc">&nbsp;            return projectRepository.getProjectProgress(projectId);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            System.err.println(&quot;Error fetching progress for project &quot; + projectId + &quot;: &quot; + e.getMessage());</b>
<b class="nc">&nbsp;            return Map.of(</b>
<b class="nc">&nbsp;                    &quot;percent_done_by_status&quot;, 0,</b>
<b class="nc">&nbsp;                    &quot;percent_done_by_checklist&quot;, 0</b>
&nbsp;            );
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Map&lt;String, Object&gt; getMetrics(Long projectId) {
&nbsp;        try {
<b class="nc">&nbsp;            return projectRepository.getProjectMetrics(projectId);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            System.err.println(&quot;Error fetching metrics for project &quot; + projectId + &quot;: &quot; + e.getMessage());</b>
<b class="nc">&nbsp;            return Map.of(</b>
<b class="nc">&nbsp;                    &quot;totalTasks&quot;, 0,</b>
<b class="nc">&nbsp;                    &quot;completedTasks&quot;, 0,</b>
<b class="nc">&nbsp;                    &quot;overdueTasks&quot;, 0,</b>
<b class="nc">&nbsp;                    &quot;activeTasks&quot;, 0</b>
&nbsp;            );
&nbsp;        }
&nbsp;    }
&nbsp;    @Override
&nbsp;    public Page&lt;ProjectMember&gt; getProjectsByUserSorted(User user, String role, Pageable pageable) {
<b class="nc">&nbsp;        if (&quot;manager&quot;.equalsIgnoreCase(role)) {</b>
<b class="nc">&nbsp;            return projectMemberRepository.findByUserSortedByManager(user, pageable);</b>
<b class="nc">&nbsp;        } else if (&quot;member&quot;.equalsIgnoreCase(role)) {</b>
<b class="nc">&nbsp;            return projectMemberRepository.findByUserSortedByMember(user, pageable);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return projectMemberRepository.findByUser(user, pageable);</b>
&nbsp;        }
&nbsp;    }
&nbsp;    @Override
&nbsp;    public Page&lt;ProjectSummaryDTO&gt; getProjectsByUserPaginated(String email, int page, int size) {
<b class="nc">&nbsp;        Pageable pageable = PageRequest.of(page, size);</b>
<b class="nc">&nbsp;        return projectRepository.findByUserEmail(email, pageable)</b>
<b class="nc">&nbsp;                .map(p -&gt; new ProjectSummaryDTO(</b>
<b class="nc">&nbsp;                        p.getProjectId(),</b>
<b class="nc">&nbsp;                        p.getName(),</b>
<b class="nc">&nbsp;                        p.getDescription(),</b>
<b class="nc">&nbsp;                        p.getStartDate(),</b>
<b class="nc">&nbsp;                        p.getDueDate(),</b>
<b class="nc">&nbsp;                        p.getStatus(),</b>
<b class="nc">&nbsp;                        p.getPriority()</b>
&nbsp;                ));
&nbsp;    }
&nbsp;    @Override
&nbsp;    public boolean existsByNameAndCreatedBy_UserId(String name, Long createdById) {
<b class="nc">&nbsp;        if (name == null || createdById == null) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;        // normalize name to avoid case-sensitive duplicates
<b class="nc">&nbsp;        return projectRepository.existsByNameIgnoreCaseAndCreatedBy_UserId(name.trim(), createdById);</b>
&nbsp;    }
&nbsp;    @Override
&nbsp;    public long countAll(){
<b class="nc">&nbsp;        return projectRepository.count();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public long countByStatus(String status){
<b class="nc">&nbsp;        return projectRepository.countByStatus(status);</b>
&nbsp;    }
&nbsp;}
&nbsp;
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-11-12 20:35</div>
</div>
</body>
</html>
