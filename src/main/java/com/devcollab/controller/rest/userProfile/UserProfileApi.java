package com.devcollab.controller.rest.userProfile;


import com.devcollab.dto.UserProfileDto.AvatarUploadResponseDto;
import com.devcollab.dto.UserProfileDto.UserPatchDto;
import com.devcollab.dto.UserProfileDto.UserProfileDto;
import com.devcollab.service.userprofileService.UserProfileService;
import jakarta.servlet.http.HttpServletRequest;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;

@RestController
@RequestMapping("/api/profile")
@RequiredArgsConstructor
public class UserProfileApi {

    private final UserProfileService userProfileService;

    @GetMapping("/me/profile")
    public ResponseEntity<UserProfileDto> getMyProfile(
            @RequestAttribute("userId") Long myUserId
    ) {
        return ResponseEntity.ok(userProfileService.getMyProfile(myUserId));
    }

    // üëÄ 2. Xem profile ng∆∞·ªùi kh√°c
    @GetMapping("/{id}/profile")
    public ResponseEntity<UserProfileDto> getUserProfile(@PathVariable Long id) {
        return ResponseEntity.ok(userProfileService.getOtherUserProfile(id));
    }

    //3. C·∫≠p nh·∫≠t profile c√° nh√¢n
    @PatchMapping(value = "/me", consumes = MediaType.APPLICATION_JSON_VALUE)
    public ResponseEntity<UserProfileDto> updateMyProfile(
            @RequestAttribute("userId") Long myUserId,
            @RequestBody UserPatchDto patchDto) { // <-- Nh·∫≠n DTO t·ª´ JSON body

        try {
            UserProfileDto updatedProfile = userProfileService.updateMyProfile(myUserId, patchDto);
            return ResponseEntity.ok(updatedProfile);
        } catch (RuntimeException e) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).build(); // VD: User kh√¥ng t·ªìn t·∫°i
        }
    }

    //4. C·∫≠p nh·∫≠t avatar
    @PostMapping(value = "/me/avatar", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity<?> uploadMyAvatar(
            @RequestAttribute("userId") Long myUserId,
            @RequestParam("avatar") MultipartFile avatarFile) { // <-- Nh·∫≠n file

        try {
            String newAvatarUrl = userProfileService.updateMyAvatar(myUserId, avatarFile);

            // Tr·∫£ v·ªÅ DTO ch·ª©a URL m·ªõi
            return ResponseEntity.ok(new AvatarUploadResponseDto(newAvatarUrl));

        } catch (IOException e) {
            // L·ªói upload file
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body("File upload failed: " + e.getMessage());
        } catch (RuntimeException e) {
            // L·ªói nghi·ªáp v·ª• (VD: User kh√¥ng t√¨m th·∫•y, file r·ªóng)
            return ResponseEntity.status(HttpStatus.BAD_REQUEST)
                    .body(e.getMessage());
        }
    }
}
