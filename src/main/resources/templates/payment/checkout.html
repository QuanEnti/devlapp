<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thanh to√°n - DevCollab</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">
<div th:replace="fragments/header :: header"></div>

<div class="max-w-3xl mx-auto bg-white mt-20 p-8 rounded-2xl shadow text-center transition-all duration-300" id="checkoutContainer">
    <h2 class="text-2xl font-bold text-blue-600 mb-2">Thanh to√°n ƒë∆°n h√†ng</h2>
    <p class="text-gray-600">M√£ ƒë∆°n h√†ng: <b>DH<span th:text="${order.id}"></span></b></p>
    <p class="mt-2">G√≥i: <span th:text="${order.name}"></span></p>
    <p class="text-lg font-semibold mt-2">S·ªë ti·ªÅn: <span th:text="${order.total}"></span>ƒë</p>

    <!-- ‚úÖ Box ch·ªù thanh to√°n -->
    <div id="checkout_box" class="mt-6 transition-opacity duration-500">
        <p class="font-medium text-gray-700 mb-3">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</p>
        <img th:src="'https://qr.sepay.vn/img?bank=MBBank&acc=VQRQAFBAZ4975&template=compact&amount=' + ${order.total.intValue()} + '&des=DH' + ${order.id}"
             class="mx-auto w-60 border p-2 rounded-lg shadow">

        <p class="mt-4 text-gray-500">Gi·ªØ nguy√™n n·ªôi dung chuy·ªÉn kho·∫£n: <b>DH<span th:text="${order.id}"></span></b></p>
        <p class="text-gray-600 mt-3">Tr·∫°ng th√°i:
            <span id="statusText" class="text-yellow-500 font-medium">‚è≥ Ch·ªù thanh to√°n...</span>
        </p>

        <div class="mt-5 text-sm text-gray-400">
            Trang s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t sau khi b·∫°n chuy·ªÉn ti·ªÅn th√†nh c√¥ng.
        </div>
    </div>

    <!-- ‚úÖ Box thanh to√°n th√†nh c√¥ng -->
    <div id="success_box" class="hidden mt-10 text-green-600 animate-fadeIn">
        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto mb-3" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h3 class="text-2xl font-semibold">‚úÖ Thanh to√°n th√†nh c√¥ng!</h3>
        <p class="text-gray-700 mt-2">C·∫£m ∆°n b·∫°n ƒë√£ n√¢ng c·∫•p t√†i kho·∫£n DevCollab Premium üéâ</p>
        <p class="text-gray-500 mt-1 text-sm">B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn v·ªÅ trang h·ªì s∆° sau 3 gi√¢y...</p>

        <div class="mt-6">
            <a href="/user/view/profile"
               class="inline-block bg-blue-500 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-600 transition">
                üë§ Quay v·ªÅ h·ªì s∆°
            </a>
        </div>
    </div>
</div>

<script th:inline="javascript">
    // ‚úÖ L·∫•y orderId t·ª´ Thymeleaf
    const orderId = [[${order.id}]];

    async function checkStatus() {
        try {
            const res = await fetch("/api/payment/check-status", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ order_id: orderId })
            });

            const data = await res.json();
            console.log("üßæ Status:", data);

            if (data.payment_status === "Paid") {
                // ·∫®n box thanh to√°n, hi·ªán success
                document.getElementById("checkout_box").classList.add("hidden");
                document.getElementById("success_box").classList.remove("hidden");
                document.getElementById("statusText").textContent = "‚úÖ Thanh to√°n th√†nh c√¥ng!";

                // T·ª± chuy·ªÉn h∆∞·ªõng sau 3 gi√¢y
                setTimeout(() => {
                    window.location.href = "/user/view/profile";
                }, 3000);
            }
        } catch (e) {
            console.error("L·ªói khi ki·ªÉm tra tr·∫°ng th√°i:", e);
        }
    }

    // ‚úÖ Ki·ªÉm tra tr·∫°ng th√°i m·ªói 2 gi√¢y
    setInterval(checkStatus, 2000);
</script>

<!-- Hi·ªáu ·ª©ng nh·ªè -->
<style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
        animation: fadeIn 0.6s ease-out forwards;
    }
</style>
</body>
</html>
