<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Payment - DevCollab</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 font-sans">
    <div th:replace="fragments/header :: header"></div>

    <div
      class="max-w-3xl mx-auto bg-white mt-20 p-8 rounded-2xl shadow text-center transition-all duration-300"
      id="checkoutContainer"
    >
      <h2 class="text-2xl font-bold text-blue-600 mb-2">Order Payment</h2>
      <p class="text-gray-600">
        Order Code: <b>DH<span th:text="${order.id}"></span></b>
      </p>
      <p class="mt-2">Plan: <span th:text="${order.name}"></span></p>
      <br />
      <p class="mb-4">
        <span
          class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full font-semibold text-sm"
        >
          $1.00 / month
        </span>
      </p>

      <!-- ‚úÖ Payment Pending Box -->
      <div id="checkout_box" class="mt-6 transition-opacity duration-500">
        <p class="font-medium text-gray-700 mb-3">
          Scan the QR code to complete your payment
        </p>

        <img
          th:src="'https://qr.sepay.vn/img?bank=MBBank&acc=VQRQAFBAZ4975&template=compact&amount=' + ${order.total.intValue()} + '&des=DH' + ${order.id}"
          class="mx-auto w-60 border p-2 rounded-lg shadow"
        />

        <p class="mt-4 text-gray-500">
          Keep the transfer description unchanged:
          <b>DH<span th:text="${order.id}"></span></b>
        </p>

        <p class="text-gray-600 mt-3">
          Status:
          <span id="statusText" class="text-yellow-500 font-medium"
            >‚è≥ Waiting for payment...</span
          >
        </p>

        <div class="mt-5 text-sm text-gray-400">
          This page will automatically update once your payment is confirmed.
        </div>
      </div>

      <!-- ‚úÖ Payment Success Box -->
      <div id="success_box" class="hidden mt-10 text-green-600 animate-fadeIn">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="mx-auto mb-3"
          width="64"
          height="64"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>

        <h3 class="text-2xl font-semibold">‚úÖ Payment Successful!</h3>
        <p class="text-gray-700 mt-2">
          Thank you for upgrading to DevCollab Premium üéâ
        </p>
        <p class="text-gray-500 mt-1 text-sm">
          You will be redirected to your profile in 3 seconds...
        </p>

        <div class="mt-6">
          <a
            href="/user/view/profile"
            class="inline-block bg-blue-500 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-600 transition"
          >
            üë§ Back to Profile
          </a>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      const orderId = [[${order.id}]];

      async function checkStatus() {
          try {
              const res = await fetch("/api/payment/check-status", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ order_id: orderId })
              });

              const data = await res.json();
              console.log("üßæ Status:", data);

              if (data.payment_status === "Paid") {
                  document.getElementById("checkout_box").classList.add("hidden");
                  document.getElementById("success_box").classList.remove("hidden");
                  document.getElementById("statusText").textContent = "‚úÖ Payment Successful!";

                  setTimeout(() => {
                      window.location.href = "/user/view/profile";
                  }, 3000);
              }
          } catch (e) {
              console.error("Error checking payment status:", e);
          }
      }

      setInterval(checkStatus, 2000);
    </script>

    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fadeIn {
        animation: fadeIn 0.6s ease-out forwards;
      }
    </style>
  </body>
</html>
