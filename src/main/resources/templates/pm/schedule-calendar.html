<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Project Schedule</title>
</head>
<body class="bg-gray-50">

<div th:replace="fragments/header :: header"></div>

<div class="flex min-h-[calc(100vh-4rem)]">
    <div th:replace="fragments/sidebar :: sidebar"></div>

    <main class="flex-1 p-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">ðŸ“… Project Schedule</h1>
                <p class="text-gray-600 text-sm" th:text="'Project: ' + ${project.name}"></p>
                <div class="mt-1">
                    <span id="userRoleBadge" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        bg-blue-100 text-blue-800" th:text="${userRole} + ' Role'">
                    </span>
                </div>
            </div>
            <button id="createScheduleBtn" onclick="openCreateModal()"
                    class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 text-sm">
                <i class="fas fa-plus"></i>
                Create Schedule
            </button>
        </div>

        <!-- Calendar Navigation -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4 mb-6">
            <div class="flex justify-between items-center mb-3">
                <button onclick="changeMonth(-1)" class="p-1 hover:bg-gray-100 rounded-lg text-gray-600">
                    <i class="fas fa-chevron-left text-sm"></i>
                </button>

                <h2 class="text-lg font-bold text-gray-800" id="currentMonth">
                    October 2024
                </h2>

                <button onclick="changeMonth(1)" class="p-1 hover:bg-gray-100 rounded-lg text-gray-600">
                    <i class="fas fa-chevron-right text-sm"></i>
                </button>
            </div>

            <!-- Calendar Grid -->
            <div class="grid grid-cols-7 gap-1 mb-1">
                <div class="text-center font-semibold text-gray-500 py-1 text-xs">SUN</div>
                <div class="text-center font-semibold text-gray-500 py-1 text-xs">MON</div>
                <div class="text-center font-semibold text-gray-500 py-1 text-xs">TUE</div>
                <div class="text-center font-semibold text-gray-500 py-1 text-xs">WED</div>
                <div class="text-center font-semibold text-gray-500 py-1 text-xs">THU</div>
                <div class="text-center font-semibold text-gray-500 py-1 text-xs">FRI</div>
                <div class="text-center font-semibold text-gray-500 py-1 text-xs">SAT</div>
            </div>

            <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                <!-- Calendar days will be populated by JavaScript -->
            </div>
        </div>

        <!-- Day Schedule Section -->
        <div id="daySchedule" class="bg-white rounded-lg shadow-sm border border-slate-200 p-4 hidden">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-semibold text-gray-800" id="selectedDateTitle">
                    Schedule for October 15, 2024
                </h3>
                <button onclick="closeDayView()" class="text-gray-500 hover:text-gray-700 text-sm">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="scheduleList" class="space-y-3">
                <!-- Schedules will be populated here -->
            </div>
        </div>
    </main>
</div>

<!-- Create/Edit Schedule Modal -->
<div id="scheduleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold" id="modalTitle">Create Schedule</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="scheduleForm" class="space-y-4" novalidate>
            <input type="hidden" id="scheduleId">
            <input type="hidden" id="selectedDate">

            <!-- Title Field -->
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-1">
                    Title *
                </label>
                <input id="title" name="title" type="text" required
                       maxlength="200"
                       class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 transition-colors text-sm"
                       placeholder="Enter schedule title">
                <div class="flex justify-between items-center mt-1">
                    <div id="titleError" class="text-red-600 text-xs hidden">
                        Please enter a title
                    </div>
                    <div id="titleCounter" class="text-gray-500 text-xs">
                        <span id="titleLength">0</span>/200
                    </div>
                </div>
            </div>

            <!-- Date and Time Fields -->
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700 mb-1">
                        Date *
                    </label>
                    <input id="date" name="date" type="date" required
                           class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 transition-colors text-sm">
                    <div id="dateError" class="text-red-600 text-xs mt-1 hidden">
                        Please select a valid future date
                    </div>
                </div>
                <div>
                    <label for="time" class="block text-sm font-medium text-gray-700 mb-1">
                        Time *
                    </label>
                    <input id="time" name="time" type="time" required
                           class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 transition-colors text-sm">
                    <div id="timeError" class="text-red-600 text-xs mt-1 hidden">
                        Please select a valid time
                    </div>
                </div>
            </div>

            <!-- Meeting Link Field -->
            <div>
                <label for="meetingLink" class="block text-sm font-medium text-gray-700 mb-1">
                    Google Meet Link
                </label>
                <input id="meetingLink" name="meetingLink" type="url"
                       pattern="https?://.+"
                       class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 transition-colors text-sm"
                       placeholder="https://meet.google.com/xxx-xxxx-xxx">
                <div id="meetingLinkError" class="text-red-600 text-xs mt-1 hidden">
                    Please enter a valid URL starting with http:// or https://
                </div>
            </div>

            <!-- Note Field -->
            <div>
                <label for="note" class="block text-sm font-medium text-gray-700 mb-1">
                    Note
                </label>
                <textarea id="note" name="note" rows="3"
                          maxlength="1000"
                          class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 transition-colors resize-vertical text-sm"
                          placeholder="Add notes about this schedule (optional)"></textarea>
                <div class="flex justify-between items-center mt-1">
                    <div id="noteError" class="text-red-600 text-xs hidden">
                        Note cannot exceed 1000 characters
                    </div>
                    <div id="noteCounter" class="text-gray-500 text-xs">
                        <span id="noteLength">0</span>/1000
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end gap-2 pt-3 border-t border-gray-200">
                <button type="button" onclick="closeModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors font-medium text-sm">
                    Cancel
                </button>
                <button type="submit" id="submitButton"
                        class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-semibold transition-colors disabled:bg-teal-400 disabled:cursor-not-allowed text-sm">
                    Save Schedule
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth();
    const projectId = new URLSearchParams(window.location.search).get("projectId");
    let userRole = ''; // Will be set from server-side
    let isProjectManager = false;
    let isMember = false;

    // Initialize calendar
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Project ID:', projectId);
        if (!projectId) {
            alert('Error: Project ID not found');
            return;
        }
        const roleBadge = document.getElementById('userRoleBadge');
        console.log("Role Badge Element:", roleBadge);
        if (roleBadge) {
            userRole = roleBadge.textContent.replace(' Role', '').trim();
            console.log('User Role from badge:', userRole);
        }

        // Alternative: If no badge, try to get from Thymeleaf data attribute
        if (!userRole) {
            const roleElement = document.querySelector('[data-user-role]');
            if (roleElement) {
                userRole = roleElement.getAttribute('data-user-role');
                console.log('User Role from data attribute:', userRole);
            }
        }

        isProjectManager = userRole === 'PM' || userRole === 'PROJECT_MANAGER';
        isMember = userRole === 'Member' || userRole === 'MEMBER';

        // Apply role-based UI restrictions
        applyRoleBasedRestrictions();

        renderCalendar();
        loadScheduledDates();
        initializeFormValidation();
    });

    function applyRoleBasedRestrictions() {
        const createBtn = document.getElementById('createScheduleBtn');

        if (isProjectManager) {
            // PM can do everything - no changes needed
            console.log('User is Project Manager - full access granted');
        } else if (isMember) {
            // Member - hide create button and show view-only message
            if (createBtn) {
                createBtn.style.display = 'none';
            }
            console.log('User is Member - view-only access');

            // Show view-only indicator
            const headerDiv = document.querySelector('.flex.justify-between.items-center.mb-6 div');
            if (headerDiv) {
                const viewOnlyBadge = document.createElement('span');
                viewOnlyBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 ml-2';
                viewOnlyBadge.textContent = 'View Only';
                headerDiv.appendChild(viewOnlyBadge);
            }
        } else {
            // Unknown role - restrict access
            if (createBtn) {
                createBtn.style.display = 'none';
            }
            console.log('Unknown user role - restricting access');
            alert('You do not have permission to access this project schedule.');
        }
    }

    function canModifySchedule() {
        if (isProjectManager) {
            return true;
        }

        if (isMember) {
            alert('Members can only view schedules. Please contact the Project Manager to make changes.');
            return false;
        }

        alert('You do not have permission to modify schedules.');
        return false;
    }

    // Form Validation Functions
    function initializeFormValidation() {
        const form = document.getElementById('scheduleForm');
        const inputs = form.querySelectorAll('input, textarea');

        inputs.forEach(input => {
            input.addEventListener('blur', validateField);
            input.addEventListener('input', validateField);

            if (input.name === 'note') {
                input.addEventListener('input', updateNoteCounter);
            }
            if (input.name === 'title') {
                input.addEventListener('input', updateTitleValidation);
            }
            if (input.name === 'date' || input.name === 'time') {
                input.addEventListener('change', validateDateTime);
            }
        });

        updateNoteCounter();
        updateTitleValidation();
    }

    function validateField(event) {
        const field = event.target;
        const errorElement = document.getElementById(field.name + 'Error');

        field.classList.remove('border-red-500', 'border-green-500');
        if (errorElement) errorElement.classList.add('hidden');

        if (!field.value.trim() && !field.required) {
            return true;
        }

        let isValid = true;
        let errorMessage = '';

        switch (field.name) {
            case 'title':
                // Only check if title is not empty, no minimum length requirement
                if (!field.value.trim()) {
                    isValid = false;
                    errorMessage = 'Please enter a title';
                }
                break;

            case 'date':
                if (!field.value) {
                    isValid = false;
                    errorMessage = 'Date is required';
                } else {
                    const selectedDate = new Date(field.value);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    if (selectedDate < today) {
                        isValid = false;
                        errorMessage = 'Please select a future date';
                    }
                }
                break;

            case 'time':
                if (!field.value) {
                    isValid = false;
                    errorMessage = 'Time is required';
                }
                break;

            case 'meetingLink':
                if (field.value && !isValidUrl(field.value)) {
                    isValid = false;
                    errorMessage = 'Please enter a valid URL starting with http:// or https://';
                }
                break;

            case 'note':
                if (field.value.length > 1000) {
                    isValid = false;
                    errorMessage = 'Note cannot exceed 1000 characters';
                }
                break;
        }

        if (!isValid) {
            field.classList.add('border-red-500');
            if (errorElement) {
                errorElement.textContent = errorMessage;
                errorElement.classList.remove('hidden');
            }
        } else {
            field.classList.add('border-green-500');
        }

        updateSubmitButton();
        return isValid;
    }

    function updateTitleValidation() {
        const titleField = document.getElementById('title');
        const titleLength = document.getElementById('titleLength');
        const titleCounter = document.getElementById('titleCounter');
        const currentLength = titleField.value.length;

        titleLength.textContent = currentLength;

        if (currentLength > 190) {
            titleCounter.classList.add('text-orange-500');
            titleCounter.classList.remove('text-gray-500', 'text-red-500');
        } else if (currentLength > 200) {
            titleCounter.classList.add('text-red-500');
            titleCounter.classList.remove('text-gray-500', 'text-orange-500');
        } else {
            titleCounter.classList.add('text-gray-500');
            titleCounter.classList.remove('text-orange-500', 'text-red-500');
        }
    }

    function validateDateTime() {
        const dateField = document.getElementById('date');
        const timeField = document.getElementById('time');

        if (dateField.value && timeField.value) {
            const selectedDateTime = new Date(dateField.value + 'T' + timeField.value);
            const now = new Date();

            if (selectedDateTime <= now) {
                dateField.classList.add('border-red-500');
                timeField.classList.add('border-red-500');
                document.getElementById('dateError').textContent = 'Please select a future date and time';
                document.getElementById('dateError').classList.remove('hidden');
                return false;
            } else {
                dateField.classList.remove('border-red-500');
                timeField.classList.remove('border-red-500');
                document.getElementById('dateError').classList.add('hidden');
            }
        }

        return true;
    }

    function isValidUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }

    function updateNoteCounter() {
        const noteField = document.getElementById('note');
        const noteLength = document.getElementById('noteLength');
        const noteCounter = document.getElementById('noteCounter');

        const length = noteField.value.length;
        noteLength.textContent = length;

        if (length > 900) {
            noteCounter.classList.add('text-orange-500');
            noteCounter.classList.remove('text-gray-500', 'text-red-500');
        } else if (length > 1000) {
            noteCounter.classList.add('text-red-500');
            noteCounter.classList.remove('text-gray-500', 'text-orange-500');
        } else {
            noteCounter.classList.add('text-gray-500');
            noteCounter.classList.remove('text-orange-500', 'text-red-500');
        }
    }

    function updateSubmitButton() {
        const submitButton = document.getElementById('submitButton');
        const form = document.getElementById('scheduleForm');
        const requiredFields = form.querySelectorAll('[required]');

        let allValid = true;

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                allValid = false;
            }
        });

        if (!validateDateTime()) {
            allValid = false;
        }

        const errorFields = form.querySelectorAll('.border-red-500');
        if (errorFields.length > 0) {
            allValid = false;
        }

        submitButton.disabled = !allValid;
    }

    function validateForm() {
        const form = document.getElementById('scheduleForm');
        const fields = form.querySelectorAll('input[required], textarea[required]');
        let isValid = true;

        fields.forEach(field => {
            if (!validateField({ target: field })) {
                isValid = false;
            }
        });

        if (!validateDateTime()) {
            isValid = false;
        }

        return isValid;
    }

    function resetFormValidation() {
        const form = document.getElementById('scheduleForm');
        const fields = form.querySelectorAll('input, textarea');
        const errorMessages = form.querySelectorAll('[id$="Error"]');

        fields.forEach(field => {
            field.classList.remove('border-red-500', 'border-green-500');
        });

        errorMessages.forEach(error => {
            error.classList.add('hidden');
        });

        updateSubmitButton();
    }

    // Compact Calendar Functions
    function renderCalendar() {
        const calendarGrid = document.getElementById('calendarGrid');
        calendarGrid.innerHTML = '';

        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const startingDay = firstDay.getDay();
        const monthLength = lastDay.getDate();

        document.getElementById('currentMonth').textContent =
            firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        // Add empty cells for days before the first day of month
        for (let i = 0; i < startingDay; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'h-16 border rounded bg-gray-50';
            calendarGrid.appendChild(emptyCell);
        }

        // Add days of the month
        for (let day = 1; day <= monthLength; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'h-16 border rounded p-1 cursor-pointer hover:bg-gray-50 transition-colors text-sm';
            dayCell.onclick = () => selectDate(day);

            const date = new Date(currentYear, currentMonth, day);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const isToday = date.toDateString() === today.toDateString();

            dayCell.innerHTML = `
                <div class="flex justify-between items-start h-full">
                    <div class="flex-1">
                        <span class="text-xs font-medium ${isToday ? 'bg-teal-500 text-white rounded-full w-5 h-5 flex items-center justify-center' : 'text-gray-700'}">
                            ${day}
                        </span>
                        <div class="schedule-previews mt-0.5 text-xs text-gray-500 space-y-0.5 overflow-hidden max-h-10"
                             id="previews-${currentYear}-${currentMonth + 1}-${day}">
                        </div>
                    </div>
                    <div class="schedule-dots flex gap-0.5" id="dots-${currentYear}-${currentMonth + 1}-${day}">
                    </div>
                </div>
            `;

            calendarGrid.appendChild(dayCell);
        }

        loadScheduledDates();
    }

    function changeMonth(direction) {
        currentMonth += direction;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        } else if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar();
    }

    async function loadScheduledDates() {
        try {
            console.log('Loading scheduled dates for project:', projectId);
            const response = await fetch(`/api/projects/${projectId}/schedule`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Scheduled dates response:', data);

            if (data && Array.isArray(data)) {
                data.forEach(schedule => {
                    const scheduleDate = new Date(schedule.datetime);

                    if (scheduleDate.getFullYear() === currentYear && scheduleDate.getMonth() === currentMonth) {
                        const day = scheduleDate.getDate();
                        const previewsContainer = document.getElementById(`previews-${currentYear}-${currentMonth + 1}-${day}`);

                        if (previewsContainer && previewsContainer.children.length < 2) {
                            const timeString = scheduleDate.toLocaleTimeString('en-US', {
                                hour: 'numeric',
                                minute: '2-digit',
                                hour12: true
                            });

                            const preview = document.createElement('div');
                            preview.className = 'truncate text-teal-600 bg-teal-50 px-1 py-0.5 rounded text-xs';
                            preview.title = `${schedule.title} at ${timeString}`;
                            preview.textContent = `${timeString} ${schedule.title.substring(0, 8)}${schedule.title.length > 8 ? '...' : ''}`;

                            previewsContainer.appendChild(preview);
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error loading scheduled dates:', error);
        }
    }

    async function selectDate(day) {
        const selectedDate = new Date(currentYear, currentMonth, day);

        const year = selectedDate.getFullYear();
        const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
        const date = String(selectedDate.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${date}`;

        document.getElementById('selectedDateTitle').textContent =
            `Schedule for ${selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}`;

        await loadDaySchedules(dateString);
        document.getElementById('daySchedule').classList.remove('hidden');
    }

    async function loadDaySchedules(date) {
        try {
            console.log('Loading day schedules for project:', projectId, 'date:', date);
            const response = await fetch(`/api/projects/${projectId}/schedule/date/${date}`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Day schedules response:', data);

            const scheduleList = document.getElementById('scheduleList');
            scheduleList.innerHTML = '';

            if (data.success && data.data.length > 0) {
                data.data.forEach(schedule => {
                    const scheduleDate = new Date(schedule.datetime);
                    const scheduleTime = scheduleDate.toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });

                    const scheduleElement = document.createElement('div');
                    scheduleElement.className = 'border-l-3 border-teal-500 bg-teal-50 p-3 rounded-r';

                    // Only show action buttons for Project Managers
                    const actionButtons = isProjectManager ? `
                        <div class="flex gap-1">
                            <button onclick="editSchedule(${schedule.scheduleId})"
                                    class="text-blue-600 hover:text-blue-800 p-0.5 rounded hover:bg-blue-50 text-xs"
                                    title="Edit schedule">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSchedule(${schedule.scheduleId})"
                                    class="text-red-600 hover:text-red-800 p-0.5 rounded hover:bg-red-50 text-xs"
                                    title="Delete schedule">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    ` : '';

                    scheduleElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 text-sm">${schedule.title}</h4>
                                <p class="text-xs text-gray-600 mt-0.5">
                                    <i class="fas fa-clock mr-1"></i>${scheduleTime}
                                </p>
                                ${schedule.note ? `<p class="text-xs text-gray-600 mt-1">${schedule.note}</p>` : ''}
                                ${schedule.meetingLink ? `
                                    <a href="${schedule.meetingLink}" target="_blank"
                                       class="text-xs text-blue-600 hover:text-blue-800 mt-1 inline-block">
                                        <i class="fas fa-video mr-0.5"></i>Join Meeting
                                    </a>
                                ` : ''}
                            </div>
                            ${actionButtons}
                        </div>
                    `;
                    scheduleList.appendChild(scheduleElement);
                });
            } else {
                // Only show create button for Project Managers
                const createButton = isProjectManager ? `
                    <button onclick="openCreateModal(${new Date(currentYear, currentMonth, parseInt(date.split('-')[2])).getDate()})"
                            class="mt-2 text-teal-600 hover:text-teal-700 text-xs font-medium">
                        <i class="fas fa-plus mr-0.5"></i>Create a schedule
                    </button>
                ` : '';

                scheduleList.innerHTML = `
                    <div class="text-center text-gray-500 py-6">
                        <i class="fas fa-calendar-day text-2xl mb-2 text-gray-300"></i>
                        <p class="text-gray-400 text-sm">No schedules for this day</p>
                        ${createButton}
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading day schedules:', error);
            scheduleList.innerHTML = `
                <div class="text-center text-red-500 py-6">
                    <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
                    <p class="text-sm">Error loading schedules</p>
                </div>
            `;
        }
    }

    function closeDayView() {
        document.getElementById('daySchedule').classList.add('hidden');
    }

    function openCreateModal(selectedDay = null) {
        if (!canModifySchedule()) {
            return;
        }

        document.getElementById('modalTitle').textContent = 'Create Schedule';
        document.getElementById('scheduleForm').reset();
        document.getElementById('scheduleId').value = '';
        resetFormValidation();

        const today = new Date();
        let defaultDate;

        if (selectedDay) {
            defaultDate = new Date(currentYear, currentMonth, selectedDay);
        } else {
            defaultDate = today;
        }

        const year = defaultDate.getFullYear();
        const month = String(defaultDate.getMonth() + 1).padStart(2, '0');
        const day = String(defaultDate.getDate()).padStart(2, '0');
        document.getElementById('date').value = `${year}-${month}-${day}`;

        const nextHour = today.getHours() + 1;
        document.getElementById('time').value = `${nextHour.toString().padStart(2, '0')}:00`;

        document.getElementById('scheduleModal').classList.remove('hidden');

        setTimeout(() => {
            validateForm();
        }, 100);
    }

    function closeModal() {
        document.getElementById('scheduleModal').classList.add('hidden');
        resetFormValidation();
    }

    async function editSchedule(scheduleId) {
        if (!canModifySchedule()) {
            return;
        }

        try {
            const response = await fetch(`/api/projects/${projectId}/schedule/${scheduleId}`);
            const data = await response.json();

            if (data.success) {
                const schedule = data.data;
                const scheduleDate = new Date(schedule.datetime);

                document.getElementById('modalTitle').textContent = 'Edit Schedule';
                document.getElementById('scheduleId').value = schedule.scheduleId;
                document.getElementById('title').value = schedule.title;

                const year = scheduleDate.getFullYear();
                const month = String(scheduleDate.getMonth() + 1).padStart(2, '0');
                const day = String(scheduleDate.getDate()).padStart(2, '0');
                document.getElementById('date').value = `${year}-${month}-${day}`;

                const hours = String(scheduleDate.getHours()).padStart(2, '0');
                const minutes = String(scheduleDate.getMinutes()).padStart(2, '0');
                document.getElementById('time').value = `${hours}:${minutes}`;

                document.getElementById('meetingLink').value = schedule.meetingLink || '';
                document.getElementById('note').value = schedule.note || '';

                document.getElementById('scheduleModal').classList.remove('hidden');

                setTimeout(() => {
                    validateForm();
                    updateNoteCounter();
                    updateTitleValidation();
                }, 100);
            }
        } catch (error) {
            console.error('Error loading schedule:', error);
            alert('Error loading schedule');
        }
    }

    async function deleteSchedule(scheduleId) {
        if (!canModifySchedule()) {
            return;
        }

        if (!confirm('Are you sure you want to delete this schedule?')) return;

        try {
            const response = await fetch(`/api/projects/${projectId}/schedule/${scheduleId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                alert('Schedule deleted successfully');
                const selectedDate = document.getElementById('selectedDateTitle').textContent;
                const dateMatch = selectedDate.match(/(\w+) (\d+), (\d+)/);
                if (dateMatch) {
                    const date = new Date(`${dateMatch[1]} ${dateMatch[2]}, ${dateMatch[3]}`);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    loadDaySchedules(`${year}-${month}-${day}`);
                }
                renderCalendar();
            } else {
                alert('Error deleting schedule: ' + data.message);
            }
        } catch (error) {
            console.error('Error deleting schedule:', error);
            alert('Error deleting schedule');
        }
    }

    // Handle form submission
    document.getElementById('scheduleForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!validateForm()) {
            alert('Please fix the validation errors before submitting.');
            return;
        }

        const scheduleId = document.getElementById('scheduleId').value;
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value;
        const datetime = `${date}T${time}`;

        const payload = {
            title: document.getElementById('title').value.trim(),
            datetime: datetime,
            meetingLink: document.getElementById('meetingLink').value.trim(),
            note: document.getElementById('note').value.trim()
        };

        try {
            const url = scheduleId
                ? `/api/projects/${projectId}/schedule/${scheduleId}`
                : `/api/projects/${projectId}/schedule`;

            const method = scheduleId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (data.success) {
                alert(scheduleId ? 'Schedule updated successfully!' : 'Schedule created successfully!');
                closeModal();
                renderCalendar();

                if (!document.getElementById('daySchedule').classList.contains('hidden')) {
                    const selectedDate = document.getElementById('selectedDateTitle').textContent;
                    const dateMatch = selectedDate.match(/(\w+) (\d+), (\d+)/);
                    if (dateMatch) {
                        const date = new Date(`${dateMatch[1]} ${dateMatch[2]}, ${dateMatch[3]}`);
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        loadDaySchedules(`${year}-${month}-${day}`);
                    }
                }
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error saving schedule:', error);
            alert('Error saving schedule');
        }
    });
</script>

</body>
</html>