<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Members â€“ DevCollab</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.25s ease-in-out; }

        .toast {
            position: fixed; bottom: 24px; right: 24px;
            color: white; padding: 10px 16px; border-radius: 8px;
            font-size: 14px; font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            opacity: 0; animation: toastIn 0.3s ease-in-out forwards;
        }
        @keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(10px); } }
    </style>
</head>

<body class="bg-slate-50 font-sans">

<!-- âœ… Shared Header & Sidebar -->
<div th:replace="fragments/header :: header"></div>
<div class="flex min-h-[calc(100vh-4rem)]">
    <div th:replace="fragments/sidebar :: sidebar"></div>

    <!-- âœ… Main Content -->
    <main class="flex-1 p-8 overflow-y-auto bg-gray-50 animate-fadeIn">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-semibold text-gray-800 flex items-center gap-3">
                <i class="fa-solid fa-users text-blue-600"></i>
                Project Members (<span id="member-count">0</span>)
            </h1>
            <button id="backBtn"
                    class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 flex items-center gap-2 transition">
                <i class="fa-solid fa-arrow-left"></i> Back to Project
            </button>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
            <div class="flex justify-between items-center mb-4">
                <div class="relative w-64">
                    <input id="searchBox" type="text" placeholder="Search member..."
                           class="pl-9 pr-3 py-2 text-sm border rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-400 outline-none w-full transition" />
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="w-4 h-4 text-slate-400 absolute left-3 top-2.5"
                         fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 104.5 4.5a7.5 7.5 0 0012.15 12.15z" />
                    </svg>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm border-separate border-spacing-y-1">
                    <thead>
                    <tr class="text-slate-500 bg-slate-50 border-b border-slate-200">
                        <th class="text-left py-3 px-4 font-medium">Member</th>
                        <th class="text-left py-3 px-4 font-medium">Email</th>
                        <th class="text-center py-3 px-4 font-medium">Role</th>
                        <th class="text-center py-3 px-4 font-medium">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="member-table"></tbody>
                </table>
            </div>

            <div id="pagination" class="flex justify-center items-center gap-2 mt-6 text-sm"></div>
        </div>
    </main>
</div>

<!-- ðŸ—‘ï¸ Delete Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 items-center justify-center transition-opacity duration-300">
    <div class="bg-white rounded-2xl shadow-2xl w-[420px] p-6 animate-fadeIn border border-slate-200">
        <h2 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-triangle-exclamation text-red-500 text-xl"></i>
            Remove Member
        </h2>

        <div class="flex items-center gap-3 mb-5">
            <img id="deleteMemberAvatar" src="" alt="avatar" class="w-12 h-12 rounded-full border shadow-sm object-cover">
            <div>
                <p id="deleteMemberName" class="font-medium text-slate-800 text-sm"></p>
                <p id="deleteMemberEmail" class="text-sm text-slate-500"></p>
            </div>
        </div>

        <p class="text-slate-600 text-sm leading-relaxed mb-4">
            Are you sure you want to remove this member from this project?
            <span class="block text-red-500 font-medium mt-1">This action cannot be undone.</span>
        </p>

        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeDeleteModal()" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-sm font-medium transition">Cancel</button>
            <button id="confirmDeleteBtn" onclick="confirmDelete()" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 text-sm font-medium transition flex items-center gap-2">
                <i class="fa-solid fa-trash-can"></i> <span>Remove</span>
            </button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const currentUserRole = /*[[${roleInProject}]]*/ "Member"; // injected by backend
</script>

<script>
    const projectId = new URLSearchParams(window.location.search).get("projectId");
    let currentUser = null, currentMembers = [], selectedUserId = null;
    let currentPage = 0, keyword = "";

    // âœ… Load current user info
    async function loadCurrentUser() {
        try {
            const res = await fetch("/api/auth/me", { credentials: "include" });
            const data = await res.json();
            currentUser = {
                userId: data.user?.userId || data.id,
                name: data.user?.name || data.name,
                email: data.user?.email || data.email
            };
        } catch {
            currentUser = null;
        }
    }

    function showToast(msg, type = "success") {
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.style.background = type === "error" ? "#dc2626" : "#16a34a";
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = "toastOut 0.3s ease-in-out forwards";
            setTimeout(() => toast.remove(), 300);
        }, 2500);
    }

    async function loadMembers() {
        const tbody = document.getElementById("member-table");
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-6 text-slate-400 italic"><i class="fa-solid fa-spinner fa-spin"></i> Loading members...</td></tr>`;

        try {
            const res = await fetch(`/api/pm/members?projectId=${projectId}&limit=200&keyword=${encodeURIComponent(keyword)}`);
            if (!res.ok) throw new Error("Failed to load");
            const data = await res.json();
            currentMembers = data;
            document.getElementById("member-count").textContent = data.length;
            renderTable();
            renderPagination();
        } catch (err) {
            showToast(err.message, "error");
        }
    }

    function renderTable() {
        const pageSize = 8;
        const start = currentPage * pageSize;
        const list = currentMembers.slice(start, start + pageSize);
        const tbody = document.getElementById("member-table");

        if (!list.length) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center py-6 text-slate-500 italic">No members found.</td></tr>`;
            return;
        }

        tbody.innerHTML = list.map(m => {
            const profileLink = `/view/user/${m.userId}`;
            const canManage = currentUserRole.toLowerCase() === "pm" || currentUserRole.toLowerCase() === "project manager";
            const isCurrentUser = currentUser && m.userId === currentUser.userId;

            // âœ… Compute action button here safely
            let actionButton;
            if (canManage) {
                actionButton = isCurrentUser
                    ? `<button disabled class="text-gray-300 cursor-not-allowed" title="You cannot remove yourself"><i class='fa-solid fa-trash-can'></i></button>`
                    : `<button class="text-red-500 hover:text-red-700 transition" onclick="openDeleteModal(${m.userId})" title="Remove member"><i class='fa-solid fa-trash-can'></i></button>`;
            } else {
                actionButton = `<span class='text-gray-400' title='Only PM can remove members'>â€”</span>`;
            }

            return `
        <tr class="bg-white hover:bg-blue-50 transition border border-slate-100 rounded-lg">
          <td class="py-3 px-4 flex items-center gap-3">
            <a href="${profileLink}">
              <img src="${m.avatarUrl || 'https://i.pravatar.cc/100?u=' + m.userId}"
                   class="w-10 h-10 rounded-full object-cover shadow-sm hover:scale-105 transition-transform">
            </a>
            <div>
              <a href="${profileLink}" class="font-medium text-slate-700 hover:text-blue-600 transition">${m.name || 'Unnamed'}</a>
              <p class="text-sm text-slate-500">${m.email || '-'}</p>
            </div>
          </td>
          <td class="py-3 px-4 text-slate-600">${m.email || '-'}</td>
          <td class="py-3 px-4 text-center">
            <span class="px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700">${m.roleInProject || "Member"}</span>
          </td>
          <td class="py-3 px-4 text-center">${actionButton}</td>
        </tr>`;
        }).join('');
    }

    function renderPagination() {
        const totalPages = Math.ceil(currentMembers.length / 8);
        const container = document.getElementById("pagination");
        if (totalPages <= 1) return container.innerHTML = "";
        container.innerHTML = Array.from({ length: totalPages }, (_, i) =>
            `<button class="px-3 py-1 border rounded-md ${i === currentPage ? 'bg-blue-600 text-white' : 'hover:bg-blue-50'}"
         onclick="currentPage=${i};renderTable();renderPagination();">${i + 1}</button>`
        ).join('');
    }

    function openDeleteModal(userId) {
        const canManage = currentUserRole.toLowerCase() === "pm" || currentUserRole.toLowerCase() === "project manager";
        if (!canManage) {
            showToast("Only Project Managers can remove members.", "error");
            return;
        }

        const m = currentMembers.find(x => x.userId === userId);
        selectedUserId = userId;
        document.getElementById("deleteMemberAvatar").src = m.avatarUrl || `https://i.pravatar.cc/100?u=${userId}`;
        document.getElementById("deleteMemberName").textContent = m.name;
        document.getElementById("deleteMemberEmail").textContent = m.email;
        document.getElementById("deleteModal").classList.remove("hidden");
        document.getElementById("deleteModal").classList.add("flex");
    }

    function closeDeleteModal() {
        document.getElementById("deleteModal").classList.add("hidden");
        document.getElementById("deleteModal").classList.remove("flex");
    }

    async function confirmDelete() {
        const btn = document.getElementById("confirmDeleteBtn");
        btn.disabled = true;
        btn.innerHTML = `<i class='fa-solid fa-spinner fa-spin'></i> Removing...`;
        try {
            const res = await fetch(`/api/pm/members/remove-user/${selectedUserId}`, { method: "DELETE" });
            if (!res.ok) throw new Error("Failed to remove");
            closeDeleteModal();
            showToast("Member removed successfully!");
            loadMembers();
        } catch (err) {
            showToast(err.message, "error");
        } finally {
            btn.disabled = false;
            btn.innerHTML = `<i class="fa-solid fa-trash-can"></i> Remove`;
        }
    }

    document.getElementById("searchBox").addEventListener("input", e => {
        clearTimeout(window._searchDelay);
        window._searchDelay = setTimeout(() => { keyword = e.target.value.trim(); loadMembers(); }, 400);
    });

    document.getElementById("backBtn").addEventListener("click", () => {
        window.location.href = `/view/pm/project/detail?projectId=${projectId}`;
    });

    document.addEventListener("DOMContentLoaded", async () => {
        await loadCurrentUser();
        await loadMembers();
    });
</script>
</body>

<div th:replace="fragments/chatbox :: chatbox"></div>
<script th:src="@{/js/chatbox.js}"></script>
</html>
