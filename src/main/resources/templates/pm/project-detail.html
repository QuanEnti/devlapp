<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${project.name} + ' ‚Äì Project Detail'">
      Project Detail
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script th:src="@{/js/toast.js}"></script>
  </head>

  <body class="bg-[#FAFAFA] font-sans">
    <!-- Header & Sidebar -->
    <div th:replace="fragments/header :: header"></div>

    <div class="flex min-h-[calc(100vh-4rem)]">
      <div th:replace="fragments/sidebar :: sidebar"></div>

      <!-- MAIN -->
      <main class="flex-1 overflow-y-auto">
        <!-- ‚úî HEADER WITH COVER -->
        <div class="relative h-56 w-full overflow-hidden">
          <!-- Cover image -->
          <img
            id="headerCoverImg"
            th:if="${project.coverImage != null}"
            th:src="${project.coverImage}"
            class="w-full h-full object-cover"
          />

          <!-- Gradient fallback -->
          <div
            th:if="${project.coverImage == null}"
            class="w-full h-full bg-gradient-to-r from-blue-400 to-indigo-500"
          ></div>

          <!-- Dark overlay -->
          <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>

          <!-- Project title & meta -->
          <div class="absolute bottom-6 left-10">
            <h1
              class="text-4xl font-semibold text-white tracking-tight drop-shadow-md"
              th:text="${project.name}"
            >
              Project Name
            </h1>
            <p class="text-white/90 mt-1 text-sm">
              Created by
              <span class="font-medium" th:text="${project.createdBy.name}"
                >User</span
              >
            </p>
          </div>

          <!-- Edit button -->
          <button
            th:if="${currentUser != null and project.createdBy != null
                            and currentUser.userId == project.createdBy.userId}"
            id="editProjectBtn"
            class="absolute top-6 right-6 bg-white/70 hover:bg-white px-4 py-2 rounded-lg text-gray-900 font-medium text-sm shadow-sm border border-white/70 backdrop-blur-lg"
          >
            ‚úèÔ∏è Edit
          </button>
        </div>

        <!-- ‚úî FLOATING ACTION BAR -->
        <div
          class="sticky top-[4.5rem] z-20 bg-white/80 backdrop-blur-md border-b border-gray-200 px-10 py-3 flex items-center gap-3"
        >
          <a
            th:href="@{'/view/pm/project/board?projectId=' + ${project.projectId}}"
          >
            <button
              class="px-4 py-2 rounded-md bg-blue-600 text-white text-sm hover:bg-blue-700"
            >
              Kanban Board
            </button>
          </a>

          <a
            th:href="@{'/view/pm/project/members?projectId=' + ${project.projectId}}"
          >
            <button
              class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 text-sm"
            >
              Members
            </button>
          </a>

          <a
            th:href="@{'/view/pm/project/schedule/calendar?projectId=' + ${project.projectId}}"
          >
            <button
              class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 text-sm"
            >
              Calendar
            </button>
          </a>
          <a
            th:if="${#strings.equalsIgnoreCase(roleInProject, 'PM')
           or #strings.equalsIgnoreCase(roleInProject, 'Project Manager')}"
            th:href="@{'/view/pm/project/review?projectId=' + ${project.projectId}}"
          >
            <button
              class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 text-sm"
            >
              Review Tasks
            </button>
          </a>

          <a
            th:if="${#strings.equalsIgnoreCase(roleInProject, 'PM')
           or #strings.equalsIgnoreCase(roleInProject, 'Project Manager')}"
            th:href="@{'/view/pm/project/performance?projectId=' + ${project.projectId}}"
          >
            <button
              class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 text-sm"
            >
              View Performance
            </button>
          </a>
          <button
            th:if="${currentUser != null and project.createdBy != null
                    and currentUser.userId == project.createdBy.userId}"
            id="deleteProjectBtn"
            class="ml-auto px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 text-sm"
          >
            üóëÔ∏è Delete Project
          </button>
          <!-- Report -->
          <button
            id="reportProjectBtn"
            th:if="${project.createdBy != null and currentUser != null
                            and project.createdBy.userId != currentUser.userId}"
            class="ml-auto px-4 py-2 rounded-md bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 text-sm"
          >
            Report Project
          </button>
        </div>

        <!-- MAIN CONTENT GRID -->
        <div class="px-10 py-10 grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- LEFT COLUMN: Overview + Updates -->
          <div class="lg:col-span-2 space-y-8">
            <!-- ‚úî PROJECT OVERVIEW -->
            <section class="bg-white border border-gray-200 rounded-xl p-6">
              <h2 class="text-lg font-semibold text-gray-900 mb-3">Overview</h2>

              <p
                class="text-gray-700 leading-relaxed whitespace-pre-line mb-6"
                th:text="${project.description != null && !#strings.isEmpty(project.description) ? project.description : 'No description provided.'}"
              >
                No description provided.
              </p>

              <!-- Business Rules -->
              <div
                th:if="${project.businessRule != null and !#strings.isEmpty(project.businessRule)}"
                class="bg-gray-50 border border-gray-200 p-5 rounded-lg"
              >
                <h3 class="font-semibold text-gray-900 mb-2">Business Rules</h3>
                <p
                  class="text-gray-700 whitespace-pre-line"
                  th:text="${project.businessRule}"
                >
                  Rules...
                </p>
              </div>

              <div
                th:if="${project.businessRule == null or #strings.isEmpty(project.businessRule)}"
                class="text-gray-500 italic text-sm"
              >
                No business rules defined.
              </div>
            </section>

            <!-- ‚úî RECENT UPDATES -->
            <section class="bg-white border border-gray-200 rounded-xl p-6">
              <h2 class="text-lg font-semibold text-gray-900 mb-4">
                Recent Updates
              </h2>

              <ul class="divide-y divide-gray-200">
                <li th:each="n : ${notifications}" class="py-4">
                  <p class="text-sm text-gray-800">
                    <span
                      class="font-semibold text-blue-700"
                      th:text="${n.actorName}"
                      >User</span
                    >
                    <span class="ml-1" th:text="${n.title}"
                      >updated project</span
                    >
                  </p>
                  <p
                    class="text-sm text-gray-600 mt-0.5"
                    th:text="${n.message}"
                  >
                    Task 'UI Review' moved to Done.
                  </p>
                  <p
                    class="text-xs text-gray-500 mt-1"
                    th:text="${#dates.format(n.created_at,'dd MMM yyyy HH:mm')}"
                  >
                    03 Nov 2025 09:30
                  </p>
                </li>
              </ul>

              <div
                th:if="${#lists.isEmpty(notifications)}"
                class="text-gray-500 text-sm italic text-center"
              >
                No recent notifications.
              </div>
            </section>
          </div>

          <!-- RIGHT COLUMN: Details + Progress + Metrics -->
          <div class="space-y-8">
            <!-- ‚úî PROJECT DETAILS -->
            <section class="bg-white border border-gray-200 rounded-xl p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Details</h3>

              <div class="space-y-3 text-sm">
                <p>
                  <span class="text-gray-500">Start:</span>
                  <span
                    class="ml-2"
                    th:text="${project.startDate != null ? project.startDate : 'N/A'}"
                    >N/A</span
                  >
                </p>

                <p>
                  <span class="text-gray-500">Due:</span>
                  <span
                    class="ml-2"
                    th:text="${project.dueDate != null ? project.dueDate : 'N/A'}"
                    >N/A</span
                  >
                </p>

                <p>
                  <span class="text-gray-500">Priority:</span>
                  <span class="ml-2 font-medium" th:text="${project.priority}"
                    >Normal</span
                  >
                </p>

                <p>
                  <span class="text-gray-500">Status:</span>
                  <span
                    th:if="${currentUser == null or project.createdBy == null
                                            or currentUser.userId != project.createdBy.userId}"
                    class="ml-2"
                    id="projectStatusDisplay"
                    th:text="${project.status}"
                    >Active</span
                  >
                  <select
                    th:if="${currentUser != null and project.createdBy != null
                                            and currentUser.userId == project.createdBy.userId}"
                    id="projectStatusSelect"
                    class="ml-2 px-2 py-1 text-sm border border-gray-300 rounded-md bg-white hover:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option
                      value="Active"
                      th:selected="${project.status == 'Active'}"
                    >
                      Active
                    </option>
                    <option
                      value="Completed"
                      th:selected="${project.status == 'Completed'}"
                    >
                      Complete
                    </option>
                    <option
                      value="In_Progress"
                      th:selected="${project.status == 'In_Progress'}"
                    >
                      In Progress
                    </option>
                    <option
                      value="On_Hold"
                      th:selected="${project.status == 'On_Hold'}"
                    >
                      On Hold
                    </option>
                    <option
                      value="Pending"
                      th:selected="${project.status == 'Pending'}"
                    >
                      Pending
                    </option>
                  </select>
                </p>

                <p>
                  <span class="text-gray-500">Visibility:</span>
                  <span class="ml-2" th:text="${project.visibility}"
                    >Private</span
                  >
                </p>
              </div>
            </section>

            <!-- ‚úî PROGRESS -->
            <!-- ‚úî PROGRESS -->
            <section class="bg-white border border-gray-200 rounded-xl p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-3">Progress</h3>

              <div class="space-y-4">
                <!-- DONE -->
                <div>
                  <div class="flex justify-between text-xs text-gray-600 mb-1">
                    <span>Done</span>
                    <p
                      class="text-xs text-slate-500 mt-1"
                      th:text="|Total tasks: ${statusBreakdown['total'] ?: 0}|"
                    ></p>
                  </div>

                  <div
                    class="w-full h-2 bg-gray-200 rounded-full overflow-hidden"
                  >
                    <div
                      class="h-full bg-green-500"
                      th:style="|width:${statusBreakdown['DONE'] ?: 0}%|"
                    ></div>
                  </div>
                </div>

                <!-- IN PROGRESS -->
                <div>
                  <div class="flex justify-between text-xs text-gray-600 mb-1">
                    <span>In Progress</span>
                    <span th:text="|${statusBreakdown['IN_PROGRESS'] ?: 0}%|"
                      >0%</span
                    >
                  </div>

                  <div
                    class="w-full h-2 bg-gray-200 rounded-full overflow-hidden"
                  >
                    <div
                      class="h-full bg-yellow-400"
                      th:style="|width:${statusBreakdown['IN_PROGRESS'] ?: 0}%|"
                    ></div>
                  </div>
                </div>

                <!-- OPEN -->
                <div>
                  <div class="flex justify-between text-xs text-gray-600 mb-1">
                    <span>Open</span>
                    <span th:text="|${statusBreakdown['OPEN'] ?: 0}%|">0%</span>
                  </div>

                  <div
                    class="w-full h-2 bg-gray-200 rounded-full overflow-hidden"
                  >
                    <div
                      class="h-full bg-blue-500"
                      th:style="|width:${statusBreakdown['OPEN'] ?: 0}%|"
                    ></div>
                  </div>
                </div>

                <!-- TOTAL -->
                <p
                  class="text-[11px] text-gray-500 mt-2 text-right"
                  th:text="|Total tasks: ${statusBreakdown['total'] ?: 0}|"
                >
                  Total tasks: 0
                </p>
              </div>
            </section>

            <!-- ‚úî METRICS -->
            <section class="bg-white border border-gray-200 rounded-xl p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-3">Metrics</h3>

              <div class="grid grid-cols-2 gap-4">
                <div
                  class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center"
                >
                  <p
                    class="text-xl font-bold text-blue-700"
                    th:text="${metrics.totalTasks}"
                  >
                    0
                  </p>
                  <p class="text-xs text-gray-600">Total Tasks</p>
                </div>

                <div
                  class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center"
                >
                  <p
                    class="text-xl font-bold text-green-700"
                    th:text="${metrics.completedTasks}"
                  >
                    0
                  </p>
                  <p class="text-xs text-gray-600">Completed</p>
                </div>

                <div
                  class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center"
                >
                  <p
                    class="text-xl font-bold text-red-700"
                    th:text="${metrics.overdueTasks}"
                  >
                    0
                  </p>
                  <p class="text-xs text-gray-600">Overdue</p>
                </div>

                <div
                  class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-center"
                >
                  <p
                    class="text-xl font-bold text-yellow-700"
                    th:text="${metrics.activeTasks}"
                  >
                    0
                  </p>
                  <p class="text-xs text-gray-600">In Progress</p>
                </div>
              </div>
            </section>
          </div>
        </div>
      </main>
    </div>

    <!-- ‚úèÔ∏è EDIT PROJECT MODAL (Linear-style) -->
    <div
      id="editProjectModal"
      class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50 overflow-y-auto"
    >
      <div
        class="bg-white p-8 rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto shadow-2xl border border-slate-200"
      >
        <div
          class="flex justify-between items-center mb-6 border-b border-gray-200 pb-3"
        >
          <h2 class="text-2xl font-semibold text-slate-900">Edit Project</h2>
          <button
            type="button"
            onclick="closeEditModal()"
            class="text-slate-400 hover:text-slate-600 transition"
          >
            ‚úï
          </button>
        </div>

        <form id="editProjectForm" class="space-y-7">
          <!-- Hidden current cover -->
          <input
            type="hidden"
            id="currentCoverImage"
            th:value="${project.coverImage}"
          />

          <!-- COVER IMAGE UPLOAD -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2"
              >Cover Image</label
            >

            <div
              class="relative h-40 w-full rounded-xl overflow-hidden border border-dashed border-slate-300 bg-slate-50 cursor-pointer group"
            >
              <!-- Always render (but hide if null) -->
              <img
                id="editCoverPreview"
                th:src="${project.coverImage}"
                th:style="${project.coverImage == null} ? 'display:none;' : ''"
                class="w-full h-full object-cover"
              />

              <!-- Placeholder when no image -->
              <div
                id="editCoverPlaceholder"
                th:style="${project.coverImage != null} ? 'display:none;' : ''"
                class="w-full h-full flex flex-col items-center justify-center text-slate-400 text-sm"
              >
                <span class="mb-1">Click to upload cover image</span>
                <span class="text-[11px] text-slate-400"
                  >Recommended: 1200 √ó 300</span
                >
              </div>

              <!-- Dim on hover -->
              <div
                class="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition flex items-center justify-center text-white text-xs font-medium"
              >
                Change cover image
              </div>

              <!-- File input -->
              <input
                id="editCoverInput"
                type="file"
                accept="image/*"
                class="absolute inset-0 opacity-0 cursor-pointer"
              />
            </div>

            <!-- Hidden: store old cover image -->
            <input
              type="hidden"
              id="currentCoverImage"
              th:value="${project.coverImage}"
            />
          </div>

          <!-- Row 1: Name + Priority -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2"
                >Project Name</label
              >
              <input
                id="editName"
                type="text"
                class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none"
                th:value="${project.name}"
                required
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2"
                >Priority</label
              >
              <select
                id="editPriority"
                class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none"
              >
                <option th:selected="${project.priority == 'Low'}">Low</option>
                <option th:selected="${project.priority == 'Normal'}">
                  Normal
                </option>
                <option th:selected="${project.priority == 'High'}">
                  High
                </option>
              </select>
            </div>
          </div>

          <!-- Status -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2"
              >Status</label
            >
            <select
              id="editStatus"
              class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none"
            >
              <option
                value="Active"
                th:selected="${project.status == 'Active'}"
              >
                Active
              </option>
              <option
                value="Completed"
                th:selected="${project.status == 'Completed'}"
              >
                Completed
              </option>
              <option
                value="In_Progress"
                th:selected="${project.status == 'In_Progress'}"
              >
                In Progress
              </option>
              <option
                value="On_Hold"
                th:selected="${project.status == 'On_Hold'}"
              >
                On Hold
              </option>
              <option
                value="Pending"
                th:selected="${project.status == 'Pending'}"
              >
                Pending
              </option>
            </select>
          </div>

          <!-- Description -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2"
              >Description</label
            >
            <textarea
              id="editDesc"
              rows="4"
              class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none resize-y"
              placeholder="Describe your project..."
              th:text="${project.description}"
            ></textarea>
          </div>

          <!-- Business rules -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2"
              >Business Rules</label
            >
            <textarea
              id="editBiz"
              rows="5"
              class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none resize-y"
              placeholder="List your business rules here..."
              th:text="${project.businessRule}"
            ></textarea>
          </div>

          <!-- Dates -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2"
                >Start Date</label
              >
              <input
                id="editStart"
                type="date"
                th:value="${project.startDate}"
                class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2"
                >End Date</label
              >
              <input
                id="editEnd"
                type="date"
                th:value="${project.dueDate}"
                class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-400 outline-none"
              />
            </div>
          </div>

          <!-- Actions -->
          <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
            <button
              type="button"
              onclick="closeEditModal()"
              class="px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold shadow-sm"
            >
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- üõë REPORT PROJECT MODAL -->
    <div
      id="reportProjectModal"
      class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50"
    >
      <div
        class="bg-white p-6 rounded-2xl w-full max-w-md shadow-xl border border-slate-200"
      >
        <div class="flex justify-between items-center mb-4">
          <h2
            class="text-lg font-semibold text-slate-900 flex items-center gap-2"
          >
            üè≥ Report Project
          </h2>
          <button
            type="button"
            onclick="closeReportProjectModal()"
            class="text-slate-400 hover:text-slate-600"
          >
            ‚úï
          </button>
        </div>

        <form id="reportProjectForm" class="space-y-4">
          <div>
            <label class="text-sm font-medium text-slate-700">Reason</label>
            <input
              id="projectReason"
              type="text"
              placeholder="Enter reason (e.g., spam, inappropriate)"
              class="w-full border rounded-lg px-3 py-2 mt-1 text-sm focus:ring-2 focus:ring-blue-400 outline-none"
              required
            />
          </div>

          <div>
            <label class="text-sm font-medium text-slate-700">Details</label>
            <textarea
              id="projectDetails"
              rows="3"
              placeholder="Describe the issue..."
              class="w-full border rounded-lg px-3 py-2 mt-1 text-sm focus:ring-2 focus:ring-blue-400 outline-none resize-none"
            ></textarea>
          </div>

          <div>
            <label class="text-sm font-medium text-slate-700"
              >Upload Proof (optional)</label
            >
            <input
              id="projectFile"
              type="file"
              accept="image/*,.pdf,.docx"
              class="w-full mt-2 text-sm border rounded-lg px-2 py-2 file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-sm file:bg-blue-50 file:text-blue-600 hover:file:bg-blue-100"
            />
          </div>

          <div class="flex justify-end gap-2 pt-3">
            <button
              type="button"
              onclick="closeReportProjectModal()"
              class="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-medium"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium"
            >
              Submit Report
            </button>
          </div>
        </form>
      </div>
    </div>
    <!-- üóëÔ∏è DELETE PROJECT CONFIRMATION MODAL -->
    <div
      id="deleteProjectModal"
      class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50"
    >
      <div
        class="bg-white p-6 rounded-2xl w-full max-w-md shadow-xl border border-slate-200"
      >
        <div class="flex justify-between items-center mb-4">
          <h2
            class="text-lg font-semibold text-slate-900 flex items-center gap-2"
          >
            üóëÔ∏è Delete Project
          </h2>
          <button
            type="button"
            onclick="closeDeleteProjectModal()"
            class="text-slate-400 hover:text-slate-600"
          >
            ‚úï
          </button>
        </div>

        <div class="space-y-4">
          <p class="text-sm text-gray-600">
            Are you sure you want to delete "<span
              th:text="${project.name}"
              class="font-semibold"
              >Project Name</span
            >"? This action cannot be undone and all project data will be
            permanently lost.
          </p>

          <div class="bg-red-50 border border-red-200 rounded-lg p-3">
            <p class="text-sm text-red-700 font-medium">
              ‚ö†Ô∏è Warning: This action is irreversible!
            </p>
            <p class="text-xs text-red-600 mt-1">
              All tasks, members, and project data will be permanently deleted.
            </p>
          </div>

          <div class="flex justify-end gap-2 pt-3">
            <button
              type="button"
              onclick="closeDeleteProjectModal()"
              class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium"
            >
              Cancel
            </button>
            <button
              id="confirmDeleteBtn"
              class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium"
            >
              Yes, Delete Project
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- SCRIPTS -->
    <script>
      const projectId = new URLSearchParams(window.location.search).get(
        "projectId"
      );

      const editProjectBtn = document.getElementById("editProjectBtn");
      const editProjectModal = document.getElementById("editProjectModal");
      const editProjectForm = document.getElementById("editProjectForm");

      const editCoverInput = document.getElementById("editCoverInput");
      const editCoverPreview = document.getElementById("editCoverPreview");
      const editCoverPlaceholder = document.getElementById(
        "editCoverPlaceholder"
      );
      const currentCoverInput = document.getElementById("currentCoverImage");
      let newCoverImageUrl = null;

      if (editProjectBtn) {
        editProjectBtn.addEventListener("click", () => {
          editProjectModal.classList.remove("hidden");
        });
      }

      function closeEditModal() {
        editProjectModal.classList.add("hidden");
      }

      // Upload cover image in edit modal
      editCoverInput?.addEventListener("change", async () => {
        const file = editCoverInput.files[0];
        if (!file) return;

        // ‚úî Local preview
        const reader = new FileReader();
        reader.onload = () => {
          editCoverPreview.src = reader.result;
          editCoverPreview.style.display = "block";
          editCoverPlaceholder.style.display = "none";
        };
        reader.readAsDataURL(file);

        const formData = new FormData();
        formData.append("file", file);

        try {
          const res = await fetch("/api/upload/project-cover", {
            method: "POST",
            body: formData,
          });

          const result = await res.json();

          // ‚úî Handle different response formats
          newCoverImageUrl = result.url;
          if (!newCoverImageUrl) {
          }
        } catch (err) {
          console.error("Upload error:", err);
        }
      });

      // Submit edit form
      editProjectForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = {
          name: document.getElementById("editName").value.trim(),
          description: document.getElementById("editDesc").value.trim(),
          businessRule: document.getElementById("editBiz").value.trim(),
          priority: document.getElementById("editPriority").value.trim(),
          status: document.getElementById("editStatus").value.trim(),
          startDate: document.getElementById("editStart").value,
          endDate: document.getElementById("editEnd").value,
          coverImage: newCoverImageUrl || currentCoverInput.value || null,
        };

        try {
          const res = await fetch(`/api/projects/${projectId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const result = await res.json();

          if (result.success || result.status === "success") {
            showToast("Project updated successfully!", "success");
            setTimeout(() => location.reload(), 1000);
          } else {
            showToast(result.message || "Update failed", "error");
          }
        } catch (err) {
          console.error("Update error:", err);
          showToast("Failed to connect to server.", "error");
        }
      });

      // REPORT MODAL
      const reportProjectBtn = document.getElementById("reportProjectBtn");
      const reportProjectModal = document.getElementById("reportProjectModal");
      const reportProjectForm = document.getElementById("reportProjectForm");

      if (reportProjectBtn) {
        reportProjectBtn.addEventListener("click", () => {
          reportProjectModal.classList.remove("hidden");
        });
      }

      function closeReportProjectModal() {
        reportProjectModal.classList.add("hidden");
      }

      if (reportProjectForm) {
        reportProjectForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const reason = document.getElementById("projectReason").value.trim();
          const details = document
            .getElementById("projectDetails")
            .value.trim();
          const fileInput = document.getElementById("projectFile");
          let proofUrl = null;

          try {
            // upload file if provided
            if (fileInput.files.length > 0) {
              const formData = new FormData();
              formData.append("file", fileInput.files[0]);
              const uploadRes = await fetch("/api/upload/avatar", {
                method: "POST",
                body: formData,
              });
              if (!uploadRes.ok) throw new Error("File upload failed");
              proofUrl = await uploadRes.text();
            }

            const res = await fetch(`/api/reports`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({
                type: "project",
                reportedId: projectId,
                reason,
                details,
                proofUrl,
              }),
            });

            if (!res.ok) throw new Error("Failed to submit project report");
            showToast("Project report submitted successfully!", "success");
            closeReportProjectModal();
            reportProjectForm.reset();
          } catch (err) {
            console.error("‚ùå Project report failed:", err.message);
            showToast(err.message, "error");
          }
        });
      }
      // DELETE PROJECT FUNCTIONALITY
      const deleteProjectBtn = document.getElementById("deleteProjectBtn");
      const deleteProjectModal = document.getElementById("deleteProjectModal");
      const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

      if (deleteProjectBtn) {
        deleteProjectBtn.addEventListener("click", () => {
          deleteProjectModal.classList.remove("hidden");
        });
      }

      function closeDeleteProjectModal() {
        deleteProjectModal.classList.add("hidden");
      }

      if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener("click", async () => {
          try {
            const res = await fetch(`/api/projects/${projectId}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
            });

            if (res.ok) {
              showToast("Project deleted successfully!", "success");
              setTimeout(() => {
                // ‚úÖ Redirect v·ªÅ trang View All Projects sau khi x√≥a project
                window.location.href = "/user/view/view-all-projects";
              }, 1000);
            } else {
              const result = await res.json();
              showToast(result.message || "Failed to delete project", "error");
            }
          } catch (err) {
            console.error("Delete error:", err);
            showToast("Failed to connect to server.", "error");
          }
        });
      }

      // Quick update status with select dropdown
      const projectStatusSelect = document.getElementById(
        "projectStatusSelect"
      );
      const projectStatusDisplay = document.getElementById(
        "projectStatusDisplay"
      );

      if (projectStatusSelect) {
        projectStatusSelect.addEventListener("change", async (e) => {
          const newStatus = e.target.value;
          const statusLabels = {
            Active: "Active",
            Completed: "Complete",
            In_Progress: "In Progress",
            On_Hold: "On Hold",
            Pending: "Pending",
          };
          const newStatusLabel = statusLabels[newStatus] || newStatus;

          // Store original value to revert if update fails
          const originalValue =
            projectStatusSelect.dataset.originalValue ||
            projectStatusSelect.value;

          try {
            const token = localStorage.getItem("token");
            const headers = {
              "Content-Type": "application/json",
            };
            if (token) {
              headers.Authorization = "Bearer " + token;
            }

            const res = await fetch(`/api/projects/${projectId}`, {
              method: "PUT",
              headers,
              credentials: "include",
              body: JSON.stringify({ status: newStatus }),
            });

            const result = await res.json();

            if (
              res.ok &&
              (result.success || result.status === "success" || result.data)
            ) {
              // Update display if exists
              if (projectStatusDisplay) {
                projectStatusDisplay.textContent = newStatusLabel;
              }
              // Update select dataset
              projectStatusSelect.dataset.originalValue = newStatus;
              showToast("Status updated to " + newStatusLabel, "success");
            } else {
              // Revert select to original value
              projectStatusSelect.value = originalValue;
              showToast(result.message || "Failed to update status", "error");
            }
          } catch (err) {
            console.error("Update status error:", err);
            // Revert select to original value
            projectStatusSelect.value = originalValue;
            showToast("Failed to connect to server.", "error");
          }
        });

        // Store original value on load
        projectStatusSelect.dataset.originalValue = projectStatusSelect.value;
      }

      // Format display text if exists (for non-owner view)
      if (projectStatusDisplay) {
        const displayText = projectStatusDisplay.textContent.trim();
        if (displayText === "Completed") {
          projectStatusDisplay.textContent = "Complete";
        }
      }
    </script>

    <!-- Chatbox -->
    <div th:replace="fragments/chatbox :: chatbox"></div>
    <script th:src="@{/js/chatbox.js}"></script>
  </body>
</html>
