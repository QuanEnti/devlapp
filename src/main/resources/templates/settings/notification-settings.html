<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>CÃ i Ä‘áº·t thÃ´ng bÃ¡o â€“ DevCollab</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10">

  <div class="bg-white shadow-md rounded-xl p-8 w-full max-w-3xl">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">ğŸ”” CÃ i Ä‘áº·t thÃ´ng bÃ¡o qua Email</h1>

    <!-- ğŸ” Form khÃ´ng cáº§n action ná»¯a vÃ¬ xá»­ lÃ½ báº±ng JS -->
    <form id="notif-settings-form" class="space-y-6">
      
      <!-- Báº­t/táº¯t toÃ n bá»™ -->
      <div class="flex items-center justify-between">
        <label class="text-gray-700 font-medium">Nháº­n email thÃ´ng bÃ¡o</label>
        <input type="checkbox" name="emailEnabled"
               class="w-5 h-5 accent-blue-600"
               th:checked="${settings.emailEnabled}" />
      </div>

      <!-- Gá»­i mail ngay cho thÃ´ng bÃ¡o quan trá»ng -->
      <div class="flex items-center justify-between">
        <label class="text-gray-700 font-medium">Gá»­i email ngay cho thÃ´ng bÃ¡o quan trá»ng</label>
        <input type="checkbox" name="emailHighImmediate"
               class="w-5 h-5 accent-blue-600"
               th:checked="${settings.emailHighImmediate}" />
      </div>

      <!-- Nháº­n email tá»•ng há»£p -->
      <div class="flex items-center justify-between">
        <div>
          <label class="text-gray-700 font-medium">Nháº­n email tá»•ng há»£p</label>
          <p class="text-sm text-gray-500 mt-1">Nháº­n má»™t email tá»•ng há»£p cÃ¡c thÃ´ng bÃ¡o má»›i theo táº§n suáº¥t báº¡n chá»n.</p>
        </div>
        <input type="checkbox" name="emailDigestEnabled"
               class="w-5 h-5 accent-blue-600"
               th:checked="${settings.emailDigestEnabled}" />
      </div>

      <!-- Táº§n suáº¥t digest -->
      <div>
        <label class="block text-gray-700 font-medium mb-2">Táº§n suáº¥t nháº­n email tá»•ng há»£p</label>
        <select name="emailDigestEveryHours"
                class="border rounded-lg px-4 py-2 w-full focus:ring focus:ring-blue-200"
                th:value="${settings.emailDigestEveryHours}">
          <option value="2">2 giá»</option>
          <option value="4">4 giá»</option>
          <option value="6">6 giá»</option>
        </select>
      </div>

      <!-- NÃºt khÃ´ng nháº­n mail -->
      <div class="pt-4 border-t">
        <label class="inline-flex items-center">
          <input type="checkbox" name="disableAll" value="true"
                 class="w-5 h-5 accent-red-500"
                 th:checked="${!settings.emailEnabled}" />
          <span class="ml-2 text-red-600 font-medium">KhÃ´ng nháº­n thÃ´ng bÃ¡o qua email</span>
        </label>
      </div>

      <!-- Submit -->
      <div class="pt-6 flex justify-end">
        <button type="submit"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg transition">
          LÆ°u thay Ä‘á»•i
        </button>
      </div>

      <!-- ThÃ´ng bÃ¡o lÆ°u thÃ nh cÃ´ng -->
      <p id="success-msg"
         class="hidden text-green-600 text-center mt-4 font-medium">
         âœ… CÃ i Ä‘áº·t Ä‘Ã£ Ä‘Æ°á»£c lÆ°u thÃ nh cÃ´ng!
      </p>
    </form>
  </div>

 <script>
const form = document.getElementById("notif-settings-form");
const successMsg = document.getElementById("success-msg");

async function ensureCurrentUser() {
  try {
    const res = await fetch("/api/auth/me", { credentials: "include" });
    if (!res.ok) throw new Error("Unauthorized");
    const data = await res.json();
    console.log("âœ… Current user:", data.email || data.user?.email);
    return data.user || data;
  } catch (err) {
    console.warn("âš ï¸ PhiÃªn Ä‘Äƒng nháº­p khÃ´ng há»£p lá»‡:", err);
    return null;
  }
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const user = await ensureCurrentUser();
  if (!user) {
    alert("âš ï¸ PhiÃªn Ä‘Äƒng nháº­p khÃ´ng há»£p lá»‡. Há»‡ thá»‘ng sáº½ chuyá»ƒn báº¡n Ä‘áº¿n trang Ä‘Äƒng nháº­p.");
    window.location.href = "/view/signin";
    return;
  }

  const data = {
    emailEnabled: e.target.emailEnabled.checked,
    emailHighImmediate: e.target.emailHighImmediate.checked,
    emailDigestEnabled: e.target.emailDigestEnabled.checked,
    emailDigestEveryHours: parseInt(e.target.emailDigestEveryHours.value)
  };

  try {
    const res = await fetch("/api/settings/notifications/update", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(data)
    });

    if (res.ok) {
      successMsg.classList.remove("hidden");
      successMsg.textContent = "âœ… CÃ i Ä‘áº·t Ä‘Ã£ Ä‘Æ°á»£c lÆ°u thÃ nh cÃ´ng!";
      setTimeout(() => successMsg.classList.add("hidden"), 3000);
    } else {
      const json = await res.json().catch(() => ({}));
      alert("âš ï¸ LÆ°u tháº¥t báº¡i: " + (json.message || "KhÃ´ng thá»ƒ xÃ¡c thá»±c."));
    }
  } catch (err) {
    console.error("âŒ Lá»—i khi gá»­i yÃªu cáº§u:", err);
    alert("âš ï¸ KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§. Vui lÃ²ng thá»­ láº¡i sau.");
  }
});

// Khi trang load, tá»± xÃ¡c thá»±c báº±ng cookie
window.addEventListener("DOMContentLoaded", async () => {
  const user = await ensureCurrentUser();
  if (!user) {
    alert("âš ï¸ PhiÃªn Ä‘Äƒng nháº­p khÃ´ng há»£p lá»‡. Há»‡ thá»‘ng sáº½ chuyá»ƒn báº¡n Ä‘áº¿n trang Ä‘Äƒng nháº­p.");
    window.location.href = "/view/signin";
  }
});
</script>



</body>
</html> 