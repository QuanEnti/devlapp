<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Reported Projects - DevCollab Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }
        .sidebar {
            background-color: #1e293b;
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        .sidebar h3 {
            font-size: 1.4rem;
            margin-bottom: 1.5rem;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
        }
        .sidebar ul li {
            margin-bottom: 1rem;
        }
        .sidebar ul li a {
            color: #cbd5e1;
            text-decoration: none;
            font-weight: 500;
        }
        .sidebar ul li a.active,
        .sidebar ul li a:hover {
            color: #fff;
            font-weight: 600;
        }
        .pagination-info {
            font-size: 0.9rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <aside class="col-2 bg-dark text-white vh-100 p-3">
            <h3>DevCollab</h3>
            <ul class="nav flex-column mt-4">
                <li class="nav-item"><a class="nav-link text-white" href="/admin/dashboard">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link text-white" href="/admin/manage">User Management</a></li>
                <li class="nav-item"><a class="nav-link text-white" href="/admin/user-reports">Reported User</a></li>
                <li class="nav-item"><a class="nav-link text-white active" href="/admin/project-reports">Reported Project</a></li>
                <li class="nav-item"><a class="nav-link text-white" href="/admin/user-logs">System Log</a></li>
                <li class="nav-item"><a class="nav-link text-white" href="#">Settings</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="col-10 p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2>Reported Projects</h2>
                    <span class="text-muted">Review reported projects and take action</span>
                </div>

                <!-- Sort options -->
                <div class="d-flex align-items-center gap-2">
                    <label class="form-label m-0">Sort by:</label>
                    <select id="sortOption" class="form-select" style="width: 180px;" onchange="applySort()">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="status_pending">Status: Pending</option>
                        <option value="status_reviewed">Status: Reviewed</option>
                        <option value="reporter">Reporter Name (A–Z)</option>
                        <option value="project">Project Name (A–Z)</option>
                    </select>
                </div>
            </div>

            <div class="table-responsive mt-3">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Reporter</th>
                        <th>Project</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Action Taken</th>
                        <th>Created At</th>
                        <th>Reviewed At</th>
                        <th>Update</th>
                    </tr>
                    </thead>
                    <tbody id="reportTable"></tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="pagination-info" id="paginationInfo">
                    Showing 0 of 0 reports
                </div>
                <div>
                    <button class="btn btn-outline-secondary btn-sm" id="prevBtn" onclick="changePage(-1)">
                        Previous
                    </button>
                    <span class="mx-3 fw-bold" id="pageInfo">Page 0 of 0</span>
                    <button class="btn btn-outline-secondary btn-sm" id="nextBtn" onclick="changePage(1)">
                        Next
                    </button>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- 📦 MODAL -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="reportModalLabel">Project Report Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered">
                    <tbody>
                    <tr><th>ID</th><td id="modalId"></td></tr>
                    <tr><th>Reporter</th><td id="modalReporter"></td></tr>
                    <tr><th>Project</th><td id="modalProject"></td></tr>
                    <tr><th>Reason</th><td id="modalReason"></td></tr>
                    <tr><th>Details</th><td id="modalDetails"></td></tr>
                    <tr><th>Proof</th><td id="modalProof"></td></tr>
                    <tr><th>Created At</th><td id="modalCreatedAt"></td></tr>
                    <tr><th>Reviewed At</th><td id="modalReviewedAt"></td></tr>
                    <tr><th>Status</th><td><span id="modalStatusView" class="badge fs-6 px-3 py-2 bg-secondary">Loading...</span></td></tr>
                    </tbody>
                </table>

                <div class="mt-3">
                    <label>Action Taken</label>
                    <select id="actionTaken" class="form-select" onchange="handleActionChange()">
                        <option value="">-- Select Action --</option>
                        <option value="Warning">Warning</option>
                        <option value="Ban">Remove Project</option>
                    </select>
                </div>

                <!-- Text area appears only for Warning -->
                <div class="mt-3" id="warningCommentBox" style="display:none;">
                    <label>Warning Message</label>
                    <textarea id="warningMessage" class="form-control" placeholder="Write a warning message to the project owner..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveChangesBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
    let reportsCache = [];
    let selectedReportId = null;
    let bootstrapModal;
    let currentPage = 0;
    let totalPages = 0;
    let totalItems = 0;
    const pageSize = 10;

    // ------------------ LOAD REPORTS WITH PAGINATION ------------------
    async function loadReports(page = 0) {
        try {
            const res = await fetch(`/api/admin/project-reports?page=${page}&size=${pageSize}`);

            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }

            const data = await res.json();

            reportsCache = data.content || [];
            currentPage = data.currentPage || 0;
            totalPages = data.totalPages || 0;
            totalItems = data.totalItems || 0;

            renderReports(reportsCache);
            updatePaginationControls();
        } catch (error) {
            console.error('Error loading reports:', error);
            document.getElementById('reportTable').innerHTML =
                `<tr><td colspan="9" class="text-center text-danger">Failed to load reports</td></tr>`;
        }
    }

    function updatePaginationControls() {
        const startItem = (currentPage * pageSize) + 1;
        const endItem = Math.min((currentPage + 1) * pageSize, totalItems);

        document.getElementById("paginationInfo").innerText =
            `Showing ${reportsCache.length > 0 ? startItem : 0}-${endItem} of ${totalItems} reports`;

        document.getElementById("pageInfo").innerText =
            `Page ${currentPage + 1} of ${totalPages}`;

        document.getElementById("prevBtn").disabled = currentPage === 0;
        document.getElementById("nextBtn").disabled = currentPage >= totalPages - 1;
    }

    function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage >= 0 && newPage < totalPages) {
            loadReports(newPage);
        }
    }

    // ------------------ RENDER TABLE ------------------
    function renderReports(data) {
        const tbody = document.getElementById('reportTable');

        if (!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">No reports found</td></tr>`;
            return;
        }

        tbody.innerHTML = data.map(r => `
            <tr>
                <td>${r.reportId || r.id}</td>
                <td>${r.reporterName || '—'}</td>
                <td>${r.projectName || '—'}</td>
                <td>${r.reason}</td>
                <td>
                    <span class="badge ${r.status === 'pending' ? 'bg-warning text-dark' :
            r.status === 'reviewed' ? 'bg-info text-dark' : 'bg-success'}">${r.status}</span>
                </td>
                <td>${r.actionTaken || ''}</td>
                <td>${r.createdAt ? new Date(r.createdAt).toLocaleString() : ''}</td>
                <td>${r.reviewedAt ? new Date(r.reviewedAt).toLocaleString() : '<span class="text-muted">—</span>'}</td>
                <td><button class="btn btn-sm btn-outline-primary" onclick="openModal(${r.reportId || r.id})">Update</button></td>
            </tr>
        `).join('');
    }

    // ------------------ SORTING ------------------
    function applySort() {
        const sortBy = document.getElementById("sortOption").value;
        let sorted = [...reportsCache];

        switch (sortBy) {
            case "newest":
                sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                break;
            case "oldest":
                sorted.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                break;
            case "status_pending":
                sorted.sort((a, b) => (a.status === 'pending' ? -1 : 1));
                break;
            case "status_reviewed":
                sorted.sort((a, b) => (a.status === 'reviewed' ? -1 : 1));
                break;
            case "reporter":
                sorted.sort((a, b) => (a.reporterName || '').localeCompare(b.reporterName || ''));
                break;
            case "project":
                sorted.sort((a, b) => (a.projectName || '').localeCompare(b.projectName || ''));
                break;
        }

        renderReports(sorted);
    }

    // ------------------ MODAL FUNCTIONS ------------------
    function openModal(id) {
        const report = reportsCache.find(r => (r.reportId || r.id) === id);
        if (!report) return;

        selectedReportId = id;

        document.getElementById("modalId").innerText = report.reportId || report.id;
        document.getElementById("modalReporter").innerText = report.reporterName || '—';
        document.getElementById("modalProject").innerText = report.projectName || '—';
        document.getElementById("modalReason").innerText = report.reason;
        document.getElementById("modalDetails").innerText = report.details || '—';
        document.getElementById("modalProof").innerHTML = report.proofUrl
            ? `<a href="${report.proofUrl}" target="_blank">View Proof</a>`
            : '<span class="text-muted">No proof submitted</span>';
        document.getElementById("modalCreatedAt").innerText = report.createdAt ? new Date(report.createdAt).toLocaleString() : '';
        document.getElementById("modalReviewedAt").innerText = report.reviewedAt ? new Date(report.reviewedAt).toLocaleString() : '—';

        const statusView = document.getElementById("modalStatusView");
        statusView.textContent = report.status;
        statusView.className = `badge fs-6 px-3 py-2 ${
            report.status === 'pending' ? 'bg-warning text-dark' :
                report.status === 'reviewed' ? 'bg-info text-dark' :
                    'bg-success'
        }`;

        document.getElementById("actionTaken").value = '';
        document.getElementById("warningCommentBox").style.display = 'none';
        document.getElementById("warningMessage").value = '';

        bootstrapModal = new bootstrap.Modal(document.getElementById('reportModal'));
        bootstrapModal.show();
    }

    function handleActionChange() {
        const action = document.getElementById("actionTaken").value;
        document.getElementById("warningCommentBox").style.display = action === "Warning" ? "block" : "none";
    }

    // ------------------ SAVE CHANGES ------------------
    async function saveChanges() {
        const actionTaken = document.getElementById("actionTaken").value;
        const warningMessage = document.getElementById("warningMessage").value.trim();

        if (actionTaken === "Ban") {
            if (!confirm("⚠️ Are you sure you want to remove this project?")) return;
            const res = await fetch(`/api/admin/project-reports/${selectedReportId}/ban`, { method: "PUT" });
            if (res.ok) {
                alert("🚫 Project removed successfully.");
                bootstrapModal.hide();
                await loadReports(currentPage); // Reload current page
            } else alert("❌ Failed to remove project.");
            return;
        }

        if (actionTaken === "Warning") {
            if (!warningMessage) {
                alert("Please enter a warning message.");
                return;
            }
            const res = await fetch(`/api/admin/project-reports/${selectedReportId}/warn`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: warningMessage })
            });
            if (res.ok) {
                alert("⚠️ Warning sent to project owner.");
                bootstrapModal.hide();
                await loadReports(currentPage); // Reload current page
            } else alert("❌ Failed to send warning.");
            return;
        }

        alert("Please choose an action.");
    }

    // ------------------ INITIALIZATION ------------------
    document.getElementById("saveChangesBtn").addEventListener("click", saveChanges);
    document.addEventListener("DOMContentLoaded", () => loadReports(0));
</script>
</body>
</html>