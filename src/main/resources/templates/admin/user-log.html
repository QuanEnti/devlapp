<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>System Logs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .nav-link.active {
            background-color: #495057;
            border-radius: 5px;
        }
        .table td, .table th {
            vertical-align: middle;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div th:replace="fragments/admin-sidebar :: adminSidebar"></div>

        <!-- Main Content -->
        <main class="col-10 p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>ðŸ§¾ System Activity Logs</h2>
                <button class="btn btn-outline-secondary btn-sm" onclick="loadLogs()">âŸ³ Refresh</button>
            </div>

            <!-- Filters -->
            <div class="mb-3 row g-3">
                <div class="col-md-3">
                    <input type="text" id="searchUser" class="form-control" placeholder="Search by User">
                </div>
                <div class="col-md-3">
                    <input type="text" id="searchAction" class="form-control" placeholder="Search by Action">
                </div>
                <div class="col-md-3">
                    <select id="entityTypeFilter" class="form-select">
                        <option value="">All Entities</option>
                        <option value="Project">Project</option>
                        <option value="Task">Task</option>
                        <option value="Comment">Comment</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" onclick="applyFilter()">Apply Filter</button>
                </div>
            </div>

            <!-- Log Table -->
            <div class="table-responsive mt-3">
                <table class="table table-hover align-middle">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Entity</th>
                        <th>Action</th>
                        <th>Data</th>
                        <th>Time</th>
                    </tr>
                    </thead>
                    <tbody id="logTable"></tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <button class="btn btn-secondary btn-sm" id="prevBtn" onclick="changePage(-1)">Previous</button>
                <span id="pageInfo" class="fw-bold"></span>
                <button class="btn btn-secondary btn-sm" id="nextBtn" onclick="changePage(1)">Next</button>
            </div>
        </main>
    </div>
</div>

<script>
    // --- State ---
    let logs = [];
    let currentPage = 0;
    let totalPages = 0;

    // --- Load paginated logs from backend ---
    async function loadLogs(page = 0) {
        try {
            const res = await fetch(`/api/admin/logs?page=${page}&size=10`);
            const json = await res.json();

            // handle non-Page format
            logs = json.content || [];
            totalPages = json.totalPages || 1;
            currentPage = json.currentPage || 0;

            renderLogs(logs);
            updatePaginationControls();
        } catch (err) {
            console.error("Error loading logs:", err);
        }
    }

    // --- Render logs to table ---
    function renderLogs(data) {
        const tbody = document.getElementById("logTable");
        tbody.innerHTML = "";

        if (!data.length) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No activity found</td></tr>`;
            return;
        }

        data.forEach(log => {
            tbody.innerHTML += `
                <tr>
                    <td>${log.activityId}</td>
                    <td>${log.actor?.name || "â€”"}</td>
                    <td>${log.entityType} #${log.entityId}</td>
                    <td><span class="badge bg-info text-dark">${log.action}</span></td>
                    <td><code>${log.dataJson || ""}</code></td>
                    <td>${new Date(log.createdAt).toLocaleString()}</td>
                </tr>
            `;
        });
    }

    // --- Pagination controls ---
    function updatePaginationControls() {
        document.getElementById("pageInfo").innerText = `Page ${currentPage + 1} of ${totalPages}`;
        document.getElementById("prevBtn").disabled = currentPage === 0;
        document.getElementById("nextBtn").disabled = currentPage >= totalPages - 1;
    }


    async function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage < 0 || newPage >= totalPages) return;
        applyFilter(newPage);
    }

    // --- Filter (client-side only) ---
    async function applyFilter(page = 0) {
        const user = document.getElementById("searchUser").value.trim();
        const action = document.getElementById("searchAction").value.trim();
        const entityType = document.getElementById("entityTypeFilter").value;
        const size = 10;

        const params = new URLSearchParams({ user, action, entityType, page, size });

        try {
            const res = await fetch(`/api/admin/logs/search?${params.toString()}`);
            const json = await res.json();

            logs = json.content || [];
            totalPages = json.totalPages || 1;
            currentPage = json.currentPage || 0;

            renderLogs(logs);
            updatePaginationControls();
        } catch (err) {
            console.error("Error applying filter:", err);
        }
    }


    // --- Initial load ---
    loadLogs();
</script>
<script src="/js/logout.js"></script>
</body>
</html>
