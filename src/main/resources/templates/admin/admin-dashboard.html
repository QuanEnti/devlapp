<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }
        .sidebar {
            background-color: #1e293b;
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        .sidebar h2 {
            font-size: 1.4rem;
            margin-bottom: 1.5rem;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
        }
        .sidebar ul li {
            margin-bottom: 1rem;
        }
        .sidebar ul li a {
            color: #cbd5e1;
            text-decoration: none;
            font-weight: 500;
        }
        .sidebar ul li a.active,
        .sidebar ul li a:hover {
            color: #fff;
            font-weight: 600;
        }
        .card {
            border: none;
            border-radius: 12px;
        }
        .card h2 {
            margin-top: 10px;
            font-size: 2rem;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div th:replace="fragments/admin-sidebar :: adminSidebar"></div>

        <!-- Main Content -->
        <main class="col-10 p-4">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Dashboard</h2>
                <div>
                    <input type="text" class="form-control d-inline-block" style="width: 250px;" placeholder="Search for anything...">
                    <span class="ms-3 fw-bold">Viet Name || Da Nang</span>
                </div>
            </div>

            <!-- Info Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card shadow-sm text-center p-3">
                        <h5 class="text-muted">Total Users</h5>
                        <h2 id="totalUsers" class="fw-bold text-primary">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card shadow-sm text-center p-3">
                        <h5 class="text-muted">Active Users</h5>
                        <h2 id="activeUsers" class="fw-bold text-success">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card shadow-sm text-center p-3">
                        <h5 class="text-muted">Projects</h5>
                        <h2 id="totalProjects" class="fw-bold text-warning">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card shadow-sm text-center p-3">
                        <h5 class="text-muted">Violated Projects</h5>
                        <h2 id="violatedProjects" class="fw-bold text-danger">0</h2>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="card shadow-sm p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">User Registrations</h5>
                    <span class="badge bg-info text-dark">Last 6 Months</span>
                </div>
                <canvas id="userChart" height="120"></canvas>
            </div>
        </main>
    </div>
</div>

<!-- Script -->
<script>
    let userChartInstance = null;

    async function loadDashboardData() {
        try {
            const response = await fetch('/api/admin/dashboard');
            const data = await response.json();

            // Update cards
            document.getElementById('totalUsers').innerText = data.totalUsers ?? 0;
            document.getElementById('activeUsers').innerText = data.activeUsers ?? 0;
            document.getElementById('totalProjects').innerText = data.totalProjects ?? 0;
            document.getElementById('violatedProjects').innerText = data.violatedProjects ?? 0;

            // Chart (user registrations)
            const labels = data.registrations.map(r => "Month " + r[0]);
            const values = data.registrations.map(r => r[1]);

            const ctx = document.getElementById('userChart').getContext('2d');
            if (userChartInstance) userChartInstance.destroy();

            userChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Registrations',
                        data: values,
                        borderColor: 'rgba(54,162,235,1)',
                        backgroundColor: 'rgba(54,162,235,0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        } catch (err) {
            console.error("Failed to load dashboard data", err);
        }
    }

    document.addEventListener("DOMContentLoaded", loadDashboardData);
</script>
<script src="/js/logout.js"></script>
</body>
</html>
