<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>User Management – DevCollab Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: #f8fafc;
        }
        .container-fluid {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background-color: #1e293b;
            color: #fff;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            padding: 25px 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .sidebar h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; }
        .sidebar ul { list-style: none; padding: 0; margin: 0; }
        .sidebar ul li { margin-bottom: 1rem; }
        .sidebar ul li a {
            color: #cbd5e1;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 500;
            transition: background .2s, transform .1s, color .2s;
        }
        .sidebar ul li a:hover { background: #334155; color: #fff; transform: translateX(3px); }
        .sidebar ul li a.active { background: #3b82f6; color: #fff; }
        .logout-btn { color: #cbd5e1; text-decoration: none; padding: 8px 12px; border-radius: 8px; }
        .logout-btn:hover { background: #334155; color: #fff; }

        /* Main */
        main { flex: 1; margin-left: 240px; padding: 30px; overflow-y: auto; }
        .badge { text-transform: capitalize; }
        .table td, .table th { vertical-align: middle; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .search-bar { width: 300px; }
        .initial {
            width: 40px; height: 40px;
            border-radius: 50%; display: inline-flex;
            align-items: center; justify-content: center;
            background: #1f2937; color: #fff; font-weight: 600;
        }
    </style>
</head>

<body>
<div class="container-fluid">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div>
            <h2>DevCollab</h2>
            <ul>
                <li><a href="/admin/dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                <li><a href="/admin/manage" class="active"><i class="bi bi-people-fill"></i> User Management</a></li>
                <li><a href="/admin/user-reports"><i class="bi bi-person-x-fill"></i> Reported Users</a></li>
                <li><a href="/admin/project-reports"><i class="bi bi-flag-fill"></i> Reported Projects</a></li>
                <li><a href="/admin/user-logs"><i class="bi bi-journal-text"></i> System Logs</a></li>
            </ul>
        </div>
        <a id="logoutBtn" href="#" class="logout-btn d-flex align-items-center">
            <i class="bi bi-box-arrow-right me-2"></i> Logout
        </a>
    </aside>

    <!-- Main Content -->
    <main>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>User Management</h2>
            <input type="text" id="searchInput" class="form-control search-bar" placeholder="Search by name or email..." oninput="applySearch()">
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>User</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Premium</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="userTable"></tbody>
            </table>
        </div>
    </main>
</div>

<script>
    let allUsers = [], filtered = [];

    document.addEventListener("DOMContentLoaded", loadUsers);

    async function loadUsers() {
        try {
            const res = await fetch('/api/users');
            if (!res.ok) throw new Error('Failed to fetch users');
            const raw = await res.json();
            allUsers = raw.map(normalizeUser);
            filtered = [...allUsers];
            render();
        } catch (error) {
            console.error('Error loading users:', error);
            alert('Failed to load users: ' + error.message);
        }
    }

    function normalizeUser(u) {
        // Improved status normalization
        const rawStatus = (u.status || '').toLowerCase();
        let status;

        if (rawStatus === 'banned' || rawStatus === 'suspended') {
            status = 'banned';
        } else if (rawStatus === 'verified' || rawStatus === 'active') {
            status = 'active';
        } else {
            status = 'active'; // Default to active for any other status
        }

        // Improved premium detection
        const premium =
            u.isPremium === true ||
            u.isPremium === "true" ||
            u.isPremium === 1 ||
            u.isPremium === "1" ||
            u.is_premium === 1 ||
            u.is_premium === "1" ||
            u.is_premium === true ||
            u.premiumExpiry !== null ||
            u.premium_expiry !== null;

        return {
            id: u.userId ?? u.user_id ?? u.id,
            name: u.name || '—',
            email: u.email || '—',
            status,
            premium,
            premiumExpiry: u.premiumExpiry || u.premium_expiry || null,
            avatarUrl: u.avatarUrl || u.avatar_url || null
        };
    }

    function render() {
        const tbody = document.getElementById("userTable");
        if (!filtered.length) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No users found</td></tr>`;
            return;
        }

        tbody.innerHTML = filtered.map((u, i) => {
            const statusBadge = u.status === 'banned'
                ? `<span class="badge bg-danger">Banned</span>`
                : `<span class="badge bg-success">Active</span>`;

            const premiumBadge = u.premium
                ? `<span class="badge bg-warning text-dark">Premium${u.premiumExpiry ? ' • ' + fmtDate(u.premiumExpiry) : ''}</span>`
                : `<span class="badge bg-secondary">Free</span>`;

            const avatar = u.avatarUrl
                ? `<img src="${u.avatarUrl}" class="avatar me-2" onerror="this.outerHTML=getInitial('${esc(u.name)}')" alt="">`
                : getInitial(u.name);

            return `
                <tr>
                    <td>${i + 1}</td>
                    <td>${avatar} ${esc(u.name)}</td>
                    <td>${esc(u.email)}</td>
                    <td>${statusBadge}</td>
                    <td>${premiumBadge}</td>
                    <td>
                        <button class="btn btn-sm ${u.status === 'banned' ? 'btn-success' : 'btn-danger'}"
                                onclick="toggleBan(${u.id}, '${u.status}')"
                                title="${u.status === 'banned' ? 'Unban' : 'Ban'}">
                            ${u.status === 'banned' ? '<i class="bi bi-unlock"></i>' : '<i class="bi bi-lock"></i>'}
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function esc(s) {
        return String(s ?? '').replace(/[&<>"']/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[m]));
    }

    function getInitial(name) {
        const ch = (name || 'U').trim()[0]?.toUpperCase() || 'U';
        return `<span class="initial me-2">${ch}</span>`;
    }

    function fmtDate(d) {
        try {
            return new Date(d).toLocaleDateString();
        } catch (e) {
            return 'Invalid Date';
        }
    }

    function applySearch() {
        const q = document.getElementById("searchInput").value.toLowerCase();
        filtered = allUsers.filter(u =>
            u.name.toLowerCase().includes(q) || u.email.toLowerCase().includes(q)
        );
        render();
    }

    async function toggleBan(userId, status) {
        const ban = status !== 'banned';
        const action = ban ? 'ban' : 'unban';

        if (!confirm(`Are you sure you want to ${action} this user?`)) return;

        try {
            // Use the toggle-ban endpoint
            const res = await fetch(`/api/users/${userId}/toggle-ban`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (res.ok) {
                const result = await res.json();

                // Update local user status
                const idx = allUsers.findIndex(u => u.id === userId);
                if (idx > -1) allUsers[idx].status = result.newStatus;

                applySearch();
                alert(`User ${action}ned successfully!`);
            } else {
                const errorData = await res.json();
                alert('Failed to update user status: ' + (errorData.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error toggling ban:', error);
            alert('Failed to update user status: ' + error.message);
        }
    }

</script>

<script src="/js/logout.js"></script>
</body>
</html>