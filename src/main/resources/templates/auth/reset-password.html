<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kanban Board - Members Popup</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-indigo-400 to-purple-500 p-6">

  <!-- üß© Kanban Board -->
  <div id="kanban-board" class="flex gap-5 overflow-x-auto pb-6"></div>

  <!-- üß© Task Detail Modal -->
  <div id="task-detail-modal"
       class="fixed inset-0 z-50 flex items-start justify-center p-4 pt-16 bg-black/60 backdrop-blur-sm hidden">

    <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto flex flex-col">

      <!-- Header -->
      <div class="flex items-center justify-between p-4 border-b sticky top-0 bg-white z-10">
        <div class="flex items-center gap-2">
          <!-- ‚úÖ Button Members -->
          <button id="open-members-btn"
                  onclick="openMemberPopup(event)"
                  class="flex items-center gap-1 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded">
            üë• Members
          </button>
          <span class="text-sm bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded cursor-pointer">
            Marketing Website ‚ñº
          </span>
        </div>
        <button onclick="closeModal()" class="text-gray-600 hover:text-gray-900 text-2xl font-light">√ó</button>
      </div>

      <!-- Content -->
      <div class="flex flex-col md:flex-row p-4 md:p-6 gap-6 overflow-y-auto">

        <!-- Left column -->
        <div class="w-full md:w-2/3 space-y-6">
          <div class="flex items-center gap-3">
            <span class="text-2xl text-gray-500">‚óã</span>
            <h2 class="text-2xl font-semibold text-gray-900">Task Title</h2>
          </div>

          <!-- Description -->
          <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center gap-2">
              <span class="text-gray-600">‚ò∞</span> Description
            </h3>

            <div id="description-display"
                 class="group relative bg-white border border-transparent rounded-md p-3 min-h-[60px] text-sm text-gray-800 hover:border-gray-300 transition">
              <p id="description-content" class="whitespace-pre-line"></p>
              <p id="description-placeholder" class="text-gray-500">Add a more detailed description...</p>

              <button onclick="showDescriptionEditor()"
                      class="absolute top-2 right-2 hidden group-hover:inline-flex text-sm text-gray-600 hover:text-blue-600">
                Edit
              </button>
            </div>

            <div id="description-editor" class="hidden mt-2">
              <textarea id="description-textarea"
                        class="w-full border border-gray-300 p-3 h-40 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 border-blue-400"
                        placeholder="Type @ to mention your teammates..."></textarea>

              <div class="flex items-center gap-2 mt-2">
                <button onclick="saveDescription()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-md text-sm font-medium">
                  Save
                </button>
                <button onclick="hideDescriptionEditor()"
                        class="hover:bg-gray-200 px-3 py-1.5 rounded-md text-sm text-gray-700">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Right column -->
        <div class="w-full md:w-1/3 space-y-4">
          <h3 class="font-semibold text-gray-800 flex items-center gap-2">
            <span class="text-gray-600">üí¨</span> Comments & Activity
          </h3>
          <textarea class="w-full border border-gray-300 rounded-md p-3 h-20 text-sm
                            focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                    placeholder="Write a comment..."></textarea>
          <p class="text-gray-500 italic text-sm">No activity yet.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Members Popup -->
  <div id="members-popup"
       class="hidden fixed z-[60] bg-white border border-gray-300 rounded-lg shadow-lg w-80 p-3">
    <div class="flex items-center justify-between mb-2">
      <h3 class="font-semibold text-gray-800 text-sm">Members</h3>
      <button onclick="closeMemberPopup()" class="text-gray-500 hover:text-gray-700 text-lg">√ó</button>
    </div>

    <input id="search-member-input" type="text"
           placeholder="Search members..."
           class="w-full border border-gray-300 rounded-md p-2 text-sm mb-3 focus:ring-2 focus:ring-blue-400">

    <div id="members-section" class="space-y-4 max-h-[300px] overflow-y-auto">
      <div>
        <h4 class="text-xs font-semibold text-gray-500 uppercase mb-1">Card Members</h4>
        <div id="card-members" class="space-y-2"></div>
      </div>
      <div>
        <h4 class="text-xs font-semibold text-gray-500 uppercase mb-1">Board Members</h4>
        <div id="board-members" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <script>
  const params = new URLSearchParams(window.location.search);
  const PROJECT_ID = params.get("projectId") || 1;
  const modal = document.getElementById('task-detail-modal');

  // ---------- C√ÅC H√ÄM B·ªä THI·∫æU ƒê·ªÇ RENDER BOARD ----------

  // üß© Load danh s√°ch c·ªôt
  async function loadColumns(projectId) {
    const res = await fetch(`/api/columns/project/${projectId}`);
    if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch c·ªôt");
    return await res.json();
  }

  // üß© Load danh s√°ch task
  async function loadTasks(projectId) {
    const res = await fetch(`/api/tasks/project/${projectId}`);
    if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch task");
    return await res.json();
  }

  // üß© Gom task theo t√™n c·ªôt
  function groupByColumn(tasks) {
    const groups = {};
    tasks.forEach(t => {
      const col = t.columnName || "Backlog";
      if (!groups[col]) groups[col] = [];
      groups[col].push(t);
    });
    return groups;
  }

  // üß© Render to√†n b·ªô Kanban
  async function renderDashboard(projectId) {
    try {
      const [columns, tasks] = await Promise.all([loadColumns(projectId), loadTasks(projectId)]);
      const grouped = groupByColumn(tasks);
      const board = document.getElementById("kanban-board");
      board.innerHTML = "";

      columns.forEach(col => {
        const items = grouped[col.name] || [];
        const htmlTasks = items.length
          ? items.map(renderCard).join("")
          : `<div class="text-sm text-slate-400 italic">Ch∆∞a c√≥ th·∫ª</div>`;

        board.innerHTML += `
          <div class="bg-white/95 backdrop-blur-md rounded-xl shadow-md p-4 min-w-[320px] flex flex-col justify-between">
            <div>
              <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-slate-800">${col.name}</h3>
                <span class="text-slate-400 text-sm">${items.length}</span>
              </div>
              <div class="space-y-3" id="col-${col.columnId}">
                ${htmlTasks}
              </div>
            </div>
            <div class="mt-4">
              <div class="add-card-area" data-col="${col.columnId}">
                <button onclick="showAddCardInput(${col.columnId})"
                        class="w-full text-left text-slate-500 hover:text-blue-600 text-sm font-medium">
                  Ôºã Add a card
                </button>
              </div>
            </div>
          </div>
        `;
      });
    } catch (e) {
      console.error("‚ö†Ô∏è L·ªói khi render board:", e);
    }
  }

  // üß© Render 1 task card (ƒê√¢y l√† h√†m g·ªçi openModal)
  function renderCard(t) {
    const taskId = t.id; // ƒê·∫£m b·∫£o task c·ªßa b·∫°n c√≥ 'id'
    return `
      <div onclick="openModal(${taskId})" 
           class="bg-white border border-slate-200 rounded-md p-3 shadow-sm hover:shadow-md transition cursor-pointer">
        <p class="font-medium text-slate-800 text-sm">${escapeHtml(t.title)}</p>
      </div>
    `;
  }
  
  // (C√°c h√†m th√™m th·∫ª nhanh, c√≥ th·ªÉ b·∫°n s·∫Ω c·∫ßn)
  function showAddCardInput(columnId) {
    const area = document.querySelector(`.add-card-area[data-col='${columnId}']`);
    area.innerHTML = `
      <div class="space-y-2">
        <textarea id="new-card-title-${columnId}" rows="2"
                  class="w-full border border-slate-300 rounded-md px-2 py-1.5 text-sm focus:ring focus:ring-blue-300"
                  placeholder="Enter a title or paste a link"></textarea>
        <div class="flex items-center gap-2">
          <button onclick="addCard(${columnId})"
                  class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1.5 rounded-md">Add card</button>
          <button onclick="cancelAddCard(${columnId})"
                  class="text-slate-500 text-sm">‚úï</button>
        </div>
      </div>
    `;
  }

  function cancelAddCard(columnId) {
    const area = document.querySelector(`.add-card-area[data-col='${columnId}']`);
    area.innerHTML = `
      <button onclick="showAddCardInput(${columnId})"
              class="w-full text-left text-slate-500 hover:text-blue-600 text-sm font-medium">
        Ôºã Add a card
      </button>
    `;
  }

  async function addCard(columnId) {
    const textarea = document.getElementById(`new-card-title-${columnId}`);
    const title = textarea.value.trim();
    if (!title) return;
    const payload = { title: title, projectId: PROJECT_ID, columnId: columnId };
    try {
      const res = await fetch("/api/tasks/quick", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫°o task");
      await renderDashboard(PROJECT_ID);
    } catch (err) { console.error("‚ùå L·ªói t·∫°o task:", err); }
  }

  function escapeHtml(str) {
    return (str || "").replace(/[&<>"']/g, s => (
      { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s]
    ));
  }
  
  // ---------- H·∫æT C√ÅC H√ÄM B·ªä THI·∫æU ----------


  // ---------- C√ÅC H√ÄM B·∫†N ƒê√É C√ì (MODAL, DESCRIPTION, MEMBER) ----------

  // ---------- MODAL ----------
  async function openModal(taskId) {
    try {
      const res = await fetch(`/api/tasks/${taskId}`);
      if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt task");
      const task = await res.json();
      document.querySelector("#task-detail-modal h2").textContent = task.title || "Untitled";
      renderDescription(task);
      window.CURRENT_TASK_ID = taskId;
      modal.classList.remove("hidden");
    } catch (err) {
      console.error("‚ùå L·ªói khi m·ªü modal:", err);
    }
  }

  function closeModal() { modal.classList.add("hidden"); }
  modal.addEventListener("click", e => { if (e.target === modal) closeModal(); });

  // ---------- DESCRIPTION ----------
  const descDisplay = document.getElementById('description-display');
  const descContent = document.getElementById('description-content');
  const descPlaceholder = document.getElementById('description-placeholder');
  const descEditor = document.getElementById('description-editor');
  const descTextarea = document.getElementById('description-textarea');

  function showDescriptionEditor() {
    descDisplay.classList.add('hidden');
    descEditor.classList.remove('hidden');
    descTextarea.value = descContent.textContent.trim() || "";
    descTextarea.focus();
  }

  function hideDescriptionEditor() {
    descEditor.classList.add('hidden');
    descDisplay.classList.remove('hidden');
  }

  async function saveDescription() {
    const newDescription = descTextarea.value.trim();
    const taskId = window.CURRENT_TASK_ID;
    try {
      const res = await fetch(`/api/tasks/${taskId}/description`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ description_md: newDescription })
      });
      const updated = await res.json();
      const newDesc = updated.descriptionMd || "";
      descContent.textContent = newDesc;
      descPlaceholder.style.display = newDesc ? "none" : "block";
      hideDescriptionEditor();
    } catch (err) { alert("Kh√¥ng th·ªÉ l∆∞u m√¥ t·∫£"); }
  }

  function renderDescription(task) {
    const desc = (task.descriptionMd || "").trim();
    if (desc) {
      descContent.textContent = desc;
      descPlaceholder.style.display = "none";
    } else {
      descContent.textContent = "";
      descPlaceholder.style.display = "block";
    }
  }

  // ---------- MEMBER POPUP ----------
  const membersPopup = document.getElementById('members-popup');
  const searchInput = document.getElementById('search-member-input');
  const cardMembersDiv = document.getElementById('card-members');
  const boardMembersDiv = document.getElementById('board-members');

  function openMemberPopup(event) {
    event.stopPropagation();
    const rect = event.currentTarget.getBoundingClientRect();
    membersPopup.style.top = rect.bottom + 6 + "px";
    membersPopup.style.left = rect.left + "px";
    membersPopup.classList.remove("hidden");
    loadMembers();
  }

  function closeMemberPopup() { membersPopup.classList.add("hidden"); }

  document.addEventListener('click', e => {
    if (!membersPopup.contains(e.target) && !e.target.closest('#open-members-btn')) {
      closeMemberPopup();
    }
  });

  async function loadMembers(keyword = "") {
    const taskId = window.CURRENT_TASK_ID;
    cardMembersDiv.innerHTML = `<p class="text-gray-400 text-sm italic">Loading...</p>`;
    boardMembersDiv.innerHTML = "";
    try {
      const [resBoard, resCard] = await Promise.all([
        fetch(`/api/pm/members?projectId=${PROJECT_ID}&keyword=${encodeURIComponent(keyword)}`),
        fetch(`/api/tasks/${taskId}/members`)
      ]);
      const boardMembers = await resBoard.json();
      const cardMembers = await resCard.json();
      const assignedIds = cardMembers.map(m => m.userId);
      renderCardMembers(cardMembers);
      renderBoardMembers(boardMembers, assignedIds);
    } catch {
      cardMembersDiv.innerHTML = `<p class="text-red-500 text-sm">Error loading members</p>`;
    }
  }

  function renderCardMembers(members) {
    if (!members.length) {
      cardMembersDiv.innerHTML = `<p class="text-gray-400 text-sm italic">No members assigned</p>`;
      return;
    }
    cardMembersDiv.innerHTML = members.map(m => `
      <div class="flex items-center justify-between p-1 hover:bg-gray-100 rounded-md">
        <div class="flex items-center gap-2">
          ${renderAvatar(m)}
          <p class="text-sm text-gray-700">${m.name}</p>
        </div>
        <button onclick="unassignMember(${m.userId})" class="text-gray-400 hover:text-red-500 text-lg">√ó</button>
      </div>`).join('');
  }

  function renderBoardMembers(members, assignedIds) {
    if (!members.length) {
      boardMembersDiv.innerHTML = `<p class="text-gray-400 text-sm italic">No other members</p>`;
      return;
    }
    boardMembersDiv.innerHTML = members
      .filter(m => !assignedIds.includes(m.userId))
      .map(m => `
        <div class="flex items-center justify-between p-1 hover:bg-gray-100 rounded-md">
          <div class="flex items-center gap-2">
            ${renderAvatar(m)}
            <p class="text-sm text-gray-700">${m.name}</p>
          </div>
          <button onclick="assignMember(${m.userId})"
                  class="text-gray-400 hover:text-blue-500 text-lg">Ôºã</button>
        </div>`).join('');
  }

  function renderAvatar(m) {
    if (m.avatarUrl && m.avatarUrl.trim() !== "")
      return `<img src="${m.avatarUrl}" alt="${m.name}"
                   class="w-8 h-8 rounded-full border border-gray-300 object-cover">`;
    const initials = getInitials(m.name);
    const color = getColorForId(m.userId);
    return `<div class="w-8 h-8 flex items-center justify-center rounded-full text-xs font-semibold text-white"
                 style="background-color:${color}">${initials}</div>`;
  }

  function getInitials(name) {
    if (!name) return "?";
    const w = name.trim().split(" ");
    return w.length > 1 ? (w[0][0] + w[w.length - 1][0]).toUpperCase() : w[0][0].toUpperCase();
  }

  function getColorForId(id) {
    const colors = ["#f59e0b","#10b981","#3b82f6","#8b5cf6","#ec4899","#ef4444","#14b8a6","#f97316","#6366f1","#84cc16"];
    const i = typeof id === "number"
      ? id % colors.length
      : id.toString().split("").reduce((a,c)=>a+c.charCodeAt(0),0)%colors.length;
    return colors[i];
  }

  async function assignMember(userId) {
    const taskId = window.CURRENT_TASK_ID;
    await fetch(`/api/tasks/${taskId}/assign/${userId}`, { method: "PUT" });
    loadMembers(searchInput.value);
  }

  async function unassignMember(userId) {
    const taskId = window.CURRENT_TASK_ID;
    await fetch(`/api/tasks/${taskId}/unassign/${userId}`, { method: "PUT" });
    loadMembers(searchInput.value);
  }

  searchInput.addEventListener('input', e => loadMembers(e.target.value.trim()));


  document.addEventListener("DOMContentLoaded", () => {
    renderDashboard(PROJECT_ID); 
  });
</script>
</body>
</html>
