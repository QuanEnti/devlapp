<link rel="icon" href="data:;base64,iVBORw0KGgo=" />
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>XÃ¡c minh email - DevCollab</title>
    <style>
      body {
        font-family: "Inter", "Segoe UI", sans-serif;
        background: #f5f7fa;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        animation: fadeIn 0.3s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .card {
        background: white;
        padding: 40px 45px;
        border-radius: 16px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        width: 380px;
        text-align: center;
      }
      input {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 22px;
        letter-spacing: 8px;
        text-align: center;
        margin-bottom: 15px;
      }
      button {
        width: 100%;
        padding: 12px;
        border-radius: 30px;
        border: none;
        background: #000;
        color: white;
        font-size: 15px;
        cursor: pointer;
        transition: 0.2s;
      }
      button:hover {
        background: #222;
      }
      #msg {
        margin-top: 10px;
        font-size: 14px;
        color: red;
        min-height: 20px;
      }
      #resend {
        background: transparent;
        color: #0078ff;
        border: none;
        cursor: pointer;
        font-size: 13px;
        margin-top: 12px;
        text-decoration: underline;
      }
      #resend:disabled {
        color: gray;
        text-decoration: none;
        cursor: not-allowed;
      }
    </style>
  </head>

  <body>
    <div class="card">
      <h2>XÃ¡c minh email</h2>
      <p id="otpInfo">Nháº­p mÃ£ 6 chá»¯ sá»‘ Ä‘Æ°á»£c gá»­i Ä‘áº¿n email cá»§a báº¡n.</p>

      <input
        type="text"
        id="otp"
        maxlength="6"
        placeholder="______"
        inputmode="numeric"
      />
      <button id="verifyBtn" onclick="verifyOtp()">XÃ¡c minh</button>
      <p id="msg"></p>
      <button id="resend" onclick="resendOtp()" disabled>
        Gá»­i láº¡i OTP (15s)
      </button>
    </div>

    <script>
        if (document.cookie.includes("AUTH_TOKEN")) {
          window.location.href = "/view/home";
        }

        const email = localStorage.getItem('email');
        const mode = localStorage.getItem('verify_mode');
        const otpInfo = document.getElementById('otpInfo');
        const resendBtn = document.getElementById('resend');
        const msg = document.getElementById('msg');

        if (!email) {
          alert('Thiáº¿u email xÃ¡c minh. Vui lÃ²ng quay láº¡i Ä‘Äƒng nháº­p hoáº·c Ä‘Äƒng kÃ½.');
          window.location.href = '/view/signin';
        } else {
          otpInfo.textContent = `Nháº­p mÃ£ 6 chá»¯ sá»‘ Ä‘Æ°á»£c gá»­i Ä‘áº¿n ${email}`;
        }

        let isCooldown = false;
        let isResending = false;
        let timerId = null;

        function startCooldown(seconds = 15) {
          isCooldown = true;
          resendBtn.disabled = true;
          clearInterval(timerId);

          const tick = () => {
            resendBtn.textContent = `Gá»­i láº¡i OTP (${seconds}s)`;
            seconds--;
            if (seconds < 0) {
              clearInterval(timerId);
              isCooldown = false;
              resendBtn.disabled = false;
              resendBtn.textContent = 'Gá»­i láº¡i OTP';
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
          .card {
            background: white;
            padding: 40px 45px;
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            width: 380px;
            text-align: center;
          }
          input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 22px;
            letter-spacing: 8px;
            text-align: center;
            margin-bottom: 15px;
          }
          button {
            width: 100%;
            padding: 12px;
            border-radius: 30px;
            border: none;
            background: #000;
            color: white;
            font-size: 15px;
            cursor: pointer;
            transition: 0.2s;
          }
          button:hover {
            background: #222;
          }
          #msg {
            margin-top: 10px;
            font-size: 14px;
            color: red;
            min-height: 20px;
          }
          #resend {
            background: transparent;
            color: #0078ff;
            border: none;
            cursor: pointer;
            font-size: 13px;
            margin-top: 12px;
            text-decoration: underline;
          }
          #resend:disabled {
            color: gray;
            text-decoration: none;
            cursor: not-allowed;
          }
        </style>
      </head>

      <body>
        <div class="card">
          <h2>XÃ¡c minh email</h2>
          <p id="otpInfo">Nháº­p mÃ£ 6 chá»¯ sá»‘ Ä‘Æ°á»£c gá»­i Ä‘áº¿n email cá»§a báº¡n.</p>

          <input
            type="text"
            id="otp"
            maxlength="6"
            placeholder="______"
            inputmode="numeric"
          />
          <button id="verifyBtn" onclick="verifyOtp()">XÃ¡c minh</button>
          <p id="msg"></p>
          <button id="resend" onclick="resendOtp()" disabled>
            Gá»­i láº¡i OTP (15s)
          </button>
        </div>

        <script>
          if (document.cookie.includes("AUTH_TOKEN")) {
            window.location.href = "/user/view/dashboard";
          }

          const email = localStorage.getItem("email");
          const mode = localStorage.getItem("verify_mode");
          const otpInfo = document.getElementById("otpInfo");
          const resendBtn = document.getElementById("resend");
          const msg = document.getElementById("msg");

          if (!email) {
            showToast(
              "Thiáº¿u email xÃ¡c minh. Vui lÃ²ng quay láº¡i Ä‘Äƒng nháº­p hoáº·c Ä‘Äƒng kÃ½.",
              "warning"
            );
            setTimeout(() => {
              window.location.href = "/view/signin";
            }, 1500);
          } else {
            otpInfo.textContent = `Nháº­p mÃ£ 6 chá»¯ sá»‘ Ä‘Æ°á»£c gá»­i Ä‘áº¿n ${email}`;
          }

          let isCooldown = false;
          let isResending = false;
          let timerId = null;

          function startCooldown(seconds = 15) {
            isCooldown = true;
            resendBtn.disabled = true;
            clearInterval(timerId);

            const tick = () => {
              resendBtn.textContent = `Gá»­i láº¡i OTP (${seconds}s)`;
              seconds--;
              if (seconds < 0) {
                clearInterval(timerId);
                isCooldown = false;
                resendBtn.disabled = false;
                resendBtn.textContent = "Gá»­i láº¡i OTP";
              }
            };
            tick();
            timerId = setInterval(tick, 1000);
          }
          startCooldown(15);
          async function resendOtp() {
            if (isCooldown || isResending) return;
            isResending = true;
            startCooldown(15);

            msg.textContent = "";
            try {
              const res = await fetch("/api/auth/resend-otp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email }),
              });

              const data = await res.json();
              if (res.ok) {
                msg.style.color = "green";
                msg.textContent = "ÄÃ£ gá»­i láº¡i mÃ£ OTP Ä‘áº¿n email cá»§a báº¡n.";
              } else {
                msg.style.color = "red";
                msg.textContent = data.error || "KhÃ´ng thá»ƒ gá»­i láº¡i OTP.";
              }
            } catch (err) {
              msg.style.color = "red";
              msg.textContent = "KhÃ´ng thá»ƒ káº¿t ná»‘i mÃ¡y chá»§.";
              console.error("âš ï¸ Lá»—i gá»­i láº¡i OTP:", err);
            } finally {
              isResending = false;
            }
          }
          async function verifyOtp() {
            const otp = document.getElementById("otp").value.trim();
            msg.textContent = "";

            if (!otp || otp.length !== 6) {
              msg.textContent = "Vui lÃ²ng nháº­p mÃ£ OTP há»£p lá»‡.";
              msg.style.color = "red";
              return;
            }

            try {
              const res = await fetch("/api/auth/verify-otp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, otp, mode }),
              });

              const data = await res.json();
              console.log("Verify OTP:", data);

              if (res.ok) {
                msg.style.color = "green";
                msg.textContent = "XÃ¡c minh thÃ nh cÃ´ng!";

                setTimeout(() => {
                  if (mode === "reset") {
                    console.log("ðŸ” Chuyá»ƒn sang /view/reset-password (mode reset)");
                    window.location.href = "/view/reset-password";
                  } else {
                    console.log("ðŸ  Chuyá»ƒn sang /view/home (mode thÆ°á»ng)");
                    window.location.href = "/user/view/profile";
                  }

                  localStorage.removeItem("verify_mode");
                }, 1000);
              } else {
                msg.style.color = "red";
                msg.textContent =
                  data.error || "MÃ£ OTP khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ háº¿t háº¡n.";
              }
            } catch (err) {
              msg.style.color = "red";
              msg.textContent = "KhÃ´ng thá»ƒ káº¿t ná»‘i mÃ¡y chá»§.";
              console.error(" Lá»—i verify OTP:", err);
            }
          }

          document.getElementById("otp").addEventListener("input", (e) => {
            const otp = e.target.value.replace(/\D/g, "").slice(0, 6);
            e.target.value = otp;
            if (otp.length === 6) verifyOtp();
          });
    </script>
  </body>
</html>
