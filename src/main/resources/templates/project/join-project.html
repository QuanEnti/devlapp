<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Join Project - DevCollab</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body
    class="min-h-screen bg-gray-50 text-gray-800 flex items-center justify-center"
  >
    <div
      id="invite-card"
      class="bg-white rounded-lg shadow-2xl w-full max-w-md p-8"
    >
      <div class="text-center mb-6">
        <img
          src="/photo/logo1.png"
          alt="DevCollab"
          class="w-16 h-16 mx-auto mb-4 object-contain"
        />

        <h1 id="invite-title" class="text-xl font-semibold text-gray-800 mb-2">
          You've been invited to join a project
        </h1>

        <p class="text-gray-600 text-sm">
          Please confirm to start collaborating with the team
        </p>
      </div>

      <button
        id="join-btn"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2.5 rounded-md shadow-sm transition-all duration-200 hover:shadow-md"
      >
        Join Project
      </button>

      <p class="text-xs text-gray-400 mt-5 text-center">
        Not you?
        <a href="#" id="logout-link" class="text-blue-600 hover:underline"
          >Logout</a
        >
      </p>
    </div>

    <script>
      // âœ… Toast notification (replaces alert) - displays in center of screen
      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.textContent = message;
        toast.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 px-6 py-4 rounded-lg text-white z-[9999] shadow-2xl transition-all duration-300 text-center min-w-[300px] max-w-[500px] ${
          type === "error"
            ? "bg-red-500"
            : type === "success"
            ? "bg-green-600"
            : "bg-blue-600"
        }`;
        document.body.appendChild(toast);

        // Auto remove sau 3 giÃ¢y
        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translate(-50%, -50%) scale(0.95)";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // âœ… Äá»c cookie
      function getCookie(name) {
        const value = document.cookie.match(
          "(^|;)\\s*" + name + "\\s*=\\s*([^;]+)"
        );
        return value ? value.pop() : null;
      }

      // âœ… HÃ m kiá»ƒm tra token cÃ³ tá»“n táº¡i chÆ°a
      function hasToken() {
        return localStorage.getItem("token") || getCookie("AUTH_TOKEN");
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const path = window.location.pathname;
        const inviteLink = path.split("/join/")[1];
        const joinBtn = document.getElementById("join-btn");

        // Prevent reload loop after login
        if (sessionStorage.getItem("redirectedOnce") === "true") {
          sessionStorage.removeItem("redirectedOnce");
        } else if (!hasToken()) {
          sessionStorage.setItem("redirectedOnce", "true");
          const redirectUrl = encodeURIComponent(window.location.pathname);
          window.location.href = `/view/signin?redirect=${redirectUrl}`;
          return;
        }

        // Wait for token cookie to stabilize (especially after OAuth2 redirect)
        await new Promise((r) => setTimeout(r, 300));

        joinBtn.addEventListener("click", async () => {
          joinBtn.disabled = true;
          joinBtn.textContent = "Processing...";

          const token =
            localStorage.getItem("token") || getCookie("AUTH_TOKEN");

          try {
            const res = await fetch(`/api/pm/invite/join/${inviteLink}`, {
              method: "POST",
              credentials: "include",
              headers: {
                Authorization: "Bearer " + token,
                "Content-Type": "application/json",
              },
            });

            const text = await res.text();

            // ðŸŸ¢ If backend returns error
            if (!res.ok) {
              let errorMessage = "Unable to join project";

              // âœ… Parse JSON error if available
              try {
                const errObj = JSON.parse(text);
                errorMessage = errObj.error || errObj.message || errorMessage;

                // âœ… If join request already sent â†’ redirect to user dashboard
                if (
                  errorMessage.includes("request sent") ||
                  errorMessage.includes("pending approval") ||
                  errorMessage.includes("waiting for approval")
                ) {
                  showToast(errorMessage, "info");
                  setTimeout(() => {
                    window.location.href = `/user/view/dashboard`;
                  }, 2000);
                  return;
                }

                // If projectId exists in error â†’ redirect
                if (errObj.projectId) {
                  showToast(errorMessage, "info");
                  setTimeout(() => {
                    window.location.href = `/view/pm/project/board?projectId=${errObj.projectId}`;
                  }, 1500);
                  return;
                }
              } catch (_) {
                // If cannot parse JSON â†’ use text directly
                if (
                  text.includes("already a member") ||
                  text.includes("Ä‘Ã£ lÃ  thÃ nh viÃªn")
                ) {
                  errorMessage =
                    "You are already a member of this project. Redirecting to board...";
                  showToast(errorMessage, "info");
                  setTimeout(() => {
                    window.location.href = `/view/pm/dashboard?joined=true`;
                  }, 1500);
                  return;
                }
                // âœ… Check if text contains request sent message
                if (
                  text.includes("request sent") ||
                  text.includes("pending approval") ||
                  text.includes("waiting for approval") ||
                  text.includes("Ä‘Ã£ gá»­i yÃªu cáº§u") ||
                  text.includes("Ä‘ang chá» phÃª duyá»‡t")
                ) {
                  errorMessage = text;
                  showToast(errorMessage, "info");
                  setTimeout(() => {
                    window.location.href = `/user/view/dashboard`;
                  }, 2000);
                  return;
                }
                errorMessage = text || errorMessage;
              }

              showToast(errorMessage, "error");
              return;
            }

            // ðŸŸ¢ Handle response based on message
            const data = JSON.parse(text);

            if (data.message === "join_request_sent") {
              showToast(
                `Join request sent! Project: ${data.projectName}. Please wait for PM approval.`,
                "info"
              );
              // âœ… Redirect to user dashboard after 2 seconds
              setTimeout(() => {
                window.location.href = `/user/view/dashboard`;
              }, 2000);
            } else if (data.message === "joined_success") {
              showToast(
                `Successfully joined project! ${data.projectName}`,
                "success"
              );
              setTimeout(() => {
                window.location.href = `/view/pm/project/board?projectId=${data.projectId}`;
              }, 1500);
            } else {
              // Fallback for other messages
              showToast(`${data.message} - ${data.projectName}`, "info");
              if (data.projectId) {
                setTimeout(() => {
                  window.location.href = `/view/pm/project/board?projectId=${data.projectId}`;
                }, 1500);
              }
            }
          } catch (err) {
            console.error("Join failed:", err);
            // âœ… Get message from error, if it's an object then parse
            let errorMessage = "Unable to join project";
            if (err.message) {
              try {
                // Try to parse if it's a JSON string
                const parsed = JSON.parse(err.message);
                errorMessage = parsed.error || parsed.message || errorMessage;
              } catch (_) {
                // If not JSON â†’ use directly
                errorMessage = err.message;
              }
            }
            showToast(errorMessage, "error");
          } finally {
            joinBtn.disabled = false;
            joinBtn.textContent = "Join Project";
          }
        });

        // âœ… Handle logout button
        const logoutLink = document.getElementById("logout-link");
        if (logoutLink) {
          logoutLink.addEventListener("click", async (e) => {
            e.preventDefault();
            try {
              // Call logout API
              await fetch("/api/auth/logout", {
                method: "POST",
                credentials: "include",
                headers: {
                  Authorization:
                    "Bearer " +
                    (localStorage.getItem("token") || getCookie("AUTH_TOKEN")),
                },
              });

              // Clear cookies and localStorage
              document.cookie = "AUTH_TOKEN=; Max-Age=0; path=/;";
              document.cookie = "REFRESH_TOKEN=; Max-Age=0; path=/;";
              localStorage.removeItem("token");
              localStorage.removeItem("AUTH_TOKEN");
              localStorage.removeItem("REFRESH_TOKEN");

              // Redirect to login page
              window.location.href = "/view/signin";
            } catch (err) {
              console.error("Logout error:", err);
              // Still redirect to signin if there's an error
              document.cookie = "AUTH_TOKEN=; Max-Age=0; path=/;";
              localStorage.clear();
              window.location.href = "/view/signin";
            }
          });
        }
      });
    </script>
  </body>
</html>
