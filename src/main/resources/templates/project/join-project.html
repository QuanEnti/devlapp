<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tham gia d·ª± √°n - DevCollab</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body
    class="min-h-screen bg-gray-50 text-gray-800 flex items-center justify-center"
  >
    <div
      id="invite-card"
      class="bg-white rounded-lg shadow-2xl w-full max-w-md p-8"
    >
      <div class="text-center mb-6">
        <img
          src="/photo/logo1.png"
          alt="DevCollab"
          class="w-16 h-16 mx-auto mb-4 object-contain"
        />

        <h1 id="invite-title" class="text-xl font-semibold text-gray-800 mb-2">
          B·∫°n ƒë∆∞·ª£c m·ªùi tham gia d·ª± √°n
        </h1>

        <p class="text-gray-600 text-sm">
          H√£y x√°c nh·∫≠n ƒë·ªÉ b·∫Øt ƒë·∫ßu c·ªông t√°c c√πng nh√≥m
        </p>
      </div>

      <button
        id="join-btn"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2.5 rounded-md shadow-sm transition-all duration-200 hover:shadow-md"
      >
        Tham gia d·ª± √°n
      </button>

      <p class="text-xs text-gray-400 mt-5 text-center">
        Kh√¥ng ph·∫£i b·∫°n?
        <a href="#" id="logout-link" class="text-blue-600 hover:underline"
          >ƒêƒÉng xu·∫•t</a
        >
      </p>
    </div>

    <script>
      // ‚úÖ Toast notification (thay th·∫ø alert) - hi·ªÉn th·ªã ·ªü gi·ªØa m√†n h√¨nh
      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.textContent = message;
        toast.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 px-6 py-4 rounded-lg text-white z-[9999] shadow-2xl transition-all duration-300 text-center min-w-[300px] max-w-[500px] ${
          type === "error"
            ? "bg-red-500"
            : type === "success"
            ? "bg-green-600"
            : "bg-blue-600"
        }`;
        document.body.appendChild(toast);

        // Auto remove sau 3 gi√¢y
        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translate(-50%, -50%) scale(0.95)";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // ‚úÖ ƒê·ªçc cookie
      function getCookie(name) {
        const value = document.cookie.match(
          "(^|;)\\s*" + name + "\\s*=\\s*([^;]+)"
        );
        return value ? value.pop() : null;
      }

      // ‚úÖ H√†m ki·ªÉm tra token c√≥ t·ªìn t·∫°i ch∆∞a
      function hasToken() {
        return localStorage.getItem("token") || getCookie("AUTH_TOKEN");
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const path = window.location.pathname;
        const inviteLink = path.split("/join/")[1];
        const joinBtn = document.getElementById("join-btn");

        // NgƒÉn v√≤ng l·∫∑p reload sau ƒëƒÉng nh·∫≠p
        if (sessionStorage.getItem("redirectedOnce") === "true") {
          sessionStorage.removeItem("redirectedOnce");
        } else if (!hasToken()) {
          sessionStorage.setItem("redirectedOnce", "true");
          const redirectUrl = encodeURIComponent(window.location.pathname);
          window.location.href = `/view/signin?redirect=${redirectUrl}`;
          return;
        }

        // ƒê·ª£i token cookie ·ªïn ƒë·ªãnh (ƒë·∫∑c bi·ªát sau OAuth2 redirect)
        await new Promise((r) => setTimeout(r, 300));

        joinBtn.addEventListener("click", async () => {
          joinBtn.disabled = true;
          joinBtn.textContent = "ƒêang x·ª≠ l√Ω...";

          const token =
            localStorage.getItem("token") || getCookie("AUTH_TOKEN");

          try {
            const res = await fetch(`/api/pm/invite/join/${inviteLink}`, {
              method: "POST",
              credentials: "include",
              headers: {
                Authorization: "Bearer " + token,
                "Content-Type": "application/json",
              },
            });

            const text = await res.text();

            // üü¢ N·∫øu backend tr·∫£ l·ªói
            if (!res.ok) {
              let errorMessage = "Kh√¥ng th·ªÉ tham gia d·ª± √°n";

              // ‚úÖ Parse JSON error n·∫øu c√≥
              try {
                const errObj = JSON.parse(text);
                errorMessage = errObj.error || errObj.message || errorMessage;

                // ‚úÖ N·∫øu ƒë√£ g·ª≠i join request ‚Üí redirect v·ªÅ user dashboard
                if (
                  errorMessage.includes("ƒë√£ g·ª≠i y√™u c·∫ßu") ||
                  errorMessage.includes("ƒëang ch·ªù ph√™ duy·ªát")
                ) {
                  showToast(errorMessage, "info");
                  setTimeout(() => {
                    window.location.href = `/user/view/dashboard`;
                  }, 2000);
                  return;
                }

                // N·∫øu c√≥ projectId trong error ‚Üí redirect
                if (errObj.projectId) {
                  showToast(errorMessage, "info");
                  setTimeout(() => {
                    window.location.href = `/view/pm/project/board?projectId=${errObj.projectId}`;
                  }, 1500);
                  return;
                }
              } catch (_) {
                // N·∫øu kh√¥ng parse ƒë∆∞·ª£c JSON ‚Üí d√πng text tr·ª±c ti·∫øp
                if (text.includes("ƒë√£ l√† th√†nh vi√™n")) {
                  errorMessage =
                    "B·∫°n ƒë√£ l√† th√†nh vi√™n c·ªßa d·ª± √°n n√†y. ƒêang chuy·ªÉn ƒë·∫øn b·∫£ng c√¥ng vi·ªác...";
                  showToast(errorMessage, "info");
                  setTimeout(() => {
                    window.location.href = `/view/pm/dashboard?joined=true`;
                  }, 1500);
                  return;
                }
                // ‚úÖ Ki·ªÉm tra n·∫øu text ch·ª©a th√¥ng b√°o ƒë√£ g·ª≠i request
                if (
                  text.includes("ƒë√£ g·ª≠i y√™u c·∫ßu") ||
                  text.includes("ƒëang ch·ªù ph√™ duy·ªát")
                ) {
                  errorMessage = text;
                  showToast(errorMessage, "info");
                  setTimeout(() => {
                    window.location.href = `/user/view/dashboard`;
                  }, 2000);
                  return;
                }
                errorMessage = text || errorMessage;
              }

              showToast(errorMessage, "error");
              return;
            }

            // üü¢ X·ª≠ l√Ω response d·ª±a tr√™n message
            const data = JSON.parse(text);

            if (data.message === "join_request_sent") {
              showToast(
                `Y√™u c·∫ßu tham gia ƒë√£ ƒë∆∞·ª£c g·ª≠i! D·ª± √°n: ${data.projectName}. Vui l√≤ng ƒë·ª£i PM duy·ªát.`,
                "info"
              );
              // ‚úÖ Chuy·ªÉn v·ªÅ dashboard user sau 2 gi√¢y
              setTimeout(() => {
                window.location.href = `/user/view/dashboard`;
              }, 2000);
            } else if (data.message === "joined_success") {
              showToast(
                `Tham gia d·ª± √°n th√†nh c√¥ng! ${data.projectName}`,
                "success"
              );
              setTimeout(() => {
                window.location.href = `/view/pm/project/board?projectId=${data.projectId}`;
              }, 1500);
            } else {
              // Fallback cho c√°c message kh√°c
              showToast(`${data.message} - ${data.projectName}`, "info");
              if (data.projectId) {
                setTimeout(() => {
                  window.location.href = `/view/pm/project/board?projectId=${data.projectId}`;
                }, 1500);
              }
            }
          } catch (err) {
            console.error("Join failed:", err);
            // ‚úÖ L·∫•y message t·ª´ error, n·∫øu l√† object th√¨ parse
            let errorMessage = "Kh√¥ng th·ªÉ tham gia d·ª± √°n";
            if (err.message) {
              try {
                // Th·ª≠ parse n·∫øu l√† JSON string
                const parsed = JSON.parse(err.message);
                errorMessage = parsed.error || parsed.message || errorMessage;
              } catch (_) {
                // N·∫øu kh√¥ng ph·∫£i JSON ‚Üí d√πng tr·ª±c ti·∫øp
                errorMessage = err.message;
              }
            }
            showToast(errorMessage, "error");
          } finally {
            joinBtn.disabled = false;
            joinBtn.textContent = "Tham gia d·ª± √°n";
          }
        });

        // ‚úÖ X·ª≠ l√Ω n√∫t ƒëƒÉng xu·∫•t
        const logoutLink = document.getElementById("logout-link");
        if (logoutLink) {
          logoutLink.addEventListener("click", async (e) => {
            e.preventDefault();
            try {
              // G·ªçi API logout
              await fetch("/api/auth/logout", {
                method: "POST",
                credentials: "include",
                headers: {
                  Authorization:
                    "Bearer " +
                    (localStorage.getItem("token") || getCookie("AUTH_TOKEN")),
                },
              });

              // X√≥a cookie v√† localStorage
              document.cookie = "AUTH_TOKEN=; Max-Age=0; path=/;";
              document.cookie = "REFRESH_TOKEN=; Max-Age=0; path=/;";
              localStorage.removeItem("token");
              localStorage.removeItem("AUTH_TOKEN");
              localStorage.removeItem("REFRESH_TOKEN");

              // Redirect v·ªÅ trang ƒëƒÉng nh·∫≠p
              window.location.href = "/view/signin";
            } catch (err) {
              console.error("Logout error:", err);
              // V·∫´n redirect v·ªÅ signin n·∫øu c√≥ l·ªói
              document.cookie = "AUTH_TOKEN=; Max-Age=0; path=/;";
              localStorage.clear();
              window.location.href = "/view/signin";
            }
          });
        }
      });
    </script>
  </body>
</html>
