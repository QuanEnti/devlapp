<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tham gia dá»± Ã¡n - DevCollab</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #4f46e5, #9333ea);
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center">
  <div id="invite-card" class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 text-center">
    <img src="/assets/devcollab-logo.svg" alt="DevCollab" class="w-14 h-14 mx-auto mb-3">

    <h1 id="invite-title" class="text-lg font-semibold text-gray-800 mb-1">
      Nguyá»…n Tiáº¿n QuÃ¢n Ä‘Ã£ chia sáº» 
      <span class="font-bold text-indigo-600">Design Project Template</span> vá»›i báº¡n.
    </h1>

    <p class="text-gray-500 text-sm mb-6">
      Báº¡n Ä‘Æ°á»£c má»i tham gia dá»± Ã¡n trÃªn DevCollab. HÃ£y xÃ¡c nháº­n Ä‘á»ƒ báº¯t Ä‘áº§u cá»™ng tÃ¡c cÃ¹ng nhÃ³m!
    </p>

    <button id="join-btn"
      class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2.5 rounded-md shadow transition">
      ğŸš€ Tham gia dá»± Ã¡n
    </button>

    <p class="text-xs text-gray-400 mt-5">
      KhÃ´ng pháº£i báº¡n?
      <a href="/logout" class="text-indigo-600 hover:underline">ÄÄƒng xuáº¥t</a>
    </p>
  </div>

  <script>
    // âœ… Äá»c cookie
    function getCookie(name) {
      const value = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return value ? value.pop() : null;
    }

    // âœ… HÃ m kiá»ƒm tra token cÃ³ tá»“n táº¡i chÆ°a
    function hasToken() {
      return localStorage.getItem("token") || getCookie("AUTH_TOKEN");
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const path = window.location.pathname;
      const inviteLink = path.split("/join/")[1];
      const joinBtn = document.getElementById("join-btn");

      // NgÄƒn vÃ²ng láº·p reload sau Ä‘Äƒng nháº­p
      if (sessionStorage.getItem("redirectedOnce") === "true") {
        sessionStorage.removeItem("redirectedOnce");
      } else if (!hasToken()) {
        sessionStorage.setItem("redirectedOnce", "true");
        const redirectUrl = encodeURIComponent(window.location.pathname);
        window.location.href = `/view/signin?redirect=${redirectUrl}`;
        return;
      }

      // Äá»£i token cookie á»•n Ä‘á»‹nh (Ä‘áº·c biá»‡t sau OAuth2 redirect)
      await new Promise(r => setTimeout(r, 300));

      joinBtn.addEventListener("click", async () => {
        joinBtn.disabled = true;
        joinBtn.textContent = "â³ Äang xá»­ lÃ½...";

        const token = localStorage.getItem("token") || getCookie("AUTH_TOKEN");

        try {
          const res = await fetch(`/api/pm/invite/join/${inviteLink}`, {
            method: "POST",
            credentials: "include",
            headers: {
              "Authorization": "Bearer " + token,
              "Content-Type": "application/json"
            }
          });

          const text = await res.text();

          // ğŸŸ¢ Náº¿u backend tráº£ lá»—i "Ä‘Ã£ lÃ  thÃ nh viÃªn"
          if (!res.ok) {
            if (text.includes("Ä‘Ã£ lÃ  thÃ nh viÃªn")) {
              alert("âœ… Báº¡n Ä‘Ã£ lÃ  thÃ nh viÃªn cá»§a dá»± Ã¡n nÃ y. Äang chuyá»ƒn Ä‘áº¿n báº£ng cÃ´ng viá»‡c...");

              try {
                const errObj = JSON.parse(text);
                if (errObj.projectId) {
                  window.location.href = `/view/pm/project/board?projectId=${errObj.projectId}`;
                  return;
                }
              } catch (_) {}

              window.location.href = `/view/pm/dashboard?joined=true`;
              return;
            }
            throw new Error(text);
          }

          // ğŸŸ¢ Tham gia má»›i thÃ nh cÃ´ng
          const data = JSON.parse(text);
          alert(`ğŸ‰ Tham gia dá»± Ã¡n thÃ nh cÃ´ng!\nğŸ“ ${data.projectName}`);
          window.location.href = `/view/pm/project/board?projectId=${data.projectId}`;

        } catch (err) {
          console.error("âŒ Join failed:", err);
          alert("âŒ KhÃ´ng thá»ƒ tham gia dá»± Ã¡n!\n" + (err.message || ""));
        } finally {
          joinBtn.disabled = false;
          joinBtn.textContent = "ğŸš€ Tham gia dá»± Ã¡n";
        }
      });
    });
  </script>
</body>
</html>
