<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Join Project - DevCollab</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body
    class="min-h-screen bg-gray-50 text-gray-800 flex items-center justify-center"
  >
    <div
      id="invite-card"
      class="bg-white rounded-lg shadow-2xl w-full max-w-md p-8"
    >
      <div class="text-center mb-6">
        <img
          src="/photo/logo1.png"
          alt="DevCollab"
          class="w-16 h-16 mx-auto mb-4 object-contain"
        />

        <h1 id="invite-title" class="text-xl font-semibold text-gray-800 mb-2">
          You've been invited to join a project
        </h1>

        <p class="text-gray-600 text-sm">
          Please confirm to start collaborating with the team
        </p>
      </div>

      <button
        id="join-btn"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-2.5 rounded-md shadow-sm transition-all duration-200 hover:shadow-md"
      >
        Join Project
      </button>

      <p class="text-xs text-gray-400 mt-5 text-center">
        Not you?
        <a href="#" id="logout-link" class="text-blue-600 hover:underline"
          >Logout</a
        >
      </p>
    </div>

    <script>
      // ‚úÖ Toast notification (replaces alert) - displays in center of screen
      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.textContent = message;
        toast.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 px-6 py-4 rounded-lg text-white z-[9999] shadow-2xl transition-all duration-300 text-center min-w-[300px] max-w-[500px] ${
          type === "error"
            ? "bg-red-500"
            : type === "success"
            ? "bg-green-600"
            : "bg-blue-600"
        }`;
        document.body.appendChild(toast);

        // Auto remove sau 3 gi√¢y
        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translate(-50%, -50%) scale(0.95)";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // ‚úÖ H√†m ƒë·ªçc cookie - x·ª≠ l√Ω decode ƒë√∫ng c√°ch
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) {
          try {
            return decodeURIComponent(parts.pop().split(";").shift());
          } catch (e) {
            return parts.pop().split(";").shift();
          }
        }
        return null;
      }

      // ‚úÖ H√†m l·∫•y token - gi·ªëng h·ªát getToken() trong utils.js
      // H·ªó tr·ª£ c·∫£ Google OAuth v√† local account
      function getToken() {
        // 1. Th·ª≠ localStorage tr∆∞·ªõc (th∆∞·ªùng d√πng cho local account)
        let token = localStorage.getItem("token");
        if (
          token &&
          token !== "null" &&
          token !== "undefined" &&
          token.trim().length > 0
        ) {
          return token.trim();
        }

        // 2. Th·ª≠ localStorage v·ªõi key AUTH_TOKEN (fallback)
        token = localStorage.getItem("AUTH_TOKEN");
        if (
          token &&
          token !== "null" &&
          token !== "undefined" &&
          token.trim().length > 0
        ) {
          // ƒê·ªìng b·ªô sang key "token" ƒë·ªÉ nh·∫•t qu√°n
          localStorage.setItem("token", token.trim());
          return token.trim();
        }

        // 3. Fallback to cookie AUTH_TOKEN (th∆∞·ªùng d√πng cho Google OAuth v√† local account)
        // ‚úÖ D√πng h√†m getCookie ƒë·ªÉ decode ƒë√∫ng c√°ch
        const cookieToken = getCookie("AUTH_TOKEN");
        if (
          cookieToken &&
          cookieToken !== "null" &&
          cookieToken !== "undefined" &&
          cookieToken.trim().length > 0
        ) {
          // L∆∞u v√†o localStorage ƒë·ªÉ d√πng l·∫ßn sau (gi·ªëng nh∆∞ trong main.js)
          localStorage.setItem("token", cookieToken.trim());
          return cookieToken.trim();
        }

        // 4. Th·ª≠ ƒë·ªçc cookie tr·ª±c ti·∫øp (fallback n·∫øu getCookie kh√¥ng ho·∫°t ƒë·ªông)
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split("=");
          if (
            name === "AUTH_TOKEN" &&
            value &&
            value !== "null" &&
            value !== "undefined"
          ) {
            try {
              const decoded = decodeURIComponent(value);
              if (decoded && decoded.trim().length > 0) {
                localStorage.setItem("token", decoded.trim());
                return decoded.trim();
              }
            } catch (e) {
              // N·∫øu decode l·ªói, th·ª≠ d√πng gi√° tr·ªã g·ªëc
              if (value.trim().length > 0) {
                localStorage.setItem("token", value.trim());
                return value.trim();
              }
            }
          }
        }

        return null;
      }

      // ‚úÖ H√†m ki·ªÉm tra token c√≥ t·ªìn t·∫°i ch∆∞a
      function hasToken() {
        return getToken() !== null;
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const path = window.location.pathname;
        const inviteLink = path.split("/join/")[1];
        const joinBtn = document.getElementById("join-btn");

        // ‚úÖ Ki·ªÉm tra token ngay t·ª´ ƒë·∫ßu
        let token = getToken();

        // ‚úÖ Ki·ªÉm tra xem c√≥ ph·∫£i redirect t·ª´ login kh√¥ng
        const urlParams = new URLSearchParams(window.location.search);
        const isFromLogin =
          urlParams.get("from") === "login" ||
          sessionStorage.getItem("redirectedOnce") === "true" ||
          document.referrer.includes("/signin") ||
          document.referrer.includes("/login") ||
          document.referrer.includes("/verify-otp");

        // ‚úÖ N·∫øu kh√¥ng c√≥ token v√† kh√¥ng ph·∫£i t·ª´ login ‚Üí redirect ƒë·∫øn login ngay
        if (!token && !isFromLogin) {
          console.log("üîç No token found, redirecting to login...");
          sessionStorage.setItem("redirectedOnce", "true");
          const redirectUrl = encodeURIComponent(window.location.pathname);
          window.location.href = `/view/signin?redirect=${redirectUrl}`;
          return;
        }

        // ‚úÖ N·∫øu ƒëang redirect t·ª´ login (OAuth2 ho·∫∑c local) ‚Üí ƒë·ª£i token ƒë∆∞·ª£c set trong cookie
        if (!token && isFromLogin) {
          console.log(
            "üîç Redirected from login, waiting for token in cookie..."
          );
          console.log("üîç Referrer:", document.referrer);
          console.log("üîç Current cookies:", document.cookie);

          // ‚úÖ ƒê·ª£i cookie ƒë∆∞·ª£c set (backend set cookie sau khi login)
          let attempts = 0;
          const maxAttempts = 20; // TƒÉng s·ªë l·∫ßn th·ª≠
          while (!token && attempts < maxAttempts) {
            const delay = 100 + attempts * 50; // 100ms, 150ms, 200ms... (nhanh h∆°n)
            await new Promise((r) => setTimeout(r, delay));

            // ‚úÖ Ki·ªÉm tra l·∫°i cookie v√† ƒë·ªìng b·ªô v√†o localStorage
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
              const [name, value] = cookie.trim().split("=");
              if (
                name === "AUTH_TOKEN" &&
                value &&
                value !== "null" &&
                value !== "undefined"
              ) {
                // ‚úÖ L∆∞u v√†o localStorage ngay khi t√¨m th·∫•y
                localStorage.setItem("token", value);
                console.log("‚úÖ Found token in cookie, saved to localStorage");
                token = value;
                break;
              }
            }

            // ‚úÖ N·∫øu v·∫´n ch∆∞a c√≥, th·ª≠ getToken() l·∫°i
            if (!token) {
              token = getToken();
            }

            attempts++;

            if (token) {
              console.log(`‚úÖ Token found after ${attempts} attempts`);
              break;
            } else if (attempts % 5 === 0) {
              console.log(
                `‚è≥ Still waiting... (attempt ${attempts}/${maxAttempts})`
              );
            }
          }

          // ‚úÖ N·∫øu v·∫´n kh√¥ng c√≥ token sau khi ƒë·ª£i
          if (!token) {
            console.error("‚ùå Token not found after waiting");
            console.error(
              "üîç Final check - localStorage.token:",
              localStorage.getItem("token")
            );
            console.error("üîç Final check - Cookies:", document.cookie);
            console.error(
              "üîç Final check - All cookies:",
              document.cookie.split(";")
            );

            // ‚úÖ Th·ª≠ ƒë·ª£i th√™m 2 gi√¢y (c√≥ th·ªÉ cookie ƒëang ƒë∆∞·ª£c set)
            await new Promise((r) => setTimeout(r, 2000));
            token = getToken();

            if (!token) {
              console.warn(
                "‚ö†Ô∏è Token not found after final wait, redirecting to login"
              );
              sessionStorage.removeItem("redirectedOnce");
              const redirectUrl = encodeURIComponent(window.location.pathname);
              window.location.href = `/view/signin?redirect=${redirectUrl}`;
              return;
            }
          }
        }

        // ‚úÖ Clear redirect flag n·∫øu ƒë√£ c√≥ token
        if (token) {
          sessionStorage.removeItem("redirectedOnce");
          console.log("‚úÖ Token ready:", token.substring(0, 20) + "...");
        }

        joinBtn.addEventListener("click", async () => {
          joinBtn.disabled = true;
          joinBtn.textContent = "Processing...";

          // ‚úÖ L·∫•y token l·∫°i (c√≥ th·ªÉ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t)
          let token = getToken();

          // ‚úÖ Ki·ªÉm tra token c√≥ t·ªìn t·∫°i v√† h·ª£p l·ªá kh√¥ng
          if (!token) {
            console.error("‚ùå Token kh√¥ng t·ªìn t·∫°i khi click");
            showToast("Invalid token. Please login again.", "error");
            setTimeout(() => {
              const redirectUrl = encodeURIComponent(window.location.pathname);
              window.location.href = `/view/signin?redirect=${redirectUrl}`;
            }, 2000);
            joinBtn.disabled = false;
            joinBtn.textContent = "Join Project";
            return;
          }

          console.log("üîë Using token:", token.substring(0, 20) + "...");

          try {
            const res = await fetch(`/api/pm/invite/join/${inviteLink}`, {
              method: "POST",
              credentials: "include",
              headers: {
                Authorization: "Bearer " + token,
                "Content-Type": "application/json",
              },
            });

            const text = await res.text();

            // üü¢ If backend returns error
            if (!res.ok) {
              // ‚úÖ X·ª≠ l√Ω l·ªói 401 (Unauthorized) - token kh√¥ng h·ª£p l·ªá
              if (res.status === 401) {
                console.error(
                  "‚ùå 401 Unauthorized - Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n"
                );
                showToast("Invalid token. Please login again.", "error");
                setTimeout(() => {
                  // Clear tokens
                  localStorage.removeItem("token");
                  localStorage.removeItem("AUTH_TOKEN");
                  document.cookie = "AUTH_TOKEN=; Max-Age=0; path=/;";
                  const redirectUrl = encodeURIComponent(
                    window.location.pathname
                  );
                  window.location.href = `/view/signin?redirect=${redirectUrl}`;
                }, 2000);
                joinBtn.disabled = false;
                joinBtn.textContent = "Join Project";
                return;
              }

              let errorMessage = "Unable to join project";

              // ‚úÖ Parse JSON error if available
              try {
                const errObj = JSON.parse(text);
                errorMessage = errObj.error || errObj.message || errorMessage;

                // ‚úÖ If join request already sent ‚Üí redirect to user dashboard
                if (
                  errorMessage.includes("request sent") ||
                  errorMessage.includes("pending approval") ||
                  errorMessage.includes("waiting for approval")
                ) {
                  showToast(errorMessage, "info");
                  setTimeout(() => {
                    window.location.href = `/user/view/dashboard`;
                  }, 2000);
                  return;
                }

                // If projectId exists in error ‚Üí redirect
                if (errObj.projectId) {
                  showToast(errorMessage, "info");
                  setTimeout(() => {
                    window.location.href = `/view/pm/project/board?projectId=${errObj.projectId}`;
                  }, 1500);
                  return;
                }
              } catch (_) {
                // If cannot parse JSON ‚Üí use text directly
                if (
                  text.includes("already a member") ||
                  text.includes("ƒë√£ l√† th√†nh vi√™n")
                ) {
                  errorMessage =
                    "You are already a member of this project. Redirecting to board...";
                  showToast(errorMessage, "info");
                  setTimeout(() => {
                    window.location.href = `/view/pm/dashboard?joined=true`;
                  }, 1500);
                  return;
                }
                // ‚úÖ Check if text contains request sent message
                if (
                  text.includes("request sent") ||
                  text.includes("pending approval") ||
                  text.includes("waiting for approval") ||
                  text.includes("ƒë√£ g·ª≠i y√™u c·∫ßu") ||
                  text.includes("ƒëang ch·ªù ph√™ duy·ªát")
                ) {
                  errorMessage = text;
                  showToast(errorMessage, "info");
                  setTimeout(() => {
                    window.location.href = `/user/view/dashboard`;
                  }, 2000);
                  return;
                }
                errorMessage = text || errorMessage;
              }

              showToast(errorMessage, "error");
              return;
            }

            // üü¢ Handle response based on message
            const data = JSON.parse(text);

            if (data.message === "join_request_sent") {
              showToast(
                `Join request sent! Project: ${data.projectName}. Please wait for PM approval.`,
                "info"
              );
              // ‚úÖ Redirect to user dashboard after 2 seconds
              setTimeout(() => {
                window.location.href = `/user/view/dashboard`;
              }, 2000);
            } else if (data.message === "joined_success") {
              showToast(
                `Successfully joined project! ${data.projectName}`,
                "success"
              );
              setTimeout(() => {
                window.location.href = `/view/pm/project/board?projectId=${data.projectId}`;
              }, 1500);
            } else {
              // Fallback for other messages
              showToast(`${data.message} - ${data.projectName}`, "info");
              if (data.projectId) {
                setTimeout(() => {
                  window.location.href = `/view/pm/project/board?projectId=${data.projectId}`;
                }, 1500);
              }
            }
          } catch (err) {
            console.error("Join failed:", err);
            // ‚úÖ Get message from error, if it's an object then parse
            let errorMessage = "Unable to join project";
            if (err.message) {
              try {
                // Try to parse if it's a JSON string
                const parsed = JSON.parse(err.message);
                errorMessage = parsed.error || parsed.message || errorMessage;
              } catch (_) {
                // If not JSON ‚Üí use directly
                errorMessage = err.message;
              }
            }
            showToast(errorMessage, "error");
          } finally {
            joinBtn.disabled = false;
            joinBtn.textContent = "Join Project";
          }
        });

        // ‚úÖ Handle logout button
        const logoutLink = document.getElementById("logout-link");
        if (logoutLink) {
          logoutLink.addEventListener("click", async (e) => {
            e.preventDefault();
            e.stopPropagation();

            try {
              // ‚úÖ Call logout API (kh√¥ng c·∫ßn token trong header, d√πng credentials)
              try {
                await fetch("/api/auth/logout", {
                  method: "POST",
                  credentials: "include",
                });
              } catch (apiErr) {
                console.warn(
                  "‚ö†Ô∏è Logout API call failed (continuing anyway):",
                  apiErr
                );
              }

              // ‚úÖ Clear cookies (c·∫£ Google OAuth v√† local account)
              document.cookie = "AUTH_TOKEN=; Max-Age=0; path=/; domain=;";
              document.cookie = "REFRESH_TOKEN=; Max-Age=0; path=/; domain=;";

              // ‚úÖ Clear localStorage
              localStorage.removeItem("token");
              localStorage.removeItem("AUTH_TOKEN");
              localStorage.removeItem("REFRESH_TOKEN");
              localStorage.removeItem("currentUserId");
              localStorage.removeItem("currentUserName");
              localStorage.removeItem("currentUserEmail");
              localStorage.removeItem("currentUserAvatar");

              // ‚úÖ Clear sessionStorage
              sessionStorage.clear();

              // ‚úÖ Redirect to login page
              window.location.href = "/view/signin";
            } catch (err) {
              console.error("‚ùå Logout error:", err);
              // ‚úÖ V·∫´n clear v√† redirect ngay c·∫£ khi c√≥ l·ªói
              try {
                document.cookie = "AUTH_TOKEN=; Max-Age=0; path=/; domain=;";
                document.cookie = "REFRESH_TOKEN=; Max-Age=0; path=/; domain=;";
                localStorage.clear();
                sessionStorage.clear();
              } catch (clearErr) {
                console.error("‚ùå Error clearing storage:", clearErr);
              }
              // ‚úÖ Redirect ƒë·∫øn login page
              window.location.href = "/view/signin";
            }
          });
        } else {
          console.warn("‚ö†Ô∏è Logout link not found in DOM");
        }
      });
    </script>
  </body>
</html>
