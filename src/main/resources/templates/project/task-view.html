<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DevCollab ‚Äì Task View</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/kanban.css}" />
  </head>

  <body class="min-h-screen bg-gray-50 text-gray-800">
    <!-- üß≠ HEADER -->
    <header th:replace="~{fragments/header :: header}"></header>

    <!-- üß± SIDEBAR + CONTENT -->
    <div class="flex min-h-[calc(100vh-4rem)]">
      <!-- üìÇ SIDEBAR -->
      <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>

      <!-- üéØ MAIN CONTENT (Task View) -->
      <main class="flex-1 overflow-y-auto kanban-main-background">
        <!-- Header Section - Trello style -->
        <div
          class="sticky top-0 z-20 bg-white/95 backdrop-blur-sm border-b border-gray-200/60 px-6 py-3 shadow-sm"
        >
          <div class="flex justify-between items-center">
            <h1 class="text-lg font-semibold text-gray-800">
              Design Project Template
            </h1>

            <div class="flex items-center gap-3">
              <button
                id="share-board-btn"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-3 py-1.5 rounded-md shadow-sm transition-all duration-200 hover:shadow-md text-sm"
              >
                Share
              </button>
            </div>
          </div>
        </div>

        <!-- Kanban Board Container - Trello style -->
        <div class="px-4 py-4">
          <div
            id="kanban-board"
            class="flex gap-3 items-start overflow-x-auto pb-4 min-h-[calc(100vh-10rem)] kanban-board-scroll"
          >
            <!-- Columns will be rendered here by JavaScript -->
          </div>
        </div>

        <!-- üß© Task Detail Modal -->
        <div
          id="task-detail-modal"
          class="fixed inset-0 z-50 flex items-start justify-center p-4 pt-16 bg-black/60 backdrop-blur-sm hidden"
        >
          <div
            class="bg-white rounded-lg shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col"
          >
            <!-- Header -->
            <div
              class="flex items-center justify-between p-4 border-b sticky top-0 bg-white z-10"
            >
              <div class="flex items-center gap-2">
                <span
                  id="column-name-display"
                  class="text-base font-semibold text-gray-800 bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded cursor-pointer"
                >
                  Marketing Website
                </span>
              </div>
              <button
                id="close-modal-btn"
                class="text-gray-600 hover:text-gray-900 text-2xl font-light"
              >
                √ó
              </button>
            </div>

            <!-- Content - 2 columns layout -->
            <div class="flex flex-1 overflow-hidden">
              <!-- Left column - Main content (7/12) -->
              <div class="flex-[7] overflow-y-auto p-6 space-y-4">
                <!-- Title with radio button -->
                <div class="flex items-center gap-3">
                  <input type="radio" class="w-5 h-5 text-blue-600" />
                  <h2
                    id="task-title-display"
                    class="text-2xl font-semibold text-gray-900"
                  >
                    Task Title
                  </h2>
                </div>

                <!-- Action Buttons Row - Labels, Dates, Checklist, Members -->
                <div class="flex items-center gap-2 flex-wrap ml-8">
                  <!-- Labels Button -->
                  <button
                    id="open-labels-btn"
                    class="flex items-center gap-2 border border-gray-300 bg-white hover:bg-gray-50 text-gray-600 text-sm font-semibold px-3 py-2 rounded"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
                      />
                    </svg>
                    <span>Labels</span>
                  </button>

                  <!-- Dates Button -->
                  <button
                    id="open-dates-btn"
                    class="flex items-center gap-2 border border-gray-300 bg-white hover:bg-gray-50 text-gray-600 text-sm font-semibold px-3 py-2 rounded"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                    <span>Dates</span>
                  </button>

                  <!-- Checklist Button -->
                  <button
                    id="open-checklist-btn"
                    class="flex items-center gap-2 border border-gray-300 bg-white hover:bg-gray-50 text-gray-600 text-sm font-semibold px-3 py-2 rounded"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                    <span>Checklist</span>
                  </button>

                  <!-- Members Button -->
                  <button
                    id="open-members-btn"
                    class="flex items-center gap-2 border border-gray-300 bg-white hover:bg-gray-50 text-gray-600 text-sm font-semibold px-3 py-2 rounded"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
                      />
                    </svg>
                    <span>Members</span>
                  </button>
                </div>

                <!-- Due Date Display (hidden by default, shown when dates are set) -->
                <div id="due-date-section" class="hidden ml-8">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-sm font-semibold text-gray-600"
                      >Due date</span
                    >
                  </div>
                  <div
                    id="due-date-display"
                    class="flex items-center gap-2 cursor-pointer bg-gray-100 hover:bg-gray-200 rounded-md px-3 py-2 w-fit transition-colors"
                  >
                    <span
                      id="due-date-text"
                      class="text-gray-600 text-sm font-semibold"
                      >No due date</span
                    >
                    <span
                      id="due-date-status"
                      class="text-xs font-medium rounded px-2 py-0.5 bg-gray-200 text-gray-600"
                    >
                      None
                    </span>
                  </div>
                </div>

                <!-- üìé ATTACHMENTS -->
                <div id="attachments-section" class="space-y-3">
                  <!-- Upload buttons -->
                  <div class="flex items-center gap-2 ml-8">
                    <input id="attachment-file" type="file" class="hidden" />
                    <button
                      id="upload-attachment-btn"
                      class="flex items-center gap-1.5 bg-gray-100 hover:bg-gray-200 text-gray-600 text-sm font-semibold px-3 py-1.5 rounded transition-colors border-0"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 4v16m8-8H4"
                        />
                      </svg>
                      Upload file
                    </button>
                    <button
                      id="open-attach-popup"
                      class="flex items-center gap-1.5 bg-white hover:bg-gray-50 text-gray-600 text-sm font-semibold px-3 py-1.5 rounded border border-gray-300 transition-colors"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 text-gray-500"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M17.657 6.343l-6.364 6.364a2.5 2.5 0 11-3.536-3.536l6.364-6.364a4.5 4.5 0 016.364 6.364l-6.364 6.364a6.5 6.5 0 11-9.192-9.192l6.364-6.364"
                        />
                      </svg>
                      Attach link
                    </button>
                  </div>

                  <!-- List -->
                  <div
                    id="attachments-list"
                    class="space-y-2 text-sm text-gray-700 ml-8"
                  >
                    <p class="text-gray-500 text-center font-normal">
                      No attachments yet.
                    </p>
                  </div>
                </div>

                <!-- ‚úÖ CHECKLIST SECTION -->
                <div id="checklist-section" class="space-y-3 hidden">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 text-gray-700"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        />
                      </svg>
                      <h3 class="text-sm font-semibold text-gray-800">
                        Checklist
                      </h3>
                    </div>
                    <div class="flex items-center gap-2">
                      <button
                        id="hide-checked-items-btn"
                        class="hidden text-sm font-normal text-gray-600 hover:text-gray-700 hover:bg-gray-100 px-2 py-1 rounded transition-colors border-0"
                      >
                        Hide checked items
                      </button>
                      <button
                        id="delete-checklist-btn"
                        class="hidden text-sm font-semibold text-gray-600 hover:text-gray-700 hover:bg-gray-200 px-2 py-1 rounded transition-colors bg-gray-100 border-0"
                      >
                        Delete
                      </button>
                    </div>
                  </div>

                  <div class="ml-8">
                    <!-- Progress bar -->
                    <div id="checklist-progress" class="mb-2 hidden">
                      <div class="flex items-center gap-2 mb-1">
                        <span
                          id="checklist-progress-text"
                          class="text-xs font-normal text-gray-600"
                          >0%</span
                        >
                        <div
                          class="flex-1 h-1.5 bg-gray-200 rounded-full overflow-hidden"
                        >
                          <div
                            id="checklist-progress-bar"
                            class="h-full bg-blue-600 transition-all duration-300"
                            style="width: 0%"
                          ></div>
                        </div>
                      </div>
                    </div>

                    <!-- Checklist items list -->
                    <div id="checklist-items-list" class="space-y-2 mb-1">
                      <p class="text-gray-500 text-center font-normal text-sm">
                        No checklist items yet.
                      </p>
                    </div>

                    <!-- Add item button -->
                    <button
                      id="add-checklist-item-btn"
                      class="flex items-center gap-2 cursor-pointer bg-gray-100 hover:bg-gray-200 rounded-md px-3 py-2 w-fit transition-colors border-0 mt-0.5"
                    >
                      <span class="text-gray-600 text-sm font-semibold"
                        >Add an item</span
                      >
                    </button>
                  </div>
                </div>

                <!-- Description -->
                <div>
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 text-gray-700"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 6h16M4 12h16M4 18h16"
                        />
                      </svg>
                      <h3 class="text-sm font-semibold text-gray-800">
                        Description
                      </h3>
                    </div>
                    <button
                      id="edit-description-btn"
                      class="hidden text-sm font-semibold text-gray-600 hover:text-gray-700 hover:bg-gray-200 px-2 py-1 rounded transition-colors bg-gray-100 border-0"
                    >
                      Edit
                    </button>
                  </div>

                  <div class="ml-8">
                    <!-- Description Display (no border when has content) -->
                    <div
                      id="description-display"
                      class="cursor-pointer min-h-[60px] w-full rounded-md border-[0.5px] border-gray-300 bg-white hover:border-gray-400 transition-all p-2.5"
                    >
                      <p
                        id="description-content"
                        class="text-sm text-gray-700 whitespace-pre-line leading-normal w-full"
                        style="display: none"
                      ></p>
                      <p
                        id="description-placeholder"
                        class="text-sm text-gray-500 text-center font-normal"
                      >
                        Add a more detailed description...
                      </p>
                    </div>

                    <!-- Description Text Display (shown when saved, no border) -->
                    <div
                      id="description-text-display"
                      class="hidden cursor-pointer"
                    >
                      <p
                        id="description-text-content"
                        class="text-sm text-gray-700 whitespace-pre-line leading-normal"
                      ></p>
                    </div>

                    <div id="description-editor" class="hidden">
                      <textarea
                        id="description-textarea"
                        class="w-full border border-gray-300 rounded-md p-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 resize-none leading-normal"
                        placeholder="Add a more detailed description..."
                        rows="3"
                      ></textarea>

                      <div class="flex items-center gap-2 mt-2">
                        <button
                          id="save-desc-btn"
                          class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm font-medium transition-colors"
                        >
                          Save
                        </button>
                        <button
                          id="cancel-desc-btn"
                          class="hover:bg-gray-200 px-3 py-1.5 rounded text-sm text-gray-700 transition-colors"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Right column - Comments & Activity (5/12) -->
              <div
                id="activity-section"
                class="flex-[5] border-l border-gray-200 bg-gray-50 overflow-y-auto"
              >
                <div class="p-4 space-y-3">
                  <!-- Header with Hide details button -->
                  <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-gray-800">
                      Comments and activity
                    </h3>
                    <button
                      id="toggle-activity-btn"
                      class="text-sm text-gray-600 hover:text-gray-800"
                    >
                      Hide details
                    </button>
                  </div>

                  <!-- Comment input -->
                  <div class="relative">
                    <textarea
                      id="comment-input"
                      rows="2"
                      placeholder="Write a comment..."
                      class="w-full border border-gray-300 rounded-md p-2 text-sm resize-none focus:ring-2 focus:ring-blue-400"
                    ></textarea>
                    <!-- Preview area for formatted links -->
                    <div
                      id="comment-preview"
                      class="hidden w-full border-t-0 border-l border-r border-b border-gray-300 rounded-b-md p-2 text-sm bg-gray-50 whitespace-pre-wrap break-words mt-[-1px]"
                      onclick="document.getElementById('comment-input')?.focus()"
                      style="cursor: text"
                    ></div>
                    <!-- Mention dropdown -->
                  </div>

                  <div class="flex items-center justify-between mt-2">
                    <div class="flex items-center gap-2">
                      <button
                        class="bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm font-medium px-3 py-1.5 rounded transition-colors border-0"
                      >
                        Formatting help
                      </button>
                      <button
                        class="bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm font-medium px-3 py-1.5 rounded transition-colors border-0"
                      >
                        Add
                      </button>
                    </div>
                    <button
                      id="post-comment-btn"
                      class="hidden bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-1.5 rounded-md transition"
                    >
                      Post
                    </button>
                  </div>

                  <!-- Comment list -->
                  <div
                    id="comments-list"
                    class="space-y-3 text-sm text-gray-800"
                  ></div>

                  <!-- Activity feed -->
                  <div
                    id="activity-feed"
                    class="space-y-2 text-sm text-gray-700"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- üè∑Ô∏è LABELS POPUP -->
        <div id="labels-popup" class="hidden fixed z-[70] labels-popup">
          <div class="labels-popup__header">
            <h3 class="labels-popup__title">Labels</h3>
            <button
              id="close-labels-btn"
              class="labels-popup__close"
              aria-label="Close labels popup"
            >
              √ó
            </button>
          </div>

          <div class="labels-popup__search-wrapper">
            <input
              id="search-label-input"
              type="text"
              placeholder="Search labels..."
              class="labels-popup__search"
              autocomplete="off"
            />
          </div>

          <div id="labels-list" class="labels-popup__list"></div>

          <button
            id="create-label-btn"
            class="labels-popup__create"
            type="button"
          >
            + Create a new label
          </button>
        </div>

        <!-- üÜï CREATE LABEL POPUP -->
        <div id="create-label-popup" class="hidden fixed z-[80] label-editor">
          <div class="label-editor__header">
            <button
              id="create-label-back"
              type="button"
              class="label-editor__back"
              aria-label="Back to labels"
            >
              ‚Üê
            </button>
            <h3>Create label</h3>
            <button
              id="close-create-label-btn"
              class="label-editor__close"
              aria-label="Close create label popup"
            >
              √ó
            </button>
          </div>
          <div id="label-preview" class="label-editor__preview">New Label</div>

          <input
            id="new-label-name"
            type="text"
            placeholder="Title"
            class="label-editor__input"
            autocomplete="off"
          />

          <label class="label-editor__label">Select a color</label>
          <div id="color-grid" class="label-editor__grid"></div>

          <div class="label-editor__actions">
            <button
              id="remove-color-btn"
              class="label-editor__link"
              type="button"
            >
              Remove color
            </button>
            <button
              id="create-label-confirm"
              class="label-editor__primary"
              type="button"
            >
              Create
            </button>
          </div>
        </div>
        <!-- ‚úèÔ∏è EDIT LABEL POPUP -->
        <div
          id="edit-label-popup-wrapper"
          class="hidden fixed inset-0 z-[90] bg-black/40 backdrop-blur-sm"
        >
          <div
            id="edit-label-popup"
            class="label-editor animate-[fadeIn_0.15s_ease-out]"
          >
            <div class="label-editor__header">
              <button
                id="edit-label-back"
                type="button"
                class="label-editor__back"
                aria-label="Back to labels"
              >
                ‚Üê
              </button>
              <h3>Edit label</h3>
              <button
                onclick="closeEditLabelPopup(event)"
                class="label-editor__close"
                aria-label="Close edit label popup"
              >
                √ó
              </button>
            </div>

            <div id="edit-label-preview" class="label-editor__preview">New</div>

            <input
              id="edit-label-name"
              type="text"
              placeholder="Title"
              class="label-editor__input"
              autocomplete="off"
            />

            <label class="label-editor__label">Select a color</label>
            <div id="edit-color-grid" class="label-editor__grid"></div>

            <div class="label-editor__actions">
              <button
                onclick="removeEditColor()"
                class="label-editor__link"
                type="button"
              >
                Remove color
              </button>
              <div class="label-editor__action-group">
                <button
                  onclick="saveEditedLabel()"
                  class="label-editor__primary"
                  type="button"
                >
                  Save
                </button>
                <button
                  onclick="deleteEditedLabel()"
                  class="label-editor__danger"
                  type="button"
                >
                  Delete
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- üîó SHARE BOARD POPUP -->
        <div
          id="share-board-popup"
          class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-sm"
        >
          <div class="bg-white rounded-lg shadow-2xl w-[460px] p-5">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-semibold text-gray-600">Share board</h2>
              <button
                id="close-share-popup"
                class="text-gray-500 hover:text-gray-700 text-xl"
              >
                √ó
              </button>
            </div>

            <div class="flex items-center gap-2 mb-3 relative">
              <div class="relative flex-1">
                <input
                  id="invite-email"
                  type="email"
                  placeholder="Email address or name"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"
                />
                <!-- üì© Suggestion dropdown -->
                <div
                  id="invite-suggestions"
                  class="hidden absolute bg-white border border-gray-300 rounded-md shadow-md mt-1 w-full z-[9999]"
                ></div>
              </div>

              <select
                id="invite-role"
                class="border border-gray-300 rounded-md text-sm px-2 py-2"
              >
                <option value="MEMBER">Member</option>
                <option value="ADMIN">PM</option>
              </select>
              <button
                id="invite-btn"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-semibold"
              >
                Share
              </button>
            </div>

            <!-- Anyone with link -->
            <div
              class="flex items-center justify-between text-sm border-t border-b py-2 mb-3"
            >
              <div class="flex flex-col">
                <div class="flex items-center gap-1">
                  <span class="text-gray-600">üîó</span>
                  <span class="text-gray-700"
                    >Anyone with the link can join as a member</span
                  >
                </div>
                <div class="ml-5 mt-1 flex gap-3 text-blue-600 text-xs">
                  <a href="#" id="copy-link" class="hover:underline"
                    >Copy link</a
                  >
                  <a
                    href="#"
                    id="delete-link"
                    class="hover:underline text-red-600"
                    >Delete link</a
                  >
                </div>
                <p
                  id="share-link-hint"
                  class="text-xs text-gray-500 mt-1 ml-5 italic"
                ></p>
              </div>
            </div>

            <!-- Tabs -->
            <div class="flex items-center gap-5 border-b mb-2">
              <button
                id="tab-members"
                class="text-blue-600 border-b-2 border-blue-600 text-sm font-semibold pb-1"
              >
                Board members
              </button>
              <button
                id="tab-requests"
                class="text-gray-500 text-sm font-medium hover:text-blue-600"
              >
                Join requests
              </button>
            </div>

            <!-- Members list -->
            <div
              id="members-list"
              class="space-y-2 max-h-[280px] overflow-y-auto mt-2"
            >
              <!-- Render member rows here -->
            </div>

            <!-- Join requests list -->
            <div
              id="join-requests-list"
              class="hidden space-y-2 max-h-[280px] overflow-y-auto mt-2"
            >
              <!-- Render join request rows here -->
            </div>
          </div>
        </div>
        <!-- üìõ Confirm Delete Popup -->
        <div
          id="delete-link-confirm"
          class="hidden absolute bg-white border border-gray-300 rounded-lg shadow-lg p-3 w-64 z-[999] animate-[fadeIn_0.15s_ease-out]"
        >
          <p class="text-sm text-gray-700 mb-2">
            Li√™n k·∫øt chia s·∫ª hi·ªán c√≥ s·∫Ω kh√¥ng ho·∫°t ƒë·ªông n·ªØa.
          </p>
          <button
            id="confirm-delete-link"
            class="w-full bg-red-600 hover:bg-red-700 text-white text-sm py-2 rounded-md font-semibold"
          >
            X√≥a li√™n k·∫øt chia s·∫ª
          </button>
        </div>

        <!-- üìÖ DATE POPUP -->
        <div
          id="date-popup"
          class="hidden fixed z-[90] bg-white border border-gray-200 rounded-lg shadow-2xl w-[620px] p-5"
        >
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-800 text-base">Dates</h3>
            <button
              id="close-date-btn"
              class="text-gray-500 hover:text-gray-700 text-xl leading-none"
            >
              √ó
            </button>
          </div>

          <div class="date-popup-body">
            <div class="date-popup-calendar">
              <div class="calendar-header">
                <button
                  id="prev-month"
                  class="calendar-nav-btn"
                  aria-label="Previous month"
                >
                  ‚Äπ
                </button>
                <div id="calendar-month" class="calendar-month-label"></div>
                <button
                  id="next-month"
                  class="calendar-nav-btn"
                  aria-label="Next month"
                >
                  ‚Ä∫
                </button>
              </div>
              <div class="calendar-weekdays">
                <span>Sun</span>
                <span>Mon</span>
                <span>Tue</span>
                <span>Wed</span>
                <span>Thu</span>
                <span>Fri</span>
                <span>Sat</span>
              </div>
              <div id="calendar-days" class="calendar-grid"></div>
            </div>

            <div class="date-popup-details">
              <div class="date-section">
                <div class="date-section-header">
                  <label
                    class="flex items-center gap-2 text-sm font-medium text-gray-700"
                  >
                    <input type="checkbox" id="start-check" class="w-4 h-4" />
                    Start date
                  </label>
                  <button
                    id="clear-start-btn"
                    class="date-clear-btn"
                    type="button"
                  >
                    Clear
                  </button>
                </div>
                <div class="date-input-row">
                  <input
                    type="text"
                    id="start-date-input"
                    class="date-input"
                    placeholder="MM/DD/YYYY"
                    inputmode="numeric"
                    disabled
                  />
                  <input
                    type="text"
                    id="start-time-input"
                    class="time-input"
                    placeholder="h:mm AM"
                    inputmode="text"
                    spellcheck="false"
                    autocomplete="off"
                    disabled
                  />
                </div>
              </div>

              <div class="date-section">
                <div class="date-section-header">
                  <label
                    class="flex items-center gap-2 text-sm font-medium text-gray-700"
                  >
                    <input type="checkbox" id="due-check" class="w-4 h-4" />
                    Due date
                  </label>
                  <button
                    id="clear-due-btn"
                    class="date-clear-btn"
                    type="button"
                  >
                    Clear
                  </button>
                </div>
                <div class="date-input-row">
                  <input
                    type="text"
                    id="due-date-input"
                    class="date-input"
                    placeholder="MM/DD/YYYY"
                    inputmode="numeric"
                    disabled
                  />
                  <input
                    type="text"
                    id="due-time-input"
                    class="time-input"
                    placeholder="h:mm AM"
                    inputmode="text"
                    spellcheck="false"
                    autocomplete="off"
                    disabled
                  />
                </div>
              </div>

              <div class="date-actions">
                <button id="remove-date-btn" class="remove-btn">Remove</button>
                <button id="save-date-btn" class="save-btn">Save</button>
              </div>
            </div>
          </div>
        </div>
        <!-- üìé ATTACH FILE POPUP -->
        <div
          id="attach-popup"
          class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-sm"
        >
          <div
            class="bg-white rounded-lg shadow-2xl w-[420px] p-5 animate-[fadeIn_0.15s_ease-out]"
          >
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-semibold text-gray-800">
                Attach a file or link
              </h2>
              <button
                id="close-attach-popup"
                class="text-gray-500 hover:text-gray-700 text-xl"
              >
                √ó
              </button>
            </div>

            <!-- Upload section -->
            <div class="mb-4">
              <label class="text-sm text-gray-700 font-medium mb-1 block"
                >Attach a file from your computer</label
              >
              <input id="popup-attachment-file" type="file" class="hidden" />
              <button
                id="choose-file-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 rounded-md"
              >
                Choose a file
              </button>
              <p class="text-xs text-gray-500 mt-1">
                You can also drag and drop files to upload.
              </p>
            </div>

            <!-- Link section -->
            <div class="mb-4">
              <label class="text-sm text-gray-700 font-medium mb-1 block">
                Search or paste a link <span class="text-red-500">*</span>
              </label>
              <input
                id="link-input"
                type="url"
                placeholder="Paste link here..."
                class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400"
              />
            </div>

            <!-- Display text -->
            <div class="mb-4">
              <label class="text-sm text-gray-700 font-medium mb-1 block"
                >Display text (optional)</label
              >
              <input
                id="display-text"
                type="text"
                placeholder="Text to display"
                class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400"
              />
              <p class="text-xs text-gray-500 mt-1">
                Give this link a title or description
              </p>
            </div>

            <!-- Recently viewed -->
            <div class="mb-5">
              <p class="text-sm font-medium text-gray-700 mb-2">
                Recently Viewed
              </p>
              <div id="recent-links" class="space-y-1.5">
                <p class="text-gray-400 italic text-sm">
                  Loading recent links...
                </p>
              </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-end gap-2">
              <button
                id="cancel-attach-btn"
                class="px-4 py-2 text-sm rounded-md border border-gray-300 hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                id="insert-attach-btn"
                class="px-4 py-2 text-sm rounded-md bg-blue-600 hover:bg-blue-700 text-white"
              >
                Insert
              </button>
            </div>
          </div>
        </div>

        <!-- üìÑ ATTACHMENT PREVIEW MODAL -->
        <div
          id="attachment-preview-modal"
          class="hidden fixed inset-0 z-[120] bg-black/60 backdrop-blur-sm flex items-center justify-center"
        >
          <div
            class="bg-white rounded-lg shadow-2xl w-[90%] max-w-4xl max-h-[85vh] overflow-hidden flex flex-col"
          >
            <!-- Header -->
            <div class="flex justify-between items-center p-3 border-b">
              <h2
                id="preview-file-name"
                class="font-semibold text-gray-800 text-sm"
              ></h2>
              <button
                id="close-preview-btn"
                class="text-gray-600 hover:text-gray-900 text-2xl font-light"
              >
                √ó
              </button>
            </div>

            <!-- Content -->
            <div
              id="preview-content"
              class="flex-1 flex items-center justify-center bg-gray-50"
            >
              <p class="text-gray-500 italic">Loading preview...</p>
            </div>

            <!-- Footer -->
            <div class="p-3 border-t flex justify-end">
              <a
                id="download-file-btn"
                href="#"
                download
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm"
              >
                Download
              </a>
            </div>
          </div>
        </div>
        <div
          id="card-context-menu"
          class="hidden fixed z-[70] bg-white border border-gray-200 rounded-xl shadow-2xl w-56 py-2"
        >
          <button
            data-action="open"
            class="w-full text-left flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-gray-800 hover:bg-blue-50 hover:text-blue-700 transition-all duration-150"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 text-gray-500"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z" />
              <path
                fill-rule="evenodd"
                d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h4a1 1 0 110 2H9a1 1 0 01-1-1z"
                clip-rule="evenodd"
              />
            </svg>
            <span>Open card</span>
          </button>

          <button
            data-action="labels"
            class="w-full text-left flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-gray-800 hover:bg-blue-50 hover:text-blue-700 transition-all duration-150"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 text-gray-500"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7a1 1 0 011.414-1.414L10 14.586l6.293-6.293a1 1 0 011.414 0z"
                clip-rule="evenodd"
              />
            </svg>
            <span>Edit card</span>
          </button>

          <button
            data-action="members"
            class="w-full text-left flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-gray-800 hover:bg-blue-50 hover:text-blue-700 transition-all duration-150"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 text-gray-500"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                clip-rule="evenodd"
              />
            </svg>
            <span>Change members</span>
          </button>

          <button
            data-action="dates"
            class="w-full text-left flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-gray-800 hover:bg-blue-50 hover:text-blue-700 transition-all duration-150"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 text-gray-500"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z"
                clip-rule="evenodd"
              />
            </svg>
            <span>Edit dates</span>
          </button>

          <div class="border-t border-gray-200 my-1"></div>

          <button
            data-action="mark-complete"
            class="w-full text-left flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-green-700 hover:bg-green-50 hover:text-green-800 transition-all duration-150"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 text-green-600"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M16.707 5.293a1 1 0 010 1.414l-7.778 7.778a1 1 0 01-1.414 0L3.293 9.85a1 1 0 111.414-1.414l3.102 3.102 7.071-7.071a1 1 0 011.414 0z"
                clip-rule="evenodd"
              />
            </svg>
            <span>Mark as Complete</span>
          </button>

          <div class="border-t border-gray-200 my-1"></div>

          <button
            data-action="archive"
            class="w-full text-left flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-orange-700 hover:bg-orange-50 hover:text-orange-800 transition-all duration-150"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 text-orange-600"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 2h10v7H5V5z"
                clip-rule="evenodd"
              />
              <path d="M8 8a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
            </svg>
            <span>Archive</span>
          </button>

          <button
            id="delete-card-btn"
            data-action="delete"
            class="w-full text-left flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-b-xl transition-all duration-150 hidden"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M6 8a1 1 0 011-1h6a1 1 0 011 1v8a2 2 0 01-2 2H8a2 2 0 01-2-2V8zm2 0v8h4V8H8zM4 5a1 1 0 011-1h10a1 1 0 011 1v1H4V5z"
                clip-rule="evenodd"
              />
            </svg>
            <span>Delete permanently</span>
          </button>
        </div>

        <div
          id="mention-suggestions"
          class="hidden absolute z-50 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-md max-h-40 overflow-y-auto"
        ></div>
        <div id="toast-stack"></div>

        <!-- ‚úÖ CHECKLIST POPUP -->
        <div
          id="checklist-popup"
          class="hidden fixed z-[70] bg-white border border-gray-200 rounded-lg shadow-lg w-[320px] p-4 checklist-popup"
        >
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-semibold text-gray-900">Add Item</h3>
            <button
              id="close-checklist-btn"
              class="text-gray-400 hover:text-gray-600 text-xl leading-none"
              aria-label="Close checklist popup"
            >
              √ó
            </button>
          </div>

          <div class="mb-4">
            <label class="block text-xs font-medium text-gray-700 mb-1"
              >Title</label
            >
            <input
              id="checklist-title-input"
              type="text"
              placeholder="Add an item"
              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              autocomplete="off"
            />
            <div
              id="checklist-suggestions"
              class="hidden mt-1 bg-white border border-gray-200 rounded-md shadow-md max-h-32 overflow-y-auto"
            ></div>
          </div>

          <div class="flex justify-end">
            <button
              id="add-checklist-btn"
              class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-2 rounded-md"
            >
              Add
            </button>
          </div>
        </div>

        <div
          id="members-popup"
          class="hidden fixed bg-white border border-gray-200 rounded-lg shadow-lg w-[340px] p-4 z-[999] members-popup"
        >
          <div class="members-popup__header">
            <h3 class="members-popup__title">Members</h3>
            <button
              id="close-members-btn"
              class="members-popup__close"
              aria-label="Close members popup"
            >
              √ó
            </button>
          </div>

          <div class="members-popup__search">
            <input
              id="search-member-input"
              type="text"
              placeholder="Search members"
              class="members-popup__search-input"
            />
          </div>

          <div
            id="members-section"
            class="members-popup__list max-h-[300px] overflow-y-auto"
          ></div>
        </div>
      </main>
    </div>

    <!-- üß© JS -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script type="module" src="/js/taskview/main.js"></script>
  </body>
</html>
