<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Tasks - DevCollab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sidebar { height: calc(100vh - 4rem); top: 4rem; transition: all 0.3s ease; }
        .sidebar-item-active { background-color: #eff6ff; color: #2563eb; font-weight: 600; border-right: 4px solid #2563eb; }
        .sidebar-item { color: #4b5563; transition: background-color 0.15s; border-right: 4px solid transparent; }
        .sidebar-item:hover { background-color: #f9fafb; color: #1f2937; }
        .task-card { transition: box-shadow 0.2s, transform 0.2s; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .badge { padding: 3px 10px; border-radius: 9999px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; }
        .badge-completed { background: #dcfce7; color: #166534; }
        .badge-in-progress { background: #dbeafe; color: #1e40af; }
        .badge-open { background: #f3f4f6; color: #4b5563; }
        .badge-overdue { background: #fee2e2; color: #991b1b; }
        .badge-low { background: #f0fdf4; color: #16a34a; }
        .badge-medium { background: #fefce8; color: #a16207; }
        .badge-high { background: #fff1f2; color: #be123c; }
        .badge-critical { background: #f5f3ff; color: #5b21b6; }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <!-- Header (from user-dashboard) -->
    <header class="bg-white p-4 flex justify-between items-center shadow-md sticky top-0 z-20 h-16 border-b border-gray-200">
        <div class="flex items-center space-x-3 w-64 flex-shrink-0">
            <img src="https://cdn-icons-png.flaticon.com/512/5968/5968705.png" alt="DevCollab Logo" class="w-9 h-9 rounded-lg shadow-sm" />
            <span class="text-2xl font-extrabold text-blue-700 tracking-wider">DevCollab</span>
        </div>
        <div class="flex-grow flex justify-center mx-10">
            <div class="relative w-full max-w-xl">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                <input type="text" placeholder="Search for anything..." class="border border-gray-200 rounded-full pl-12 pr-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-sm shadow-sm" style="height: 40px" />
            </div>
        </div>
        <div class="flex items-center space-x-6 flex-shrink-0">
            <div class="relative cursor-pointer p-2 rounded-full hover:bg-gray-100 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg></div>
            <div class="flex items-center space-x-3 cursor-pointer p-1 rounded-full hover:bg-gray-100 transition">
                <div class="text-right leading-tight"><span class="block text-sm font-semibold text-gray-800">Anima Agrawal</span><span class="block text-xs text-gray-500">U.P, India</span></div>
                <img src="https://i.pravatar.cc/40?img=15" class="rounded-full w-10 h-10 border-2 border-white shadow-lg" alt="User Avatar" />
            </div>
        </div>
    </header>

    <div class="flex min-h-[calc(100vh-4rem)]">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-xl flex-shrink-0 sticky left-0 sidebar border-r border-gray-200 z-10">
            <nav class="mt-2">
                <ul>
                    <li class="flex items-center px-6 py-3 cursor-pointer sidebar-item">
                        <a href="/user/view/dashboard" class="flex items-center w-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>Home</a>
                    </li>
                    <li class="flex items-center px-6 py-3 cursor-pointer sidebar-item">
                        <a href="/user/view/create-project" class="flex items-center w-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>Create Project</a>
                    </li>
                    <li class="flex items-center px-6 py-3 cursor-pointer sidebar-item">
                        <a href="/user/view/view-invitation" class="flex items-center w-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.707-8.707a1 1 0 00-1.414 1.414L9 12.414V5a1 1 0 10-2 0v5.414L3.707 9.707a1 1 0 00-1.414 1.414l4 4a1 1 0 001.414 0l4-4a1 1 0 00-1.414-1.414L8 12.586V7a1 1 0 10-2 0v5.586l.293-.293z" clip-rule="evenodd" /></svg>View Invitations</a>
                    </li>
                    <li class="flex items-center px-6 py-3 cursor-pointer sidebar-item">
                        <a href="/user/view/view-all-projects" class="flex items-center w-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM3 8a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM5 12a1 1 0 100 2h10a1 1 0 100-2H5zM8 16a1 1 0 100 2h4a1 1 0 100-2H8z" /></svg>View All Projects</a>
                    </li>
                    <li class="flex items-center px-6 py-3 cursor-pointer sidebar-item-active">
                        <a href="/user/view/tasks" class="flex items-center w-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>My Tasks</a>
                    </li>
                    <li class="flex items-center px-6 py-3 cursor-pointer sidebar-item">
                        <a href="/user/view/message" class="flex items-center w-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z" /><path d="M15 11a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>Chat</a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main content -->
        <main class="flex-1 p-8 overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">My Tasks</h1>
                <div class="flex items-center space-x-2">
                    <select id="projectFilter" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Projects</option>
                    </select>
                    <select id="statusFilter" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Statuses</option>
                        <option value="OPEN">Open</option>
                        <option value="IN_PROGRESS">In Progress</option>
                        <option value="REVIEW">Review</option>
                        <option value="DONE">Done</option>
                    </select>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-md text-sm">New Task</button>
                </div>
            </div>

            <!-- Task List -->
            <div class="space-y-3" id="taskContainer">
                <div id="loadingMessage" class="text-center text-gray-500 py-8">
                    <p>Loading tasks...</p>
                </div>
            </div>

            <!-- Pagination (static placeholder) -->
            <div class="mt-8 flex justify-center">
                <nav class="flex items-center space-x-2">
                    <a href="#" class="px-3 py-1 border border-gray-300 rounded-md text-sm text-gray-600 hover:bg-gray-50">Previous</a>
                    <a href="#" class="px-3 py-1 border border-blue-500 bg-blue-50 rounded-md text-sm text-blue-600 font-semibold">1</a>
                    <a href="#" class="px-3 py-1 border border-gray-300 rounded-md text-sm text-gray-600 hover:bg-gray-50">2</a>
                    <a href="#" class="px-3 py-1 border border-gray-300 rounded-md text-sm text-gray-600 hover:bg-gray-50">3</a>
                    <a href="#" class="px-3 py-1 border border-gray-300 rounded-md text-sm text-gray-600 hover:bg-gray-50">Next</a>
                </nav>
            </div>
        </main>
    </div>

    <!-- Task Detail Modal -->
    <div id="taskDetailModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between z-10">
                <div class="flex items-center space-x-3">
                    <span id="modalProjectInfo" class="text-sm text-gray-500">Project / Task ID-</span>
                </div>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl font-light">×</button>
            </div>

            <div class="p-6 space-y-6">
                <div class="flex items-center justify-between">
                    <h2 id="modalTaskTitle" class="text-2xl font-semibold text-gray-800">Task Title</h2>
                    <div class="flex items-center space-x-2">
                        <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm font-medium">Priority</span>
                        <select id="modalPriority" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="LOW">Low</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="HIGH">High</option>
                            <option value="CRITICAL">Critical</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-600 font-semibold mb-1 block">Status</label>
                        <span id="modalStatusView" class="badge badge-open">Open</span>
                    </div>
                    <div>
                        <label class="text-sm text-gray-600 font-semibold mb-1 block">Due Date</label>
                        <input type="date" id="modalDueDate" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="text-sm text-gray-600 font-semibold mb-2 block">Description</label>
                    <textarea id="modalDescription" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm h-32 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Add description..."></textarea>
                </div>

                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm text-gray-600 font-semibold">Attachments</label>
                        <input type="file" id="attachmentInput" class="hidden" multiple>
                        <button id="uploadAttachmentBtn" class="text-blue-600 hover:text-blue-700 text-sm font-medium">+ Add Attachment</button>
                    </div>
                    <div id="attachmentsList" class="space-y-2"></div>
                </div>

                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm text-gray-600 font-semibold">Comments</label>
                    </div>
                    <div id="commentsList" class="space-y-3 mb-3"></div>
                    <div class="flex space-x-2">
                        <textarea id="commentInput" class="flex-1 border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Add a comment..."></textarea>
                        <button id="postCommentBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">Post</button>
                    </div>
                </div>
            </div>

            <div class="sticky bottom-0 bg-white border-t border-gray-200 px-6 py-4 flex justify-end space-x-2">
                <button id="cancelBtn" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        function getStatusClass(status) {
            // Chỉ kiểm tra các giá trị có trong CONSTRAINT
            if (status === 'DONE') return 'badge-completed';
            if (status === 'IN_PROGRESS') return 'badge-in-progress';
            if (status === 'REVIEW') return 'badge-medium'; // (Ví dụ: dùng màu vàng cho 'Review')
            if (status === 'OPEN') return 'badge-open';

            // Xử lý riêng cho trạng thái suy ra (isOverdue)
            // Bạn nên truyền 'task.isOverdue' vào đây nếu có
//if (status === 'Overdue') return 'badge-overdue';

            return 'badge-open';
        }
        function getPriorityClass(priority) {
            if (priority === 'LOW') return 'badge-low';
            if (priority === 'MEDIUM') return 'badge-medium';
            if (priority === 'HIGH') return 'badge-high';
            if (priority === 'CRITICAL') return 'badge-critical';
            return 'badge-medium';
        }
        function formatStatus(status) {
            // Khớp 1-1 với CONSTRAINT
            if (status === 'DONE') return 'Completed';
            if (status === 'IN_PROGRESS') return 'In Progress';
            if (status === 'REVIEW') return 'In Review'; // Làm cho nó đẹp hơn
            if (status === 'OPEN') return 'Open';

            return status; // Trả về nguyên bản nếu có lỗi
        }
        function formatPriority(priority) {
            if (priority === 'LOW') return 'Low';
            if (priority === 'MEDIUM') return 'Medium';
            if (priority === 'HIGH') return 'High';
            if (priority === 'CRITICAL') return 'Critical';
            return priority;
        }

        async function loadProjects() {
            const projectFilter = document.getElementById('projectFilter');
            try {
                const urlParams = new URLSearchParams(window.location.search);
                let token = urlParams.get('token') || localStorage.getItem('jwtToken');
                if (!token) return;
                const response = await fetch('/api/tasks/user/projects', { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                if (!response.ok) return;
                const projects = await response.json();
                projectFilter.innerHTML = '<option value="">All Projects</option>';
                projects.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.projectId; opt.textContent = p.name; projectFilter.appendChild(opt);
                });
            } catch (e) { console.error('Load projects failed', e); }
        }

        async function loadTasks(projectId = null, statuses = null) {
            const container = document.getElementById('taskContainer');
            const loadingMessage = document.getElementById('loadingMessage');
            try {
                const urlParams = new URLSearchParams(window.location.search);
                let token = urlParams.get('token') || localStorage.getItem('jwtToken');
                if (!token) { container.innerHTML = '<p class="text-center text-red-500 py-8">⚠️ Vui lòng đăng nhập</p>'; return; }
                let apiUrl = '/api/tasks/user/my-tasks';
                let params = [];
                if (projectId) params.push(`projectId=${projectId}`);
                if (statuses) params.push(`statuses=${statuses}`);
                if (params.length > 0) apiUrl += `?${params.join('&')}`;
                const response = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                if (!response.ok) { if (response.status === 401 || response.status === 403) { container.innerHTML = '<p class="text-center text-red-500 py-8">⚠️ Không có quyền truy cập. Vui lòng đăng nhập lại.</p>'; return; } throw new Error('HTTP ' + response.status); }
                const tasks = await response.json();
                loadingMessage.style.display = 'none';
                if (!tasks || tasks.length === 0) { container.innerHTML = `<p class="text-center text-gray-400 py-8">Bạn chưa có task nào${projectId ? ' trong project này' : ''}.</p>`; return; }
                container.innerHTML = tasks.map(task => `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 flex items-center space-x-4 task-card cursor-pointer" onclick="openTaskDetail(${task.id})">
                        <div class="flex-1 flex items-center space-x-4">
                            <div class="task-main">
                                <p class="font-semibold text-gray-800">${task.title || 'N/A'}</p>
                                <div class="text-xs text-gray-500 flex items-center space-x-3">
                                    <span>#${task.id}</span>
                                    <span>Opened ${task.openedDaysAgo} days ago by ${task.creatorName || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="badge ${getStatusClass(task.status)}">${formatStatus(task.status)}</span>
                            <span class="badge ${getPriorityClass(task.priority)}">${formatPriority(task.priority)}</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center text-sm ${task.isOverdue ? 'text-red-600' : 'text-gray-600'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                <span>${task.timeRemaining || 'N/A'}</span>
                            </div>
                            ${task.assignee && task.assignee.avatarUrl ? `<img class="w-8 h-8 rounded-full border-2 border-white shadow" src="${task.assignee.avatarUrl}" alt="Assignee" />` : '<div class="w-8 h-8 rounded-full bg-gray-200 border-2 border-white"></div>'}
                            <div class="flex items-center space-x-3 text-sm text-gray-500">
                                <div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg><span>${task.checklistCount || 0}</span></div>
                                <div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z" /><path d="M15 11a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg><span>${task.commentCount || 0}</span></div>
                            </div>
                            <button class="text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg></button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Lỗi khi tải tasks:', error);
                container.innerHTML = '<p class="text-center text-red-500 py-8">❌ Không thể tải tasks. Vui lòng thử lại sau.</p>';
            }
        }

        // Apply filters for both project and status
        function applyFilters() {
            const projectFilter = document.getElementById('projectFilter');
            const statusFilter = document.getElementById('statusFilter');
            const selectedProject = projectFilter.value || null;
            let selectedStatus = statusFilter.value || null;
            // If select all, send null; if only one status selected, send that; if needed support multi, can split here
            if (selectedStatus === '') selectedStatus = null;
            loadTasks(selectedProject, selectedStatus);
        }

        let currentTaskId = null;
        async function openTaskDetail(taskId) {
            currentTaskId = taskId;
            const modal = document.getElementById('taskDetailModal');
            const urlParams = new URLSearchParams(window.location.search);
            let token = urlParams.get('token') || localStorage.getItem('jwtToken');
            try {
                const res = await fetch(`/api/tasks/${taskId}`, { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } });
                if (!res.ok) throw new Error('Failed to load task details');
                const task = await res.json();
                document.getElementById('modalTaskTitle').textContent = task.title;
                document.getElementById('modalProjectInfo').textContent = `Project: ${task.project?.name || 'N/A'} / Task ID-${task.taskId}`;
                const statusView = document.getElementById('modalStatusView');
                statusView.textContent = formatStatus(task.status);
                statusView.className = `badge ${getStatusClass(task.status)}`;
                document.getElementById('modalPriority').value = task.priority;
                document.getElementById('modalDescription').value = task.descriptionMd || '';
                if (task.deadline) { const date = new Date(task.deadline); document.getElementById('modalDueDate').value = date.toISOString().split('T')[0]; }
                loadAttachments(task.attachments || []);
                loadComments(task.comments || []);
                modal.classList.remove('hidden');
            } catch (e) { console.error(e); alert('Không thể tải chi tiết task'); }
        }
        function loadAttachments(attachments) {
            const list = document.getElementById('attachmentsList');
            if (!attachments || attachments.length === 0) { list.innerHTML = '<p class="text-sm text-gray-400">No attachments</p>'; return; }
            list.innerHTML = attachments.map(a => `
                <div class="flex items-center justify-between bg-gray-50 rounded-md p-2">
                    <div class="flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>
                        <span class="text-sm text-gray-700">${a.fileName || 'File'}</span>
                    </div>
                    <a href="${a.fileUrl}" target="_blank" class="text-blue-600 hover:text-blue-700 text-sm">View</a>
                </div>
            `).join('');
        }
        function loadComments(comments) {
            const list = document.getElementById('commentsList');
            if (!comments || comments.length === 0) { list.innerHTML = '<p class="text-sm text-gray-400">No comments yet</p>'; return; }
            list.innerHTML = comments.map(c => `
                <div class="bg-gray-50 rounded-md p-3">
                    <div class="flex items-center space-x-2 mb-1">
                        <img src="${c.user?.avatarUrl || 'https://i.pravatar.cc/30'}" class="w-6 h-6 rounded-full" alt="User">
                        <span class="text-sm font-medium text-gray-700">${c.user?.name || 'User'}</span>
                        <span class="text-xs text-gray-400">${c.createdAt ? new Date(c.createdAt).toLocaleDateString() : ''}</span>
                    </div>
                    <p class="text-sm text-gray-600">${c.content}</p>
                </div>
            `).join('');
        }
        document.getElementById('closeModalBtn').addEventListener('click', () => { document.getElementById('taskDetailModal').classList.add('hidden'); });
        document.getElementById('cancelBtn').addEventListener('click', () => { document.getElementById('taskDetailModal').classList.add('hidden'); });
        document.getElementById('uploadAttachmentBtn').addEventListener('click', () => { document.getElementById('attachmentInput').click(); });
        document.getElementById('attachmentInput').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return; const urlParams = new URLSearchParams(window.location.search); let token = urlParams.get('token') || localStorage.getItem('jwtToken');
            const form = new FormData(); form.append('file', file);
            try {
                const res = await fetch(`/api/tasks/${currentTaskId}/attachments`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: form });
                if (!res.ok) throw new Error('Upload failed');
                alert('Attachment uploaded successfully!'); openTaskDetail(currentTaskId);
            } catch (e) { console.error(e); alert('Không thể upload file'); }
        });
        document.getElementById('postCommentBtn').addEventListener('click', async () => {
            const input = document.getElementById('commentInput'); const content = input.value.trim(); if (!content) return; const urlParams = new URLSearchParams(window.location.search); let token = urlParams.get('token') || localStorage.getItem('jwtToken');
            try {
                const res = await fetch(`/api/tasks/${currentTaskId}/comments`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ content }) });
                if (!res.ok) throw new Error('Post comment failed'); input.value = ''; alert('Comment posted!'); openTaskDetail(currentTaskId);
            } catch (e) { console.error(e); alert('Không thể đăng comment'); }
        });
        window.addEventListener('DOMContentLoaded', async () => {
            await loadProjects();
            const projectFilter = document.getElementById('projectFilter');
            const statusFilter = document.getElementById('statusFilter');
            projectFilter.addEventListener('change', applyFilters);
            statusFilter.addEventListener('change', applyFilters);
            applyFilters();
        });
    </script>
</body>
</html>