<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Messaging - DevCollab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>

    <style>
      body {
        font-family: "Inter", sans-serif;
      }

      /* ‚úÖ Sidebar c·ªë ƒë·ªãnh theo chi·ªÅu cao m√†n h√¨nh */
      .sidebar {
        height: calc(100vh - 4rem);
        top: 4rem;
      }

      /* ‚úÖ Thanh b√™n d·ª± √°n (My Projects) cu·ªôn ƒë·ªôc l·∫≠p */
      .projects-scroll {
        height: calc(100vh - 8rem);
        overflow-y: auto;
      }

      /* ‚úÖ Chat box cu·ªôn ƒë·ªôc l·∫≠p */
      .messages-container {
        height: calc(100vh - 12rem);
        overflow-y: auto;
      }

      /* ‚úÖ Thanh cu·ªôn nh·∫π nh√†ng */
      .projects-scroll::-webkit-scrollbar,
      .messages-container::-webkit-scrollbar {
        width: 8px;
      }
      .projects-scroll::-webkit-scrollbar-thumb,
      .messages-container::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 4px;
      }

      .sidebar-item-active {
        background-color: #eff6ff;
        color: #2563eb;
        font-weight: 600;
        border-right: 4px solid #2563eb;
      }

      .sidebar-item {
        color: #4b5563;
        transition: background-color 0.15s;
        border-right: 4px solid transparent;
      }

      .sidebar-item:hover {
        background-color: #f3f4f6;
        color: #1f2937;
      }

      .chat-list-item:hover {
        background-color: #f3f4f6;
      }

      .chat-list-item-active {
        background-color: #3b82f6;
        color: white;
      }
    </style>
</head>

<body class="bg-gray-50 font-sans">
<!-- ‚úÖ Header -->
<div th:replace="fragments/header :: header"></div>

<div class="flex min-h-[calc(100vh-4rem)]">
    <!-- ‚úÖ Sidebar -->
    <div th:replace="fragments/sidebar :: sidebar"></div>

      <!-- ‚úÖ Main Chat -->
      <div class="flex-1 flex bg-gray-50">
        <!-- üîπ Danh s√°ch Project -->
        <div class="w-80 border-r bg-white flex flex-col">
          <div class="p-4 border-b">
            <h2 class="font-semibold text-lg text-gray-700">My Projects</h2>
          </div>

          <!-- ‚úÖ Th√™m kh·ªëi cu·ªôn ri√™ng -->
          <div class="projects-scroll">
            <!-- N·∫øu c√≥ project -->
            <div th:if="${projects != null and !#lists.isEmpty(projects)}">
              <div
                th:each="project : ${projects}"
                th:data-id="${project.projectId}"
                class="chat-list-item px-4 py-3 cursor-pointer border-b hover:bg-gray-50"
                onclick="loadMessages(this.getAttribute('data-id'), this)"
              >
                <p
                  class="font-semibold text-gray-800"
                  th:text="${project.name}"
                >
                  Project Name
                </p>
                <p
                  class="text-sm text-gray-500 truncate"
                  th:text="${project.description}"
                >
                  No messages yet
                </p>
              </div>
            </div>

            <!-- Project container -->
            <div id="projectList" class="flex-1 overflow-y-auto"></div>

            <!-- Pagination controls -->
            <div class="pagination text-center py-3 border-t bg-gray-50" id="paginationControls"></div>
        </div>

        <!-- üîπ Khu v·ª±c Chat -->
        <div class="flex-1 flex flex-col bg-gray-50">
          <div id="chatHeader" class="flex items-center p-4 border-b bg-white">
            <h2 class="font-semibold text-gray-700" id="chatProjectName">
              Select a project to start chatting
            </h2>
          </div>

          <!-- ‚úÖ Th√™m class messages-container -->
          <div
            id="chatBox"
            class="messages-container p-6 space-y-4 bg-gray-50"
          ></div>

            <div class="p-4 border-t bg-white flex items-center space-x-3">
                <input id="messageInput" type="text" placeholder="Type your message..."
                       class="flex-1 border rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled />
                <button id="sendBtn"
                        class="bg-blue-600 text-white px-4 py-2 rounded-full hover:bg-blue-700 transition"
                        disabled>Send</button>
            </div>
        </div>
    </div>
</div>

    <!-- ‚úÖ JavaScript (gi·ªØ nguy√™n logic ho√†n to√†n) -->
    <script th:inline="javascript">
      const chatBox = document.getElementById("chatBox");
      const sendBtn = document.getElementById("sendBtn");
      const input = document.getElementById("messageInput");
      const chatProjectName = document.getElementById("chatProjectName");
      let currentProjectId = null;

    const username = /*[[${#strings.escapeJavaScript(username)}]]*/ "";
    const userEmail = /*[[${#strings.escapeJavaScript(user.email)}]]*/ "";

    // ‚úÖ Connect WebSocket
    function connectWs() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => console.log("‚úÖ WebSocket connected"));
    }
    connectWs();

    // ‚úÖ Fetch paginated project list
    function loadProjects(page = 0) {
        fetch(`/api/projects?page=${page}&size=9`)
            .then(res => res.json())
            .then(data => {
                renderProjects(data.content);
                renderPagination(data.number, data.totalPages);
            })
            .catch(err => {
                console.error("Error loading projects:", err);
                projectListDiv.innerHTML = "<p class='text-center text-gray-500 p-4'>Failed to load projects</p>";
            });
    }

        fetch("/api/messages/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ projectId: currentProjectId, content: text }),
        })
          .then((res) => res.json())
          .then((data) => {
            appendMessage(
              data.senderName,
              data.content,
              data.senderEmail,
              data.senderAvatar
            );
            input.value = "";
          })
          .catch(console.error);
      }

        projects.forEach(project => {
            const item = document.createElement("div");
            item.className = "chat-list-item px-4 py-3 cursor-pointer border-b hover:bg-gray-50";
            item.innerHTML = `
            <p class="font-semibold text-gray-800">${project.name}</p>
            <p class="text-sm text-gray-500 truncate">${project.description || "No description"}</p>`;
            item.addEventListener("click", () => loadMessages(project.projectId, item));
            projectListDiv.appendChild(item);
        });
    }

    // ‚úÖ Render pagination controls
    function renderPagination(current, total) {
        paginationDiv.innerHTML = "";
        totalPages = total;
        currentPage = current;

        if (total <= 1) return;

        for (let i = 0; i < total; i++) {
            const btn = document.createElement("button");
            btn.textContent = i + 1;
            btn.className = i === current ? "active" : "";
            btn.addEventListener("click", () => loadProjects(i));
            paginationDiv.appendChild(btn);
        }
    }

    // ‚úÖ Load chat messages (REST + WebSocket)
    function loadMessages(projectId, element) {
        currentProjectId = projectId;
        input.disabled = false;
        sendBtn.disabled = false;

        document.querySelectorAll(".chat-list-item")
            .forEach(el => el.classList.remove("chat-list-item-active"));
        element.classList.add("chat-list-item-active");

        chatProjectName.textContent = element.querySelector(".font-semibold").textContent;
        chatBox.innerHTML = "<p class='text-center text-gray-500'>Loading messages...</p>";

        fetch(`/api/messages/${projectId}`)
          .then((res) => res.json())
          .then((messages) => {
            chatBox.innerHTML = "";
            messages.forEach((msg) =>
              appendMessage(
                msg.senderName,
                msg.content,
                msg.senderEmail,
                msg.senderAvatar
              )
            );
            chatBox.scrollTop = chatBox.scrollHeight;
          })
          .catch(console.error);
      }
      window.loadMessages = loadMessages;

        if (subscription) subscription.unsubscribe();
        subscription = stompClient.subscribe(`/topic/project.${projectId}`, message => {
            const msg = JSON.parse(message.body);
            appendMessage(msg.senderName, msg.content, msg.senderEmail, msg.senderAvatar);
        });
    }

    // ‚úÖ Send chat message
    function sendMessage() {
        const text = input.value.trim();
        if (!text || !currentProjectId || !stompClient.connected) return;

        const msg = { projectId: currentProjectId, content: text, senderEmail: userEmail };
        stompClient.send(`/app/chat/${currentProjectId}`, {}, JSON.stringify(msg));
        input.value = "";
    }

    // ‚úÖ Append message to chat box
    function appendMessage(senderName, content, senderEmail, avatarUrl) {
        const msgDiv = document.createElement("div");
        const isCurrentUser =
          senderEmail?.trim().toLowerCase() === userEmail?.trim().toLowerCase();

        const avatar = avatarUrl
          ? avatarUrl
          : `https://i.pravatar.cc/40?u=${senderEmail}`;

        if (isCurrentUser) {
          msgDiv.className = "flex justify-end mb-3";
          msgDiv.innerHTML = `
        <div class="flex flex-col items-end max-w-[70%]">
          <div class="bg-blue-600 text-white px-4 py-2 rounded-2xl shadow text-sm text-right break-words">
            ${content}
          </div>
        </div>`;
        } else {
          msgDiv.className = "flex justify-start mb-3";
          msgDiv.innerHTML = `
        <div class="flex items-start space-x-2 max-w-[70%]">
          <img src="${avatar}" class="w-8 h-8 rounded-full border" alt="${senderName}">
          <div>
            <p class="text-xs text-gray-500 mb-1 font-medium">${senderName}</p>
            <div class="bg-gray-200 text-gray-800 px-4 py-2 rounded-2xl shadow text-sm break-words">
              ${content}
            </div>
          </div>
        </div>`;
        }

        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keypress", e => e.key === "Enter" && sendMessage());

    // ‚úÖ Initial load
    loadProjects(0);
</script>
</body>
</html>
