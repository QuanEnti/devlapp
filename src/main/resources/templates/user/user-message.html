<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Messaging - DevCollab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>

    <style>
        body { font-family: "Inter", sans-serif; }
        .sidebar { height: calc(100vh - 4rem); top: 4rem; }
        .sidebar-item-active { background-color: #eff6ff; color: #2563eb; font-weight: 600; border-right: 4px solid #2563eb; }
        .sidebar-item { color: #4b5563; transition: background-color 0.15s; border-right: 4px solid transparent; }
        .sidebar-item:hover { background-color: #f3f4f6; color: #1f2937; }
        .chat-list-item:hover { background-color: #f3f4f6; }
        .chat-list-item-active { background-color: #3b82f6; color: white; }
        .messages-container::-webkit-scrollbar { width: 8px; }
        .messages-container::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .pagination button { padding: 6px 10px; margin: 2px; border-radius: 6px; }
        .pagination button.active { background-color: #2563eb; color: white; }
        .pagination button:hover { background-color: #e5e7eb; }
    </style>
</head>

<body class="bg-gray-50 font-sans">
<!-- âœ… Header -->
<div th:replace="fragments/header :: header"></div>

<div class="flex min-h-[calc(100vh-4rem)]">
    <!-- âœ… Sidebar -->
    <div th:replace="fragments/sidebar :: sidebar"></div>

    <!-- âœ… Main Chat -->
    <div class="flex-1 flex bg-gray-50">
        <!-- ðŸ”¹ Project list -->
        <div class="w-80 border-r bg-white overflow-y-auto flex flex-col">
            <div class="p-4 border-b">
                <h2 class="font-semibold text-lg text-gray-700">My Projects</h2>
            </div>

            <!-- Project container -->
            <div id="projectList" class="flex-1 overflow-y-auto"></div>

            <!-- Pagination controls -->
            <div class="pagination text-center py-3 border-t bg-gray-50" id="paginationControls"></div>
        </div>

        <!-- ðŸ”¹ Chat window -->
        <div class="flex-1 flex flex-col">
            <div id="chatHeader" class="flex items-center p-4 border-b bg-white">
                <h2 class="font-semibold text-gray-700" id="chatProjectName">
                    Select a project to start chatting
                </h2>
            </div>

            <div id="chatBox" class="flex-1 p-6 space-y-4 overflow-y-auto bg-gray-50 messages-container"></div>

            <div class="p-4 border-t bg-white flex items-center space-x-3">
                <input id="messageInput" type="text" placeholder="Type your message..."
                       class="flex-1 border rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" disabled />
                <button id="sendBtn"
                        class="bg-blue-600 text-white px-4 py-2 rounded-full hover:bg-blue-700 transition"
                        disabled>Send</button>
            </div>
        </div>
    </div>
</div>

<!-- âœ… JavaScript -->
<script th:inline="javascript">
    const chatBox = document.getElementById("chatBox");
    const sendBtn = document.getElementById("sendBtn");
    const input = document.getElementById("messageInput");
    const chatProjectName = document.getElementById("chatProjectName");
    const projectListDiv = document.getElementById("projectList");
    const paginationDiv = document.getElementById("paginationControls");
    let currentPage = 0;
    let totalPages = 0;
    let stompClient = null;
    let currentProjectId = null;
    let subscription = null;

    const username = /*[[${#strings.escapeJavaScript(username)}]]*/ "";
    const userEmail = /*[[${#strings.escapeJavaScript(user.email)}]]*/ "";

    // âœ… Connect WebSocket
    function connectWs() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => console.log("âœ… WebSocket connected"));
    }
    connectWs();

    // âœ… Fetch paginated project list
    function loadProjects(page = 0) {
        fetch(`/api/projects?page=${page}&size=9`)
            .then(res => res.json())
            .then(data => {
                renderProjects(data.content);
                renderPagination(data.number, data.totalPages);
            })
            .catch(err => {
                console.error("Error loading projects:", err);
                projectListDiv.innerHTML = "<p class='text-center text-gray-500 p-4'>Failed to load projects</p>";
            });
    }

    // âœ… Render projects into sidebar
    function renderProjects(projects) {
        projectListDiv.innerHTML = "";
        if (!projects || projects.length === 0) {
            projectListDiv.innerHTML = "<p class='text-center text-gray-500 p-6 text-sm'>You have not joined any projects yet.</p>";
            return;
        }

        projects.forEach(project => {
            const item = document.createElement("div");
            item.className = "chat-list-item px-4 py-3 cursor-pointer border-b hover:bg-gray-50";
            item.innerHTML = `
            <p class="font-semibold text-gray-800">${project.name}</p>
            <p class="text-sm text-gray-500 truncate">${project.description || "No description"}</p>`;
            item.addEventListener("click", () => loadMessages(project.projectId, item));
            projectListDiv.appendChild(item);
        });
    }

    // âœ… Render pagination controls
    function renderPagination(current, total) {
        paginationDiv.innerHTML = "";
        totalPages = total;
        currentPage = current;

        if (total <= 1) return;

        for (let i = 0; i < total; i++) {
            const btn = document.createElement("button");
            btn.textContent = i + 1;
            btn.className = i === current ? "active" : "";
            btn.addEventListener("click", () => loadProjects(i));
            paginationDiv.appendChild(btn);
        }
    }

    // âœ… Load chat messages (REST + WebSocket)
    function loadMessages(projectId, element) {
        currentProjectId = projectId;
        input.disabled = false;
        sendBtn.disabled = false;

        document.querySelectorAll(".chat-list-item")
            .forEach(el => el.classList.remove("chat-list-item-active"));
        element.classList.add("chat-list-item-active");

        chatProjectName.textContent = element.querySelector(".font-semibold").textContent;
        chatBox.innerHTML = "<p class='text-center text-gray-500'>Loading messages...</p>";

        fetch(`/api/messages/${projectId}`)
            .then(res => res.json())
            .then(messages => {
                chatBox.innerHTML = "";
                messages.forEach(m => appendMessage(m.senderName, m.content, m.senderEmail, m.senderAvatar));
                chatBox.scrollTop = chatBox.scrollHeight;
            });

        if (subscription) subscription.unsubscribe();
        subscription = stompClient.subscribe(`/topic/project.${projectId}`, message => {
            const msg = JSON.parse(message.body);
            appendMessage(msg.senderName, msg.content, msg.senderEmail, msg.senderAvatar);
        });
    }

    // âœ… Send chat message
    function sendMessage() {
        const text = input.value.trim();
        if (!text || !currentProjectId || !stompClient.connected) return;

        const msg = { projectId: currentProjectId, content: text, senderEmail: userEmail };
        stompClient.send(`/app/chat/${currentProjectId}`, {}, JSON.stringify(msg));
        input.value = "";
    }

    // âœ… Append message to chat box
    function appendMessage(senderName, content, senderEmail, avatarUrl) {
        const msgDiv = document.createElement("div");
        const isCurrentUser = senderEmail?.trim().toLowerCase() === userEmail?.trim().toLowerCase();
        const avatar = avatarUrl || `https://i.pravatar.cc/40?u=${senderEmail}`;
        msgDiv.className = isCurrentUser ? "flex justify-end mb-3" : "flex justify-start mb-3";
        msgDiv.innerHTML = isCurrentUser
            ? `<div class="flex flex-col items-end max-w-[70%]">
               <div class="bg-blue-600 text-white px-4 py-2 rounded-2xl shadow text-sm text-right break-words">${content}</div>
             </div>`
            : `<div class="flex items-start space-x-2 max-w-[70%]">
               <img src="${avatar}" class="w-8 h-8 rounded-full border" alt="${senderName}">
               <div>
                 <p class="text-xs text-gray-500 mb-1 font-medium">${senderName}</p>
                 <div class="bg-gray-200 text-gray-800 px-4 py-2 rounded-2xl shadow text-sm break-words">${content}</div>
               </div>
             </div>`;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keypress", e => e.key === "Enter" && sendMessage());

    // âœ… Initial load
    loadProjects(0);
</script>
</body>
</html>
