<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Messaging - DevCollab</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- âœ… ThÃªm thÆ° viá»‡n WebSocket -->
  <script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
  <script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
    }

    .sidebar {
      height: calc(100vh - 4rem);
      top: 4rem;
    }

    .projects-scroll {
      height: calc(100vh - 8rem);
      overflow-y: auto;
    }

    .messages-container {
      height: calc(100vh - 12rem);
      overflow-y: auto;
    }

    .projects-scroll::-webkit-scrollbar,
    .messages-container::-webkit-scrollbar {
      width: 8px;
    }

    .projects-scroll::-webkit-scrollbar-thumb,
    .messages-container::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 4px;
    }

    .chat-list-item:hover {
      background-color: #f3f4f6;
    }

    .chat-list-item-active {
      background-color: #3b82f6;
      color: white;
    }
  </style>
</head>

<body class="bg-gray-50 font-sans">
  <!-- âœ… Header -->
  <div th:replace="fragments/header :: header"></div>

  <div class="flex min-h-[calc(100vh-4rem)]">
    <!-- âœ… Sidebar -->
    <div th:replace="fragments/sidebar :: sidebar"></div>

    <!-- âœ… Main Chat -->
    <div class="flex-1 flex bg-gray-50">
      <!-- ðŸ”¹ Danh sÃ¡ch Project -->
      <div class="w-80 border-r bg-white flex flex-col">
        <div class="p-4 border-b">
          <h2 class="font-semibold text-lg text-gray-700">My Projects</h2>
        </div>

        <div class="projects-scroll">
          <div th:if="${projects != null and !#lists.isEmpty(projects)}">
            <div
              th:each="project : ${projects}"
              th:data-id="${project.projectId}"
              class="chat-list-item px-4 py-3 cursor-pointer border-b hover:bg-gray-50"
              onclick="loadMessages(this.getAttribute('data-id'), this)"
            >
              <p class="font-semibold text-gray-800" th:text="${project.name}">
                Project Name
              </p>
              <p
                class="text-sm text-gray-500 truncate"
                th:text="${project.description}"
              >
                No messages yet
              </p>
            </div>
          </div>

          <div
            th:if="${projects == null or #lists.isEmpty(projects)}"
            class="text-center text-gray-500 p-6 text-sm"
          >
            You have not joined any projects yet.
          </div>
        </div>
      </div>

      <!-- ðŸ”¹ Khu vá»±c Chat -->
      <div class="flex-1 flex flex-col bg-gray-50">
        <div id="chatHeader" class="flex items-center p-4 border-b bg-white">
          <h2 class="font-semibold text-gray-700" id="chatProjectName">
            Select a project to start chatting
          </h2>
        </div>

        <div id="chatBox" class="messages-container p-6 space-y-4 bg-gray-50"></div>

        <div class="p-4 border-t bg-white flex items-center space-x-3">
          <input
            id="messageInput"
            type="text"
            placeholder="Type your message..."
            class="flex-1 border rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            disabled
          />
          <button
            id="sendBtn"
            class="bg-blue-600 text-white px-4 py-2 rounded-full hover:bg-blue-700 transition"
            disabled
          >
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… JavaScript -->
  <script th:inline="javascript">
    const chatBox = document.getElementById("chatBox");
    const sendBtn = document.getElementById("sendBtn");
    const input = document.getElementById("messageInput");
    const chatProjectName = document.getElementById("chatProjectName");

    let currentProjectId = null;
    let stompClient = null;
    let subscription = null;

    const username = /*[[${#strings.escapeJavaScript(username)}]]*/ "";
    const userEmail = /*[[${#strings.escapeJavaScript(user.email)}]]*/ "";

    // âœ… Káº¿t ná»‘i WebSocket
    function connectWs() {
      const socket = new SockJS("/ws");
      stompClient = Stomp.over(socket);
      stompClient.connect({}, () => console.log("âœ… WebSocket connected"));
    }
    connectWs();

    // âœ… Khi gá»­i tin nháº¯n
    function sendMessage() {
      const text = input.value.trim();
      if (!text || !currentProjectId || !stompClient.connected) return;

      const msg = {
        projectId: currentProjectId,
        content: text,
        senderEmail: userEmail
      };

      stompClient.send(`/app/chat/${currentProjectId}`, {}, JSON.stringify(msg));
      input.value = "";
    }

    // âœ… Khi chá»n project Ä‘á»ƒ xem tin nháº¯n
    function loadMessages(projectId, element) {
      currentProjectId = projectId;
      input.disabled = false;
      sendBtn.disabled = false;

      document
        .querySelectorAll(".chat-list-item")
        .forEach((el) => el.classList.remove("chat-list-item-active"));
      element.classList.add("chat-list-item-active");

      chatProjectName.textContent =
        element.querySelector("p.font-semibold").textContent;
      chatBox.innerHTML =
        "<p class='text-center text-gray-500'>Loading messages...</p>";

      fetch(`/api/messages/${projectId}`)
        .then((res) => res.json())
        .then((messages) => {
          chatBox.innerHTML = "";
          messages.forEach((msg) =>
            appendMessage(
              msg.senderName,
              msg.content,
              msg.senderEmail,
              msg.senderAvatar
            )
          );
          chatBox.scrollTop = chatBox.scrollHeight;
        })
        .catch(console.error);

      // âœ… ÄÄƒng kÃ½ nháº­n tin nháº¯n realtime
      if (subscription) subscription.unsubscribe();
      subscription = stompClient.subscribe(
        `/topic/project.${projectId}`,
        (message) => {
          const msg = JSON.parse(message.body);
          appendMessage(
            msg.senderName,
            msg.content,
            msg.senderEmail,
            msg.senderAvatar
          );
        }
      );
    }
    window.loadMessages = loadMessages;

    // âœ… Hiá»ƒn thá»‹ tin nháº¯n trong chat box
    function appendMessage(senderName, content, senderEmail, avatarUrl) {
      const msgDiv = document.createElement("div");
      const isCurrentUser =
        senderEmail?.trim().toLowerCase() === userEmail?.trim().toLowerCase();

      const avatar = avatarUrl
        ? avatarUrl
        : `https://i.pravatar.cc/40?u=${senderEmail}`;

      if (isCurrentUser) {
        msgDiv.className = "flex justify-end mb-3";
        msgDiv.innerHTML = `
          <div class="flex flex-col items-end max-w-[70%]">
            <div class="bg-blue-600 text-white px-4 py-2 rounded-2xl shadow text-sm text-right break-words">
              ${content}
            </div>
          </div>`;
      } else {
        msgDiv.className = "flex justify-start mb-3";
        msgDiv.innerHTML = `
          <div class="flex items-start space-x-2 max-w-[70%]">
            <img src="${avatar}" class="w-8 h-8 rounded-full border" alt="${senderName}">
            <div>
              <p class="text-xs text-gray-500 mb-1 font-medium">${senderName}</p>
              <div class="bg-gray-200 text-gray-800 px-4 py-2 rounded-2xl shadow text-sm break-words">
                ${content}
              </div>
            </div>
          </div>`;
      }

      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // âœ… Event listener
    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>
