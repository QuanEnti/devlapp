<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Messaging - DevCollab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .sidebar {
        height: calc(100vh - 4rem);
        top: 4rem;
      }
      .sidebar-item-active {
        background-color: #eff6ff;
        color: #2563eb;
        font-weight: 600;
        border-right: 4px solid #2563eb;
      }
      .sidebar-item {
        color: #4b5563;
        transition: background-color 0.15s;
        border-right: 4px solid transparent;
      }
      .sidebar-item:hover {
        background-color: #f3f4f6;
        color: #1f2937;
      }
      .chat-list-item:hover {
        background-color: #f3f4f6;
      }
      .chat-list-item-active {
        background-color: #3b82f6;
        color: white;
      }
      .messages-container::-webkit-scrollbar {
        width: 8px;
      }
      .messages-container::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 4px;
      }
    </style>
  </head>

  <body class="bg-gray-50 font-sans">
    <!-- ✅ Header -->
    <div th:replace="fragments/header :: header"></div>

    <div class="flex min-h-[calc(100vh-4rem)]">
      <!-- ✅ Sidebar -->
      <div th:replace="fragments/sidebar :: sidebar"></div>

      <!-- ✅ Main Chat -->
      <div class="flex-1 flex bg-gray-50">
        <div class="w-80 border-r bg-white overflow-y-auto">
          <div class="p-4 border-b">
            <h2 class="font-semibold text-lg text-gray-700">My Projects</h2>
          </div>
          <div>
            <!-- Nếu có project -->
            <div th:if="${projects != null and !#lists.isEmpty(projects)}">
              <div
                th:each="project : ${projects}"
                th:data-id="${project.projectId}"
                class="chat-list-item px-4 py-3 cursor-pointer border-b hover:bg-gray-50"
                onclick="loadMessages(this.getAttribute('data-id'), this)"
              >
                <p
                  class="font-semibold text-gray-800"
                  th:text="${project.name}"
                >
                  Project Name
                </p>
                <p
                  class="text-sm text-gray-500 truncate"
                  th:text="${project.description}"
                >
                  No messages yet
                </p>
              </div>
            </div>

            <!-- Nếu không có project -->
            <div
              th:if="${projects == null or #lists.isEmpty(projects)}"
              class="text-center text-gray-500 p-6 text-sm"
            >
              You have not joined any projects yet.
            </div>
          </div>
        </div>

        <div class="flex-1 flex flex-col">
          <div id="chatHeader" class="flex items-center p-4 border-b bg-white">
            <h2 class="font-semibold text-gray-700" id="chatProjectName">
              Select a project to start chatting
            </h2>
          </div>

          <div
            id="chatBox"
            class="flex-1 p-6 space-y-4 overflow-y-auto bg-gray-50"
          ></div>

          <div class="p-4 border-t bg-white flex items-center space-x-3">
            <input
              id="messageInput"
              type="text"
              placeholder="Type your message..."
              class="flex-1 border rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              disabled
            />
            <button
              id="sendBtn"
              class="bg-blue-600 text-white px-4 py-2 rounded-full hover:bg-blue-700 transition"
              disabled
            >
              Send
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ JavaScript -->
    <script th:inline="javascript">
      const chatBox = document.getElementById("chatBox");
      const sendBtn = document.getElementById("sendBtn");
      const input = document.getElementById("messageInput");
      const chatProjectName = document.getElementById("chatProjectName");
      let currentProjectId = null;

      const username = /*[[${#strings.escapeJavaScript(username)}]]*/ "";
      const userEmail = /*[[${#strings.escapeJavaScript(user.email)}]]*/ "";

      sendBtn.addEventListener("click", sendMessage);
      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      function sendMessage() {
        const text = input.value.trim();
        if (!text || !currentProjectId) return;

        fetch("/api/messages/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ projectId: currentProjectId, content: text }),
        })
          .then((res) => res.json())
          .then((data) => {
            // ✅ Truyền thêm avatar từ backend
            appendMessage(
              data.senderName,
              data.content,
              data.senderEmail,
              data.senderAvatar
            );
            input.value = "";
          })
          .catch(console.error);
      }

      function loadMessages(projectId, element) {
        currentProjectId = projectId;
        input.disabled = false;
        sendBtn.disabled = false;

        document
          .querySelectorAll(".chat-list-item")
          .forEach((el) => el.classList.remove("chat-list-item-active"));
        element.classList.add("chat-list-item-active");

        chatProjectName.textContent =
          element.querySelector("p.font-semibold").textContent;
        chatBox.innerHTML =
          "<p class='text-center text-gray-500'>Đang tải tin nhắn...</p>";

        fetch(`/api/messages/${projectId}`)
          .then((res) => res.json())
          .then((messages) => {
            chatBox.innerHTML = "";
            messages.forEach((msg) =>
              // ✅ Truyền thêm avatar
              appendMessage(
                msg.senderName,
                msg.content,
                msg.senderEmail,
                msg.senderAvatar
              )
            );
            chatBox.scrollTop = chatBox.scrollHeight;
          })
          .catch(console.error);
      }
      window.loadMessages = loadMessages;

      function appendMessage(senderName, content, senderEmail, avatarUrl) {
        const msgDiv = document.createElement("div");
        const isCurrentUser =
          senderEmail?.trim().toLowerCase() === userEmail?.trim().toLowerCase();

        // ✅ Ưu tiên avatar backend trả về – nếu null sẽ fallback theo email
        const avatar = avatarUrl
          ? avatarUrl
          : `https://i.pravatar.cc/40?u=${senderEmail}`;

        if (isCurrentUser) {
          msgDiv.className = "flex justify-end mb-3";
          msgDiv.innerHTML = `
        <div class="flex flex-col items-end max-w-[70%]">
          <div class="bg-blue-600 text-white px-4 py-2 rounded-2xl shadow text-sm text-right break-words">
            ${content}
          </div>
        </div>`;
        } else {
          msgDiv.className = "flex justify-start mb-3";
          msgDiv.innerHTML = `
        <div class="flex items-start space-x-2 max-w-[70%]">
          <img src="${avatar}" class="w-8 h-8 rounded-full border" alt="${senderName}">
          <div>
            <p class="text-xs text-gray-500 mb-1 font-medium">${senderName}</p>
            <div class="bg-gray-200 text-gray-800 px-4 py-2 rounded-2xl shadow text-sm break-words">
              ${content}
            </div>
          </div>
        </div>`;
        }

        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    </script>
  </body>
</html>
