<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - DevCollab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Sidebar full height */
      .sidebar {
        height: calc(100vh - 4rem);
        top: 4rem;
        transition: all 0.3s ease;
      }

      /* Card project style */
      .project-card-item {
        border: 1px solid #e5e7eb;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
      }
      .project-card-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      /* Avatar style */
      .avatar {
        width: 28px;
        height: 28px;
        object-fit: cover;
        border: 2px solid white;
        box-shadow: 0 0 0 1px #e5e7eb;
      }

      /* Sidebar active styles */
      .sidebar-item-active {
        background-color: #eff6ff;
        color: #2563eb;
        font-weight: 600;
        border-right: 4px solid #2563eb;
      }
      .sidebar-item {
        color: #4b5563;
        transition: background-color 0.15s;
        border-right: 4px solid transparent;
      }
      .sidebar-item:hover {
        background-color: #f9fafb;
        color: #1f2937;
      }

      /* Form input style */
      .form-input {
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 0.75rem;
        width: 100%;
        outline: none;
        transition: border-color 0.15s, box-shadow 0.15s;
      }
      .form-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
      }
    </style>
  </head>

  <body class="bg-gray-50 font-sans">
    <!-- ‚úÖ Header import -->
    <div th:replace="fragments/header :: header"></div>

    <div class="flex min-h-[calc(100vh-4rem)]">
      <!-- ‚úÖ Sidebar import -->
      <div th:replace="fragments/sidebar :: sidebar"></div>

      <!-- ‚úÖ Main content -->
        <main class="flex-1 p-8 overflow-y-auto bg-gray-50">
            <div class="grid grid-cols-12 gap-8">
                <!-- ‚úÖ Left Profile Card -->
                <div class="col-span-4 bg-white rounded-2xl shadow p-6 text-center">
                    <img
                            th:src="${user.avatarUrl != null ? user.avatarUrl : 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
                            alt="Avatar"
                            class="w-36 h-36 mx-auto rounded-full object-cover border-4 border-blue-500"
                    />
                    <h2 class="text-lg font-semibold mt-4" th:text="${user.name}">User Name</h2>
                    <p class="text-gray-500" th:text="${user.timezone != null ? user.timezone : 'Kh√¥ng c√≥ m√∫i gi·ªù'}">Asia/Ho_Chi_Minh</p>
                    <div class="mt-3 px-4">
                        <p class="text-sm text-gray-600 italic" th:text="${user.bio != null ? user.bio : 'Ch∆∞a c√≥ m√¥ t·∫£ c√° nh√¢n'}">
                            Ch∆∞a c√≥ m√¥ t·∫£ c√° nh√¢n
                        </p>
                    </div>

                    <div class="mt-6 space-y-2 text-sm text-gray-700">
                        <div><span class="font-semibold text-gray-600">Skill:</span>
                            <span th:text="${user.skills != null ? user.skills : 'Ch∆∞a c·∫≠p nh·∫≠t k·ªπ nƒÉng'}">Java</span>
                        </div>
                        <div><span class="font-semibold text-gray-600">Email:</span>
                            <span th:text="${user.email}">example@email.com</span>
                        </div>
                        <div><span class="font-semibold text-gray-600">Language:</span>
                            <span th:text="${user.preferredLanguage != null ? user.preferredLanguage : 'Ch∆∞a ch·ªçn ng√¥n ng·ªØ'}">English</span>
                        </div>
                        <div><span class="font-semibold text-gray-600">User Verified:</span>
                            <span th:text="${user.status}" th:classappend="${user.status == 'active'} ? 'text-green-600 font-medium' : 'text-red-500 font-medium'">
            active
          </span>
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ Right Profile Form (fills more width) -->
                <div class="col-span-8 bg-white rounded-2xl shadow p-8">
                    <h2 class="text-2xl font-semibold mb-6 border-b pb-3">üë§ Th√¥ng tin c√° nh√¢n</h2>

                    <form th:action="@{/user/update}" th:object="${user}" method="post" id="profileForm" th:data-user-id="${user.userId}" class="space-y-5">
                        <!-- Avatar Upload -->
                        <div class="flex items-center space-x-6">
                            <img th:src="${user.avatarUrl != null ? user.avatarUrl : '/images/default-avatar.png'}"
                                 alt="Avatar" class="w-24 h-24 rounded-full border object-cover" id="avatarPreview" />
                            <div>
                                <label class="block text-gray-700 font-medium mb-1">·∫¢nh ƒë·∫°i di·ªán</label>
                                <button type="button" id="changeAvatarBtn"
                                        class="px-4 py-2 bg-gray-200 rounded-lg text-sm hover:bg-gray-300"
                                        onclick="document.getElementById('avatarInput').click()" disabled>
                                    Thay ·∫£nh
                                </button>
                                <input type="file" name="avatarFile" id="avatarInput" accept="image/*" class="hidden" onchange="previewAvatar(event)" disabled />
                            </div>
                        </div>

                        <!-- Info Inputs -->
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-gray-700 font-medium mb-1">H·ªç v√† t√™n</label>
                                <input type="text" th:field="*{name}" class="form-input bg-gray-100" disabled />
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-1">K·ªπ nƒÉng</label>
                                <input type="text" th:field="*{skills}" class="form-input bg-gray-100" disabled />
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-700 font-medium mb-1">Gi·ªõi thi·ªáu b·∫£n th√¢n</label>
                            <textarea th:field="*{bio}" rows="3" class="form-input bg-gray-100" disabled></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-gray-700 font-medium mb-1">M√∫i gi·ªù</label>
                                <input type="text" th:field="*{timezone}" class="form-input bg-gray-100" disabled />
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-1">Ng√¥n ng·ªØ ∆∞u ti√™n</label>
                                <input type="text" th:field="*{preferredLanguage}" class="form-input bg-gray-100" disabled />
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="pt-4 flex flex-wrap gap-3">
                            <button type="button" id="editBtn" class="bg-blue-500 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-600 transition">
                                ‚úèÔ∏è Ch·ªânh s·ª≠a h·ªì s∆°
                            </button>
                            <button type="submit" id="saveBtn" class="bg-green-500 text-white px-5 py-2 rounded-lg shadow hover:bg-green-600 transition hidden">
                                üíæ L∆∞u thay ƒë·ªïi
                            </button>
                            <button type="button" id="cancelBtn" class="bg-gray-400 text-white px-5 py-2 rounded-lg shadow hover:bg-gray-500 transition hidden">
                                ‚ùå H·ªßy
                            </button>
                        </div>
                    </form>

                    <!-- üîí Change Password Section -->
                    <div class="mt-10 border-t pt-6 space-y-4">
                        <button type="button" id="togglePasswordBtn" class="text-blue-500 hover:underline font-medium">
                            üîí Thay ƒë·ªïi m·∫≠t kh·∫©u
                        </button>

                        <form th:action="@{/user/change-password}" method="post" id="passwordForm" class="space-y-4 hidden">
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-1">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                                    <input type="password" name="oldPassword" class="form-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i" />
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-1">M·∫≠t kh·∫©u m·ªõi</label>
                                    <input type="password" name="newPassword" class="form-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi" />
                                </div>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-1">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                                <input type="password" name="confirmPassword" class="form-input" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" />
                            </div>
                            <div class="pt-4">
                                <button type="submit" class="bg-pink-500 text-white px-6 py-2 rounded-lg shadow hover:bg-pink-600 transition">
                                    üîÑ C·∫≠p nh·∫≠t m·∫≠t kh·∫©u
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- üöÄ Upgrade Plan -->
                    <div class="pt-8 border-t mt-6 text-center">
                        <h3 class="text-gray-700 font-semibold mb-2">
                            <span th:text="${user.premium} ? '‚ôªÔ∏è Gia h·∫°n Premium' : 'üöÄ N√¢ng c·∫•p t√†i kho·∫£n c·ªßa b·∫°n'"></span>
                        </h3>
                        <p class="text-gray-500 text-sm mb-3">
          <span th:if="${user.premium}">
            H·∫°n s·ª≠ d·ª•ng ƒë·∫øn: <b th:text="${#temporals.format(user.premiumExpiry, 'dd/MM/yyyy')}">--/--/----</b>
          </span>
                            <span th:unless="${user.premium}">
            M·ªü kh√≥a nhi·ªÅu t√≠nh nƒÉng chuy√™n nghi·ªáp h∆°n, h·ªó tr·ª£ t·ªët h∆°n v√† quy·ªÅn truy c·∫≠p n√¢ng cao.
          </span>
                        </p>
                        <button id="upgradeBtn" class="bg-blue-500 text-white px-5 py-2 rounded-lg hover:bg-blue-600 transition">
                            <span th:text="${user.premium} ? '‚ôªÔ∏è Gia h·∫°n Premium' : 'üåü Mua g√≥i Pro'"></span>
                        </button>
                    </div>
                    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md text-center">
                            <h3 class="text-xl font-bold text-blue-600 mb-3">X√°c nh·∫≠n n√¢ng c·∫•p t√†i kho·∫£n</h3>
                            <p class="text-gray-600 mb-4">G√≥i <b>DevCollab Pro</b> mang l·∫°i:</p>
                            <ul class="text-sm text-gray-700 text-left mb-4 list-disc list-inside">
                                <li>üí° Truy c·∫≠p AI Assistant th√¥ng minh</li>
                                <li>üìà Ph√¢n t√≠ch d·ª± √°n n√¢ng cao</li>
                                <li>üìÇ L∆∞u tr·ªØ kh√¥ng gi·ªõi h·∫°n</li>
                                <li>üë• TƒÉng s·ªë l∆∞·ª£ng th√†nh vi√™n m·ªói d·ª± √°n l√™n 20+</li>
                            </ul>
                            <p class="text-gray-600 mb-4">Ph√≠: <b>2.000ƒë / th√°ng</b></p>
                            <div class="flex justify-center space-x-4">
                                <button id="confirmBuyBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">X√°c nh·∫≠n</button>
                                <button id="cancelBuyBtn" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500">H·ªßy</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
      const editBtn = document.getElementById("editBtn");
      const saveBtn = document.getElementById("saveBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const passwordForm = document.getElementById("passwordForm");
      const togglePasswordBtn = document.getElementById("togglePasswordBtn");
      const form = document.getElementById("profileForm");
      const formInputs = form.querySelectorAll(
        "input:not([type='hidden']), textarea"
      );

      // ‚úÖ Chuy·ªÉn sang ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
      editBtn.addEventListener("click", () => {
        formInputs.forEach((el) => (el.disabled = false));
        document.getElementById("avatarInput").disabled = false;
        document.getElementById("changeAvatarBtn").disabled = false;

        editBtn.classList.add("hidden");
        saveBtn.classList.remove("hidden");
        cancelBtn.classList.remove("hidden");
      });

      // ‚úÖ H·ªßy ch·ªânh s·ª≠a
      cancelBtn.addEventListener("click", () => {
        formInputs.forEach((el) => (el.disabled = true));
        document.getElementById("avatarInput").disabled = true;
        document.getElementById("changeAvatarBtn").disabled = true;

        editBtn.classList.remove("hidden");
        saveBtn.classList.add("hidden");
        cancelBtn.classList.add("hidden");
      });

      // ‚úÖ Toggle ƒë·ªïi m·∫≠t kh·∫©u
      togglePasswordBtn.addEventListener("click", () => {
        passwordForm.classList.toggle("hidden");
      });

      // ‚úÖ Ch·ªâ xem tr∆∞·ªõc ·∫£nh, KH√îNG upload ngay
      function previewAvatar(event) {
        const reader = new FileReader();
        reader.onload = function () {
          document.getElementById("avatarPreview").src = reader.result;
        };
        reader.readAsDataURL(event.target.files[0]);
      }
      window.previewAvatar = previewAvatar;

      // ‚úÖ G·ª≠i d·ªØ li·ªáu c·∫≠p nh·∫≠t qua API
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const userId = form.getAttribute("data-user-id");
        const formData = new FormData(form);

        // L·∫•y file ·∫£nh (n·∫øu c√≥)
        const avatarFile = document.getElementById("avatarInput").files[0];

        // B∆∞·ªõc 1Ô∏è‚É£: Upload ·∫£nh l√™n Cloudinary n·∫øu c√≥ ch·ªçn m·ªõi
        let avatarUrl = null;
        if (avatarFile) {
          const uploadData = new FormData();
          uploadData.append("file", avatarFile);

          try {
            const uploadResponse = await fetch(`/api/users/${userId}/avatar`, {
              method: "POST",
              body: uploadData,
            });

            if (uploadResponse.ok) {
              const uploadResult = await uploadResponse.json();
              avatarUrl = uploadResult.avatarUrl;
            } else {
              const errText = await uploadResponse.text();
              alert("‚ùå Upload ·∫£nh th·∫•t b·∫°i: " + errText);
              return;
            }
          } catch (err) {
            alert("‚ö†Ô∏è L·ªói khi upload ·∫£nh: " + err);
            return;
          }
        }

        // B∆∞·ªõc 2Ô∏è‚É£: C·∫≠p nh·∫≠t th√¥ng tin h·ªì s∆° (v√† ·∫£nh n·∫øu c√≥)
        const data = {};
        formData.forEach((value, key) => {
          if (key !== "avatarFile") data[key] = value;
        });
        if (avatarUrl) data.avatarUrl = avatarUrl;

        try {
          const response = await fetch(`/api/users/${userId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          if (response.ok) {
            alert("‚úÖ C·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng!");
            formInputs.forEach((el) => (el.disabled = true));
            document.getElementById("avatarInput").disabled = true;
            document.getElementById("changeAvatarBtn").disabled = true;
            saveBtn.classList.add("hidden");
            cancelBtn.classList.add("hidden");
            editBtn.classList.remove("hidden");
          } else {
            const errText = await response.text();
            alert("‚ùå L·ªói khi c·∫≠p nh·∫≠t h·ªì s∆°: " + errText);
          }
        } catch (err) {
          alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß: " + err);
        }
      });

      // ‚úÖ X·ª≠ l√Ω g·ª≠i y√™u c·∫ßu ƒë·ªïi m·∫≠t kh·∫©u
      const passwordFormEl = document.getElementById("passwordForm");

      passwordFormEl.addEventListener("submit", async (e) => {
        e.preventDefault();

        const userId = form.getAttribute("data-user-id");
        const oldPassword = passwordFormEl.querySelector(
          "input[name='oldPassword']"
        ).value;
        const newPassword = passwordFormEl.querySelector(
          "input[name='newPassword']"
        ).value;
        const confirmPassword = passwordFormEl.querySelector(
          "input[name='confirmPassword']"
        ).value;

        // Ki·ªÉm tra c∆° b·∫£n ·ªü frontend
        if (!oldPassword || !newPassword || !confirmPassword) {
          alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng.");
          return;
        }
        if (newPassword !== confirmPassword) {
          alert("‚ö†Ô∏è M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n kh√¥ng kh·ªõp!");
          return;
        }

        // ‚úÖ Ki·ªÉm tra ƒë·ªô m·∫°nh m·∫≠t kh·∫©u
        const passwordRegex =
          /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).{8,}$/;
        if (!passwordRegex.test(newPassword)) {
          alert(
            "‚ö†Ô∏è M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±, g·ªìm ch·ªØ hoa, s·ªë v√† k√Ω t·ª± ƒë·∫∑c bi·ªát."
          );
          return;
        }

        try {
          const response = await fetch(`/api/users/${userId}/change-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              oldPassword,
              newPassword,
              confirmPassword,
            }),
          });

          if (response.ok) {
            const result = await response.json();
            alert("‚úÖ " + (result.message || "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!"));
            passwordFormEl.reset();
            passwordFormEl.classList.add("hidden");
          } else {
            const errorData = await response.json().catch(() => ({}));
            const msg =
              errorData.message ||
              errorData.error ||
              "Kh√¥ng th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u. Vui l√≤ng th·ª≠ l·∫°i.";
            alert("‚ùå " + msg);
          }
        } catch (err) {
          alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß: " + err);
        }
      });
      const upgradeBtn = document.getElementById("upgradeBtn");
      const confirmModal = document.getElementById("confirmModal");
      const confirmBuyBtn = document.getElementById("confirmBuyBtn");
      const cancelBuyBtn = document.getElementById("cancelBuyBtn");
      upgradeBtn.addEventListener("click", () => {
          confirmModal.classList.remove("hidden");
      });

      // Khi b·∫•m "H·ªßy"
      cancelBuyBtn.addEventListener("click", () => {
          confirmModal.classList.add("hidden");
      });

      // Khi b·∫•m "X√°c nh·∫≠n"
      confirmBuyBtn.addEventListener("click", async () => {
          confirmBuyBtn.disabled = true;
          confirmBuyBtn.textContent = "ƒêang x·ª≠ l√Ω...";

          try {
              const res = await fetch("/api/payment/create", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ total: 2000, plan: "Pro" })
              });

              const data = await res.json();
              if (data.success) {
                  window.location.href = data.redirectUrl;
              } else {
                  alert("‚ùå Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng!");
              }
          } catch (err) {
              alert("‚ö†Ô∏è L·ªói k·∫øt n·ªëi m√°y ch·ªß: " + err);
          } finally {
              confirmBuyBtn.disabled = false;
              confirmBuyBtn.textContent = "X√°c nh·∫≠n";
              confirmModal.classList.add("hidden");
          }
      });
      document.getElementById("buyProBtn").addEventListener("click", async () => {
          try {
              const response = await fetch("/api/payment/create", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ total: 2000, plan: "Pro" })
              });

              const data = await response.json();
              if (data.success) {
                  window.location.href = data.redirectUrl;
              } else {
                  alert("‚ùå Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng!");
              }
          } catch (err) {
              alert("‚ö†Ô∏è L·ªói khi t·∫°o ƒë∆°n h√†ng: " + err);
          }
      });
    </script>
  </body>
</html>
