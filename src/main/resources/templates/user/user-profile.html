<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - DevCollab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Sidebar full height */
      .sidebar {
        height: calc(100vh - 4rem);
        top: 4rem;
        transition: all 0.3s ease;
      }

      /* Card project style */
      .project-card-item {
        border: 1px solid #e5e7eb;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
      }
      .project-card-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      /* Avatar style */
      .avatar {
        width: 28px;
        height: 28px;
        object-fit: cover;
        border: 2px solid white;
        box-shadow: 0 0 0 1px #e5e7eb;
      }

      /* Sidebar active styles */
      .sidebar-item-active {
        background-color: #eff6ff;
        color: #2563eb;
        font-weight: 600;
        border-right: 4px solid #2563eb;
      }
      .sidebar-item {
        color: #4b5563;
        transition: background-color 0.15s;
        border-right: 4px solid transparent;
      }
      .sidebar-item:hover {
        background-color: #f9fafb;
        color: #1f2937;
      }

      /* Form input style */
      .form-input {
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 0.75rem;
        width: 100%;
        outline: none;
        transition: border-color 0.15s, box-shadow 0.15s;
      }
      .form-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
      }
    </style>
  </head>

  <body class="bg-gray-50 font-sans">
    <!-- ‚úÖ Header import -->
    <div th:replace="fragments/header :: header"></div>

    <div class="flex min-h-[calc(100vh-4rem)]">
      <!-- ‚úÖ Sidebar import -->
      <div th:replace="fragments/sidebar :: sidebar"></div>

      <!-- ‚úÖ Main content -->
      <main class="flex-1 p-8 overflow-y-auto bg-gray-50">
        <div class="grid grid-cols-12 gap-6">
          <!-- ‚úÖ Left Profile Card -->

          <div class="col-span-3 bg-white rounded-2xl shadow p-6 text-center">
            <!-- Avatar -->
            <img
              th:src="${user.avatarUrl != null ? user.avatarUrl : 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
              alt="Avatar"
              class="w-32 h-32 mx-auto rounded-full object-cover border-4 border-pink-500"
            />

            <!-- Name -->
            <h2 class="text-lg font-semibold mt-4" th:text="${user.name}">
              User Name
            </h2>

            <!-- Timezone -->
            <p
              class="text-gray-500"
              th:text="${user.timezone != null ? user.timezone : 'Kh√¥ng c√≥ m√∫i gi·ªù'}"
            >
              Asia/Ho_Chi_Minh
            </p>
            <!-- Bio -->
            <div class="mt-4 px-4">
              <p
                class="text-sm text-gray-600 italic"
                th:text="${user.bio != null ? user.bio : 'Ch∆∞a c√≥ m√¥ t·∫£ c√° nh√¢n'}"
              >
                Ch∆∞a c√≥ m√¥ t·∫£ c√° nh√¢n
              </p>
            </div>
            <!-- ‚úÖ C√°c th√¥ng tin chi ti·∫øt -->
            <div class="mt-6 space-y-2 text-sm text-gray-700">
              <!-- Skills -->
              <div class="flex items-center justify-center space-x-2">
                <span class="material-icons text-gray-400 text-base"
                  >Skill:</span
                >
                <span
                  th:text="${user.skills != null ? user.skills : 'Ch∆∞a c·∫≠p nh·∫≠t k·ªπ nƒÉng'}"
                  >Java, Spring Boot</span
                >
              </div>

              <!-- Email -->
              <div class="flex items-center justify-center space-x-2">
                <span class="material-icons text-gray-400 text-base"
                  >Email</span
                >
                <span th:text="${user.email}">example@email.com</span>
              </div>

              <!-- Language -->
              <div class="flex items-center justify-center space-x-2">
                <span class="material-icons text-gray-400 text-base"
                  >Language</span
                >
                <span
                  th:text="${user.preferredLanguage != null ? user.preferredLanguage : 'Ch∆∞a ch·ªçn ng√¥n ng·ªØ'}"
                  >English</span
                >
              </div>

              <!-- Status -->
              <div class="flex items-center justify-center space-x-2">
                <span class="material-icons text-gray-400 text-base"
                  >User Verified:</span
                >
                <span
                  th:text="${user.status}"
                  th:classappend="${user.status == 'active'} ? 'text-green-600 font-medium' : 'text-red-500 font-medium'"
                >
                  active
                </span>
              </div>

              <!-- Last Seen -->
              <!-- <div class="flex items-center justify-center space-x-2">
                <span class="material-icons text-gray-400 text-base"
                  >Last Seen</span
                >
                <span
                  th:text="${#temporals.format(user.lastSeen, 'dd/MM/yyyy HH:mm')}"
                  >22/10/2025 10:00</span
                >
              </div> -->
            </div>
          </div>

          <!-- ‚úÖ Middle Section -->
          <div class="col-span-6 bg-white rounded-2xl shadow p-6">
            <h2 class="text-xl font-semibold mb-4">üë§ Th√¥ng tin c√° nh√¢n</h2>

            <!-- ‚úÖ Profile Info Form -->
            <form
              th:action="@{/user/update}"
              th:object="${user}"
              method="post"
              id="profileForm"
              th:data-user-id="${user.userId}"
            >
              <!-- Avatar Upload -->
              <div>
                <label class="block text-gray-700 font-medium mb-1"
                  >·∫¢nh ƒë·∫°i di·ªán</label
                >
                <div class="flex items-center space-x-4">
                  <img
                    th:src="${user.avatarUrl != null ? user.avatarUrl : '/images/default-avatar.png'}"
                    alt="Avatar"
                    class="w-20 h-20 rounded-full border object-cover"
                    id="avatarPreview"
                  />
                  <input
                    type="file"
                    name="avatarFile"
                    id="avatarInput"
                    accept="image/*"
                    class="hidden"
                    onchange="previewAvatar(event)"
                    disabled
                  />
                  <button
                    type="button"
                    id="changeAvatarBtn"
                    class="px-3 py-2 bg-gray-200 rounded-lg text-sm"
                    onclick="document.getElementById('avatarInput').click()"
                    disabled
                  >
                    Thay ·∫£nh
                  </button>
                </div>
              </div>

              <!-- Name -->
              <div>
                <label class="block text-gray-700 font-medium mb-1"
                  >H·ªç v√† t√™n</label
                >
                <input
                  type="text"
                  th:field="*{name}"
                  class="form-input bg-gray-100"
                  disabled
                />
              </div>

              <!-- Bio -->
              <div>
                <label class="block text-gray-700 font-medium mb-1"
                  >Gi·ªõi thi·ªáu b·∫£n th√¢n</label
                >
                <textarea
                  th:field="*{bio}"
                  rows="3"
                  class="form-input bg-gray-100"
                  disabled
                ></textarea>
              </div>

              <!-- Skills -->
              <div>
                <label class="block text-gray-700 font-medium mb-1"
                  >K·ªπ nƒÉng</label
                >
                <input
                  type="text"
                  th:field="*{skills}"
                  class="form-input bg-gray-100"
                  disabled
                />
              </div>

              <!-- Timezone & Language -->
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-gray-700 font-medium mb-1"
                    >M√∫i gi·ªù</label
                  >
                  <input
                    type="text"
                    th:field="*{timezone}"
                    class="form-input bg-gray-100"
                    disabled
                  />
                </div>
                <div>
                  <label class="block text-gray-700 font-medium mb-1"
                    >Ng√¥n ng·ªØ ∆∞u ti√™n</label
                  >
                  <input
                    type="text"
                    th:field="*{preferredLanguage}"
                    class="form-input bg-gray-100"
                    disabled
                  />
                </div>
              </div>

              <!-- ‚úÖ Buttons -->
              <div class="pt-4 flex space-x-3">
                <button
                  type="button"
                  id="editBtn"
                  class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition"
                >
                  ‚úèÔ∏è Ch·ªânh s·ª≠a h·ªì s∆°
                </button>

                <button
                  type="submit"
                  id="saveBtn"
                  class="bg-green-500 text-white px-4 py-2 rounded-lg shadow hover:bg-green-600 transition hidden"
                >
                  üíæ L∆∞u thay ƒë·ªïi
                </button>

                <button
                  type="button"
                  id="cancelBtn"
                  class="bg-gray-400 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-500 transition hidden"
                >
                  ‚ùå H·ªßy
                </button>
              </div>
            </form>

            <!-- üîí Change Password Section -->
            <div class="mt-8 border-t pt-6 space-y-4">
              <!-- Toggle button -->
              <button
                type="button"
                id="togglePasswordBtn"
                class="text-blue-500 hover:underline font-medium"
              >
                üîí Thay ƒë·ªïi m·∫≠t kh·∫©u
              </button>

              <!-- Password form (hidden by default) -->
              <form
                th:action="@{/user/change-password}"
                method="post"
                id="passwordForm"
                class="space-y-4 hidden"
              >
                <div>
                  <label class="block text-gray-700 font-medium mb-1"
                    >M·∫≠t kh·∫©u hi·ªán t·∫°i</label
                  >
                  <input
                    type="password"
                    name="oldPassword"
                    class="form-input"
                    placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i"
                  />
                </div>

                <div>
                  <label class="block text-gray-700 font-medium mb-1"
                    >M·∫≠t kh·∫©u m·ªõi</label
                  >
                  <input
                    type="password"
                    name="newPassword"
                    class="form-input"
                    placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi"
                  />
                </div>

                <div>
                  <label class="block text-gray-700 font-medium mb-1"
                    >X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label
                  >
                  <input
                    type="password"
                    name="confirmPassword"
                    class="form-input"
                    placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi"
                  />
                </div>

                <div class="pt-4">
                  <button
                    type="submit"
                    class="bg-pink-500 text-white px-6 py-2 rounded-lg shadow hover:bg-pink-600 transition"
                  >
                    üîÑ C·∫≠p nh·∫≠t m·∫≠t kh·∫©u
                  </button>
                </div>
              </form>

              <!-- üöÄ Upgrade plan section -->
              <div class="pt-6 border-t mt-4">
                <h3 class="text-gray-700 font-semibold mb-2">
                  üöÄ N√¢ng c·∫•p t√†i kho·∫£n c·ªßa b·∫°n
                </h3>
                <p class="text-gray-500 text-sm mb-3">
                  M·ªü kh√≥a nhi·ªÅu t√≠nh nƒÉng chuy√™n nghi·ªáp h∆°n, h·ªó tr·ª£ t·ªët h∆°n v√†
                  quy·ªÅn truy c·∫≠p n√¢ng cao.
                </p>
                <a
                  href="/pricing"
                  class="inline-block bg-yellow-500 text-white px-5 py-2 rounded-lg shadow hover:bg-yellow-600 transition"
                >
                  üåü Mua g√≥i n√¢ng c·∫•p
                </a>
              </div>
            </div>
          </div>

          <!-- ‚úÖ Right Section -->
          <div class="col-span-3 space-y-6">
            <!-- Projects -->
            <div class="bg-white rounded-2xl shadow p-6">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-gray-700">Projects</h3>
                <a
                  href="/user/view/view-all-projects"
                  class="text-blue-500 text-sm font-medium hover:underline"
                  >View all</a
                >
              </div>

              <div class="grid grid-cols-3 gap-3">
                <img
                  src="https://i.imgur.com/7Y7Q1cJ.jpg"
                  class="rounded-lg w-full h-20 object-cover"
                />
                <img
                  src="https://i.imgur.com/rQO3vDk.jpg"
                  class="rounded-lg w-full h-20 object-cover"
                />
                <img
                  src="https://i.imgur.com/EiAG7qz.jpg"
                  class="rounded-lg w-full h-20 object-cover"
                />
                <img
                  src="https://i.imgur.com/k8UqS93.jpg"
                  class="rounded-lg w-full h-20 object-cover"
                />
                <img
                  src="https://i.imgur.com/lsHOPkz.jpg"
                  class="rounded-lg w-full h-20 object-cover"
                />
                <img
                  src="https://i.imgur.com/jPyKbrv.jpg"
                  class="rounded-lg w-full h-20 object-cover"
                />
              </div>
            </div>

            <!-- Work Done -->
            <div class="bg-white rounded-2xl shadow p-6">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-gray-700">Total work done</h3>
                <span
                  class="text-sm text-blue-600 bg-blue-50 px-2 py-1 rounded-lg"
                  >This Week</span
                >
              </div>
              <div class="flex justify-center items-center">
                <div
                  class="relative w-32 h-32 rounded-full border-8 border-gray-200 flex items-center justify-center"
                >
                  <div
                    class="absolute w-32 h-32 rounded-full border-8 border-blue-500 border-t-transparent animate-spin-slow"
                    style="animation: spin 10s linear infinite"
                  ></div>
                  <p class="text-lg font-semibold text-gray-800">5w:2d</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      const editBtn = document.getElementById("editBtn");
      const saveBtn = document.getElementById("saveBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const passwordForm = document.getElementById("passwordForm");
      const togglePasswordBtn = document.getElementById("togglePasswordBtn");
      const form = document.getElementById("profileForm");
      const formInputs = form.querySelectorAll(
        "input:not([type='hidden']), textarea"
      );

      // ‚úÖ Chuy·ªÉn sang ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
      editBtn.addEventListener("click", () => {
        formInputs.forEach((el) => (el.disabled = false));
        document.getElementById("avatarInput").disabled = false;
        document.getElementById("changeAvatarBtn").disabled = false;

        editBtn.classList.add("hidden");
        saveBtn.classList.remove("hidden");
        cancelBtn.classList.remove("hidden");
      });

      // ‚úÖ H·ªßy ch·ªânh s·ª≠a
      cancelBtn.addEventListener("click", () => {
        formInputs.forEach((el) => (el.disabled = true));
        document.getElementById("avatarInput").disabled = true;
        document.getElementById("changeAvatarBtn").disabled = true;

        editBtn.classList.remove("hidden");
        saveBtn.classList.add("hidden");
        cancelBtn.classList.add("hidden");
      });

      // ‚úÖ Toggle ƒë·ªïi m·∫≠t kh·∫©u
      togglePasswordBtn.addEventListener("click", () => {
        passwordForm.classList.toggle("hidden");
      });

      // ‚úÖ Ch·ªâ xem tr∆∞·ªõc ·∫£nh, KH√îNG upload ngay
      function previewAvatar(event) {
        const reader = new FileReader();
        reader.onload = function () {
          document.getElementById("avatarPreview").src = reader.result;
        };
        reader.readAsDataURL(event.target.files[0]);
      }
      window.previewAvatar = previewAvatar;

      // ‚úÖ G·ª≠i d·ªØ li·ªáu c·∫≠p nh·∫≠t qua API
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const userId = form.getAttribute("data-user-id");
        const formData = new FormData(form);

        // L·∫•y file ·∫£nh (n·∫øu c√≥)
        const avatarFile = document.getElementById("avatarInput").files[0];

        // B∆∞·ªõc 1Ô∏è‚É£: Upload ·∫£nh l√™n Cloudinary n·∫øu c√≥ ch·ªçn m·ªõi
        let avatarUrl = null;
        if (avatarFile) {
          const uploadData = new FormData();
          uploadData.append("file", avatarFile);

          try {
            const uploadResponse = await fetch(`/api/users/${userId}/avatar`, {
              method: "POST",
              body: uploadData,
            });

            if (uploadResponse.ok) {
              const uploadResult = await uploadResponse.json();
              avatarUrl = uploadResult.avatarUrl;
            } else {
              const errText = await uploadResponse.text();
              alert("‚ùå Upload ·∫£nh th·∫•t b·∫°i: " + errText);
              return;
            }
          } catch (err) {
            alert("‚ö†Ô∏è L·ªói khi upload ·∫£nh: " + err);
            return;
          }
        }

        // B∆∞·ªõc 2Ô∏è‚É£: C·∫≠p nh·∫≠t th√¥ng tin h·ªì s∆° (v√† ·∫£nh n·∫øu c√≥)
        const data = {};
        formData.forEach((value, key) => {
          if (key !== "avatarFile") data[key] = value;
        });
        if (avatarUrl) data.avatarUrl = avatarUrl;

        try {
          const response = await fetch(`/api/users/${userId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          if (response.ok) {
            alert("‚úÖ C·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng!");
            formInputs.forEach((el) => (el.disabled = true));
            document.getElementById("avatarInput").disabled = true;
            document.getElementById("changeAvatarBtn").disabled = true;
            saveBtn.classList.add("hidden");
            cancelBtn.classList.add("hidden");
            editBtn.classList.remove("hidden");
          } else {
            const errText = await response.text();
            alert("‚ùå L·ªói khi c·∫≠p nh·∫≠t h·ªì s∆°: " + errText);
          }
        } catch (err) {
          alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß: " + err);
        }
      });

      // ‚úÖ X·ª≠ l√Ω g·ª≠i y√™u c·∫ßu ƒë·ªïi m·∫≠t kh·∫©u
      const passwordFormEl = document.getElementById("passwordForm");

      passwordFormEl.addEventListener("submit", async (e) => {
        e.preventDefault();

        const userId = form.getAttribute("data-user-id");
        const oldPassword = passwordFormEl.querySelector(
          "input[name='oldPassword']"
        ).value;
        const newPassword = passwordFormEl.querySelector(
          "input[name='newPassword']"
        ).value;
        const confirmPassword = passwordFormEl.querySelector(
          "input[name='confirmPassword']"
        ).value;

        // Ki·ªÉm tra c∆° b·∫£n ·ªü frontend
        if (!oldPassword || !newPassword || !confirmPassword) {
          alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng.");
          return;
        }
        if (newPassword !== confirmPassword) {
          alert("‚ö†Ô∏è M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n kh√¥ng kh·ªõp!");
          return;
        }

        // ‚úÖ Ki·ªÉm tra ƒë·ªô m·∫°nh m·∫≠t kh·∫©u
        const passwordRegex =
          /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).{8,}$/;
        if (!passwordRegex.test(newPassword)) {
          alert(
            "‚ö†Ô∏è M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±, g·ªìm ch·ªØ hoa, s·ªë v√† k√Ω t·ª± ƒë·∫∑c bi·ªát."
          );
          return;
        }

        try {
          const response = await fetch(`/api/users/${userId}/change-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              oldPassword,
              newPassword,
              confirmPassword,
            }),
          });

          if (response.ok) {
            const result = await response.json();
            alert("‚úÖ " + (result.message || "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!"));
            passwordFormEl.reset();
            passwordFormEl.classList.add("hidden");
          } else {
            const errorData = await response.json().catch(() => ({}));
            const msg =
              errorData.message ||
              errorData.error ||
              "Kh√¥ng th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u. Vui l√≤ng th·ª≠ l·∫°i.";
            alert("‚ùå " + msg);
          }
        } catch (err) {
          alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß: " + err);
        }
      });
    </script>
  </body>
</html>
