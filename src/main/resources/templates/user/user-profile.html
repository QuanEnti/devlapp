<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - DevCollab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .sidebar {
        height: calc(100vh - 4rem);
        top: 4rem;
        transition: all 0.3s ease;
      }

      .project-card-item {
        border: 1px solid #e5e7eb;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
      }
      .project-card-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      .avatar {
        width: 28px;
        height: 28px;
        object-fit: cover;
        border: 2px solid white;
        box-shadow: 0 0 0 1px #e5e7eb;
      }

      .sidebar-item-active {
        background-color: #eff6ff;
        color: #2563eb;
        font-weight: 600;
        border-right: 4px solid #2563eb;
      }
      .sidebar-item {
        color: #4b5563;
        transition: background-color 0.15s;
        border-right: 4px solid transparent;
      }
      .sidebar-item:hover {
        background-color: #f9fafb;
        color: #1f2937;
      }

      .form-input {
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 0.75rem;
        width: 100%;
        outline: none;
        transition: border-color 0.15s, box-shadow 0.15s;
      }
      .form-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
      }
    </style>
  </head>

  <body class="bg-gray-50 font-sans">
    <div th:replace="fragments/header :: header"></div>

    <div class="flex min-h-[calc(100vh-4rem)]">
      <div th:replace="fragments/sidebar :: sidebar"></div>

      <main class="flex-1 p-8 overflow-y-auto bg-gray-50">
        <div class="grid grid-cols-12 gap-8">
          <!-- Left Profile Card -->
          <div class="col-span-4 bg-white rounded-2xl shadow p-6 text-center">
            <img
              th:src="${user.avatarUrl != null ? user.avatarUrl : 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
              alt="Avatar"
              class="w-36 h-36 mx-auto rounded-full object-cover border-4 border-blue-500"
            />
            <h2 class="text-lg font-semibold mt-4" th:text="${user.name}">
              User Name
            </h2>
            <p
              class="text-gray-500"
              th:text="${user.timezone != null ? user.timezone : 'No timezone set'}"
            >
              Asia/Ho_Chi_Minh
            </p>
            <div class="mt-3 px-4">
              <p
                class="text-sm text-gray-600 italic"
                th:text="${user.bio != null ? user.bio : 'No bio available'}"
              >
                No bio available
              </p>
            </div>

            <div class="mt-6 space-y-2 text-sm text-gray-700">
              <div>
                <span class="font-semibold text-gray-600">Skill:</span>
                <span
                  th:text="${user.skills != null ? user.skills : 'No skills set'}"
                  >Java</span
                >
              </div>
              <div>
                <span class="font-semibold text-gray-600">Email:</span>
                <span th:text="${user.email}">example@email.com</span>
              </div>
              <div>
                <span class="font-semibold text-gray-600">Language:</span>
                <span
                  th:text="${user.preferredLanguage != null ? user.preferredLanguage : 'No language set'}"
                  >English</span
                >
              </div>
              <div>
                <span class="font-semibold text-gray-600">User Verified:</span>
                <span
                  th:text="${user.status}"
                  th:classappend="${user.status == 'active'} ? 'text-green-600 font-medium' : 'text-red-500 font-medium'"
                >
                  active
                </span>
              </div>
            </div>
          </div>

          <!-- Right Profile Form -->
          <div class="col-span-8 bg-white rounded-2xl shadow p-8">
            <h2 class="text-2xl font-semibold mb-6 border-b pb-3">
              Personal Information
            </h2>

            <form
              th:action="@{/user/update}"
              th:object="${user}"
              method="post"
              id="profileForm"
              th:data-user-id="${user.userId}"
              class="space-y-5"
            >
              <!-- Avatar Upload -->
              <div class="flex items-center space-x-6">
                <img
                  th:src="${user.avatarUrl != null ? user.avatarUrl : '/images/default-avatar.png'}"
                  alt="Avatar"
                  class="w-24 h-24 rounded-full border object-cover"
                  id="avatarPreview"
                />
                <div>
                  <label class="block text-gray-700 font-medium mb-1"
                    >Profile Picture</label
                  >
                  <button
                    type="button"
                    id="changeAvatarBtn"
                    class="px-4 py-2 bg-gray-200 rounded-lg text-sm hover:bg-gray-300"
                    onclick="document.getElementById('avatarInput').click()"
                    disabled
                  >
                    Change Picture
                  </button>
                  <input
                    type="file"
                    name="avatarFile"
                    id="avatarInput"
                    accept="image/*"
                    class="hidden"
                    onchange="previewAvatar(event)"
                    disabled
                  />
                </div>
              </div>

              <!-- Info Inputs -->
              <div class="grid grid-cols-2 gap-6">
                <div>
                  <label class="block text-gray-700 font-medium mb-1"
                    >Full Name</label
                  >
                  <input
                    type="text"
                    th:field="*{name}"
                    class="form-input bg-gray-100"
                    disabled
                  />
                </div>
                <div>
                  <label class="block text-gray-700 font-medium mb-1"
                    >Skills</label
                  >
                  <input
                    type="text"
                    th:field="*{skills}"
                    class="form-input bg-gray-100"
                    disabled
                  />
                </div>
              </div>

              <div>
                <label class="block text-gray-700 font-medium mb-1">Bio</label>
                <textarea
                  th:field="*{bio}"
                  rows="3"
                  class="form-input bg-gray-100"
                  disabled
                ></textarea>
              </div>

              <div class="grid grid-cols-2 gap-6">
                <div>
                  <label class="block text-gray-700 font-medium mb-1"
                    >Timezone</label
                  >
                  <select
                    th:field="*{timezone}"
                    id="timezoneSelect"
                    class="form-input bg-gray-100"
                    disabled
                  >
                    <option value="">-- Select timezone --</option>
                    <option value="Asia/Ho_Chi_Minh">
                      Asia/Ho_Chi_Minh (GMT+7)
                    </option>
                    <option value="Asia/Singapore">
                      Asia/Singapore (GMT+8)
                    </option>
                    <option value="Asia/Tokyo">Asia/Tokyo (GMT+9)</option>
                    <option value="Europe/London">Europe/London (GMT+0)</option>
                    <option value="Europe/Paris">Europe/Paris (GMT+1)</option>
                    <option value="America/New_York">
                      America/New_York (GMT-5)
                    </option>
                    <option value="America/Los_Angeles">
                      America/Los_Angeles (GMT-8)
                    </option>
                  </select>
                </div>
                <div>
                  <label class="block text-gray-700 font-medium mb-1"
                    >Preferred Language</label
                  >
                  <select
                    th:field="*{preferredLanguage}"
                    id="languageSelect"
                    class="form-input bg-gray-100"
                    disabled
                  >
                    <option value="">-- Select language --</option>
                    <option value="vi">Vietnamese</option>
                    <option value="en">English</option>
                    <option value="ja">Japanese</option>
                    <option value="ko">Korean</option>
                    <option value="fr">French</option>
                  </select>
                </div>
              </div>

              <!-- Buttons -->
              <div class="pt-4 flex flex-wrap gap-3">
                <button
                  type="button"
                  id="editBtn"
                  class="bg-blue-500 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-600 transition"
                >
                  Edit Profile
                </button>
                <button
                  type="submit"
                  id="saveBtn"
                  class="bg-green-500 text-white px-5 py-2 rounded-lg shadow hover:bg-green-600 transition hidden"
                >
                  Save Changes
                </button>
                <button
                  type="button"
                  id="cancelBtn"
                  class="bg-gray-400 text-white px-5 py-2 rounded-lg shadow hover:bg-gray-500 transition hidden"
                >
                  Cancel
                </button>
              </div>
            </form>

            <!-- Change Password Section -->
            <div class="mt-10 border-t pt-6 space-y-4">
              <button
                type="button"
                id="togglePasswordBtn"
                class="text-blue-500 hover:underline font-medium"
              >
                Change Password
              </button>

              <form
                th:action="@{/user/change-password}"
                method="post"
                id="passwordForm"
                class="space-y-4 hidden"
              >
                <div class="grid grid-cols-2 gap-6">
                  <div>
                    <label class="block text-gray-700 font-medium mb-1"
                      >Current Password</label
                    >
                    <input
                      type="password"
                      name="oldPassword"
                      class="form-input"
                      placeholder="Enter current password"
                    />
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-1"
                      >New Password</label
                    >
                    <input
                      type="password"
                      name="newPassword"
                      class="form-input"
                      placeholder="Enter new password"
                    />
                  </div>
                </div>
                <div>
                  <label class="block text-gray-700 font-medium mb-1"
                    >Confirm New Password</label
                  >
                  <input
                    type="password"
                    name="confirmPassword"
                    class="form-input"
                    placeholder="Re-enter new password"
                  />
                </div>
                <div class="pt-4">
                  <button
                    type="submit"
                    class="bg-pink-500 text-white px-6 py-2 rounded-lg shadow hover:bg-pink-600 transition"
                  >
                    Update Password
                  </button>
                </div>
              </form>
            </div>

            <!-- Upgrade Plan -->
            <div class="pt-8 border-t mt-6 text-center">
              <h3 class="text-gray-700 font-semibold mb-2">
                <span
                  th:text="${user.premium} ? 'Renew Premium' : 'Upgrade Your Account'"
                ></span>
              </h3>
              <p class="text-gray-500 text-sm mb-3">
                <span th:if="${user.premium}">
                  Expires on:
                  <b
                    th:text="${#temporals.format(user.premiumExpiry, 'dd/MM/yyyy')}"
                    >--/--/----</b
                  >
                </span>
                <span th:unless="${user.premium}">
                  Unlock more professional features, better support and advanced
                  access.
                </span>
              </p>
              <button
                id="upgradeBtn"
                class="bg-blue-500 text-white px-5 py-2 rounded-lg hover:bg-blue-600 transition"
              >
                <span
                  th:text="${user.premium} ? 'Renew Premium' : 'Buy Pro Plan'"
                ></span>
              </button>
            </div>
            <div
              id="confirmModal"
              class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
            >
              <div
                class="bg-white p-8 rounded-2xl shadow-xl max-w-md text-center"
              >
                <h3 class="text-xl font-bold text-blue-600 mb-3">
                  Confirm Account Upgrade
                </h3>
                <p class="text-gray-600 mb-4">
                  The <b>DevCollab Pro</b> plan includes:
                </p>
                <ul
                  class="text-sm text-gray-700 text-left mb-4 list-disc list-inside"
                >
                  <li>Access to smart AI Assistant</li>
                  <li>Upload limit from 10 mb to 100 mb</li>
                </ul>
                <p class="text-gray-600 mb-4">Price: <b>$1 / month</b></p>

                <div class="flex justify-center space-x-4">
                  <button
                    id="confirmBuyBtn"
                    class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"
                  >
                    Confirm
                  </button>
                  <button
                    id="cancelBuyBtn"
                    class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <div
      id="toast"
      class="hidden fixed top-6 right-6 z-50 px-5 py-3 rounded-xl shadow-lg text-white font-medium transition-all duration-300"
    ></div>

    <script th:src="@{/js/toast.js}"></script>
    <script>
      const editBtn = document.getElementById("editBtn");
      const saveBtn = document.getElementById("saveBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const passwordForm = document.getElementById("passwordForm");
      const togglePasswordBtn = document.getElementById("togglePasswordBtn");
      const form = document.getElementById("profileForm");
      const formInputs = form.querySelectorAll(
        "input:not([type='hidden']), textarea, select"
      );

      editBtn.addEventListener("click", () => {
        formInputs.forEach((el) => (el.disabled = false));
        document.getElementById("avatarInput").disabled = false;
        document.getElementById("changeAvatarBtn").disabled = false;

        editBtn.classList.add("hidden");
        saveBtn.classList.remove("hidden");
        cancelBtn.classList.remove("hidden");
      });

      cancelBtn.addEventListener("click", () => {
        formInputs.forEach((el) => (el.disabled = true));
        document.getElementById("avatarInput").disabled = true;
        document.getElementById("changeAvatarBtn").disabled = true;

        editBtn.classList.remove("hidden");
        saveBtn.classList.add("hidden");
        cancelBtn.classList.add("hidden");
      });

      togglePasswordBtn.addEventListener("click", () => {
        passwordForm.classList.toggle("hidden");
      });

      function previewAvatar(event) {
        const reader = new FileReader();
        reader.onload = function () {
          document.getElementById("avatarPreview").src = reader.result;
        };
        reader.readAsDataURL(event.target.files[0]);
      }
      window.previewAvatar = previewAvatar;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const userId = form.getAttribute("data-user-id");
        const formData = new FormData(form);

        const avatarFile = document.getElementById("avatarInput").files[0];

        let avatarUrl = null;
        if (avatarFile) {
          const uploadData = new FormData();
          uploadData.append("file", avatarFile);

          try {
            const uploadResponse = await fetch(`/api/users/${userId}/avatar`, {
              method: "POST",
              body: uploadData,
            });

            if (uploadResponse.ok) {
              const uploadResult = await uploadResponse.json();
              avatarUrl = uploadResult.avatarUrl;
            } else {
              const errText = await uploadResponse.text();
              showToast("Failed to upload image: " + errText, "error");
              return;
            }
          } catch (err) {
            showToast("Error uploading image: " + err, "error");
            return;
          }
        }

        const data = {};
        formData.forEach((value, key) => {
          if (key !== "avatarFile") data[key] = value;
        });
        if (avatarUrl) data.avatarUrl = avatarUrl;

        try {
          const response = await fetch(`/api/users/${userId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          if (response.ok) {
            showToast("Profile updated successfully!", "success");
            formInputs.forEach((el) => (el.disabled = true));
            document.getElementById("avatarInput").disabled = true;
            document.getElementById("changeAvatarBtn").disabled = true;
            saveBtn.classList.add("hidden");
            cancelBtn.classList.add("hidden");
            editBtn.classList.remove("hidden");
          } else {
            const errText = await response.text();
            showToast("Error updating profile: " + errText, "error");
          }
        } catch (err) {
          showToast("Cannot connect to server: " + err, "error");
        }
      });

      const passwordFormEl = document.getElementById("passwordForm");

      passwordFormEl.addEventListener("submit", async (e) => {
        e.preventDefault();

        const userId = form.getAttribute("data-user-id");
        const oldPassword = passwordFormEl.querySelector(
          "input[name='oldPassword']"
        ).value;
        const newPassword = passwordFormEl.querySelector(
          "input[name='newPassword']"
        ).value;
        const confirmPassword = passwordFormEl.querySelector(
          "input[name='confirmPassword']"
        ).value;

        if (!oldPassword || !newPassword || !confirmPassword) {
          showToast("Please fill in all fields.", "error");
          return;
        }
        if (newPassword !== confirmPassword) {
          showToast("New password and confirmation do not match!", "error");
          return;
        }

        const passwordRegex =
          /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*(),.?":{}|<>]).{8,}$/;
        if (!passwordRegex.test(newPassword)) {
          showToast(
            "Password must be at least 8 characters, including uppercase, number and special character.",
            "error"
          );
          return;
        }

        try {
          const response = await fetch(`/api/users/${userId}/change-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              oldPassword,
              newPassword,
              confirmPassword,
            }),
          });

          if (response.ok) {
            const result = await response.json();
            showToast(
              result.message || "Password changed successfully!",
              "success"
            );
            passwordFormEl.reset();
            passwordFormEl.classList.add("hidden");
          } else {
            const errorData = await response.json().catch(() => ({}));
            const msg =
              errorData.message ||
              errorData.error ||
              "Cannot change password. Please try again.";
            showToast(msg, "error");
          }
        } catch (err) {
          showToast("Cannot connect to server: " + err, "error");
        }
      });

      const upgradeBtn = document.getElementById("upgradeBtn");
      const confirmModal = document.getElementById("confirmModal");
      const confirmBuyBtn = document.getElementById("confirmBuyBtn");
      const cancelBuyBtn = document.getElementById("cancelBuyBtn");

      upgradeBtn.addEventListener("click", () => {
        confirmModal.classList.remove("hidden");
      });

      cancelBuyBtn.addEventListener("click", () => {
        confirmModal.classList.add("hidden");
      });

      confirmBuyBtn.addEventListener("click", async () => {
        confirmBuyBtn.disabled = true;
        confirmBuyBtn.textContent = "Processing...";

        try {
          const res = await fetch("/api/payment/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ total: 25000, plan: "Pro" }),
          });

          const data = await res.json();
          if (data.success) {
            window.location.href = data.redirectUrl;
          } else {
            showToast("Cannot create order!", "error");
          }
        } catch (err) {
          showToast("Server connection error: " + err, "error");
        } finally {
          confirmBuyBtn.disabled = false;
          confirmBuyBtn.textContent = "Confirm";
          confirmModal.classList.add("hidden");
        }
      });
    </script>
  </body>
</html>
