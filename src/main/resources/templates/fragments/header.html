<header
  th:fragment="header"
  class="bg-white p-4 flex justify-between items-center shadow-md sticky top-0 z-20 h-16 border-b border-gray-200"
>
<<<<<<< HEAD
  <!-- üîπ Logo -->
  <div class="flex items-center space-x-3 w-64 flex-shrink-0">
    <img
      th:src="@{/photo/logo1.png}"
      alt="DevCollab Logo"
      class="w-9 h-9 rounded-lg shadow-sm"
    />
    <span class="text-2xl font-extrabold text-blue-700 tracking-wider"
      >DevCollab</span
    >
  </div>

  <!-- üîπ Search -->
  <div class="flex-grow flex justify-center mx-10">
    <div class="relative w-full max-w-xl">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        id="searchIcon"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
        />
      </svg>

      <input
        id="searchInput"
        type="text"
        placeholder="Search for anything..."
        class="border border-gray-200 rounded-full pl-12 pr-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-sm shadow-sm"
      />

      <div
        id="searchDropdown"
        class="hidden absolute left-0 mt-3 w-full bg-white border border-gray-200 rounded-xl shadow-lg z-30"
      >
        <div class="p-3 border-b bg-gray-50 font-semibold text-gray-700">
          K·∫øt qu·∫£ t√¨m ki·∫øm
        </div>
        <div id="searchResults" class="max-h-80 overflow-y-auto">
          <p class="p-4 text-gray-500 text-sm text-center">
            Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu t√¨m ki·∫øm...
          </p>
=======
    <!-- üîπ Logo -->
    <a th:href="@{/user/view/dashboard}">
        <div class="flex items-center space-x-3 w-64 flex-shrink-0">
            <img th:src="@{/photo/logo1.png}" alt="DevCollab Logo"
                 class="w-9 h-9 rounded-lg shadow-sm" />
            <span class="text-2xl font-extrabold text-blue-700 tracking-wider">DevCollab</span>
        </div>
    </a>

    <!-- üîπ Search -->
    <div class="flex-grow flex justify-center mx-10">
        <div class="relative w-full max-w-xl">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-5 w-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" id="searchIcon">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>

            <input id="searchInput" type="text" placeholder="Search for anything..."
                   class="border border-gray-200 rounded-full pl-12 pr-4 py-2 w-full
                          focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500
                          bg-gray-50 text-sm shadow-sm"/>

            <div id="searchDropdown"
                 class="hidden absolute left-0 mt-3 w-full bg-white border border-gray-200
                        rounded-xl shadow-lg z-30">
                <div class="p-3 border-b bg-gray-50 font-semibold text-gray-700">K·∫øt qu·∫£ t√¨m ki·∫øm</div>
                <div id="searchResults" class="max-h-80 overflow-y-auto">
                    <p class="p-4 text-gray-500 text-sm text-center">
                        Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu t√¨m ki·∫øm...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- üîπ Right side -->
    <div class="flex items-center space-x-6 flex-shrink-0">

        <!-- üîî Notification -->
        <div class="relative cursor-pointer p-2 rounded-full hover:bg-gray-100 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" id="notificationBell">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2
                         2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214
                         1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>

            <span th:if="${unreadNotifications > 0}" th:text="${unreadNotifications}"
                  class="absolute -top-1 -right-1 bg-red-500 text-white text-xs
                         rounded-full px-1.5 py-0.5 font-semibold"></span>

            <div id="notificationDropdown"
                 class="hidden absolute right-0 mt-3 w-80 bg-white border border-gray-200
                        rounded-xl shadow-lg z-30">
                <div class="p-3 border-b bg-gray-50 font-semibold text-gray-700">Th√¥ng b√°o</div>
                <div id="notificationList" class="max-h-80 overflow-y-auto">
                    <p class="p-4 text-gray-500 text-sm text-center">Kh√¥ng c√≥ th√¥ng b√°o</p>
                </div>
            </div>
>>>>>>> payment
        </div>
      </div>
    </div>
  </div>

<<<<<<< HEAD
  <!-- üîπ Right side -->
  <div class="flex items-center space-x-6 flex-shrink-0">
    <div class="relative">
      <button
        id="open-notif-btn"
        class="relative bg-white/90 text-gray-700 hover:bg-white px-3 py-2 rounded-md shadow-sm"
      >
        üîî
        <span
          id="notif-dot"
          class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full hidden"
        ></span>
        <span
          id="notif-count-badge"
          class="hidden absolute -top-1 -right-2 text-[10px] px-1.5 py-0.5 rounded-full bg-red-600 text-white font-semibold min-w-[18px] text-center"
        ></span>
      </button>
    </div>
    <div
      id="notif-panel"
      class="hidden absolute right-6 top-16 w-[420px] bg-white rounded-xl shadow-xl border border-gray-200 overflow-hidden z-[150]"
    >
      <div
        class="flex items-center justify-between px-4 py-3 border-b bg-gray-50 relative"
      >
        <h2 class="font-semibold text-gray-800 text-[15px]">Th√¥ng b√°o</h2>

        <div class="flex items-center gap-3">
          <label
            class="flex items-center text-sm text-gray-600 cursor-pointer select-none"
          >
            <span class="mr-1">Ch·ªâ hi·ªÉn th·ªã ch∆∞a ƒë·ªçc</span>
            <input id="toggle-unread" type="checkbox" class="sr-only peer" />
            <div
              class="w-10 h-5 bg-gray-300 rounded-full relative after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:w-4 after:h-4 after:bg-white after:rounded-full after:transition-all peer-checked:bg-blue-600 peer-checked:after:translate-x-5"
            ></div>
          </label>

          <button
            id="mark-all-read"
            class="hidden text-sm text-blue-600 hover:text-blue-800 font-medium transition"
          >
            ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc
          </button>

          <!-- ‚ãØ Menu Button -->
          <div class="relative">
            <button
              id="notif-options-btn"
              class="text-gray-500 hover:text-gray-800 text-xl px-2 py-1 rounded transition"
            >
              ‚ãØ
            </button>

            <!-- Dropdown menu -->
            <div
              id="notif-options-menu"
              class="hidden absolute right-0 mt-2 w-64 bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden z-[999] animate-[fadeIn_0.15s_ease-out]"
            >
              <ul class="divide-y divide-gray-100">
                <!-- üìß Toggle Email Notification -->
                <li>
                  <button
                    id="toggle-email-btn"
                    type="button"
                    class="w-full text-left px-4 py-2.5 text-sm flex items-center justify-between hover:bg-gray-50 transition"
                  >
                    <div class="flex items-center gap-2 text-gray-700">
                      <span class="text-[16px]">üìß</span>
                      <span id="email-toggle-text" class="font-medium"
                        >T·∫Øt th√¥ng b√°o qua Gmail</span
                      >
                    </div>
                    <!-- üîò Switch -->
                    <div
                      id="email-toggle-icon"
                      class="w-9 h-5 flex items-center bg-gray-300 rounded-full p-0.5 transition-all duration-300"
                    >
                      <div
                        class="dot bg-white w-4 h-4 rounded-full transform translate-x-0 transition-all duration-300"
                      ></div>
                    </div>
                  </button>
                </li>

                <li>
                  <a
                    id="open-settings-link"
                    href="/settings/notifications"
                    class="block w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 transition"
                  >
                    <span class="text-[16px]">‚öôÔ∏è</span>
                    <span class="font-medium">T·∫•t c·∫£ c√†i ƒë·∫∑t th√¥ng b√°o</span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <!-- Empty State -->
      <div
        id="notif-empty"
        class="hidden flex flex-col items-center justify-center py-16"
      >
        <img
          src="https://cdn-icons-png.flaticon.com/512/616/616408.png"
          alt="empty"
          class="w-24 h-24 opacity-80 mb-3"
        />
        <p class="text-gray-500 text-sm font-medium">No unread notifications</p>
      </div>

      <!-- List (render ƒë·ªông) -->
      <div
        id="notif-list"
        class="max-h-[480px] overflow-y-auto divide-y divide-gray-100"
      >
        <!-- JS s·∫Ω render n·ªôi dung v√†o ƒë√¢y -->
      </div>
    </div>
    <!-- üë§ User info -->
    <div class="relative">
      <div
        id="userMenuButton"
        class="flex items-center space-x-3 cursor-pointer p-1 rounded-full hover:bg-gray-100 transition"
      >
        <div class="text-right leading-tight">
          <div class="flex items-center justify-end space-x-2">
            <span
              class="block text-sm font-semibold text-gray-800"
              th:text="${user != null ? user.name : 'User'}"
              >User</span
            >

            <!-- üèÜ Premium -->
            <span
              th:if="${user != null && user.isPremium}"
              class="bg-yellow-400 text-white text-[11px] font-bold px-2 py-0.5 rounded-full shadow-sm flex items-center space-x-1"
              title="T√†i kho·∫£n Premium"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 20 20"
                class="w-3.5 h-3.5"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 2a1 1 0 01.894.553l1.382 2.802
=======
        <!-- üë§ User info -->
        <div class="relative">
            <div id="userMenuButton"
                 class="flex items-center space-x-3 cursor-pointer p-1 rounded-full hover:bg-gray-100 transition">
                <div class="text-right leading-tight">
                    <div class="flex items-center justify-end space-x-2">
                        <span class="block text-sm font-semibold text-gray-800"
                              th:text="${user != null ? user.name : 'User'}">User</span>

                        <!-- üèÜ Premium -->
                        <span th:if="${user != null && user.isPremium}"
                              class="bg-yellow-400 text-white text-[11px] font-bold px-2 py-0.5
                                     rounded-full shadow-sm flex items-center space-x-1"
                              title="T√†i kho·∫£n Premium">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor"
                                 viewBox="0 0 20 20" class="w-3.5 h-3.5">
                                <path fill-rule="evenodd"
                                      d="M10 2a1 1 0 01.894.553l1.382 2.802
>>>>>>> payment
                                         3.09.45a1 1 0 01.554 1.707l-2.236
                                         2.18.528 3.078a1 1 0 01-1.45
                                         1.054L10 12.347l-2.762
                                         1.457a1 1 0 01-1.45-1.054l.528-3.078-2.236-2.18a1
                                         1 0 01.554-1.707l3.09-.45L9.106
                                         2.553A1 1 0 0110 2z"
<<<<<<< HEAD
                  clip-rule="evenodd"
                />
              </svg>
              <span>Premium</span>
            </span>

            <!-- üÜì Free -->
            <span
              th:if="${user != null && !user.isPremium}"
              class="bg-gray-200 text-gray-600 text-[11px] font-medium px-2 py-0.5 rounded-full shadow-sm"
              title="T√†i kho·∫£n mi·ªÖn ph√≠"
              >Free</span
            >
          </div>

          <span
            class="block text-xs text-gray-500"
            th:text="${user != null ? user.email : ''}"
            >user@email.com</span
          >
        </div>

        <!-- Avatar -->
        <img
          th:src="${user != null && user.avatarUrl != null && !#strings.isEmpty(user.avatarUrl)
                              ? user.avatarUrl : '/photo/default-avatar.png'}"
          class="rounded-full w-10 h-10 border-2 border-white shadow-lg object-cover"
          alt="User Avatar"
        />
      </div>

      <!-- Dropdown -->
      <div
        id="userDropdown"
        class="hidden absolute right-0 mt-3 w-44 bg-white border border-gray-200 rounded-xl shadow-lg z-30"
      >
        <a
          href="/user/view/profile"
          class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-xl"
        >
          üë§ Profile
        </a>
        <a
          href="#"
          id="logoutBtn"
          class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-b-xl"
        >
          üö™ Logout
        </a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2/dist/stomp.min.js"></script>

  <script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
      // ================== üîî NOTIFICATIONS PANEL ==================
      const notifBtn = document.getElementById("open-notif-btn");
      const notifPanel = document.getElementById("notif-panel");
      const notifList = document.getElementById("notif-list");
      const notifEmpty = document.getElementById("notif-empty");
      const toggleUnread = document.getElementById("toggle-unread");
      const notifDot = document.getElementById("notif-dot");
      const markAllBtn = document.getElementById("mark-all-read");
      const closeNotifPanel = document.getElementById("close-notif-panel");
      const notifCountBadge = document.getElementById("notif-count-badge");

      function updateUnreadBadge(count) {
        if (!notifCountBadge) return;
        const c = Number(count) || 0;
        if (c <= 0) {
          notifCountBadge.classList.add("hidden");
          notifCountBadge.textContent = "";
          notifDot?.classList.add("hidden");
        } else {
          notifCountBadge.classList.remove("hidden");
          notifCountBadge.textContent = c > 99 ? "99+" : String(c);
          notifDot?.classList.remove("hidden");
        }
      }

      // TƒÉng 1 khi nh·∫≠n realtime (n·∫øu panel ƒëang ƒë√≥ng)
      function incrementUnreadBadge() {
        if (!notifCountBadge) return;
        const isOpen = !document
          .getElementById("notif-panel")
          .classList.contains("hidden");
        if (isOpen) return; // panel m·ªü th√¨ s·∫Ω reload list v√† t√≠nh l·∫°i

        const cur = parseInt(notifCountBadge.textContent) || 0;
        updateUnreadBadge(cur + 1);
      }

      // ================== üì• Load Notifications (Tre llo-style) ==================
      async function loadNotifications(onlyUnread = false) {
        const token = localStorage.getItem("token");
        notifList.innerHTML = `<p class="text-gray-400 text-sm italic text-center py-4">Loading...</p>`;
        notifEmpty.classList.add("hidden");

        try {
          const res = await fetch(`/api/notifications`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok)
            throw new Error(`Failed to fetch notifications (${res.status})`);

          const data = await res.json();
          const list = Array.isArray(data)
            ? data
            : data?.content || data?.notifications || data?.data || [];

          const totalUnread = list.filter(
            (n) => n.status && n.status.toLowerCase() !== "read"
          ).length;
          updateUnreadBadge(totalUnread);

          const filtered = onlyUnread
            ? list.filter((n) => n.status && n.status.toLowerCase() !== "read")
            : list;

          if (filtered.length === 0) {
            notifEmpty.classList.remove("hidden");
            notifList.innerHTML = "";
            markAllBtn?.classList.add("hidden");
            notifDot.classList.add("hidden");
            return;
          }

          const hasUnread = list.some(
            (n) => n.status && n.status.toLowerCase() !== "read"
          );
          notifDot.classList.toggle("hidden", !hasUnread);
          markAllBtn?.classList.remove("hidden");

          notifList.innerHTML = filtered
            .map((n) => {
              const id = n.notificationId || n.id;
              const link = n.link || "#";
              const msg = n.message || "";
              const createdAt = n.createdAt || new Date().toISOString();
              const isRead = n.status && n.status.toLowerCase() === "read";
              const senderName = n.senderName || "H·ªá th·ªëng";
              const senderAvatar =
                n.senderAvatar && n.senderAvatar.trim() !== ""
                  ? n.senderAvatar
                  : "https://cdn-icons-png.flaticon.com/512/149/149071.png";

              return `
            <div onclick="handleNotificationClick(${id}, '${link}')"
                class="bg-white px-4 py-3 hover:bg-gray-50 transition cursor-pointer relative border-b border-gray-100 ${
                  isRead ? "opacity-60" : ""
                }">
              <div class="flex items-start gap-3">
                <img src="${senderAvatar}" 
                    class="w-9 h-9 rounded-full border object-cover" 
                    alt="avatar">
                <div class="flex-1 text-sm">
                  <p class="text-gray-800 font-medium">${senderName}</p>
                  <p class="text-gray-700 leading-snug">${msg}</p>
                  <p class="text-xs text-gray-400 mt-1">${formatRelativeTime(
                    createdAt
                  )}</p>
                </div>
                ${
                  !isRead
                    ? `<span class="absolute right-3 top-3 w-2.5 h-2.5 bg-blue-500 rounded-full"></span>`
                    : ""
                }
              </div>
            </div>`;
            })
            .join("");
        } catch (err) {
          console.error("‚ùå loadNotifications:", err);
          notifList.innerHTML = `<p class="text-red-500 text-sm text-center py-4">Failed to load notifications</p>`;
        }
      }

      // ================== ‚úÖ Mark Read ==================
      async function markNotificationRead(id) {
        if (!id) return;
        const token = localStorage.getItem("token");
        try {
          const res = await fetch(`/api/notifications/${id}/read`, {
            method: "PUT",
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) console.warn("‚ö†Ô∏è Failed to mark read:", res.status);
        } catch (err) {
          console.error("‚ùå markNotificationRead:", err);
        }
      }

      // ================== ‚úÖ Mark All as Read ==================
      async function markAllNotificationsRead() {
        const token = localStorage.getItem("token");
        try {
          const res = await fetch(`/api/notifications/read-all`, {
            method: "PUT",
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) throw new Error("Failed to mark all as read");
          await loadNotifications(toggleUnread.checked);
          updateUnreadBadge(0);
        } catch (err) {
          console.error("‚ùå markAllNotificationsRead:", err);
        }
      }
      if (markAllBtn)
        markAllBtn.addEventListener("click", markAllNotificationsRead);

      // ================== üîó Handle Click Notification ==================
      async function handleNotificationClick(id, link) {
        console.log("üü£ CLICK:", id, link);
        await markNotificationRead(id);
        // Gi·∫£m 1 local (UI) ‚Äì server s·∫Ω sync l·∫°i khi reload panel
        const cur =
          parseInt(document.getElementById("notif-count-badge")?.textContent) ||
          0;
        if (cur > 0) updateUnreadBadge(cur - 1);

        if (!link || link === "#" || link === "null") {
          console.log("‚ÑπÔ∏è No link to redirect.");
          return;
        }

        // üß© Tr∆∞·ªùng h·ª£p task notification
        if (link.includes("/tasks/")) {
          const taskId = link.split("taskId=")[1] || link.split("/tasks/")[1];
          if (taskId) {
            await openTaskDetailFromApi(taskId);
            return;
          }
        }

        // üß≠ N·∫øu l√† link d·ª± √°n th√¨ m·ªü n·ªôi b·ªô (c√πng tab)
        if (link.startsWith("/view/pm/project/")) {
          window.location.href = link; // üëâ Chuy·ªÉn n·ªôi b·ªô thay v√¨ m·ªü tab m·ªõi
          return;
        }

        // üåê M·∫∑c ƒë·ªãnh m·ªü tab m·ªõi
        window.open(link, "_blank");
      }
      window.handleNotificationClick = handleNotificationClick;

      async function openTaskDetailFromApi(taskId) {
        try {
          const res = await fetch(`/api/tasks/${taskId}`, {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          if (!res.ok) throw new Error("Failed to load task");
          const task = await res.json();
          openTaskModal(task);
        } catch (err) {
          console.error("‚ùå openTaskDetailFromApi:", err);
          alert("Kh√¥ng th·ªÉ t·∫£i th√¥ng tin c√¥ng vi·ªác.");
        }
      }

      // ================== ü™ü Render Task Detail into Modal ==================
      function openTaskModal(task) {
        const modal = document.getElementById("task-detail-modal");
        if (!modal) {
          console.error("‚ùå Modal task-detail-modal not found in DOM");
          return;
        }

        const titleEl = modal.querySelector("h2.text-2xl");
        if (titleEl) titleEl.textContent = task.title || "(Untitled Task)";

        const descContent = modal.querySelector("#description-content");
        const descPlaceholder = modal.querySelector("#description-placeholder");
        if (descContent && descPlaceholder) {
          if (task.descriptionMd && task.descriptionMd.trim() !== "") {
            descContent.textContent = task.descriptionMd;
            descPlaceholder.classList.add("hidden");
          } else {
            descContent.textContent = "";
            descPlaceholder.classList.remove("hidden");
          }
        }

        const dueText = modal.querySelector("#due-date-text");
        const dueStatus = modal.querySelector("#due-date-status");
        if (dueText && dueStatus) {
          if (task.deadline) {
            const date = new Date(task.deadline);
            dueText.textContent = date.toLocaleString();
            dueStatus.textContent = "Due";
            dueStatus.className =
              "ml-2 text-xs font-medium rounded px-2 py-0.5 bg-yellow-100 text-yellow-700";
          } else {
            dueText.textContent = "No due date";
            dueStatus.textContent = "None";
            dueStatus.className =
              "ml-2 text-xs font-medium rounded px-2 py-0.5 bg-gray-200 text-gray-600";
          }
        }

        const attachList = modal.querySelector("#attachments-list");
        if (attachList) {
          if (task.attachments && task.attachments.length > 0) {
            attachList.innerHTML = task.attachments
              .map(
                (a) => `
          <div class="flex items-center justify-between border rounded px-3 py-2">
            <a href="${
              a.fileUrl
            }" target="_blank" class="text-blue-600 hover:underline truncate">${
                  a.fileName
                }</a>
            <span class="text-xs text-gray-400">${new Date(
              a.uploadedAt
            ).toLocaleDateString()}</span>
          </div>`
              )
              .join("");
          } else {
            attachList.innerHTML = `<p class="text-gray-400 italic">No attachments yet.</p>`;
          }
        }

        if (typeof loadActivityFeed === "function") {
          loadActivityFeed(task.taskId);
        }

        modal.classList.remove("hidden");
      }

      // ================== üì° WebSocket Realtime Notifications ==================
      let stompClient = null;
      let wsConnected = false;
      let wsRetry = 0;
      const WS_MAX_RETRY = 8; // t·ªëi ƒëa 8 l·∫ßn (‚âà ~30s backoff)
      const WS_BASE_DELAY = 1000; // 1s
      const WS_MAX_DELAY = 30000; // 30s
      let wsSubscription = null;

      function backoffDelay(attempt) {
        // exponential backoff + jitter
        const expo = Math.min(
          WS_MAX_DELAY,
          WS_BASE_DELAY * Math.pow(2, attempt)
        );
        return Math.floor(expo * (0.7 + Math.random() * 0.6)); // 70%‚Äì130% jitter
      }

      async function connectWebSocketNotifications() {
        let token = localStorage.getItem("token");

        if (!token) {
          try {
            const res = await fetch("/api/auth/me", { credentials: "include" });
            if (res.ok) {
              const data = await res.json();
              console.log(
                "‚úÖ Fallback via cookie:",
                data.email || data.user?.email
              );
            } else {
              console.warn("‚ö†Ô∏è Kh√¥ng th·ªÉ x√°c th·ª±c cookie, WS s·∫Ω kh√¥ng k·∫øt n·ªëi");
              return;
            }
          } catch (err) {
            console.error("‚ùå L·ªói khi x√°c th·ª±c cookie:", err);
            return;
          }
        }

        // 3Ô∏è‚É£ Ti·∫øp t·ª•c k·∫øt n·ªëi (c√≥ ho·∫∑c kh√¥ng c√≥ token)
        if (stompClient && wsConnected) return;

        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.heartbeat.outgoing = 15000;
        stompClient.heartbeat.incoming = 15000;

        const headers = token ? { Authorization: `Bearer ${token}` } : {};
        stompClient.connect(
          headers,
          (frame) => {
            console.log("‚úÖ WS connected:", frame);
            wsConnected = true;
            wsRetry = 0;

            // h·ªßy sub c≈©
            if (
              wsSubscription &&
              typeof wsSubscription.unsubscribe === "function"
            ) {
              try {
                wsSubscription.unsubscribe();
              } catch {}
            }

            wsSubscription = stompClient.subscribe(
              "/user/queue/notifications",
              (message) => {
                try {
                  const notif = JSON.parse(message.body);
                  console.log("üîî Realtime:", notif);
                  incrementUnreadBadge();

                  if (
                    !document
                      .getElementById("notif-panel")
                      .classList.contains("hidden")
                  ) {
                    loadNotifications(
                      document.getElementById("toggle-unread").checked
                    );
                  } else {
                    showToastNotification(
                      notif.title,
                      notif.message,
                      notif.senderAvatar,
                      notif.senderName
                    );
                  }
                } catch (e) {
                  console.error("‚ùå WS message parse:", e);
                }
              }
            );
          },
          (error) => {
            console.warn("‚ö†Ô∏è WS connect ERROR:", error);
            scheduleWsReconnect();
          }
        );

        socket.onclose = () => {
          console.warn("‚ö†Ô∏è WS closed");
          wsConnected = false;
          scheduleWsReconnect();
        };
      }

      function scheduleWsReconnect() {
        if (wsConnected) return; // ƒë√£ k·∫øt n·ªëi l·∫°i
        if (wsRetry >= WS_MAX_RETRY) {
          console.error("üö´ WS max retries reached ‚Äî stop reconnecting");
          return;
        }
        const delay = backoffDelay(wsRetry);
        console.log(
          `‚è≥ WS reconnect in ${Math.round(delay / 1000)}s (attempt ${
            wsRetry + 1
          }/${WS_MAX_RETRY})`
        );
        setTimeout(() => {
          wsRetry++;
          connectWebSocketNotifications();
        }, delay);
      }

      // ================== üéØ Event bindings ==================
      toggleUnread.addEventListener("change", (e) =>
        loadNotifications(e.target.checked)
      );

      notifBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        notifPanel.classList.toggle("hidden");
        if (!notifPanel.classList.contains("hidden"))
          loadNotifications(toggleUnread.checked);
      });

      closeNotifPanel?.addEventListener("click", () =>
        notifPanel.classList.add("hidden")
      );

      document.addEventListener("click", (e) => {
        if (!notifPanel.contains(e.target) && !notifBtn.contains(e.target)) {
          notifPanel.classList.add("hidden");
        }
      });

      // üîÅ Auto refresh m·ªói 30s
      setInterval(() => {
        if (!notifPanel.classList.contains("hidden"))
          loadNotifications(toggleUnread.checked);
      }, 30000);

      // ====== ‚ãØ NOTIFICATION SETTINGS MENU ======
      const notifMenuBtn = document.getElementById("notif-options-btn");
      const notifMenu = document.getElementById("notif-options-menu");
      const toggleEmailBtn = document.getElementById("toggle-email-btn");
      const emailToggleText = document.getElementById("email-toggle-text");

      let emailEnabled = true;

      notifMenuBtn?.addEventListener("click", (e) => {
        e.stopPropagation();
        notifMenu.classList.toggle("hidden");
      });

      // ƒê√≥ng khi click ra ngo√†i
      document.addEventListener("click", (e) => {
        if (!notifMenu.contains(e.target) && !notifMenuBtn.contains(e.target)) {
          notifMenu.classList.add("hidden");
        }
      });

      // G·ªçi API b·∫≠t/t·∫Øt Gmail notification
      toggleEmailBtn?.addEventListener("click", async (e) => {
        e.preventDefault(); // üõë NgƒÉn h√†nh vi m·∫∑c ƒë·ªãnh
        e.stopPropagation(); // üõë Kh√¥ng lan sang <a> b√™n d∆∞·ªõi

        emailEnabled = !emailEnabled;

        try {
          const token = localStorage.getItem("token");

          const res = await fetch("/api/settings/notifications/email-toggle", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ enabled: emailEnabled }),
          });

          if (res.ok) {
            emailToggleText.textContent = emailEnabled
              ? "T·∫Øt th√¥ng b√°o qua Gmail"
              : "B·∫≠t l·∫°i th√¥ng b√°o qua Gmail";
            showToast(
              emailEnabled
                ? "‚úÖ ƒê√£ b·∫≠t l·∫°i th√¥ng b√°o Gmail"
                : "üö´ ƒê√£ t·∫Øt th√¥ng b√°o Gmail"
            );
          } else {
            showToast("‚ö†Ô∏è Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t c√†i ƒë·∫∑t.");
          }
        } catch (err) {
          console.error("‚ùå toggleEmailBtn error:", err);
          showToast("‚ö†Ô∏è L·ªói k·∫øt n·ªëi server.");
        }

        notifMenu.classList.add("hidden");
      });
      // ================== SETTINGS LINK ==================
      window.addEventListener("DOMContentLoaded", () => {
        const openSettingsLink = document.getElementById("open-settings-link");
        if (!openSettingsLink) return;

        openSettingsLink.addEventListener("click", async (e) => {
          e.preventDefault();

          try {
            // 1Ô∏è‚É£ Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p qua API
            const meRes = await fetch("/api/auth/me", {
              credentials: "include",
            });

            if (!meRes.ok) {
              alert("‚ö†Ô∏è B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p! Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c.");
              window.location.href = "/view/signin";
              return;
            }

            const userData = await meRes.json();

            // 2Ô∏è‚É£ L∆∞u l·∫°i email (tu·ª≥ ch·ªçn, n·∫øu c·∫ßn)
            if (userData.email) {
              localStorage.setItem("currentUserEmail", userData.email);
            }

            // 3Ô∏è‚É£ Ki·ªÉm tra quy·ªÅn truy c·∫≠p c√†i ƒë·∫∑t (d√πng c√πng cookie)
            const res = await fetch("/api/settings/notifications/me", {
              credentials: "include", //
            });

            if (!res.ok) {
              alert(
                "‚ùå Kh√¥ng th·ªÉ truy c·∫≠p trang c√†i ƒë·∫∑t. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!"
              );
              window.location.href = "/view/signin";
              return;
            }

            // ‚úÖ Th√†nh c√¥ng ‚Üí ƒëi·ªÅu h∆∞·ªõng
            window.location.href = "/settings/notifications";
          } catch (err) {
            console.error("‚ö†Ô∏è openSettingsLink error:", err);
            alert("‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau.");
          }
        });
      });

      // ================== WEBSOCKET ==================
      window.addEventListener("load", () => {
        try {
          connectWebSocketNotifications();
        } catch (err) {
          console.warn("‚ö†Ô∏è Kh√¥ng th·ªÉ kh·ªüi t·∫°o WebSocket:", err);
        }
      });

      // --- User Dropdown ---
      const userBtn = document.getElementById("userMenuButton");
      const userDropdown = document.getElementById("userDropdown");
      if (userBtn && userDropdown) {
        userBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          userDropdown.classList.toggle("hidden");
        });
        document.addEventListener("click", (e) => {
          if (!userDropdown.contains(e.target) && !userBtn.contains(e.target)) {
            userDropdown.classList.add("hidden");
          }
        });
      }
      function formatRelativeTime(isoString) {
        const now = new Date();
        const date = new Date(isoString);
        const diff = Math.floor((now - date) / 60000);
        if (diff < 1) return "just now";
        if (diff < 60) return `${diff} min${diff > 1 ? "s" : ""} ago`;
        const hrs = Math.floor(diff / 60);
        if (hrs < 24) return `${hrs} hour${hrs > 1 ? "s" : ""} ago`;
        const days = Math.floor(hrs / 24);
        return `${days} day${days > 1 ? "s" : ""} ago`;
      }
      // --- Search ---
      const searchInput = document.getElementById("searchInput");
      const searchDropdown = document.getElementById("searchDropdown");
      const searchResults = document.getElementById("searchResults");

      if (searchInput && searchDropdown && searchResults) {
        searchInput.addEventListener("focus", () => {
          searchDropdown.classList.remove("hidden");
          searchResults.innerHTML =
            "<p class='p-4 text-gray-500 text-sm text-center'>Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu t√¨m ki·∫øm...</p>";
        });

        document.addEventListener("click", (e) => {
          if (!searchDropdown.contains(e.target) && e.target !== searchInput) {
            searchDropdown.classList.add("hidden");
          }
        });

        let searchTimeout;
        searchInput.addEventListener("input", () => {
          clearTimeout(searchTimeout);
          const query = searchInput.value.trim();

          if (query.length < 2) {
            searchResults.innerHTML =
              "<p class='p-4 text-gray-500 text-sm text-center'>Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu t√¨m ki·∫øm...</p>";
            return;
          }

          searchTimeout = setTimeout(() => {
            fetch(`/api/search?query=${encodeURIComponent(query)}`)
              .then((res) => res.json())
              .then((data) => {
                if (!data || data.length === 0) {
                  searchResults.innerHTML =
                    "<p class='p-4 text-gray-500 text-sm text-center'>Kh√¥ng c√≥ k·∫øt qu·∫£</p>";
                  return;
                }

                searchResults.innerHTML = data
                  .map(
                    (item) => `
                                    <div class="px-4 py-3 hover:bg-gray-50 border-b border-gray-100 cursor-pointer transition"
                                         onclick="window.location.href='/view/project/${
                                           item.projectId
                                         }'">
                                        <p class="text-sm font-medium text-gray-800">${this.escapeHtml(
                                          item.name
                                        )}</p>
                                        <p class="text-xs text-gray-500">${
                                          item.description
                                            ? this.escapeHtml(item.description)
                                            : ""
                                        }</p>
                                    </div>
                                `
                  )
                  .join("");
              })
              .catch(() => {
                searchResults.innerHTML =
                  "<p class='p-4 text-gray-500 text-sm text-center'>Kh√¥ng th·ªÉ t·∫£i k·∫øt qu·∫£</p>";
              });
          }, 300);
        });
      }

      // Utility function to escape HTML
      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // --- Logout ---
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", (e) => {
          e.preventDefault();
          fetch("/api/auth/logout", { method: "POST", credentials: "include" })
            .then(() => {
              // Clear cookies
              document.cookie =
                "AUTH_TOKEN=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
              document.cookie =
                "REFRESH_TOKEN=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

              // Clear localStorage
              localStorage.removeItem("AUTH_TOKEN");
              localStorage.removeItem("REFRESH_TOKEN");

              // Redirect to login page
              window.location.href = "/view/signin";
            })
            .catch((err) => console.error("Logout error:", err));
        });
      }
    });
  </script>
  <script>
    (async () => {
      try {
        // üë§ L·∫•y c√°c ph·∫ßn t·ª≠ trong header
        const nameEl = document.querySelector(
          "#userMenuButton span[th\\:text]"
        );
        const emailEl = document.querySelector("#userMenuButton .text-xs");
        const freeBadge = document.querySelector(
          "#userMenuButton .bg-gray-200"
        );
        const premiumBadge = document.querySelector(
          "#userMenuButton .bg-yellow-400"
        );
        const avatarImg = document.querySelector(
          '#userMenuButton img[alt="User Avatar"]'
        );

        // N·∫øu ƒë√£ c√≥ d·ªØ li·ªáu Thymeleaf th√¨ kh√¥ng c·∫ßn fetch
        if (
          nameEl &&
          nameEl.textContent.trim() !== "User" &&
          emailEl &&
          emailEl.textContent.trim() !== ""
        ) {
          return;
        }

        const token = localStorage.getItem("token");
        const res = await fetch("/api/auth/me", {
          headers: token ? { Authorization: "Bearer " + token } : {},
          credentials: "include",
        });

        if (!res.ok) throw new Error("Unauthorized");
        const data = await res.json();
        const u = data.user || data;

        const user = {
          name: u.name || u.fullName || "User",
          email: u.email || "",
          avatarUrl:
            u.avatarUrl && u.avatarUrl.trim() !== "" ? u.avatarUrl : "",
          isPremium: !!u.isPremium || (u.roles || []).includes("ROLE_PREMIUM"),
        };

        // üü© Ghi ƒë√® th√¥ng tin
        if (nameEl) nameEl.textContent = user.name;
        if (emailEl) emailEl.textContent = user.email;

        // üèÜ C·∫≠p nh·∫≠t badge Free / Premium
        if (user.isPremium) {
          freeBadge?.classList.add("hidden");
          premiumBadge?.classList.remove("hidden");
        } else {
          premiumBadge?.classList.add("hidden");
          freeBadge?.classList.remove("hidden");
        }

        // üü¶ C·∫≠p nh·∫≠t avatar
        if (avatarImg) {
          if (user.avatarUrl) {
            avatarImg.src = user.avatarUrl;
          } else {
            // T·∫°o avatar ch·ªØ c√°i ƒë·∫ßu
            const canvas = document.createElement("canvas");
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext("2d");
            ctx.fillStyle = "#2563eb"; // xanh d∆∞∆°ng
            ctx.beginPath();
            ctx.arc(50, 50, 50, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = "#fff";
            ctx.font = "bold 50px Inter, sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(user.name.charAt(0).toUpperCase(), 50, 55);
            avatarImg.src = canvas.toDataURL();
          }
        }
      } catch (err) {
        console.warn("‚ö†Ô∏è Auto-load user header failed:", err);
      }
    })();
  </script>
</header>
=======
                                      clip-rule="evenodd"/>
                            </svg>
                            <span>Premium</span>
                        </span>

                        <!-- üÜì Free -->
                        <span th:if="${user != null && !user.isPremium}"
                              class="bg-gray-200 text-gray-600 text-[11px] font-medium px-2 py-0.5
                                     rounded-full shadow-sm"
                              title="T√†i kho·∫£n mi·ªÖn ph√≠">Free</span>
                    </div>

                    <span class="block text-xs text-gray-500"
                          th:text="${user != null ? user.email : ''}">user@email.com</span>
                </div>

                <!-- Avatar -->
                <img th:src="${user != null && user.avatarUrl != null && !#strings.isEmpty(user.avatarUrl)
                              ? user.avatarUrl : '/photo/default-avatar.png'}"
                     class="rounded-full w-10 h-10 border-2 border-white shadow-lg object-cover"
                     alt="User Avatar"/>
            </div>

            <!-- Dropdown -->
            <div id="userDropdown"
                 class="hidden absolute right-0 mt-3 w-44 bg-white border border-gray-200
                        rounded-xl shadow-lg z-30">
                <a href="/user/view/profile"
                   class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-xl">
                    üë§ Profile
                </a>
                <a href="#" id="logoutBtn"
                   class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-b-xl">
                    üö™ Logout
                </a>
            </div>
        </div>
    </div>

    <script src="/js/logout.js"></script>
    <!-- ‚úÖ JavaScript -->
    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {
            // --- Notification ---
            const bell = document.getElementById("notificationBell");
            const notificationDropdown = document.getElementById("notificationDropdown");
            const notificationList = document.getElementById("notificationList");

            if (bell && notificationDropdown && notificationList) {
                bell.addEventListener("click", (e) => {
                    e.stopPropagation();
                    notificationDropdown.classList.toggle("hidden");
                    if (!notificationDropdown.classList.contains("hidden")) {
                        loadNotifications();
                    }
                });

                document.addEventListener("click", (e) => {
                    if (!notificationDropdown.contains(e.target) && !bell.contains(e.target)) {
                        notificationDropdown.classList.add("hidden");
                    }
                });
            }

            function loadNotifications() {
                fetch("/api/notifications")
                    .then((res) => res.json())
                    .then((notifications) => {
                        if (!notifications || notifications.length === 0) {
                            notificationList.innerHTML =
                                "<p class='p-4 text-gray-500 text-sm text-center'>Kh√¥ng c√≥ th√¥ng b√°o</p>";
                            return;
                        }
                        notificationList.innerHTML = "";
                        notifications.forEach((n) => {
                            const item = document.createElement("div");
                            item.className =
                                "px-4 py-3 hover:bg-gray-50 border-b border-gray-100 cursor-pointer transition";

                            // üîπ X√¢y ph·∫ßn n·ªôi dung th√¥ng b√°o
                            let contentHtml = "";
                            if (n.type === "WARNING" || n.type === "BAN") {
                                contentHtml = `
                                    <p class="text-sm font-medium text-gray-800">
                                        ${n.title || "Th√¥ng b√°o m·ªõi"}
                                    </p>
                                    <p class="text-xs text-gray-500 mt-0.5">
                                        ${n.message || "B·∫°n b·ªã b√°o c√°o vi ph·∫°m. Nh·∫•n ƒë·ªÉ xem chi ti·∫øt."}
                                    </p>
                                `;
                            } else {
                                contentHtml = `
                                    <p class="text-sm font-medium text-gray-800">
                                        ${n.title || "Th√¥ng b√°o m·ªõi"}
                                    </p>
                                    <p class="text-xs text-gray-500 mt-0.5">
                                        ${n.message || "B·∫°n c√≥ th√¥ng b√°o m·ªõi"}
                                    </p>
                                `;
                            }

                            // üîπ G·∫Øn n·ªôi dung ho√†n ch·ªânh
                            item.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div>${contentHtml}</div>
                            ${
                                n.status === "unread"
                                    ? "<span class='bg-blue-500 w-2 h-2 rounded-full mt-1'></span>"
                                    : ""
                            }
                            </div>
                        `;

                            item.addEventListener("click", () => {
                                fetch(`/api/notifications/${n.notificationId}/read`, { method: "PUT" })
                                    .then(() => {
                                        if (n.referenceId) {
                                            if (n.type === "WARNING" || n.type === "BAN") {
                                                window.location.href = `${n.link}`;
                                            }else if(n.type ==="PROJECT_CREATED"){
                                                window.location.href = `${n.link}`;
                                            } else {
                                                window.location.href = `/view/pm/project/board?projectId=${n.referenceId}`;
                                            }
                                        } else {
                                            notificationDropdown.classList.add("hidden");
                                        }
                                    })
                                    .catch(err => console.error("Mark as read error:", err));
                            });
                            notificationList.appendChild(item);
                        });
                    })
                    .catch(() => {
                        notificationList.innerHTML =
                            "<p class='p-4 text-gray-500 text-sm text-center'>Kh√¥ng th·ªÉ t·∫£i th√¥ng b√°o</p>";
                    });
            }

            // --- User Dropdown ---
            const userBtn = document.getElementById("userMenuButton");
            const userDropdown = document.getElementById("userDropdown");
            if (userBtn && userDropdown) {
                userBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    userDropdown.classList.toggle("hidden");
                });
                document.addEventListener("click", (e) => {
                    if (!userDropdown.contains(e.target) && !userBtn.contains(e.target)) {
                        userDropdown.classList.add("hidden");
                    }
                });
            }

            // --- Search ---
            const searchInput = document.getElementById("searchInput");
            const searchDropdown = document.getElementById("searchDropdown");
            const searchResults = document.getElementById("searchResults");

            function escapeHtml(unsafe) {
                if (!unsafe) return "";
                return unsafe.replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            if (searchInput && searchDropdown && searchResults) {
                let searchTimeout;

                searchInput.addEventListener("focus", () => {
                    searchDropdown.classList.remove("hidden");
                    searchResults.innerHTML =
                        "<p class='p-4 text-gray-500 text-sm text-center'>Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu t√¨m ki·∫øm...</p>";
                });

                document.addEventListener("click", (e) => {
                    if (!searchDropdown.contains(e.target) && e.target !== searchInput) {
                        searchDropdown.classList.add("hidden");
                    }
                });

                searchInput.addEventListener("input", () => {
                    clearTimeout(searchTimeout);
                    const query = searchInput.value.trim();
                    if (query.length < 1) {
                        searchResults.innerHTML =
                            "<p class='p-4 text-gray-500 text-sm text-center'>Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu t√¨m ki·∫øm...</p>";
                        return;
                    }

                    searchTimeout = setTimeout(() => {
                        fetch("/api/search?query=" + encodeURIComponent(query))
                            .then(res => res.json())
                            .then(data => {
                                if (!Array.isArray(data) || data.length === 0) {
                                    searchResults.innerHTML =
                                        "<p class='p-4 text-gray-500 text-sm text-center'>Kh√¥ng c√≥ k·∫øt qu·∫£</p>";
                                    return;
                                }

                                searchResults.innerHTML = data.map(function(item) {
                                    return '' +
                                        '<div class="px-4 py-3 hover:bg-gray-50 border-b border-gray-100 cursor-pointer transition" ' +
                                        '     onclick="window.location.href=\'/view/pm/project/board?projectId=' + item.projectId + '\'">' +
                                        '  <p class="text-sm font-semibold text-gray-800">' + escapeHtml(item.name) + '</p>' +
                                        '  <p class="text-xs text-gray-500 truncate">' + escapeHtml(item.description || "") + '</p>' +
                                        '  <p class="text-[11px] text-gray-400 mt-0.5">Status: ' + (item.status || "") + '</p>' +
                                        '</div>';
                                }).join("");
                            })
                            .catch(err => {
                                console.error("Search error:", err);
                                searchResults.innerHTML =
                                    "<p class='p-4 text-gray-500 text-sm text-center'>Kh√¥ng th·ªÉ t·∫£i k·∫øt qu·∫£</p>";
                            });
                    }, 300);
                });
            }
        });
    </script>
</header>
>>>>>>> payment
