<header
  th:fragment="header"
  class="bg-white p-4 flex justify-between items-center shadow-md sticky top-0 z-20 h-16 border-b border-gray-200"
>
  <div class="flex items-center space-x-3 w-64 flex-shrink-0">
    <img
      th:src="@{/photo/logo1.png}"
      alt="DevCollab Logo"
      class="w-9 h-9 rounded-lg shadow-sm"
    />
    <span class="text-2xl font-extrabold text-blue-700 tracking-wider">
      DevCollab
    </span>
  </div>

  <div class="flex-grow flex justify-center mx-10">
    <div class="relative w-full max-w-xl">
      <!-- üîç Icon t√¨m ki·∫øm -->
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        id="searchIcon"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
        />
      </svg>

      <!-- √î nh·∫≠p t√¨m ki·∫øm -->
      <input
        id="searchInput"
        type="text"
        placeholder="Search for anything..."
        class="border border-gray-200 rounded-full pl-12 pr-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-sm shadow-sm"
      />

      <!-- üîΩ Dropdown k·∫øt qu·∫£ t√¨m ki·∫øm -->
      <div
        id="searchDropdown"
        class="hidden absolute left-0 mt-3 w-full bg-white border border-gray-200 rounded-xl shadow-lg z-30"
      >
        <div class="p-3 border-b bg-gray-50 font-semibold text-gray-700">
          K·∫øt qu·∫£ t√¨m ki·∫øm
        </div>
        <div id="searchResults" class="max-h-80 overflow-y-auto">
          <p class="p-4 text-gray-500 text-sm text-center">
            Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu t√¨m ki·∫øm...
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="flex items-center space-x-6 flex-shrink-0">
    <!-- üîî Notification -->
    <div
      class="relative cursor-pointer p-2 rounded-full hover:bg-gray-100 transition"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6 text-gray-500"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        id="notificationBell"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
        />
      </svg>

      <span
        th:if="${unreadNotifications > 0}"
        th:text="${unreadNotifications}"
        class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 font-semibold"
      ></span>

      <div
        id="notificationDropdown"
        class="hidden absolute right-0 mt-3 w-80 bg-white border border-gray-200 rounded-xl shadow-lg z-30"
      >
        <div class="p-3 border-b bg-gray-50 font-semibold text-gray-700">
          Th√¥ng b√°o
        </div>
        <div id="notificationList" class="max-h-80 overflow-y-auto">
          <p class="p-4 text-gray-500 text-sm text-center">
            Kh√¥ng c√≥ th√¥ng b√°o
          </p>
        </div>
      </div>
    </div>

    <!-- üë§ User info + dropdown -->
    <div class="relative">
      <div
        id="userMenuButton"
        class="flex items-center space-x-3 cursor-pointer p-1 rounded-full hover:bg-gray-100 transition"
      >
        <div class="text-right leading-tight">
          <span
            class="block text-sm font-semibold text-gray-800"
            th:text="${user != null ? user.Name : 'User'}"
            >User</span
          >
          <span
            class="block text-xs text-gray-500"
            th:text="${user != null ? user.email : ''}"
            >user@email.com</span
          >
        </div>
        <img
          th:src="${user != null && user.avatarUrl != null && !#strings.isEmpty(user.avatarUrl) 
           ? user.avatarUrl 
           : '/photo/default-avatar.png'}"
          class="rounded-full w-10 h-10 border-2 border-white shadow-lg object-cover"
          alt="User Avatar"
        />
      </div>

      <!-- Dropdown user -->
      <div
        id="userDropdown"
        class="hidden absolute right-0 mt-3 w-44 bg-white border border-gray-200 rounded-xl shadow-lg z-30"
      >
        <a
          href="/user/view/profile"
          class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-xl"
        >
          üë§ Profile
        </a>
        <a
          href="#"
          id="logoutBtn"
          class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-b-xl"
        >
          üö™ Logout
        </a>
      </div>
    </div>
  </div>

  <!-- ‚úÖ JS -->
  <script th:inline="javascript">
    // ---------------- NOTIFICATION ----------------
    const bell = document.getElementById("notificationBell");
    const dropdown = document.getElementById("notificationDropdown");
    const listContainer = document.getElementById("notificationList");

    if (bell && dropdown && listContainer) {
      bell.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.classList.toggle("hidden");
        if (!dropdown.classList.contains("hidden")) loadNotifications();
      });

      document.addEventListener("click", (e) => {
        if (!dropdown.contains(e.target) && !bell.contains(e.target))
          dropdown.classList.add("hidden");
      });

      function getAuthToken() {
        const match = document.cookie.match(/AUTH_TOKEN=([^;]+)/);
        return match ? match[1] : localStorage.getItem("AUTH_TOKEN");
      }

      function loadNotifications() { //Ch∆∞a x·ª≠ l√Ω status = read khi nh·∫•n v√†o th√¥ng b√°o
        fetch("/api/notifications")
          .then((res) => res.json())
          .then((notifications) => {
            if (!notifications || notifications.length === 0) {
              listContainer.innerHTML =
                "<p class='p-4 text-gray-500 text-sm text-center'>Kh√¥ng c√≥ th√¥ng b√°o</p>";
              return;
            }
            listContainer.innerHTML = "";
            notifications.forEach((n) => {
              const item = document.createElement("div");
              item.className =
                "px-4 py-3 hover:bg-gray-50 border-b border-gray-100 cursor-pointer transition";
              item.innerHTML = `
      <div class="flex items-start justify-between">
        <div>
          <p class="text-sm font-medium text-gray-800">${
            n.title || "Th√¥ng b√°o m·ªõi"
          }</p>
          <p class="text-xs text-gray-500 mt-0.5">${n.message}</p>
        </div>
        ${
          n.status === "unread"
            ? `<span class="bg-blue-500 w-2 h-2 rounded-full mt-1"></span>`
            : ""
        }
      </div>`;

              // ‚¨áÔ∏è Khi click v√†o th√¥ng b√°o, chuy·ªÉn h∆∞·ªõng t·ªõi trang project t∆∞∆°ng ·ª©ng
              if (n.referenceId) {
                item.addEventListener("click", () => {
                  // ‚úÖ G·ª≠i y√™u c·∫ßu ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
                  fetch(`/api/notifications/${n.notificationId}/read`, {
                    method: "PUT",
                  })
                    .then(() => {
                      // Chuy·ªÉn h∆∞·ªõng sau khi ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
                      window.location.href = `/view/project/${n.referenceId}/tasks`;
                    })
                    .catch((err) => console.error("Mark as read error:", err));
                });
              } else {
                item.addEventListener("click", () => {
                  fetch(`/api/notifications/${n.notificationId}/read`, {
                    method: "PUT",
                  })
                    .then(() => dropdown.classList.add("hidden"))
                    .catch((err) => console.error("Mark as read error:", err));
                });
              }

              listContainer.appendChild(item);
            });
          })
          .catch(() => {
            listContainer.innerHTML =
              "<p class='p-4 text-gray-500 text-sm text-center'>Kh√¥ng th·ªÉ t·∫£i th√¥ng b√°o</p>";
          });
      }
    }

    // ---------------- USER DROPDOWN ----------------
    const userBtn = document.getElementById("userMenuButton");
    const userDropdown = document.getElementById("userDropdown");

    if (userBtn && userDropdown) {
      userBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        userDropdown.classList.toggle("hidden");
      });

      document.addEventListener("click", (e) => {
        if (!userDropdown.contains(e.target) && !userBtn.contains(e.target)) {
          userDropdown.classList.add("hidden");
        }
      });
    }

    // ---------------- SEARCH ----------------
    const searchInput = document.getElementById("searchInput");
    const searchDropdown = document.getElementById("searchDropdown");
    const searchResults = document.getElementById("searchResults");

    if (searchInput && searchDropdown) {
      searchInput.addEventListener("focus", () => {
        searchDropdown.classList.remove("hidden");
        searchResults.innerHTML =
          "<p class='p-4 text-gray-500 text-sm text-center'>Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu t√¨m ki·∫øm...</p>";
      });

      document.addEventListener("click", (e) => {
        if (!searchDropdown.contains(e.target) && e.target !== searchInput) {
          searchDropdown.classList.add("hidden");
        }
      });

      searchInput.addEventListener("input", () => {
        const query = searchInput.value.trim();
        if (query.length < 2) {
          searchResults.innerHTML =
            "<p class='p-4 text-gray-500 text-sm text-center'>Nh·∫≠p ƒë·ªÉ b·∫Øt ƒë·∫ßu t√¨m ki·∫øm...</p>";
          return;
        }

        fetch(`/api/search?query=${encodeURIComponent(query)}`)
          .then((res) => res.json())
          .then((data) => {
            if (!data || data.length === 0) {
              searchResults.innerHTML =
                "<p class='p-4 text-gray-500 text-sm text-center'>Kh√¥ng c√≥ k·∫øt qu·∫£</p>";
              return;
            }

            searchResults.innerHTML = data
              .map(
                (item) => `
            <div class="px-4 py-3 hover:bg-gray-50 border-b border-gray-100 cursor-pointer transition"
                onclick="window.location.href='/view/project/' + ${
                  item.projectId
                }">
              <p class="text-sm font-medium text-gray-800">${item.name}</p>
              <p class="text-xs text-gray-500">${item.description || ""}</p>
            </div>`
              )
              .join("");
          })
          .catch(() => {
            searchResults.innerHTML =
              "<p class='p-4 text-gray-500 text-sm text-center'>Kh√¥ng th·ªÉ t·∫£i k·∫øt qu·∫£</p>";
          });
      });
    }
    // ---------------- LOGOUT ----------------
    const logoutBtn = document.getElementById("logoutBtn");

    if (logoutBtn) {
      logoutBtn.addEventListener("click", (e) => {
        e.preventDefault();
        fetch("/api/auth/logout", {
          method: "POST",
          credentials: "include",
        })
          .then((res) => res.json())
          .then(() => {
            // X√≥a th·ªß c√¥ng ph√≠a client
            document.cookie = "AUTH_TOKEN=; Max-Age=0; path=/;";
            document.cookie = "REFRESH_TOKEN=; Max-Age=0; path=/;";
            localStorage.removeItem("AUTH_TOKEN");
            localStorage.removeItem("REFRESH_TOKEN");

            // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p
            window.location.href = "/view/signin";
          })
          .catch((err) => console.error("Logout error:", err));
      });
    }
  </script>
</header>
