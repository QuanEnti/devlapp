<header
  th:fragment="header"
  class="bg-white px-6 py-3 flex justify-between items-center shadow-sm sticky top-0 z-50 h-14 border-b border-gray-100"
>
  <!-- üîπ Logo -->
  <div class="flex items-center space-x-3 w-64 flex-shrink-0">
    <img
      th:src="@{/photo/logo1.png}"
      alt="DevCollab Logo"
      class="w-8 h-8 rounded-lg"
    />
    <span class="text-xl font-bold text-gray-800 tracking-tight"
      >DevCollab</span
    >
  </div>

  <!-- üîπ Search -->
  <div class="flex-grow flex justify-center mx-8">
    <div class="relative w-full max-w-2xl">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
        id="searchIcon"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
        />
      </svg>

      <input
        id="searchInput"
        type="text"
        placeholder="Search for anything..."
        class="border border-gray-200 rounded-md pl-10 pr-4 py-1.5 w-full focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 hover:bg-white text-sm transition-colors"
      />

      <div
        id="searchDropdown"
        class="hidden absolute left-0 mt-2 w-full bg-white border border-gray-200 rounded-lg shadow-lg z-[100]"
      >
        <div class="px-4 py-2.5 border-b border-gray-100 bg-gray-50/50">
          <span
            class="text-xs font-semibold text-gray-600 uppercase tracking-wide"
            >Search Results</span
          >
        </div>
        <div id="searchResults" class="max-h-80 overflow-y-auto">
          <p class="p-4 text-gray-500 text-sm text-center">
            Type to start searching...
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- üîπ Right side -->
  <div class="flex items-center space-x-3 flex-shrink-0">
    <div class="relative">
      <button
        id="open-notif-btn"
        class="relative text-gray-600 hover:text-gray-900 hover:bg-gray-100 p-2 rounded-md transition-colors"
        title="Notifications"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
          />
        </svg>
        <span
          id="notif-dot"
          class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full hidden border border-white"
        ></span>
        <span
          id="notif-count-badge"
          class="hidden absolute -top-0.5 -right-0.5 text-[10px] px-1.5 py-0.5 rounded-full bg-red-600 text-white font-semibold min-w-[18px] text-center border-2 border-white"
        ></span>
      </button>
    </div>
    <div
      id="notif-panel"
      class="hidden absolute right-0 top-14 w-[420px] bg-white rounded-lg shadow-xl border border-gray-200 overflow-hidden z-[9999]"
    >
      <div
        class="flex items-center justify-between px-5 py-3.5 border-b border-gray-200 bg-gray-50/50"
      >
        <h2 class="font-semibold text-gray-900 text-sm flex items-center gap-2">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 text-gray-600"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
            />
          </svg>
          Notifications
        </h2>

        <div class="flex items-center gap-2">
          <button
            id="mark-all-read"
            class="hidden text-xs text-blue-600 hover:text-blue-700 font-medium transition-colors px-2 py-1 hover:bg-blue-50 rounded"
          >
            Mark all as read
          </button>

          <!-- ‚ãØ Menu Button -->
          <div class="relative">
            <button
              id="notif-options-btn"
              class="text-gray-500 hover:text-gray-700 p-1.5 rounded hover:bg-gray-200 transition-colors"
              title="Settings"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
                />
              </svg>
            </button>

            <!-- Dropdown menu -->
            <div
              id="notif-options-menu"
              class="hidden absolute right-0 mt-1.5 w-56 bg-white border border-gray-200 rounded-lg shadow-xl overflow-hidden z-[10000]"
            >
              <ul class="py-1">
                <li>
                  <label
                    class="flex items-center justify-between px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 cursor-pointer"
                  >
                    <span class="flex items-center gap-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 text-gray-500"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                        />
                      </svg>
                      <span class="text-xs text-gray-600"
                        >Show unread only</span
                      >
                    </span>
                    <input
                      id="toggle-unread"
                      type="checkbox"
                      class="sr-only peer"
                    />
                    <div
                      class="w-9 h-5 bg-gray-300 rounded-full relative after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:w-4 after:h-4 after:bg-white after:rounded-full after:transition-all peer-checked:bg-blue-600 peer-checked:after:translate-x-4"
                    ></div>
                  </label>
                </li>
                <li class="border-t border-gray-100 my-1"></li>
                <li>
                  <button
                    id="toggle-email-btn"
                    type="button"
                    class="w-full text-left px-3 py-2 text-sm flex items-center justify-between hover:bg-gray-50 transition text-gray-700"
                  >
                    <div class="flex items-center gap-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4 text-gray-500"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                        />
                      </svg>
                      <span id="email-toggle-text" class="text-xs">
                        Disable Gmail notifications
                      </span>
                    </div>
                    <div
                      id="email-toggle-icon"
                      class="w-8 h-4 flex items-center bg-gray-300 rounded-full p-0.5 transition-all duration-300"
                    >
                      <div
                        class="dot bg-white w-3.5 h-3.5 rounded-full transform translate-x-0 transition-all duration-300"
                      ></div>
                    </div>
                  </button>
                </li>
                <li>
                  <a
                    id="open-settings-link"
                    href="/settings/notifications"
                    class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 transition"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4 text-gray-500"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                      />
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                      />
                    </svg>
                    <span class="text-xs">All notification settings</span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <!-- Empty State -->
      <div
        id="notif-empty"
        class="hidden flex flex-col items-center justify-center py-16"
      >
        <img
          src="https://cdn-icons-png.flaticon.com/512/616/616408.png"
          alt="empty"
          class="w-24 h-24 opacity-80 mb-3"
        />
        <p class="text-gray-500 text-sm font-medium">No new notifications</p>
        <p class="text-gray-400 text-xs mt-1">
          All notifications have been read
        </p>
      </div>

      <!-- List (render ƒë·ªông) -->
      <div id="notif-list" class="max-h-[500px] overflow-y-auto">
        <!-- JS s·∫Ω render n·ªôi dung v√†o ƒë√¢y -->
      </div>
    </div>
    <!-- üë§ User info -->
    <div class="relative">
      <div
        id="userMenuButton"
        class="flex items-center space-x-2 cursor-pointer p-1.5 rounded-md hover:bg-gray-100 transition-colors"
      >
        <!-- Avatar -->
        <img
          th:src="${user != null && user.avatarUrl != null && !#strings.isEmpty(user.avatarUrl)
                              ? user.avatarUrl : '/photo/default-avatar.png'}"
          class="rounded-full w-8 h-8 border border-gray-200 object-cover"
          alt="User Avatar"
        />
        <div class="text-left leading-tight hidden md:block">
          <div class="flex items-center space-x-1.5">
            <span
              class="block text-sm font-medium text-gray-700"
              th:text="${user != null ? user.name : 'User'}"
              >User</span
            >

            <!-- üèÜ Premium -->
            <span
              th:if="${user != null && (user.isPremium || user.premium)}"
              class="bg-yellow-400 text-white text-[10px] font-bold px-1.5 py-0.5 rounded flex items-center space-x-0.5"
              title="Premium Account"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 20 20"
                class="w-3 h-3"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 2a1 1 0 01.894.553l1.382 2.802
                  3.09.45a1 1 0 01.554 1.707l-2.236
                  2.18.528 3.078a1 1 0 01-1.45
                  1.054L10 12.347l-2.762
                  1.457a1 1 0 01-1.45-1.054l.528-3.078-2.236-2.18a1
                  1 0 01.554-1.707l3.09-.45L9.106
                  2.553A1 1 0 0110 2z"
                  clip-rule="evenodd"
                />
              </svg>
              <span>Premium</span>
            </span>

            <!-- üÜì Free -->
            <span
              th:if="${user != null && !(user.isPremium || user.premium)}"
              class="bg-gray-200 text-gray-600 text-[10px] font-medium px-1.5 py-0.5 rounded"
              title="Free Account"
            >
              Free
            </span>
          </div>
        </div>
      </div>

      <!-- Dropdown -->
      <div
        id="userDropdown"
        class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-[100] overflow-hidden"
      >
        <div class="px-4 py-3 border-b border-gray-100 bg-gray-50/50">
          <p
            class="text-sm font-semibold text-gray-900"
            th:text="${user != null ? user.name : 'User'}"
          >
            User
          </p>
          <p
            class="text-xs text-gray-500 mt-0.5"
            th:text="${user != null ? user.email : ''}"
          >
            user@email.com
          </p>
        </div>
        <a
          href="/user/view/profile"
          class="flex items-center gap-2 px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
            />
          </svg>
          Profile
        </a>
        <a
          href="#"
          id="logoutBtn"
          class="flex items-center gap-2 px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
            />
          </svg>
          Logout
        </a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2/dist/stomp.min.js"></script>

  <script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
      // ================== üîî NOTIFICATIONS PANEL ==================
      const notifBtn = document.getElementById("open-notif-btn");
      const notifPanel = document.getElementById("notif-panel");
      const notifList = document.getElementById("notif-list");
      const notifEmpty = document.getElementById("notif-empty");
      const toggleUnread = document.getElementById("toggle-unread");
      const notifDot = document.getElementById("notif-dot");
      const markAllBtn = document.getElementById("mark-all-read");
      const closeNotifPanel = document.getElementById("close-notif-panel");
      const notifCountBadge = document.getElementById("notif-count-badge");

      function updateUnreadBadge(count) {
        if (!notifCountBadge) return;
        const c = Number(count) || 0;
        if (c <= 0) {
          notifCountBadge.classList.add("hidden");
          notifCountBadge.textContent = "";
          notifDot?.classList.add("hidden");
        } else {
          notifCountBadge.classList.remove("hidden");
          notifCountBadge.textContent = c > 99 ? "99+" : String(c);
          notifDot?.classList.remove("hidden");
        }
      }

      // TƒÉng 1 khi nh·∫≠n realtime (n·∫øu panel ƒëang ƒë√≥ng)
      function incrementUnreadBadge() {
        if (!notifCountBadge) return;
        const isOpen = !document
          .getElementById("notif-panel")
          .classList.contains("hidden");
        if (isOpen) return; // panel m·ªü th√¨ s·∫Ω reload list v√† t√≠nh l·∫°i

        const cur = parseInt(notifCountBadge.textContent) || 0;
        updateUnreadBadge(cur + 1);
      }

      // ================== üì• Load Notifications (Tre llo-style) ==================
      async function loadNotifications(onlyUnread = false) {
        const token = localStorage.getItem("token");
        notifList.innerHTML = `<p class="text-gray-400 text-sm italic text-center py-4">Loading...</p>`;
        notifEmpty.classList.add("hidden");

        try {
          const headers = {};
          if (token) {
            headers.Authorization = `Bearer ${token}`;
          }
          const res = await fetch(`/api/notifications`, {
            headers,
          });
          if (!res.ok)
            throw new Error(`Failed to fetch notifications (${res.status})`);

          const data = await res.json();
          const list = Array.isArray(data)
            ? data
            : data?.content || data?.notifications || data?.data || [];

          const totalUnread = list.filter(
            (n) => n.status && n.status.toLowerCase() !== "read"
          ).length;
          updateUnreadBadge(totalUnread);

          const filtered = onlyUnread
            ? list.filter((n) => n.status && n.status.toLowerCase() !== "read")
            : list;

          if (filtered.length === 0) {
            notifEmpty.classList.remove("hidden");
            notifList.innerHTML = "";
            markAllBtn?.classList.add("hidden");
            notifDot.classList.add("hidden");
            return;
          }

          const hasUnread = list.some(
            (n) => n.status && n.status.toLowerCase() !== "read"
          );
          notifDot.classList.toggle("hidden", !hasUnread);
          markAllBtn?.classList.remove("hidden");

          notifList.innerHTML = filtered
            .map((n) => {
              const id = n.notificationId || n.id;
              const link = n.link || "#";
              const msg = n.message || "";
              const createdAt = n.createdAt || new Date().toISOString();
              const isRead = n.status && n.status.toLowerCase() === "read";
              const senderName = n.senderName || "H·ªá th·ªëng";
              const senderAvatar =
                n.senderAvatar && n.senderAvatar.trim() !== ""
                  ? n.senderAvatar
                  : "https://cdn-icons-png.flaticon.com/512/149/149071.png";

              // T·∫°o avatar ch·ªØ c√°i ƒë·∫ßu n·∫øu kh√¥ng c√≥ avatar
              const avatarInitial = senderName.charAt(0).toUpperCase();
              const avatarBgColors = [
                "#3b82f6", // Blue
                "#10b981", // Green
                "#8b5cf6", // Purple
                "#f59e0b", // Amber
                "#ef4444", // Red
                "#06b6d4", // Cyan
                "#ec4899", // Pink
                "#14b8a6", // Teal
                "#f97316", // Orange
                "#6366f1", // Indigo
              ];
              // S·ª≠ d·ª•ng hash c·ªßa to√†n b·ªô t√™n ƒë·ªÉ c√≥ m√†u ƒëa d·∫°ng h∆°n
              let hash = 0;
              for (let i = 0; i < senderName.length; i++) {
                hash = senderName.charCodeAt(i) + ((hash << 5) - hash);
              }
              const avatarBgColor =
                avatarBgColors[Math.abs(hash) % avatarBgColors.length];

              return `
            <div onclick="handleNotificationClick(${id}, '${link}')"
                class="px-4 py-2.5 hover:bg-gray-50 transition-colors cursor-pointer border-b border-gray-100 last:border-b-0 ${
                  isRead ? "bg-white" : "bg-blue-50/50"
                }">
              <div class="flex items-start gap-2.5">
                <div class="relative flex-shrink-0">
                  ${
                    senderAvatar && senderAvatar.includes("http")
                      ? `<img 
                          src="${senderAvatar}" 
                          class="w-8 h-8 rounded-full border border-gray-200 object-cover" 
                          alt="avatar"
                          onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                        />`
                      : ""
                  }
                  <div 
                    class="${
                      senderAvatar && senderAvatar.includes("http")
                        ? "hidden"
                        : "flex"
                    } w-8 h-8 rounded-full items-center justify-center text-white font-semibold text-[11px]"
                    style="background-color: ${avatarBgColor};"
                  >
                    ${avatarInitial}
                  </div>
                  ${
                    !isRead
                      ? `<span class="absolute -top-0.5 -right-0.5 w-2.5 h-2.5 bg-blue-500 rounded-full border-2 border-white"></span>`
                      : ""
                  }
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-start justify-between gap-2 mb-0.5">
                    <p class="text-gray-900 font-semibold text-[13px] leading-tight">${senderName}</p>
                    <p class="text-[11px] text-gray-400 whitespace-nowrap flex-shrink-0 leading-tight">${formatRelativeTime(
                      createdAt
                    )}</p>
                  </div>
                  <p class="text-gray-600 text-[13px] leading-relaxed break-words">${msg}</p>
                </div>
              </div>
            </div>`;
            })
            .join("");
        } catch (err) {
          console.error("‚ùå loadNotifications:", err);
          notifList.innerHTML = `<p class="text-red-500 text-sm text-center py-4">Failed to load notifications</p>`;
        }
      }

      // ================== ‚úÖ Mark Read ==================
      async function markNotificationRead(id) {
        if (!id) return;
        const token = localStorage.getItem("token");
        try {
          const headers = {};
          if (token) {
            headers.Authorization = `Bearer ${token}`;
          }
          const res = await fetch(`/api/notifications/${id}/read`, {
            method: "PUT",
            headers,
          });
          if (!res.ok) console.warn("‚ö†Ô∏è Failed to mark read:", res.status);
        } catch (err) {
          console.error("‚ùå markNotificationRead:", err);
        }
      }

      // ================== ‚úÖ Mark All as Read ==================
      async function markAllNotificationsRead() {
        const token = localStorage.getItem("token");
        try {
          const headers = {};
          if (token) {
            headers.Authorization = `Bearer ${token}`;
          }
          const res = await fetch(`/api/notifications/read-all`, {
            method: "PUT",
            headers,
          });
          if (!res.ok) throw new Error("Failed to mark all as read");
          await loadNotifications(toggleUnread.checked);
          updateUnreadBadge(0);
        } catch (err) {
          console.error("‚ùå markAllNotificationsRead:", err);
        }
      }
      if (markAllBtn)
        markAllBtn.addEventListener("click", markAllNotificationsRead);

      // ================== üîó Handle Click Notification ==================
      async function handleNotificationClick(id, link) {
        console.log("üü£ CLICK:", id, link);
        await markNotificationRead(id);
        // Gi·∫£m 1 local (UI) ‚Äì server s·∫Ω sync l·∫°i khi reload panel
        const cur =
          parseInt(document.getElementById("notif-count-badge")?.textContent) ||
          0;
        if (cur > 0) updateUnreadBadge(cur - 1);

        if (!link || link === "#" || link === "null") {
          console.log("‚ÑπÔ∏è No link to redirect.");
          return;
        }

        // üß© Tr∆∞·ªùng h·ª£p task notification
        if (link.includes("/tasks/")) {
          const taskId = link.split("taskId=")[1] || link.split("/tasks/")[1];
          if (taskId) {
            await openTaskDetailFromApi(taskId);
            return;
          }
        }

        // üß≠ N·∫øu l√† link d·ª± √°n th√¨ m·ªü n·ªôi b·ªô (c√πng tab)
        if (link.startsWith("/view/pm/project/")) {
          window.location.href = link; // üëâ Chuy·ªÉn n·ªôi b·ªô thay v√¨ m·ªü tab m·ªõi
          return;
        }

        // üåê M·∫∑c ƒë·ªãnh m·ªü tab m·ªõi
        window.open(link, "_blank");
      }
      window.handleNotificationClick = handleNotificationClick;

      async function openTaskDetailFromApi(taskId) {
        try {
          const token = localStorage.getItem("token");
          const headers = {};
          if (token) {
            headers.Authorization = "Bearer " + token;
          }
          const res = await fetch(`/api/tasks/${taskId}`, {
            headers,
          });
          if (!res.ok) throw new Error("Failed to load task");
          const task = await res.json();
          openTaskModal(task);
        } catch (err) {
          console.error("‚ùå openTaskDetailFromApi:", err);
          showToast("Failed to load task information.", "error");
        }
      }

      // ================== ü™ü Render Task Detail into Modal ==================
      function openTaskModal(task) {
        const modal = document.getElementById("task-detail-modal");
        if (!modal) {
          console.error("‚ùå Modal task-detail-modal not found in DOM");
          return;
        }

        const titleEl = modal.querySelector("h2.text-2xl");
        if (titleEl) titleEl.textContent = task.title || "(Untitled Task)";

        const descContent = modal.querySelector("#description-content");
        const descPlaceholder = modal.querySelector("#description-placeholder");
        if (descContent && descPlaceholder) {
          if (task.descriptionMd && task.descriptionMd.trim() !== "") {
            descContent.textContent = task.descriptionMd;
            descPlaceholder.classList.add("hidden");
          } else {
            descContent.textContent = "";
            descPlaceholder.classList.remove("hidden");
          }
        }

        const dueText = modal.querySelector("#due-date-text");
        const dueStatus = modal.querySelector("#due-date-status");
        if (dueText && dueStatus) {
          if (task.deadline) {
            const date = new Date(task.deadline);
            dueText.textContent = date.toLocaleString();
            dueStatus.textContent = "Due";
            dueStatus.className =
              "ml-2 text-xs font-medium rounded px-2 py-0.5 bg-yellow-100 text-yellow-700";
          } else {
            dueText.textContent = "No due date";
            dueStatus.textContent = "None";
            dueStatus.className =
              "ml-2 text-xs font-medium rounded px-2 py-0.5 bg-gray-200 text-gray-600";
          }
        }

        const attachList = modal.querySelector("#attachments-list");
        if (attachList) {
          if (task.attachments && task.attachments.length > 0) {
            attachList.innerHTML = task.attachments
              .map(
                (a) => `
          <div class="flex items-center justify-between border rounded px-3 py-2">
            <a href="${
              a.fileUrl
            }" target="_blank" class="text-blue-600 hover:underline truncate">${
                  a.fileName
                }</a>
            <span class="text-xs text-gray-400">${new Date(
              a.uploadedAt
            ).toLocaleDateString()}</span>
          </div>`
              )
              .join("");
          } else {
            attachList.innerHTML = `<p class="text-gray-400 italic">No attachments yet.</p>`;
          }
        }

        if (typeof loadActivityFeed === "function") {
          loadActivityFeed(task.taskId);
        }

        modal.classList.remove("hidden");
      }

      // ================== üì° WebSocket Realtime Notifications ==================
      let stompClient = null;
      let wsConnected = false;
      let wsRetry = 0;
      const WS_MAX_RETRY = 8; // t·ªëi ƒëa 8 l·∫ßn (‚âà ~30s backoff)
      const WS_BASE_DELAY = 1000; // 1s
      const WS_MAX_DELAY = 30000; // 30s
      let wsSubscription = null;

      function backoffDelay(attempt) {
        // exponential backoff + jitter
        const expo = Math.min(
          WS_MAX_DELAY,
          WS_BASE_DELAY * Math.pow(2, attempt)
        );
        return Math.floor(expo * (0.7 + Math.random() * 0.6)); // 70%‚Äì130% jitter
      }

      async function connectWebSocketNotifications() {
        let token = localStorage.getItem("token");

        if (!token) {
          try {
            const res = await fetch("/api/auth/me", { credentials: "include" });
            if (res.ok) {
              const data = await res.json();
              console.log(
                "‚úÖ Fallback via cookie:",
                data.email || data.user?.email
              );
            } else {
              console.warn(
                "‚ö†Ô∏è Cannot authenticate cookie, WS will not connect"
              );
              return;
            }
          } catch (err) {
            console.error("‚ùå Error authenticating cookie:", err);
            return;
          }
        }

        // 3Ô∏è‚É£ Ti·∫øp t·ª•c k·∫øt n·ªëi (c√≥ ho·∫∑c kh√¥ng c√≥ token)
        if (stompClient && wsConnected) return;

        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.heartbeat.outgoing = 15000;
        stompClient.heartbeat.incoming = 15000;

        const headers = token ? { Authorization: `Bearer ${token}` } : {};
        stompClient.connect(
          headers,
          (frame) => {
            console.log("‚úÖ WS connected:", frame);
            wsConnected = true;
            wsRetry = 0;

            // h·ªßy sub c≈©
            if (
              wsSubscription &&
              typeof wsSubscription.unsubscribe === "function"
            ) {
              try {
                wsSubscription.unsubscribe();
              } catch {}
            }

            wsSubscription = stompClient.subscribe(
              "/user/queue/notifications",
              (message) => {
                try {
                  const notif = JSON.parse(message.body);
                  console.log("üîî Realtime:", notif);
                  incrementUnreadBadge();

                  if (
                    !document
                      .getElementById("notif-panel")
                      .classList.contains("hidden")
                  ) {
                    loadNotifications(
                      document.getElementById("toggle-unread").checked
                    );
                  } else {
                    showToastNotification(
                      notif.title,
                      notif.message,
                      notif.senderAvatar,
                      notif.senderName
                    );
                  }
                } catch (e) {
                  console.error("‚ùå WS message parse:", e);
                }
              }
            );
          },
          (error) => {
            console.warn("‚ö†Ô∏è WS connect ERROR:", error);
            scheduleWsReconnect();
          }
        );

        socket.onclose = () => {
          console.warn("‚ö†Ô∏è WS closed");
          wsConnected = false;
          scheduleWsReconnect();
        };
      }

      function scheduleWsReconnect() {
        if (wsConnected) return; // ƒë√£ k·∫øt n·ªëi l·∫°i
        if (wsRetry >= WS_MAX_RETRY) {
          console.error("üö´ WS max retries reached ‚Äî stop reconnecting");
          return;
        }
        const delay = backoffDelay(wsRetry);
        console.log(
          `‚è≥ WS reconnect in ${Math.round(delay / 1000)}s (attempt ${
            wsRetry + 1
          }/${WS_MAX_RETRY})`
        );
        setTimeout(() => {
          wsRetry++;
          connectWebSocketNotifications();
        }, delay);
      }

      // ================== üéØ Event bindings ==================
      const toggleUnreadEl = document.getElementById("toggle-unread");
      if (toggleUnreadEl) {
        toggleUnreadEl.addEventListener("change", (e) =>
          loadNotifications(e.target.checked)
        );
      }

      notifBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        notifPanel.classList.toggle("hidden");
        if (!notifPanel.classList.contains("hidden"))
          loadNotifications(toggleUnread.checked);
      });

      closeNotifPanel?.addEventListener("click", () =>
        notifPanel.classList.add("hidden")
      );

      document.addEventListener("click", (e) => {
        if (!notifPanel.contains(e.target) && !notifBtn.contains(e.target)) {
          notifPanel.classList.add("hidden");
        }
      });

      // üîÅ Auto refresh m·ªói 30s
      setInterval(() => {
        if (!notifPanel.classList.contains("hidden"))
          loadNotifications(toggleUnread.checked);
      }, 30000);

      // ====== ‚ãØ NOTIFICATION SETTINGS MENU ======
      const notifMenuBtn = document.getElementById("notif-options-btn");
      const notifMenu = document.getElementById("notif-options-menu");
      const toggleEmailBtn = document.getElementById("toggle-email-btn");
      const emailToggleText = document.getElementById("email-toggle-text");

      let emailEnabled = true;

      notifMenuBtn?.addEventListener("click", (e) => {
        e.stopPropagation();
        notifMenu.classList.toggle("hidden");
      });

      // ƒê√≥ng khi click ra ngo√†i
      document.addEventListener("click", (e) => {
        if (!notifMenu.contains(e.target) && !notifMenuBtn.contains(e.target)) {
          notifMenu.classList.add("hidden");
        }
      });

      // G·ªçi API b·∫≠t/t·∫Øt Gmail notification
      toggleEmailBtn?.addEventListener("click", async (e) => {
        e.preventDefault(); // üõë NgƒÉn h√†nh vi m·∫∑c ƒë·ªãnh
        e.stopPropagation(); // üõë Kh√¥ng lan sang <a> b√™n d∆∞·ªõi

        emailEnabled = !emailEnabled;

        try {
          const token = localStorage.getItem("token");
          const headers = {
            "Content-Type": "application/json",
          };
          if (token) {
            headers.Authorization = `Bearer ${token}`;
          }

          const res = await fetch("/api/settings/notifications/email-toggle", {
            method: "POST",
            headers,
            body: JSON.stringify({ enabled: emailEnabled }),
          });

          if (res.ok) {
            emailToggleText.textContent = emailEnabled
              ? "Disable Gmail notifications"
              : "Enable Gmail notifications";
            showToast(
              emailEnabled
                ? "‚úÖ Gmail notifications enabled"
                : "üö´ Gmail notifications disabled"
            );
          } else {
            showToast("‚ö†Ô∏è Failed to update settings.");
          }
        } catch (err) {
          console.error("‚ùå toggleEmailBtn error:", err);
          showToast("‚ö†Ô∏è Server connection error.");
        }

        notifMenu.classList.add("hidden");
      });
      // ================== SETTINGS LINK ==================
      window.addEventListener("DOMContentLoaded", () => {
        const openSettingsLink = document.getElementById("open-settings-link");
        if (!openSettingsLink) return;

        openSettingsLink.addEventListener("click", async (e) => {
          e.preventDefault();

          try {
            // 1Ô∏è‚É£ Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p qua API
            const meRes = await fetch("/api/auth/me", {
              credentials: "include",
            });

            if (!meRes.ok) {
              showToast(
                "You are not logged in! Please login to continue.",
                "warning"
              );
              setTimeout(() => (window.location.href = "/view/signin"), 1500);
              return;
            }

            const userData = await meRes.json();

            // 2Ô∏è‚É£ L∆∞u l·∫°i email (tu·ª≥ ch·ªçn, n·∫øu c·∫ßn)
            if (userData.email) {
              localStorage.setItem("currentUserEmail", userData.email);
            }

            // 3Ô∏è‚É£ Ki·ªÉm tra quy·ªÅn truy c·∫≠p c√†i ƒë·∫∑t (d√πng c√πng cookie)
            const res = await fetch("/api/settings/notifications/me", {
              credentials: "include", //
            });

            if (!res.ok) {
              showToast(
                "Cannot access settings page. Please login again!",
                "error"
              );
              setTimeout(() => (window.location.href = "/view/signin"), 1500);
              return;
            }

            // ‚úÖ Th√†nh c√¥ng ‚Üí ƒëi·ªÅu h∆∞·ªõng
            window.location.href = "/settings/notifications";
          } catch (err) {
            console.error("‚ö†Ô∏è openSettingsLink error:", err);
            showToast("Connection error. Please try again later.", "error");
          }
        });
      });

      // ================== WEBSOCKET ==================
      window.addEventListener("load", () => {
        try {
          connectWebSocketNotifications();
        } catch (err) {
          console.warn("‚ö†Ô∏è Failed to initialize WebSocket:", err);
        }
      });

      // --- User Dropdown ---
      const userBtn = document.getElementById("userMenuButton");
      const userDropdown = document.getElementById("userDropdown");
      if (userBtn && userDropdown) {
        userBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          userDropdown.classList.toggle("hidden");
        });
        document.addEventListener("click", (e) => {
          if (!userDropdown.contains(e.target) && !userBtn.contains(e.target)) {
            userDropdown.classList.add("hidden");
          }
        });
      }
      function formatRelativeTime(isoString) {
        const now = new Date();
        const date = new Date(isoString);
        const diff = Math.floor((now - date) / 60000);
        if (diff < 1) return "just now";
        if (diff < 60) return `${diff} min${diff > 1 ? "s" : ""} ago`;
        const hrs = Math.floor(diff / 60);
        if (hrs < 24) return `${hrs} hour${hrs > 1 ? "s" : ""} ago`;
        const days = Math.floor(hrs / 24);
        return `${days} day${days > 1 ? "s" : ""} ago`;
      }
      // --- Search ---
      const searchInput = document.getElementById("searchInput");
      const searchDropdown = document.getElementById("searchDropdown");
      const searchResults = document.getElementById("searchResults");

      function escapeHtml(unsafe) {
        if (!unsafe) return "";
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      if (searchInput && searchDropdown && searchResults) {
        let searchTimeout;

        searchInput.addEventListener("focus", () => {
          searchDropdown.classList.remove("hidden");
          searchResults.innerHTML =
            "<p class='p-4 text-gray-500 text-sm text-center'>Type to start searching...</p>";
        });

        document.addEventListener("click", (e) => {
          if (!searchDropdown.contains(e.target) && e.target !== searchInput) {
            searchDropdown.classList.add("hidden");
          }
        });

        searchInput.addEventListener("input", () => {
          clearTimeout(searchTimeout);
          const query = searchInput.value.trim();
          if (query.length < 1) {
            searchResults.innerHTML =
              "<p class='p-4 text-gray-500 text-sm text-center'>Type to start searching...</p>";
            return;
          }

          searchTimeout = setTimeout(() => {
            fetch("/api/search?query=" + encodeURIComponent(query))
              .then((res) => res.json())
              .then((data) => {
                if (!Array.isArray(data) || data.length === 0) {
                  searchResults.innerHTML =
                    "<p class='p-4 text-gray-500 text-sm text-center'>No results found</p>";
                  return;
                }

                searchResults.innerHTML = data
                  .map(function (item) {
                    return (
                      "" +
                      '<div class="px-4 py-3 hover:bg-gray-50 border-b border-gray-100 cursor-pointer transition" ' +
                      "     onclick=\"window.location.href='/view/pm/project/board?projectId=" +
                      item.projectId +
                      "'\">" +
                      '  <p class="text-sm font-semibold text-gray-800">' +
                      escapeHtml(item.name) +
                      "</p>" +
                      '  <p class="text-xs text-gray-500 truncate">' +
                      escapeHtml(item.description || "") +
                      "</p>" +
                      '  <p class="text-[11px] text-gray-400 mt-0.5">Status: ' +
                      (item.status || "") +
                      "</p>" +
                      "</div>"
                    );
                  })
                  .join("");
              })
              .catch((err) => {
                console.error("Search error:", err);
                searchResults.innerHTML =
                  "<p class='p-4 text-gray-500 text-sm text-center'>Failed to load results</p>";
              });
          }, 300);
        });
      }

      // Utility function to escape HTML
      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // --- Logout ---
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", (e) => {
          e.preventDefault();
          fetch("/api/auth/logout", { method: "POST", credentials: "include" })
            .then(() => {
              // Clear cookies
              document.cookie =
                "AUTH_TOKEN=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
              document.cookie =
                "REFRESH_TOKEN=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

              // Clear localStorage
              localStorage.removeItem("AUTH_TOKEN");
              localStorage.removeItem("REFRESH_TOKEN");

              // Redirect to login page
              window.location.href = "/view/signin";
            })
            .catch((err) => console.error("Logout error:", err));
        });
      }
    });
  </script>
  <script>
    (async () => {
      try {
        // üë§ L·∫•y c√°c ph·∫ßn t·ª≠ trong header
        const nameEl = document.querySelector(
          "#userMenuButton span[th\\:text]"
        );
        const emailEl = document.querySelector("#userMenuButton .text-xs");
        const freeBadge = document.querySelector(
          "#userMenuButton .bg-gray-200"
        );
        const premiumBadge = document.querySelector(
          "#userMenuButton .bg-yellow-400"
        );
        const avatarImg = document.querySelector(
          '#userMenuButton img[alt="User Avatar"]'
        );

        // üîç QUAN TR·ªåNG: Ki·ªÉm tra xem Thymeleaf ƒë√£ render badge ch∆∞a
        const hasThymeleafBadge =
          freeBadge &&
          premiumBadge &&
          (!freeBadge.classList.contains("hidden") ||
            !premiumBadge.classList.contains("hidden"));

        // N·∫øu Thymeleaf ƒë√£ render badge th√†nh c√¥ng, KH√îNG l√†m g√¨ c·∫£
        if (hasThymeleafBadge) {
          console.log("‚úÖ Thymeleaf ƒë√£ render badge - kh√¥ng c·∫ßn JavaScript");
          return;
        }

        // N·∫øu Thymeleaf ch∆∞a render (trang kh√¥ng d√πng Thymeleaf ho·∫∑c l·ªói), th√¨ m·ªõi fetch API
        console.log("üîÑ Thymeleaf ch∆∞a render - d√πng JavaScript fallback");

        const token = localStorage.getItem("token");
        const res = await fetch("/api/auth/me", {
          headers: token ? { Authorization: "Bearer " + token } : {},
          credentials: "include",
        });

        if (!res.ok) throw new Error("Unauthorized");
        const data = await res.json();
        const u = data.user || data;

        const user = {
          name: u.name || u.fullName || "User",
          email: u.email || "",
          avatarUrl:
            u.avatarUrl && u.avatarUrl.trim() !== "" ? u.avatarUrl : "",
          isPremium:
            !!u.isPremium ||
            !!u.premium ||
            (u.roles || []).includes("ROLE_PREMIUM"),
        };

        // üü© Ch·ªâ c·∫≠p nh·∫≠t n·∫øu element t·ªìn t·∫°i V√Ä ch∆∞a c√≥ n·ªôi dung t·ª´ Thymeleaf
        if (
          nameEl &&
          (!nameEl.textContent || nameEl.textContent.trim() === "User")
        ) {
          nameEl.textContent = user.name;
        }
        if (
          emailEl &&
          (!emailEl.textContent || emailEl.textContent.trim() === "")
        ) {
          emailEl.textContent = user.email;
        }

        // üèÜ C·∫≠p nh·∫≠t badge Free / Premium - CH·ªà khi ch∆∞a c√≥ t·ª´ Thymeleaf
        if (freeBadge && premiumBadge) {
          if (
            freeBadge.classList.contains("hidden") &&
            premiumBadge.classList.contains("hidden")
          ) {
            // C·∫£ hai ƒë·ªÅu hidden -> ch∆∞a ƒë∆∞·ª£c render t·ª´ Thymeleaf
            if (user.isPremium) {
              freeBadge.classList.add("hidden");
              premiumBadge.classList.remove("hidden");
            } else {
              premiumBadge.classList.add("hidden");
              freeBadge.classList.remove("hidden");
            }
          }
          // N·∫øu m·ªôt trong hai ƒëang hi·ªán -> Thymeleaf ƒë√£ render, kh√¥ng l√†m g√¨
        }

        // üü¶ C·∫≠p nh·∫≠t avatar - CH·ªà khi avatar m·∫∑c ƒë·ªãnh
        if (avatarImg && avatarImg.src.includes("default-avatar.png")) {
          if (user.avatarUrl) {
            avatarImg.src = user.avatarUrl;
          } else {
            // T·∫°o avatar ch·ªØ c√°i ƒë·∫ßu
            const canvas = document.createElement("canvas");
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext("2d");
            ctx.fillStyle = "#2563eb";
            ctx.beginPath();
            ctx.arc(50, 50, 50, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = "#fff";
            ctx.font = "bold 50px Inter, sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(user.name.charAt(0).toUpperCase(), 50, 55);
            avatarImg.src = canvas.toDataURL();
          }
        }
      } catch (err) {
        console.warn("‚ö†Ô∏è Auto-load user header failed:", err);
      }
    })();

    // Toast function (if not already defined)
    if (typeof showToast === "undefined") {
      function showToast(message, type = "info") {
        const cleanMessage = message.replace(/[‚úÖ‚ùå‚ö†Ô∏èüö´üîí]/g, "").trim();
        const toast = document.createElement("div");
        toast.textContent = cleanMessage || message;

        let bgClass = "bg-blue-600";
        if (
          type === "error" ||
          message.includes("‚ùå") ||
          message.includes("Failed") ||
          message.includes("Error") ||
          message.includes("Cannot")
        ) {
          bgClass = "bg-red-600";
        } else if (type === "warning" || message.includes("‚ö†Ô∏è")) {
          bgClass = "bg-amber-500";
        } else if (
          type === "success" ||
          message.includes("‚úÖ") ||
          message.includes("successfully")
        ) {
          bgClass = "bg-emerald-600";
        }

        toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg text-white text-sm font-medium shadow-xl z-[9999]
            pointer-events-none transition-all duration-200 ease-out translate-y-4 opacity-0 ${bgClass}`;
        document.body.appendChild(toast);

        requestAnimationFrame(() => {
          toast.classList.remove("translate-y-4", "opacity-0");
        });

        setTimeout(() => {
          toast.classList.add("opacity-0", "translate-y-4");
          setTimeout(() => toast.remove(), 250);
        }, 3000);
      }
    }
  </script>
</header>
